<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kinben KPN System - Simplified</title>
    
    <!-- Production Edition - Direct CSV file integration with localStorage fallback -->
    
    <style>
        body { 
            font-family: Calibri, Arial, sans-serif; 
            margin: 0; 
            background: #f5f5f5;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            color: #666;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e3f2fd;
        }
        
        .tab.active {
            background: #0078d4;
            color: white;
        }
        
        .content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        /* Validation styles - consistent field sizing */
        .form-group input.valid,
        .form-group select.valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.1rem rgba(40, 167, 69, 0.25);
        }

        .form-group input.invalid,
        .form-group select.invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.1rem rgba(220, 53, 69, 0.25);
        }

        .validation-message {
            font-size: 12px;
            margin-top: 4px;
            display: none;
            min-height: 16px;
        }

        .validation-message.error {
            color: #dc3545;
            display: block;
        }

        .validation-message.success {
            color: #28a745;
            display: block;
        }

        /* Value with unit input styles - consistent sizing */
        .value-unit-container {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .value-unit-container input {
            flex: 2;
            min-width: 0;
        }

        .value-unit-container select {
            flex: 1;
            min-width: 80px;
            max-width: 120px;
        }

        /* Required field indicator */
        .required-field {
            color: #dc3545;
            margin-left: 2px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #0078d4;
            color: white;
        }
        
        .btn-primary:hover {
            background: #106ebe;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .table th {
            background: #0078d4;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .table tr:hover {
            background: #e3f2fd;
        }
        
        /* Sortable table headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px !important;
        }
        
        .sortable:hover {
            background: #106ebe !important;
        }
        
        .sortable::after {
            content: '↕️';
            position: absolute;
            right: 8px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        .sortable.sort-asc::after {
            content: '↑';
            opacity: 1;
            font-weight: bold;
        }
        
        .sortable.sort-desc::after {
            content: '↓';
            opacity: 1;
            font-weight: bold;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #0078d4;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .kpn-preview {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            color: #0078d4;
            text-align: center;
            margin: 10px 0;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .actions .btn {
            flex-shrink: 0;
        }
        
        #bulk-actions {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
        }
        
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }
        
        .bom-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .login-container h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 24px;
        }
        
        .login-container p {
            margin: 0 0 30px 0;
            color: #666;
            font-size: 14px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-form input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #0078d4;
        }
        
        .login-form button {
            padding: 12px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-form button:hover {
            background: #106ebe;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        /* Archived component styles */
        .status-archived {
            color: #6c757d;
            font-weight: bold;
        }
        
        .archived-row {
            opacity: 0.5;
            background-color: #f8f9fa !important;
        }
        
        .archived-row td {
            color: #6c757d !important;
        }
        
        /* Role-based action buttons */
        .archive-btn {
            background: #ffc107 !important;
            color: #212529 !important;
        }
        
        .archive-btn:hover {
            background: #e0a800 !important;
        }
        
        .delete-btn {
            background: #dc3545 !important;
            color: white !important;
        }
        
        .delete-btn:hover {
            background: #c82333 !important;
        }

        /* Duplicate Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .modal-header h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 20px;
        }

        .modal-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .modal-body {
            padding: 20px 30px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .duplicate-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .duplicate-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .duplicate-item-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .duplicate-item-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .duplicate-item-existing {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .duplicate-item-existing strong {
            color: #0078d4;
        }

        .duplicate-choices {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .duplicate-choices input[type="radio"] {
            margin-right: 5px;
        }

        .duplicate-choices label {
            cursor: pointer;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .duplicate-choices label:hover {
            background: #e9ecef;
        }

        .duplicate-choices input[type="radio"]:checked + label {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="login-modal" class="login-modal">
        <div class="login-container">
            <h2>🔐 Login to KPN System</h2>
            <p id="login-description">Enter your credentials to access the system</p>
            <div class="login-form">
                <!-- Local Authentication Form -->
                <div id="local-auth-form">
                    <input type="text" id="username" placeholder="Username" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                    <input type="password" id="password" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                    <button onclick="signInLocal()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 10px;">
                        🔑 Sign In
                    </button>
                </div>
                
                <div id="login-status" style="text-align: center; color: #666; font-size: 14px;"></div>
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
                <strong>Note:</strong><br>
                <span id="auth-note">Contact your administrator for login credentials.</span>
            </div>
        </div>
    </div>
    
    <!-- User Info Display -->
    <div id="user-info" class="user-info" style="display: none;">
        <span id="current-user"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>🔧 Kinben Parts Reference System - Local CSV Edition</h1>
            <p>Direct CSV File Integration - Offline Capable ERP System</p>
            
            <!-- CSV Directory Access Controls -->
            <div id="csv-controls" style="margin-top: 20px;">
                <button id="csv-access-btn" class="btn btn-primary" onclick="setupCSVAccess()" style="margin-right: 10px;">
                    📁 Select CSV Files Directory
                </button>
                <button id="csv-change-btn" class="btn btn-info" onclick="changeCSVDirectory()" style="margin-right: 10px; display: none;">
                    🔄 Change Directory
                </button>
                <span id="csv-status" style="color: #666; font-size: 14px;">
                    Not connected to CSV files - Using localStorage
                </span>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-components">0</div>
                <div class="stat-label">Components</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-assemblies">0</div>
                <div class="stat-label">Assemblies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-systems">0</div>
                <div class="stat-label">Systems</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('components')">📋 Components</button>
            <button class="tab" onclick="showTab('assemblies')">🔧 Assemblies</button>
            <button class="tab" onclick="showTab('systems')">🏗️ Systems</button>
            <button class="tab" onclick="showTab('export')">📊 Export</button>
            <button class="tab" onclick="showTab('config')">⚙️ Config</button>
        </div>
        
        <div class="content" id="simplified-structure">
            <!-- Components Tab -->
            <div id="components" class="tab-panel active">
                <h2>KPN Components</h2>
                <p>Basic electronic parts catalog with auto-generated KPNs</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="comp-category" onchange="updateComponentSubcategories()">
                            <option value="">Select Category</option>
                            <option value="capacitors">Capacitors</option>
                            <option value="resistors">Resistors</option>
                            <option value="inductors">Inductors</option>
                            <option value="diodes">Diodes</option>
                            <option value="transistors">Transistors</option>
                            <option value="ics">Integrated Circuits</option>
                            <option value="connectors">Connectors</option>
                            <option value="switches">Switches</option>
                            <option value="pcb">PCBs</option>
                            <option value="mechanical">Mechanical Parts</option>
                            <option value="printed3d">3D-Printed Parts</option>
                            <option value="cable">Cable Assemblies</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subcategory</label>
                        <select id="comp-subcategory" onchange="generateComponentKPN()">
                            <option value="">Select Subcategory</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>KPN (Auto-generated)</label>
                        <div class="kpn-preview" id="comp-kpn-preview">Select category and subcategory</div>
                    </div>
                </div>
                
                <!-- Dynamic component fields based on category -->
                <div id="component-dynamic-fields">
                    <p style="color: #666; text-align: center; margin: 40px 0;">
                        Select a category and subcategory to display component-specific fields
                    </p>
                </div>
                
                <div class="actions">
                    <!-- Main Action Buttons -->
                    <button class="btn btn-primary" onclick="addComponent()">Add Component</button>
                    <button class="btn" onclick="resetComponentForm()" style="background: #6c757d; color: white; display: none;" id="cancel-edit-btn">Cancel Edit</button>
                    <button class="btn btn-success" onclick="exportComponents()">Export CSV</button>
                    <input type="file" id="csv-import-input" accept=".csv" style="display: none;" onchange="importCSV()">
                    <button class="btn btn-info" onclick="document.getElementById('csv-import-input').click()">Import CSV</button>
                    <button class="btn" onclick="exportTemplate()" style="background: #6c757d; color: white;">Download Template</button>
                    
                    <!-- Bulk Select Button -->
                    <button class="btn" onclick="toggleBulkSelection()" style="background: #6c757d; color: white;" id="bulk-select-btn">Enable Bulk Select</button>
                </div>
                
                <!-- Bulk Actions Container -->
                <div id="bulk-actions" class="actions" style="display: none;">
                    <button class="btn btn-info" onclick="selectAllComponents()">Select All</button>
                    <button class="btn" onclick="deselectAllComponents()" style="background: #6c757d; color: white;">Deselect All</button>
                    <button class="btn archive-btn" onclick="bulkArchiveComponents()">Archive Selected</button>
                    <button class="btn delete-btn" onclick="bulkDeleteComponents()" id="bulk-delete-btn" style="display: none;">Delete Selected</button>
                </div>
                
                <input type="text" class="search-box" id="comp-search" placeholder="Search components..." onkeyup="filterComponents()">
                
                <table class="table" id="components-table">
                    <thead>
                        <tr>
                            <th id="bulk-select-header" style="display: none;">
                                <input type="checkbox" id="select-all-checkbox" onchange="toggleAllCheckboxes(this)">
                            </th>
                            <th class="sortable" onclick="sortComponents('kpn')">KPN</th>
                            <th class="sortable" onclick="sortComponents('category')">Category</th>
                            <th class="sortable" onclick="sortComponents('subcategory')">Subcategory</th>
                            <th class="sortable" onclick="sortComponents('value')">Value/PN</th>
                            <th class="sortable" onclick="sortComponents('package')">Package</th>
                            <th class="sortable" onclick="sortComponents('manufacturer')">Specs</th>
                            <th class="sortable" onclick="sortComponents('preferredVendor')">Vendor</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="components-tbody">
                    </tbody>
                </table>
            </div>
            
            <!-- PCBs Tab -->
            <div id="assemblies" class="tab-panel">
                <h2>Assembly Management</h2>
                <p>Assembly definitions with multiple item types (PCBs, mechanical parts, 3D-printed parts, components)</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Assembly Name</label>
                        <input type="text" id="assembly-name" placeholder="e.g., Main Controller Assembly">
                    </div>
                    <div class="form-group">
                        <label>Version</label>
                        <input type="text" id="assembly-version" placeholder="e.g., v1.0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="assembly-status">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="assembly-description" placeholder="Assembly description and purpose">
                </div>
                
                <h3>Assembly Items</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Item Type</label>
                        <select id="bom-type" onchange="updateBOMItemOptions()">
                            <option value="">Select Item Type</option>
                            <option value="component">Electronic Component</option>
                            <option value="pcb">PCB</option>
                            <option value="mechanical">Mechanical Part</option>
                            <option value="printed3d">3D-Printed Part</option>
                            <option value="cable">Cable Assembly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item KPN</label>
                        <select id="bom-kpn">
                            <option value="">Select Item Type First</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="bom-quantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>Reference Designator</label>
                        <input type="text" id="bom-refdes" placeholder="e.g., R1, C2, U3">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addBOMItem()">Add to Assembly</button>
                    </div>
                </div>
                
                <div id="bom-items"></div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="addAssembly()">Add Assembly</button>
                    <button class="btn btn-success" onclick="exportAssemblies()">Export CSV</button>
                </div>
                
                <input type="text" class="search-box" id="assembly-search" placeholder="Search Assemblies..." onkeyup="filterAssemblies()">
                
                <table class="table" id="assemblies-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortAssemblies('name')">Name</th>
                            <th class="sortable" onclick="sortAssemblies('version')">Version</th>
                            <th class="sortable" onclick="sortAssemblies('description')">Description</th>
                            <th class="sortable" onclick="sortAssemblies('itemCount')">Assembly Items</th>
                            <th class="sortable" onclick="sortAssemblies('status')">Status</th>
                        </tr>
                    </thead>
                    <tbody id="assemblies-tbody">
                    </tbody>
                </table>
            </div>
            
            <!-- Systems Tab -->
            <div id="systems" class="tab-panel">
                <h2>System Hierarchy</h2>
                <p>Systems containing assemblies, mechanical/3D-printed parts, cable assemblies, and other systems</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>System Name</label>
                        <input type="text" id="system-name" placeholder="e.g., IoT Environmental Monitor">
                    </div>
                    <div class="form-group">
                        <label>Version</label>
                        <input type="text" id="system-version" placeholder="e.g., v1.0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="system-status">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="system-description" placeholder="System description and purpose">
                </div>
                
                <h3>System Items</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Item Type</label>
                        <select id="system-item-type" onchange="updateSystemItemOptions()">
                            <option value="">Select Item Type</option>
                            <option value="assembly">Assembly</option>
                            <option value="mechanical">Mechanical Part</option>
                            <option value="printed3d">3D-Printed Part</option>
                            <option value="cable">Cable Assembly</option>
                            <option value="system">Other System</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item</label>
                        <select id="system-pcb">
                            <option value="">Select Item Type First</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="system-pcb-quantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addSystemItem()">Add Item</button>
                    </div>
                </div>
                
                <div id="system-items"></div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="addSystem()">Add System</button>
                    <button class="btn btn-success" onclick="exportSystems()">Export CSV</button>
                </div>
                
                <input type="text" class="search-box" id="system-search" placeholder="Search systems..." onkeyup="filterSystems()">
                
                <table class="table" id="systems-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortSystems('name')">Name</th>
                            <th class="sortable" onclick="sortSystems('version')">Version</th>
                            <th class="sortable" onclick="sortSystems('description')">Description</th>
                            <th class="sortable" onclick="sortSystems('itemCount')">Item Count</th>
                            <th class="sortable" onclick="sortSystems('status')">Status</th>
                        </tr>
                    </thead>
                    <tbody id="systems-tbody">
                    </tbody>
                </table>
            </div>
            
            <!-- Export Tab -->
            <div id="export" class="tab-panel">
                <h2>Data Export</h2>
                <p>Export your data in CSV format for external tools</p>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="export-components">0</div>
                        <div class="stat-label">Components to Export</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="export-assemblies">0</div>
                        <div class="stat-label">Assemblies to Export</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="export-systems">0</div>
                        <div class="stat-label">Systems to Export</div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="exportAll()">Export All Data</button>
                    <button class="btn btn-success" onclick="exportComponents()">Export Components Only</button>
                    <button class="btn btn-success" onclick="exportAssemblies()">Export Assemblies Only</button>
                    <button class="btn btn-success" onclick="exportSystems()">Export Systems Only</button>
                </div>
            </div>
            
            <!-- Config Tab -->
            <div id="config" class="tab-panel">
                <h2>Configuration</h2>
                <p>Manage system settings and preferred vendors</p>
                
                <div style="max-width: 800px;">
                    <!-- User Management Section (Admin Only) -->
                    <div id="user-management-section" style="display: none;">
                        <h3>👥 User Management</h3>
                        <p>Manage user accounts and permissions (Admin only)</p>
                        
                        <!-- Current Users -->
                        <div style="margin-bottom: 30px;">
                            <h4>Current Users</h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Username</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Display Name</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Role</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <!-- Users will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Add New User -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                            <h4>Add New User</h4>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label>Username <span style="color: red;">*</span></label>
                                    <input type="text" id="new-username" placeholder="e.g., john.doe">
                                </div>
                                <div class="form-group">
                                    <label>Display Name <span style="color: red;">*</span></label>
                                    <input type="text" id="new-displayname" placeholder="e.g., John Doe">
                                </div>
                                <div class="form-group">
                                    <label>Password <span style="color: red;">*</span></label>
                                    <input type="password" id="new-password" placeholder="Minimum 6 characters">
                                </div>
                                <div class="form-group">
                                    <label>Role <span style="color: red;">*</span></label>
                                    <select id="new-role">
                                        <option value="team">Team</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="btn btn-primary" onclick="addUser()">Add User</button>
                                <button class="btn" onclick="clearUserForm()" style="background: #6c757d; color: white;">Clear</button>
                            </div>
                            <div style="margin-top: 15px; font-size: 12px; color: #666;">
                                <strong>Note:</strong> Maximum 5 additional users (team + admin combined). One admin user is required.
                            </div>
                        </div>
                        
                        <!-- Role Descriptions -->
                        <div style="padding: 15px; background: #e3f2fd; border-radius: 5px; margin-bottom: 20px;">
                            <h4>Role Descriptions</h4>
                            <ul style="margin: 10px 0;">
                                <li><strong>Team:</strong> Can create and archive components, create PCBs and systems</li>
                                <li><strong>Admin:</strong> All team permissions plus ability to delete components and manage users</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Team User Profile Section -->
                    <div id="user-profile-section" style="display: none;">
                        <h3>👤 My Profile</h3>
                        <p>Update your personal information</p>
                        
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; max-width: 400px;">
                            <div class="form-group">
                                <label>Display Name</label>
                                <input type="text" id="profile-displayname" placeholder="Your display name">
                            </div>
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="profile-current-password" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label>New Password (leave blank to keep current)</label>
                                <input type="password" id="profile-new-password" placeholder="Enter new password">
                            </div>
                            <div class="actions">
                                <button class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
                            </div>
                        </div>
                    </div>

                    <h3>Preferred Vendors</h3>
                    <p>Add and manage your preferred component vendors for dropdown selection</p>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr auto; align-items: end;">
                        <div class="form-group">
                            <label>Vendor Name</label>
                            <input type="text" id="new-vendor-name" placeholder="e.g., Mouser, Digi-Key, Arrow">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="addVendor()">Add Vendor</button>
                        </div>
                    </div>
                    
                    <div id="vendors-list" style="margin-top: 20px;">
                        <h4>Current Vendors:</h4>
                        <div id="vendors-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Duplicate Confirmation Modal -->
    <div id="duplicate-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🔍 Duplicate Components Found</h3>
                <p>The following components already exist in your database. Choose your action for each:</p>
            </div>
            <div class="modal-body">
                <div id="duplicate-list" class="duplicate-list">
                    <!-- Duplicate items will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="processDuplicateChoices()">Apply Choices</button>
                <button class="btn" onclick="cancelDuplicateImport()" style="background: #6c757d; color: white;">Cancel Import</button>
            </div>
        </div>
    </div>

    <script>
        // Local user management system
        // User data stored in localStorage
        
        // CSV File System Integration
        let csvDirectoryHandle = null;
        let csvFileHandles = {};
        let supportsFileSystemAccess = false;
        
        // CSV file names and their component categories
        const csvFileMap = {
            'CAPACITORS.csv': 'capacitors',
            'RESISTORS.csv': 'resistors', 
            'INDUCTORS.csv': 'inductors',
            'DIODES.csv': 'diodes',
            'TRANSISTORS.csv': 'transistors',
            'INTEGRATED_CIRCUITS.csv': 'integrated_circuits',
            'CONNECTORS.csv': 'connectors',
            'SWITCHES.csv': 'switches',
            'CRYSTALS_OSCILLATORS.csv': 'crystals_oscillators',
            'LEDS.csv': 'leds',
            'FUSES.csv': 'fuses',
            'RELAYS.csv': 'relays',
            'SENSORS.csv': 'sensors',
            'OPTOCOUPLERS.csv': 'optocouplers',
            'HARDWARE.csv': 'hardware',
            'MECHANICAL.csv': 'mechanical'
        };

        // Simplified data storage
        let data = {
            components: [],
            assemblies: [],
            systems: [],
            vendors: ['Mouser', 'Digi-Key', 'Arrow', 'Newark', 'Farnell', 'RS Components', 'Avnet', 'Future Electronics']
        };

        // Current user object
        let currentUser = { role: 'none', email: '', uid: '', displayName: '', username: null };

        // Load users from localStorage or initialize with default admin
        function loadUsers() {
            const saved = localStorage.getItem('kpn_users');
            if (saved) {
                return JSON.parse(saved);
            } else {
                // Initialize with default admin user
                return {
                    'admin': { 
                        password: 'admin123', 
                        role: 'admin', 
                        email: 'admin@kinben.local', 
                        displayName: 'Administrator',
                        created: new Date().toISOString()
                    }
                };
            }
        }

        // Save users to localStorage
        function saveUsers() {
            localStorage.setItem('kpn_users', JSON.stringify(localUsers));
        }

        // Local user accounts
        let localUsers = loadUsers();

        // Handle local authentication
        function signInLocal() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showLoginError('Please enter both username and password.');
                return;
            }
            
            const user = localUsers[username];
            if (user && user.password === password) {
                // Successful local login
                currentUser = {
                    uid: 'local_' + username,
                    username: username,
                    email: user.email,
                    displayName: user.displayName,
                    role: user.role
                };
                
                hideLogin();
                showUserInfo();
                loadData(); // Load app data
                
                // Show appropriate features based on role
                updateUIForRole(user.role);
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                console.log('Local authentication successful for:', username);
            } else {
                showLoginError('Invalid username or password.');
            }
        }

        // Update UI based on user role
        function updateUIForRole(role) {
            const userMgmtSection = document.getElementById('user-management-section');
            const userProfileSection = document.getElementById('user-profile-section');
            
            if (role === 'admin') {
                userMgmtSection.style.display = 'block';
                userProfileSection.style.display = 'block';
                loadUsersTable();
            } else if (role === 'team') {
                userMgmtSection.style.display = 'none';
                userProfileSection.style.display = 'block';
                loadUserProfile();
            } else {
                userMgmtSection.style.display = 'none';
                userProfileSection.style.display = 'none';
            }
        }

        // Load users table for admin
        function loadUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            Object.keys(localUsers).forEach(username => {
                const user = localUsers[username];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd;">${username}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${user.displayName}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <span style="background: ${user.role === 'admin' ? '#dc3545' : '#28a745'}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">
                            ${user.role.toUpperCase()}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        ${username === 'admin' ? 
                            '<span style="color: #666; font-style: italic;">Protected</span>' : 
                            `<button class="btn" onclick="editUser('${username}')" style="background: #ffc107; color: black; padding: 4px 8px; font-size: 12px; margin-right: 5px;">Edit</button>
                             <button class="btn" onclick="deleteUser('${username}')" style="background: #dc3545; color: white; padding: 4px 8px; font-size: 12px;">Delete</button>`
                        }
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Load user profile for team users
        function loadUserProfile() {
            const user = localUsers[currentUser.username];
            if (user) {
                document.getElementById('profile-displayname').value = user.displayName;
            }
        }

        // Add new user (admin only)
        function addUser() {
            if (currentUser.role !== 'admin') {
                alert('Only administrators can add users.');
                return;
            }
            
            const username = document.getElementById('new-username').value.trim();
            const displayName = document.getElementById('new-displayname').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            
            // Validation
            if (!username || !displayName || !password || !role) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }
            
            if (localUsers[username]) {
                alert('Username already exists. Please choose a different username.');
                return;
            }
            
            // Check user limit (max 6 total: 1 admin + 5 others)
            const userCount = Object.keys(localUsers).length;
            if (userCount >= 6) {
                alert('Maximum number of users (6) reached. Please delete a user before adding a new one.');
                return;
            }
            
            // Add user
            localUsers[username] = {
                password: password,
                role: role,
                email: `${username}@kinben.local`,
                displayName: displayName,
                created: new Date().toISOString()
            };
            
            saveUsers();
            loadUsersTable();
            clearUserForm();
            alert(`User "${username}" added successfully.`);
        }

        // Clear user form
        function clearUserForm() {
            document.getElementById('new-username').value = '';
            document.getElementById('new-displayname').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-role').value = 'team';
        }

        // Edit user (admin only)
        function editUser(username) {
            if (currentUser.role !== 'admin') {
                alert('Only administrators can edit users.');
                return;
            }
            
            const user = localUsers[username];
            if (!user) return;
            
            const newDisplayName = prompt('Enter new display name:', user.displayName);
            if (newDisplayName && newDisplayName.trim() !== user.displayName) {
                user.displayName = newDisplayName.trim();
                saveUsers();
                loadUsersTable();
                alert('Display name updated successfully.');
            }
        }

        // Delete user (admin only)
        function deleteUser(username) {
            if (currentUser.role !== 'admin') {
                alert('Only administrators can delete users.');
                return;
            }
            
            if (username === 'admin') {
                alert('Cannot delete the admin user.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                delete localUsers[username];
                saveUsers();
                loadUsersTable();
                alert('User deleted successfully.');
            }
        }

        // Update user profile (team users can update their own info)
        function updateProfile() {
            const user = localUsers[currentUser.username];
            if (!user) {
                alert('User not found.');
                return;
            }
            
            const newDisplayName = document.getElementById('profile-displayname').value.trim();
            const currentPassword = document.getElementById('profile-current-password').value;
            const newPassword = document.getElementById('profile-new-password').value;
            
            // Verify current password
            if (user.password !== currentPassword) {
                alert('Current password is incorrect.');
                return;
            }
            
            // Update display name
            if (newDisplayName && newDisplayName !== user.displayName) {
                user.displayName = newDisplayName;
            }
            
            // Update password if provided
            if (newPassword) {
                if (newPassword.length < 6) {
                    alert('New password must be at least 6 characters long.');
                    return;
                }
                user.password = newPassword;
            }
            
            saveUsers();
            
            // Update current user object
            currentUser.displayName = user.displayName;
            showUserInfo();
            
            // Clear password fields
            document.getElementById('profile-current-password').value = '';
            document.getElementById('profile-new-password').value = '';
            
            alert('Profile updated successfully.');
        }

        // Handle user sign out
        function handleUserSignOut() {
            currentUser = { username: null, role: null, uid: null, email: null, displayName: null };
            showLogin();
            hideUserInfo();
        }

        // Sign out user
        function signOutUser() {
            handleUserSignOut();
        }

        // Show login error
        function showLoginError(message) {
            document.getElementById('login-status').innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 3px; margin-top: 10px;">
                    ${message}
                </div>
            `;
        }

        // Check authentication status
        function checkAuth() {
            return currentUser.role && currentUser.role !== 'none';
        }

        // Logout function
        function logout() {
            signOutUser();
        }

        // Show/hide login modal
        function showLogin() {
            document.getElementById('login-modal').style.display = 'flex';
        }

        function hideLogin() {
            document.getElementById('login-modal').style.display = 'none';
        }

        // Show/hide user info
        function showUserInfo() {
            const userInfo = document.getElementById('user-info');
            const currentUserSpan = document.getElementById('current-user');
            currentUserSpan.textContent = `${currentUser.username.charAt(0).toUpperCase() + currentUser.username.slice(1)} User (${currentUser.role === 'admin' ? 'Admin' : 'Team'})`;
            userInfo.style.display = 'block';
            updateUIForRole(currentUser.role);
        }

        function hideUserInfo() {
            document.getElementById('user-info').style.display = 'none';
        }

        // Initialize authentication on page load
        window.addEventListener('load', function() {
            showLogin();
        });

        // Add keyboard support for login modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('login-modal').style.display !== 'none') {
                signInLocal();
            }
        });

        // Load data from localStorage
        // File System Access API Functions
        
        // Check if File System Access API is supported
        function checkFileSystemSupport() {
            supportsFileSystemAccess = 'showDirectoryPicker' in window;
            return supportsFileSystemAccess;
        }
        
        // Request access to CSV files directory
        async function requestCSVDirectory() {
            try {
                if (!checkFileSystemSupport()) {
                    throw new Error('File System Access API not supported in this browser');
                }
                
                // Request directory access
                csvDirectoryHandle = await window.showDirectoryPicker({
                    mode: 'readwrite',
                    id: 'kpn-csv-directory'
                });
                
                console.log('Directory access granted:', csvDirectoryHandle.name);
                
                // Try to load CSV files
                await loadCSVFiles();
                
                return true;
            } catch (error) {
                console.error('Failed to access directory:', error);
                if (error.name === 'AbortError') {
                    alert('Directory access was cancelled. Using localStorage fallback.');
                } else {
                    alert('Failed to access CSV files: ' + error.message + '\nUsing localStorage fallback.');
                }
                return false;
            }
        }
        
        // Load all CSV files from the directory
        async function loadCSVFiles() {
            try {
                // Clear existing data
                data.components = [];
                
                // Look for CSV_Files subdirectory first
                let csvDir = csvDirectoryHandle;
                let foundCSVDir = false;
                
                try {
                    // Try to find CSV_Files subdirectory
                    for await (const [name, handle] of csvDirectoryHandle.entries()) {
                        if (name === 'KPN Master Reference Sheet' && handle.kind === 'directory') {
                            const masterDir = handle;
                            for await (const [subName, subHandle] of masterDir.entries()) {
                                if (subName === 'CSV_Files' && subHandle.kind === 'directory') {
                                    csvDir = subHandle;
                                    foundCSVDir = true;
                                    console.log('Found CSV_Files directory');
                                    break;
                                }
                            }
                            break;
                        }
                    }
                } catch (e) {
                    console.log('Using root directory for CSV files');
                }
                
                // Check if directory has any CSV files
                let foundAnyCSV = false;
                let missingFiles = [];
                
                // First pass: check what exists
                for (const [fileName, category] of Object.entries(csvFileMap)) {
                    try {
                        const fileHandle = await csvDir.getFileHandle(fileName);
                        foundAnyCSV = true;
                    } catch (error) {
                        missingFiles.push(fileName);
                    }
                }
                
                // If no CSV files found, offer to create them
                if (!foundAnyCSV) {
                    const createFiles = confirm(
                        `No CSV files found in the selected directory.\n\n` +
                        `Would you like to create blank CSV files with proper headers?\n\n` +
                        `This will create ${Object.keys(csvFileMap).length} files:\n` +
                        Object.keys(csvFileMap).join(', ') + '\n\n' +
                        `Click OK to create files, or Cancel to go back.`
                    );
                    
                    if (!createFiles) {
                        // User chose not to create files - reset to initial state
                        csvDirectoryHandle = null;
                        csvFileHandles = {};
                        document.getElementById('csv-access-btn').textContent = '📁 Select CSV Files Directory';
                        document.getElementById('csv-access-btn').onclick = setupCSVAccess;
                        document.getElementById('csv-change-btn').style.display = 'none';
                        updateCSVStatus('No CSV files found - Using localStorage fallback', 'orange');
                        return;
                    }
                    
                    // Create all CSV files with headers
                    updateCSVStatus('Creating blank CSV files...', 'orange');
                    for (const [fileName, category] of Object.entries(csvFileMap)) {
                        try {
                            const fileHandle = await csvDir.getFileHandle(fileName, { create: true });
                            csvFileHandles[fileName] = fileHandle;
                            await writeCSVHeader(fileHandle);
                            console.log(`Created ${fileName}`);
                        } catch (createError) {
                            console.error(`Failed to create ${fileName}:`, createError);
                        }
                    }
                    updateCSVStatus(`✅ Created ${Object.keys(csvFileMap).length} blank CSV files`, 'green');
                    return;
                }
                
                // Load each CSV file
                for (const [fileName, category] of Object.entries(csvFileMap)) {
                    try {
                        const fileHandle = await csvDir.getFileHandle(fileName);
                        csvFileHandles[fileName] = fileHandle;
                        
                        const file = await fileHandle.getFile();
                        const content = await file.text();
                        
                        if (content.trim()) {
                            const components = parseCSVContent(content, category);
                            data.components.push(...components);
                            console.log(`Loaded ${components.length} components from ${fileName}`);
                        }
                    } catch (error) {
                        console.log(`File ${fileName} not found:`, error.message);
                        // Create missing file with header
                        if (missingFiles.includes(fileName)) {
                            try {
                                const fileHandle = await csvDir.getFileHandle(fileName, { create: true });
                                csvFileHandles[fileName] = fileHandle;
                                await writeCSVHeader(fileHandle);
                                console.log(`Created missing file: ${fileName}`);
                            } catch (createError) {
                                console.error(`Failed to create ${fileName}:`, createError);
                            }
                        }
                    }
                }
                
                console.log(`Total components loaded: ${data.components.length}`);
                updateStats();
                renderAll();
                
            } catch (error) {
                console.error('Error loading CSV files:', error);
                throw error;
            }
        }
        
        // Parse CSV content into components
        function parseCSVContent(csvContent, category) {
            const lines = csvContent.trim().split('\n');
            if (lines.length <= 1) return []; // Only header or empty
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const components = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === 0 || !values[0]) continue; // Skip empty rows
                
                const component = {};
                headers.forEach((header, index) => {
                    component[header] = values[index] || '';
                });
                
                // Ensure required fields exist
                if (!component.Kinben_PN) continue;
                
                // Map to internal structure
                const mappedComponent = {
                    kpn: component.Kinben_PN,
                    category: getCategoryFromKPN(component.Kinben_PN) || category,
                    subcategory: component.Subcategory || getSubcategoryFromKPN(component.Kinben_PN) || '',
                    value: component.Value || '',
                    package: component.Package || '',
                    manufacturer: component.Manufacturer || '',
                    manufacturerPn: component.Manufacturer_PN || '',
                    description: component.Description || '',
                    preferredVendor: component.Preferred_Supplier || '',
                    status: component.Status || 'Active',
                    // Store all original CSV fields for round-trip compatibility
                    _csvData: component
                };
                
                components.push(mappedComponent);
            }
            
            return components;
        }
        
        // Parse a single CSV line handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // Extract category from KPN (e.g., "RES-STD-001" -> "resistors")
        function getCategoryFromKPN(kpn) {
            if (!kpn) return null;
            const prefix = kpn.split('-')[0];
            const categoryMap = {
                'CAP': 'capacitors',
                'RES': 'resistors',
                'IND': 'inductors',
                'DIO': 'diodes',
                'TRA': 'transistors',
                'IC': 'integrated_circuits',
                'CON': 'connectors',
                'SW': 'switches',
                'OSC': 'crystals_oscillators',
                'LED': 'leds',
                'FUS': 'fuses',
                'REL': 'relays',
                'SEN': 'sensors',
                'OPT': 'optocouplers',
                'HW': 'hardware',
                'MEC': 'mechanical'
            };
            return categoryMap[prefix] || null;
        }
        
        // Extract subcategory from KPN (e.g., "RES-STD-001" -> "STD")
        function getSubcategoryFromKPN(kpn) {
            if (!kpn) return null;
            const parts = kpn.split('-');
            return parts.length > 1 ? parts[1] : null;
        }
        
        // Write CSV header to a new file
        async function writeCSVHeader(fileHandle) {
            const headers = [
                'Kinben_PN', 'Category', 'Subcategory', 'Value', 'Package', 'Manufacturer', 
                'Manufacturer_PN', 'Description', 'Voltage_Rating', 'Current_Rating', 
                'Tolerance', 'Mounting', 'Preferred_Supplier', 'Mouser_PN', 'DigiKey_PN',
                'Unit_Cost', 'Stock_Level', 'Symbol_File', 'Footprint_File', '3D_Model_File',
                'Datasheet_URL', 'Status', 'Created_Date', 'Notes'
            ];
            
            const csvContent = headers.join(',') + '\n';
            const writable = await fileHandle.createWritable();
            await writable.write(csvContent);
            await writable.close();
        }
        
        // Setup CSV access - main function called by UI button
        async function setupCSVAccess() {
            updateCSVStatus('Requesting directory access...', 'orange');
            
            const success = await requestCSVDirectory();
            if (success) {
                updateCSVStatus('✅ Connected to CSV files', 'green');
                document.getElementById('csv-access-btn').textContent = '🔄 Reload CSV Files';
                document.getElementById('csv-access-btn').onclick = reloadCSVFiles;
                document.getElementById('csv-change-btn').style.display = 'inline-block';
            } else {
                updateCSVStatus('❌ CSV access failed - Using localStorage', 'red');
            }
        }
        
        // Change CSV directory - allows user to select a different folder
        async function changeCSVDirectory() {
            if (confirm('Changing CSV directory will reload all data from the new location. Any unsaved changes will be lost. Continue?')) {
                // Reset CSV handles
                csvDirectoryHandle = null;
                csvFileHandles = {};
                
                // Reset UI
                document.getElementById('csv-access-btn').textContent = '📁 Select CSV Files Directory';
                document.getElementById('csv-access-btn').onclick = setupCSVAccess;
                document.getElementById('csv-change-btn').style.display = 'none';
                updateCSVStatus('Requesting new directory access...', 'orange');
                
                // Request new directory
                const success = await requestCSVDirectory();
                if (success) {
                    updateCSVStatus('✅ Connected to new CSV directory', 'green');
                    document.getElementById('csv-access-btn').textContent = '🔄 Reload CSV Files';
                    document.getElementById('csv-access-btn').onclick = reloadCSVFiles;
                    document.getElementById('csv-change-btn').style.display = 'inline-block';
                } else {
                    updateCSVStatus('❌ Directory change failed - Using localStorage', 'red');
                }
            }
        }
        
        // Reload CSV files
        async function reloadCSVFiles() {
            if (!csvDirectoryHandle) {
                await setupCSVAccess();
                return;
            }
            
            updateCSVStatus('Reloading CSV files...', 'orange');
            try {
                await loadCSVFiles();
                updateCSVStatus('✅ CSV files reloaded', 'green');
            } catch (error) {
                console.error('Failed to reload CSV files:', error);
                updateCSVStatus('❌ Failed to reload CSV files', 'red');
            }
        }
        
        // Update CSV status display
        function updateCSVStatus(message, color = '#666') {
            const statusElement = document.getElementById('csv-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = color;
            }
        }
        
        // Initialize CSV system on page load
        function initializeCSVSystem() {
            // Check browser support and update UI
            if (checkFileSystemSupport()) {
                updateCSVStatus('Ready for CSV file access', '#666');
            } else {
                updateCSVStatus('⚠️ Browser doesn\'t support direct file access - Using localStorage only', 'orange');
                document.getElementById('csv-access-btn').style.display = 'none';
            }
        }

        // Modified loadData function to support CSV files
        async function loadData() {
            // Try to load from CSV files first if directory access is available
            if (csvDirectoryHandle) {
                try {
                    await loadCSVFiles();
                    return;
                } catch (error) {
                    console.error('Failed to load CSV files, falling back to localStorage:', error);
                }
            }
            
            // Fallback to localStorage
            const saved = localStorage.getItem('kinben-simple-data');
            if (saved) {
                data = JSON.parse(saved);
                // Ensure vendors array exists for backward compatibility
                if (!data.vendors) {
                    data.vendors = ['Mouser', 'Digi-Key', 'Arrow', 'Newark', 'Farnell', 'RS Components', 'Avnet', 'Future Electronics'];
                    saveData();
                }
                // Migrate pcbs to assemblies for backward compatibility
                if (data.pcbs && !data.assemblies) {
                    data.assemblies = data.pcbs;
                    delete data.pcbs;
                    saveData();
                }
                // Ensure assemblies array exists
                if (!data.assemblies) {
                    data.assemblies = [];
                    saveData();
                }
                // Migrate system pcbs to items for backward compatibility
                if (data.systems) {
                    data.systems.forEach(system => {
                        if (system.pcbs && !system.items) {
                            system.items = system.pcbs.map(pcb => ({
                                type: 'assembly',
                                value: pcb.name,
                                name: pcb.name,
                                version: pcb.version,
                                quantity: pcb.quantity
                            }));
                            delete system.pcbs;
                        }
                    });
                    saveData();
                }
            }
            updateStats();
            renderAll();
        }

        // Save data to localStorage and CSV files (if connected)
        async function saveData() {
            // Always save to localStorage as backup
            localStorage.setItem('kinben-simple-data', JSON.stringify(data));
            
            // If CSV files are connected, sync to CSV files
            if (csvDirectoryHandle && Object.keys(csvFileHandles).length > 0) {
                try {
                    await syncComponentsToCSV();
                } catch (error) {
                    console.error('Failed to sync to CSV files:', error);
                    updateCSVStatus('⚠️ CSV sync failed - Data saved to localStorage only', 'orange');
                }
            }
            
            updateStats();
        }
        
        // Sync all components to their respective CSV files
        async function syncComponentsToCSV() {
            updateCSVStatus('🔄 Syncing to CSV files...', 'orange');
            
            // Group components by category for CSV file writing
            const componentsByCategory = {};
            
            // Initialize empty arrays for all categories
            Object.values(csvFileMap).forEach(category => {
                componentsByCategory[category] = [];
            });
            
            // Group components by their category
            data.components.forEach(component => {
                const category = component.category || getCategoryFromKPN(component.kpn);
                if (category && componentsByCategory[category]) {
                    componentsByCategory[category].push(component);
                }
            });
            
            let syncedCount = 0;
            // Write each category to its CSV file
            for (const [fileName, category] of Object.entries(csvFileMap)) {
                if (csvFileHandles[fileName]) {
                    try {
                        await writeComponentsToCSV(csvFileHandles[fileName], componentsByCategory[category]);
                        syncedCount++;
                    } catch (error) {
                        console.error(`Failed to write to ${fileName}:`, error);
                        throw error;
                    }
                }
            }
            
            updateCSVStatus(`✅ ${data.components.length} components synced to ${syncedCount} CSV files`, 'green');
            console.log('CSV files synchronized successfully');
        }
        
        // Write components to a specific CSV file
        async function writeComponentsToCSV(fileHandle, components) {
            // Create CSV content with headers
            const headers = [
                'Kinben_PN', 'Category', 'Subcategory', 'Value', 'Package', 'Manufacturer', 
                'Manufacturer_PN', 'Description', 'Voltage_Rating', 'Current_Rating', 
                'Tolerance', 'Mounting', 'Preferred_Supplier', 'Mouser_PN', 'DigiKey_PN',
                'Unit_Cost', 'Stock_Level', 'Symbol_File', 'Footprint_File', '3D_Model_File',
                'Datasheet_URL', 'Status', 'Created_Date', 'Notes'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            // Add each component as a CSV row
            components.forEach(component => {
                const csvRow = headers.map(header => {
                    let value = '';
                    
                    // Map internal fields to CSV headers
                    switch (header) {
                        case 'Kinben_PN': value = component.kpn || ''; break;
                        case 'Category': value = component.category || ''; break;
                        case 'Subcategory': value = component.subcategory || ''; break;
                        case 'Value': value = component.value || component.resistance_value || component.capacitance_value || ''; break;
                        case 'Package': value = component.package || ''; break;
                        case 'Manufacturer': value = component.manufacturer || ''; break;
                        case 'Manufacturer_PN': value = component.manufacturerPn || component.manufacturer_pn || ''; break;
                        case 'Description': value = component.description || ''; break;
                        case 'Preferred_Supplier': value = component.preferredVendor || component.preferred_vendor || ''; break;
                        case 'Status': value = component.status || 'Active'; break;
                        case 'Created_Date': value = component.dateAdded || component.created_date || ''; break;
                        case 'Voltage_Rating': value = component.voltage_rating || component.voltage || ''; break;
                        case 'Current_Rating': value = component.current_rating || component.current || ''; break;
                        case 'Tolerance': value = component.tolerance || ''; break;
                        case 'Mounting': value = component.mounting || ''; break;
                        case 'Notes': value = component.notes || ''; break;
                        default:
                            // Check if the field exists in _csvData (original CSV data)
                            if (component._csvData && component._csvData[header]) {
                                value = component._csvData[header];
                            }
                            break;
                    }
                    
                    // Escape and quote the value if it contains commas or quotes
                    if (value.toString().includes(',') || value.toString().includes('"') || value.toString().includes('\n')) {
                        value = '"' + value.toString().replace(/"/g, '""') + '"';
                    }
                    
                    return value;
                });
                
                csvContent += csvRow.join(',') + '\n';
            });
            
            // Write to file
            const writable = await fileHandle.createWritable();
            await writable.write(csvContent);
            await writable.close();
        }

        // Category configurations with component-specific fields
        const categoryConfigs = {
            resistors: { 
                code: 'RES', 
                subcategories: ['STD', 'PRE', 'VAR', 'NET'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Yageo, Vishay' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., RC0805FR-0710KL' },
                    { id: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 10k, 4.7k' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 0805, 1206' },
                    { id: 'tolerance', label: 'Tolerance', type: 'text', required: true, placeholder: 'e.g., 1%, 5%' },
                    { id: 'temp-rating', label: 'Temp Rating', type: 'text', required: false, placeholder: 'e.g., -55°C to +125°C' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            capacitors: { 
                code: 'CAP', 
                subcategories: ['CER', 'ELE', 'TAN', 'FIL'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Murata, TDK' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., GRM21BR71H104KA01L' },
                    { id: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 10uF, 100nF' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 0805, 1206' },
                    { id: 'tolerance', label: 'Tolerance', type: 'text', required: false, placeholder: 'e.g., 10%, 20%' },
                    { id: 'voltage', label: 'Voltage', type: 'text', required: true, placeholder: 'e.g., 25V, 50V' },
                    { id: 'rating', label: 'Rating', type: 'text', required: false, placeholder: 'e.g., X7R, X5R, Y5V' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            ics: { 
                code: 'IC', 
                subcategories: ['MCU', 'ANA', 'DIG', 'PWR'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., STMicroelectronics, TI' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., STM32F103C8T6' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., 32-bit ARM Cortex-M3 MCU' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., LQFP-48, QFN-32' },
                    { id: 'rating', label: 'Rating', type: 'text', required: false, placeholder: 'e.g., Automotive, Industrial' },
                    { id: 'datasheet-link', label: 'Datasheet/Product Link', type: 'url', required: false, placeholder: 'https://...' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            inductors: { 
                code: 'IND', 
                subcategories: ['PWR', 'CHK', 'FER'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Murata, Coilcraft' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., LQM18FN1R0M00D' },
                    { id: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 10uH, 220nH' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 0805, 1210' },
                    { id: 'tolerance', label: 'Tolerance', type: 'text', required: false, placeholder: 'e.g., 10%, 20%' },
                    { id: 'current-rating', label: 'Current Rating', type: 'text', required: false, placeholder: 'e.g., 1A, 500mA' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            diodes: { 
                code: 'DIO', 
                subcategories: ['STD', 'LED', 'ZEN', 'SCH'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Vishay, Diodes Inc' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., 1N4148WS' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., SOD-323, SOT-23' },
                    { id: 'voltage-rating', label: 'Voltage Rating', type: 'text', required: false, placeholder: 'e.g., 75V, 100V' },
                    { id: 'current-rating', label: 'Current Rating', type: 'text', required: false, placeholder: 'e.g., 150mA, 1A' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            transistors: { 
                code: 'TRA', 
                subcategories: ['BJT', 'FET', 'MOS'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Infineon, ON Semi' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., 2N7002K' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., SOT-23, TO-220' },
                    { id: 'voltage-rating', label: 'Voltage Rating', type: 'text', required: false, placeholder: 'e.g., 60V, 100V' },
                    { id: 'current-rating', label: 'Current Rating', type: 'text', required: false, placeholder: 'e.g., 300mA, 1A' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            connectors: { 
                code: 'CON', 
                subcategories: ['HDR', 'JST', 'USB', 'RJ45'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., JST, Molex' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., B2B-XH-A(LF)(SN)' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., 2-pin JST XH connector' },
                    { id: 'pitch', label: 'Pitch', type: 'text', required: false, placeholder: 'e.g., 2.54mm, 1.25mm' },
                    { id: 'pins', label: 'Pins', type: 'number', required: false, placeholder: 'e.g., 2, 4, 8' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            switches: { 
                code: 'SWI', 
                subcategories: ['TAC', 'DIP', 'ROT', 'SLI'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., ALPS, Omron' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., SKHHPNA010' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., Tactile switch 4.3x4.3mm' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 4.3x4.3mm, SMD' },
                    { id: 'actuation-force', label: 'Actuation Force', type: 'text', required: false, placeholder: 'e.g., 160gf, 260gf' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            pcb: { 
                code: 'PCB', 
                subcategories: ['STD', 'FLX', 'RIG', 'MLB'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., JLCPCB, PCBWay' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., PCB-MAIN-V1.0' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., Main Controller PCB 2-layer' },
                    { id: 'dimensions', label: 'Dimensions', type: 'text', required: false, placeholder: 'e.g., 50x30mm, 100x80mm' },
                    { id: 'layers', label: 'Layers', type: 'text', required: false, placeholder: 'e.g., 2, 4, 6' },
                    { id: 'thickness', label: 'Thickness', type: 'text', required: false, placeholder: 'e.g., 1.6mm, 0.8mm' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            mechanical: { 
                code: 'MEC', 
                subcategories: ['SCR', 'NUT', 'WSH', 'BRK', 'SPR'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., McMaster-Carr, Fastenal' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., 91292A110' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., M3x10mm Phillips Head Screw' },
                    { id: 'material', label: 'Material', type: 'text', required: false, placeholder: 'e.g., Stainless Steel, Aluminum' },
                    { id: 'finish', label: 'Finish', type: 'text', required: false, placeholder: 'e.g., Black Oxide, Zinc Plated' },
                    { id: 'dimensions', label: 'Dimensions', type: 'text', required: false, placeholder: 'e.g., M3x10mm, 6.35x12.7mm' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            printed3d: { 
                code: 'P3D', 
                subcategories: ['CAS', 'BRK', 'SPA', 'MNT'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Internal, Shapeways' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., CASE-001-V1.2' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., Sensor Housing Top Cover' },
                    { id: 'material', label: 'Material', type: 'text', required: false, placeholder: 'e.g., PLA, ABS, PETG' },
                    { id: 'color', label: 'Color', type: 'text', required: false, placeholder: 'e.g., Black, White, Clear' },
                    { id: 'dimensions', label: 'Dimensions', type: 'text', required: false, placeholder: 'e.g., 80x60x25mm' },
                    { id: 'file-link', label: 'CAD File Link', type: 'url', required: false, placeholder: 'https://...' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            cable: { 
                code: 'CAB', 
                subcategories: ['PWR', 'DATA', 'SIG', 'CUS'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Amphenol, TE Connectivity' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., USB-A-TO-C-1M' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., USB-A to USB-C Cable 1m' },
                    { id: 'length', label: 'Length', type: 'text', required: false, placeholder: 'e.g., 1m, 500mm, 6ft' },
                    { id: 'connectors', label: 'Connectors', type: 'text', required: false, placeholder: 'e.g., USB-A to USB-C, JST-XH 2pin' },
                    { id: 'wire-gauge', label: 'Wire Gauge', type: 'text', required: false, placeholder: 'e.g., 24AWG, 20AWG' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            }
        };

        // ============ VALIDATION FRAMEWORK ============
        
        // Standard package options per category
        const packageOptions = {
            resistors: ['0402', '0603', '0805', '1206', '1210', '2010', '2512', 'AXIAL'],
            capacitors: ['0402', '0603', '0805', '1206', '1210', '1812', '2220', 'RADIAL'],
            inductors: ['0402', '0603', '0805', '1206', '1210', '1812', 'RADIAL'],
            diodes: ['SOD-123', 'SOD-323', 'SOD-523', 'SMA', 'SMB', 'SMC', 'DO-214'],
            transistors: ['SOT-23', 'SOT-223', 'TO-220', 'DPAK', 'D2PAK', 'SO-8'],
            ics: ['SOIC-8', 'SOIC-14', 'SOIC-16', 'TSSOP-14', 'QFN-16', 'BGA-256'],
            connectors: ['THT', 'SMD', '2.54mm', '1.27mm', 'USB', 'RJ45']
        };

        // Standard unit options
        const unitOptions = {
            resistance: ['Ω', 'kΩ', 'MΩ', 'GΩ'],
            capacitance: ['pF', 'nF', 'µF', 'mF'],
            inductance: ['nH', 'µH', 'mH', 'H'],
            voltage: ['mV', 'V', 'kV'],
            current: ['µA', 'mA', 'A']
        };

        // Validation functions
        function validateComponentValue(value, category) {
            if (!value || value.trim() === '') {
                return { valid: false, message: 'Value is required' };
            }

            // Patterns for different component types
            const patterns = {
                resistors: /^(\d+(?:\.\d+)?)\s*([kKmMgG]?[rRΩ])$/i,
                capacitors: /^(\d+(?:\.\d+)?)\s*([pnµumk]+[fF])$/i,
                inductors: /^(\d+(?:\.\d+)?)\s*([nµumk]+[hH])$/i
            };

            const pattern = patterns[category];
            if (pattern && pattern.test(value.trim())) {
                return { valid: true, message: 'Valid format' };
            } else if (pattern) {
                const examples = {
                    resistors: 'e.g., 10kΩ, 4.7k, 100R',
                    capacitors: 'e.g., 10µF, 100nF, 22pF',
                    inductors: 'e.g., 10µH, 1mH, 220nH'
                };
                return { 
                    valid: false, 
                    message: `Invalid format. ${examples[category] || ''}` 
                };
            }
            
            return { valid: true, message: '' }; // Other categories don't have strict validation
        }

        function validatePackage(packageValue, category) {
            if (!packageValue || packageValue.trim() === '') {
                return { valid: false, message: 'Package is required' };
            }

            const validPackages = packageOptions[category] || [];
            if (validPackages.length > 0 && !validPackages.includes(packageValue)) {
                return { 
                    valid: false, 
                    message: `Suggested: ${validPackages.slice(0, 3).join(', ')}` 
                };
            }

            return { valid: true, message: 'Valid package' };
        }

        function validateManufacturerPN(partNumber) {
            if (!partNumber || partNumber.trim() === '') {
                return { valid: true, message: '' }; // Optional field
            }

            // Basic pattern: alphanumeric with some special characters
            const pattern = /^[A-Za-z0-9\-_\.\/]+$/;
            if (pattern.test(partNumber.trim())) {
                return { valid: true, message: 'Valid format' };
            } else {
                return { 
                    valid: false, 
                    message: 'Only letters, numbers, hyphens, underscores, dots, and slashes allowed' 
                };
            }
        }

        function standardizeValue(value, category) {
            if (!value) return value;

            const standardizations = {
                resistors: value => {
                    return value
                        .replace(/r/gi, 'Ω')
                        .replace(/k/gi, 'k')
                        .replace(/m/gi, 'M')
                        .replace(/(\d+)k(\d*)/gi, (match, p1, p2) => {
                            return p2 ? `${p1}.${p2}kΩ` : `${p1}kΩ`;
                        });
                },
                capacitors: value => {
                    return value
                        .replace(/u/gi, 'µ')
                        .replace(/(\d+)µ([fF])/gi, '$1µF')
                        .replace(/(\d+)n([fF])/gi, '$1nF')
                        .replace(/(\d+)p([fF])/gi, '$1pF');
                },
                inductors: value => {
                    return value
                        .replace(/u/gi, 'µ')
                        .replace(/(\d+)µ([hH])/gi, '$1µH')
                        .replace(/(\d+)n([hH])/gi, '$1nH')
                        .replace(/(\d+)m([hH])/gi, '$1mH');
                }
            };

            const standardize = standardizations[category];
            return standardize ? standardize(value) : value;
        }

        function addValidationToField(field, category, fieldConfig) {
            const validationContainer = document.createElement('div');
            validationContainer.className = 'validation-message';
            validationContainer.id = `${field.id}-validation`;
            
            field.addEventListener('input', function() {
                validateField(field, category, fieldConfig);
            });

            field.addEventListener('blur', function() {
                if (fieldConfig.autoFormat && fieldConfig.id === 'value') {
                    field.value = standardizeValue(field.value, category);
                }
                validateField(field, category, fieldConfig);
            });

            field.parentNode.appendChild(validationContainer);
        }

        function validateField(field, category, fieldConfig) {
            const value = field.value;
            const validationMessage = document.getElementById(`${field.id}-validation`);
            let result = { valid: true, message: '' };

            // Clear previous validation state
            field.classList.remove('valid', 'invalid');

            // Apply validation based on field type
            if (fieldConfig.id === 'value') {
                result = validateComponentValue(value, category);
            } else if (fieldConfig.id === 'package') {
                result = validatePackage(value, category);
            } else if (fieldConfig.id === 'manufacturer-pn') {
                result = validateManufacturerPN(value);
            }

            // Only show validation state if field has content or if it's required and empty
            if (value || (fieldConfig.required && !value)) {
                field.classList.add(result.valid ? 'valid' : 'invalid');
            }

            if (validationMessage) {
                validationMessage.className = `validation-message ${result.valid ? 'success' : 'error'}`;
                validationMessage.textContent = result.message;
            }

            return result.valid;
        }

        function validateAllComponentFields() {
            const category = document.getElementById('comp-category').value;
            if (!category || !categoryConfigs[category]) {
                return true;
            }

            let allValid = true;
            const config = categoryConfigs[category];

            config.fields.forEach(fieldConfig => {
                const field = document.getElementById(`comp-${fieldConfig.id}`);
                if (field) {
                    const isValid = validateField(field, category, fieldConfig);
                    if (!isValid && fieldConfig.required) allValid = false;
                }
            });

            return allValid;
        }

        // ============ END VALIDATION FRAMEWORK ============

        // Tab management
        function showTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected panel and tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Update component dropdowns when switching tabs
            if (tabName === 'pcbs' || tabName === 'systems') {
                updateDropdowns();
            }
        }

        // Update subcategories based on category selection
        function updateComponentSubcategories() {
            const category = document.getElementById('comp-category').value;
            const subcategorySelect = document.getElementById('comp-subcategory');
            
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (category && categoryConfigs[category]) {
                categoryConfigs[category].subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
            
            // Update dynamic fields
            updateComponentFields();
            generateComponentKPN();
        }

        // Update component fields based on selected category
        function updateComponentFields() {
            const category = document.getElementById('comp-category').value;
            const dynamicFieldsContainer = document.getElementById('component-dynamic-fields');
            
            if (!category || !categoryConfigs[category]) {
                dynamicFieldsContainer.innerHTML = `
                    <p style="color: #666; text-align: center; margin: 40px 0;">
                        Select a category and subcategory to display component-specific fields
                    </p>
                `;
                return;
            }
            
            const config = categoryConfigs[category];
            let fieldsHTML = '<div class="form-grid">';
            
            // Add KPN field (always present)
            fieldsHTML += `
                <div class="form-group">
                    <label>KPN <span class="required-field">*</span></label>
                    <input type="text" id="comp-kpn" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Category <span class="required-field">*</span></label>
                    <input type="text" id="comp-category-display" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Subcategory <span class="required-field">*</span></label>
                    <input type="text" id="comp-subcategory-display" readonly style="background: #f5f5f5;">
                </div>
            `;
            
            // Add category-specific fields
            config.fields.forEach(field => {
                const requiredMark = field.required ? '<span class="required-field">*</span>' : '';
                
                if (field.type === 'vendor-select') {
                    // Create vendor dropdown
                    let vendorOptions = '<option value="">Select Vendor</option>';
                    data.vendors.forEach(vendor => {
                        vendorOptions += `<option value="${vendor}">${vendor}</option>`;
                    });
                    
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <select id="comp-${field.id}" ${field.required ? 'required' : ''}>
                                ${vendorOptions}
                            </select>
                        </div>
                    `;
                } else if (field.id === 'value' && ['resistors', 'capacitors', 'inductors'].includes(category)) {
                    // Special value field with unit dropdown for passive components
                    let unitType = '';
                    let unitList = [];
                    
                    const categoryUnitMap = {
                        resistors: { unitType: 'resistance', unitList: unitOptions.resistance },
                        capacitors: { unitType: 'capacitance', unitList: unitOptions.capacitance },
                        inductors: { unitType: 'inductance', unitList: unitOptions.inductance }
                    };
                    
                    const { unitType, unitList } = categoryUnitMap[category] || { unitType: '', unitList: [] };
                    
                    let unitOptionsHTML = unitList.map(unit => 
                        `<option value="${unit}">${unit}</option>`
                    ).join('');
                    
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <div class="value-unit-container">
                                <input type="text" 
                                       id="comp-${field.id}" 
                                       placeholder="Enter numeric value"
                                       ${field.required ? 'required' : ''}>
                                <select id="comp-${field.id}-unit">
                                    <option value="">Unit</option>
                                    ${unitOptionsHTML}
                                </select>
                            </div>
                        </div>
                    `;
                } else if (field.id === 'package') {
                    // Package field with dropdown suggestions
                    const packages = packageOptions[category] || [];
                    let packageOptionsHTML = packages.map(pkg => 
                        `<option value="${pkg}">${pkg}</option>`
                    ).join('');
                    
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <select id="comp-${field.id}" ${field.required ? 'required' : ''}>
                                <option value="">Select Package</option>
                                ${packageOptionsHTML}
                                <option value="custom">Other (specify)</option>
                            </select>
                        </div>
                    `;
                } else {
                    // Regular input field
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <input type="${field.type}" 
                                   id="comp-${field.id}" 
                                   placeholder="${field.placeholder || ''}"
                                   ${field.required ? 'required' : ''}>
                        </div>
                    `;
                }
            });
            
            fieldsHTML += '</div>';
            dynamicFieldsContainer.innerHTML = fieldsHTML;
            
            // Update readonly fields if category/subcategory are already selected
            const categorySelect = document.getElementById('comp-category');
            const subcategorySelect = document.getElementById('comp-subcategory');
            if (categorySelect.value) {
                document.getElementById('comp-category-display').value = categorySelect.options[categorySelect.selectedIndex].text;
            }
            if (subcategorySelect.value) {
                document.getElementById('comp-subcategory-display').value = subcategorySelect.value;
            }
            
            // Add validation to all the new fields
            config.fields.forEach(fieldConfig => {
                const field = document.getElementById(`comp-${fieldConfig.id}`);
                if (field) {
                    addValidationToField(field, category, fieldConfig);
                }
            });
        }

        // Generate KPN for component
        // Check if a component with the same identifying fields already exists
        function findDuplicateComponent(componentData) {
            const { category, subcategory } = componentData;
            
            // Core identifying fields that must match for all components
            const coreFields = ['category', 'subcategory'];
            
            // Additional identifying fields per category - comprehensive list based on schema
            const categoryIdentifyingFields = {
                resistors: ['value', 'package', 'tolerance', 'temp_rating', 'manufacturer', 'manufacturer_pn'],
                capacitors: ['value', 'package', 'tolerance', 'voltage_rating', 'rating', 'manufacturer', 'manufacturer_pn'],
                inductors: ['value', 'package', 'tolerance', 'current_rating', 'manufacturer', 'manufacturer_pn'],
                ics: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                diodes: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                transistors: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                connectors: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                switches: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer']
            };
            
            // Get all fields to check for this category
            const allFieldsToCheck = [
                ...coreFields,
                ...(categoryIdentifyingFields[category] || (() => {
                    console.warn(`Unknown category "${category}" encountered. Using fallback fields.`);
                    return ['manufacturer_pn', 'description', 'package'];
                })())
            ];
            
            // Find existing components with same category and subcategory first
            const similarComponents = data.components.filter(comp => 
                comp.category === category && 
                comp.subcategory === subcategory &&
                comp.status === 'Active' // Only check active components
            );
            
            // Check if any existing component has ALL matching identifying fields
            for (const existingComp of similarComponents) {
                let isMatch = true;
                
                for (const field of allFieldsToCheck) {
                    const newValue = (componentData[field] || '').toString().toLowerCase().trim();
                    const existingValue = (existingComp[field] || '').toString().toLowerCase().trim();
                    
                    // Track if at least one field is non-empty for both components
                    const isFieldIdentifying = newValue !== '' || existingValue !== '';
                    
                    if (!isFieldIdentifying) {
                        continue; // Skip non-identifying fields
                    }
                    
                    if (newValue !== existingValue) {
                        isMatch = false;
                        break;
                    }
                }
                
                if (isMatch) {
                    return existingComp;
                }
            }
            
            return null;
        }

        function generateComponentKPN() {
            const category = document.getElementById('comp-category').value;
            const subcategory = document.getElementById('comp-subcategory').value;
            const preview = document.getElementById('comp-kpn-preview');
            
            if (category && subcategory) {
                const config = categoryConfigs[category];
                const existingKPNs = data.components
                    .filter(c => c.kpn.startsWith(`${config.code}-${subcategory}`))
                    .map(c => parseInt(c.kpn.split('-')[2]))
                    .filter(n => !isNaN(n))
                    .sort((a, b) => a - b); // Sort to find gaps
                
                let nextNumber = 1;
                
                // Find the first available number (allows reuse of deleted KPNs)
                for (let i = 0; i < existingKPNs.length; i++) {
                    if (existingKPNs[i] === nextNumber) {
                        nextNumber++;
                    } else {
                        // Found a gap, use this number
                        break;
                    }
                }
                
                const kpn = `${config.code}-${subcategory}-${nextNumber.toString().padStart(3, '0')}`;
                
                preview.textContent = kpn;
                
                // Update KPN in dynamic form if it exists
                const compKpnField = document.getElementById('comp-kpn');
                if (compKpnField) {
                    compKpnField.value = kpn;
                }
                
                // Update category and subcategory display fields
                const compCategoryDisplay = document.getElementById('comp-category-display');
                const compSubcategoryDisplay = document.getElementById('comp-subcategory-display');
                if (compCategoryDisplay) {
                    const categorySelect = document.getElementById('comp-category');
                    compCategoryDisplay.value = categorySelect.options[categorySelect.selectedIndex].text;
                }
                if (compSubcategoryDisplay) {
                    compSubcategoryDisplay.value = subcategory;
                }
            } else {
                preview.textContent = 'Select category and subcategory';
                // Clear dynamic form KPN field
                const compKpnField = document.getElementById('comp-kpn');
                if (compKpnField) {
                    compKpnField.value = '';
                }
            }
        }

        // Add component
        async function addComponent() {
            const category = document.getElementById('comp-category').value;
            const subcategory = document.getElementById('comp-subcategory').value;
            
            if (!category || !subcategory) {
                alert('Please select category and subcategory first');
                return;
            }
            
            const kpn = document.getElementById('comp-kpn').value || document.getElementById('comp-kpn-preview').textContent;
            
            // Validate all fields using the validation framework
            if (!validateAllComponentFields()) {
                alert('Please fix validation errors before submitting.');
                return;
            }
            
            // Collect data from dynamic fields
            const component = {
                kpn,
                category,
                subcategory,
                status: 'Active', // Default status for new components
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            // Collect and validate field data
            const config = categoryConfigs[category];
            let missingRequired = [];
            
            config.fields.forEach(field => {
                const fieldElement = document.getElementById(`comp-${field.id}`);
                if (fieldElement) {
                    let value = fieldElement.value.trim();
                    
                    // Handle value + unit combination for passive components
                    if (field.id === 'value' && ['resistors', 'capacitors', 'inductors'].includes(category)) {
                        const unitElement = document.getElementById(`comp-${field.id}-unit`);
                        if (unitElement && unitElement.value) {
                            value = value + unitElement.value;
                        }
                    }
                    
                    if (field.required && !value) {
                        missingRequired.push(field.label);
                    }
                    component[field.id.replace('-', '_')] = value;
                }
            });
            
            if (missingRequired.length > 0) {
                alert(`Please fill in all required fields: ${missingRequired.join(', ')}`);
                return;
            }
            
            // Check for duplicate components
            const duplicateComponent = findDuplicateComponent(component);
            if (duplicateComponent) {
                alert(`A component with matching specifications already exists with KPN: ${duplicateComponent.kpn}. Cannot create duplicate.`);
                return;
            }
            
            data.components.push(component);
            await saveData();
            renderComponents();
            
            // Clear form
            document.getElementById('comp-category').value = '';
            document.getElementById('comp-subcategory').value = '';
            document.getElementById('comp-kpn-preview').textContent = 'Select category and subcategory';
            
            // Clear dynamic fields
            const dynamicFieldsContainer = document.getElementById('component-dynamic-fields');
            dynamicFieldsContainer.innerHTML = `
                <p style="color: #666; text-align: center; margin: 40px 0;">
                    Select a category and subcategory to display component-specific fields
                </p>
            `;
            
            // Show success message
            alert('Component added successfully!');
        }

        // Global variables for import process
        let pendingImportData = null;
        let duplicateResults = [];

        // Import components from CSV with duplicate detection
        function importCSV() {
            const fileInput = document.getElementById('csv-import-input');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file must have at least a header row and one data row');
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    let errors = [];
                    let validComponents = [];
                    let duplicates = [];
                    
                    // Check for required headers
                    const requiredHeaders = ['category', 'subcategory'];
                    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                    if (missingHeaders.length > 0) {
                        alert(`Missing required columns: ${missingHeaders.join(', ')}`);
                        return;
                    }
                    
                    // Phase 1: Parse and validate all rows, detect duplicates
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        if (values.length !== headers.length) continue;
                        
                        const rowData = {};
                        headers.forEach((header, index) => {
                            rowData[header] = values[index];
                        });
                        
                        // Validate category and subcategory
                        const category = rowData.category?.toLowerCase();
                        const subcategory = rowData.subcategory?.toUpperCase();
                        
                        if (!category || !categoryConfigs[category]) {
                            errors.push(`Row ${i + 1}: Invalid category "${rowData.category}"`);
                            continue;
                        }
                        
                        if (!subcategory || !categoryConfigs[category].subcategories.includes(subcategory)) {
                            errors.push(`Row ${i + 1}: Invalid subcategory "${rowData.subcategory}" for category "${category}"`);
                            continue;
                        }
                        
                        // Create component object (without KPN for now)
                        const component = {
                            category,
                            subcategory,
                            dateAdded: new Date().toISOString().split('T')[0],
                            status: 'Active',
                            rowNumber: i + 1
                        };
                        
                        // Map CSV fields to component fields - improved mapping logic
                        const config = categoryConfigs[category];
                        config.fields.forEach(field => {
                            // Get the field label and find the matching CSV field
                            const fieldLabel = field.label.toLowerCase();
                            const value = findMatchingCSVField(fieldLabel, field, rowData);
                            
                            // Store with underscored field name
                            component[field.id.replace(/-/g, '_')] = value || '';
                        });
                        
                        // Function to find matching CSV field
                        function findMatchingCSVField(fieldLabel, field, rowData) {
                            // Try exact match with the field label
                            for (const [csvKey, csvValue] of Object.entries(rowData)) {
                                if (csvKey.toLowerCase() === fieldLabel) {
                                    return csvValue;
                                }
                            }
                            
                            // Try common variations
                            const variations = [
                                fieldLabel.replace(/\s+/g, '-'),   // "manufacturer pn" -> "manufacturer-pn"
                                fieldLabel.replace(/\s+/g, '_'),   // "manufacturer pn" -> "manufacturer_pn" 
                                fieldLabel.replace(/\s+/g, ''),    // "manufacturer pn" -> "manufacturerpn"
                                field.id.replace(/-/g, '_'),       // "manufacturer-pn" -> "manufacturer_pn"
                                field.id                            // "manufacturer-pn"
                            ];
                            
                            for (const variation of variations) {
                                if (rowData[variation] !== undefined) {
                                    return rowData[variation];
                                }
                            }
                            
                            // Return empty string if no match is found
                            return '';
                        }
                        
                        // Check for duplicate components
                        const duplicateComponent = findDuplicateComponent(component);
                        if (duplicateComponent) {
                            duplicates.push({
                                component,
                                existingComponent: duplicateComponent,
                                choice: 'keep' // default choice
                            });
                        } else {
                            validComponents.push(component);
                        }
                    }
                    
                    // Show errors if any
                    if (errors.length > 0) {
                        console.log('Import validation errors:', errors);
                        alert(`Found ${errors.length} validation errors. Check console for details.`);
                    }
                    
                    // Store data for processing after user choices
                    pendingImportData = {
                        validComponents,
                        duplicates,
                        errors
                    };
                    
                    // Phase 2: If duplicates found, show modal for user choice
                    if (duplicates.length > 0) {
                        showDuplicateModal(duplicates);
                    } else {
                        // No duplicates, proceed with direct import
                        processFinalImport();
                    }
                    
                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
                
                // Clear the input
                fileInput.value = '';
            };
            
            reader.readAsText(file);
        }

        // Show duplicate confirmation modal
        function showDuplicateModal(duplicates) {
            const modal = document.getElementById('duplicate-modal');
            const duplicateList = document.getElementById('duplicate-list');
            
            // Clear previous content
            duplicateList.innerHTML = '';
            
            // Populate duplicate items
            duplicates.forEach((duplicate, index) => {
                const component = duplicate.component;
                const existing = duplicate.existingComponent;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'duplicate-item';
                
                // Create a user-friendly component description
                const componentDesc = createComponentDescription(component);
                const existingDesc = createComponentDescription(existing);
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'duplicate-item-header';
                const headerSpan = document.createElement('span');
                headerSpan.textContent = `⚠️ Row ${component.rowNumber}: ${componentDesc}`;
                headerDiv.appendChild(headerSpan);
                
                const existingDiv = document.createElement('div');
                existingDiv.className = 'duplicate-item-existing';
                const existingKpnStrong = document.createElement('strong');
                existingKpnStrong.textContent = 'Existing KPN:';
                existingDiv.appendChild(existingKpnStrong);
                existingDiv.appendChild(document.createTextNode(` ${existing.kpn}`));
                existingDiv.appendChild(document.createElement('br'));
                const detailsStrong = document.createElement('strong');
                detailsStrong.textContent = 'Details:';
                existingDiv.appendChild(detailsStrong);
                existingDiv.appendChild(document.createTextNode(` ${existingDesc}`));
                
                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'duplicate-choices';
                const keepInput = document.createElement('input');
                keepInput.type = 'radio';
                keepInput.id = `keep-${index}`;
                keepInput.name = `choice-${index}`;
                keepInput.value = 'keep';
                keepInput.checked = true;
                const keepLabel = document.createElement('label');
                keepLabel.htmlFor = `keep-${index}`;
                keepLabel.textContent = `✅ Keep Existing KPN (${existing.kpn})`;
                choicesDiv.appendChild(keepInput);
                choicesDiv.appendChild(keepLabel);
                
                const newInput = document.createElement('input');
                newInput.type = 'radio';
                newInput.id = `new-${index}`;
                newInput.name = `choice-${index}`;
                newInput.value = 'new';
                const newLabel = document.createElement('label');
                newLabel.htmlFor = `new-${index}`;
                newLabel.textContent = '➕ Assign New KPN';
                choicesDiv.appendChild(newInput);
                choicesDiv.appendChild(newLabel);
                
                itemDiv.appendChild(headerDiv);
                itemDiv.appendChild(existingDiv);
                itemDiv.appendChild(choicesDiv);
                
                duplicateList.appendChild(itemDiv);
            });
            
            // Show modal
            modal.style.display = 'flex';
        }

        // Create user-friendly component description
        function createComponentDescription(component) {
            const category = component.category?.charAt(0).toUpperCase() + component.category?.slice(1);
            const subcategory = component.subcategory;
            
            // Create description based on component type
            switch(component.category) {
                case 'resistors':
                case 'inductors':
                    return `${category} ${component.value || 'N/A'} ${component.package || 'N/A'} ${component.tolerance || ''}`.trim();
                case 'capacitors':
                    return `${category} ${component.value || 'N/A'} ${component.package || 'N/A'} ${component.voltage_rating || ''}`.trim();
                case 'ics':
                case 'diodes':
                case 'transistors':
                case 'connectors':
                case 'switches':
                    return `${category} ${component.manufacturer_pn || component.description || 'N/A'}`.trim();
                default:
                    return `${category} ${subcategory}`;
            }
        }

        // Process user choices and handle final import
        function processDuplicateChoices() {
            const duplicates = pendingImportData.duplicates;
            
            // Collect user choices
            duplicates.forEach((duplicate, index) => {
                const keepRadio = document.getElementById(`keep-${index}`);
                const newRadio = document.getElementById(`new-${index}`);
                
                if (keepRadio.checked) {
                    duplicate.choice = 'keep';
                } else if (newRadio.checked) {
                    duplicate.choice = 'new';
                }
            });
            
            // Hide modal and process import
            document.getElementById('duplicate-modal').style.display = 'none';
            processFinalImport();
        }

        // Cancel import process
        function cancelDuplicateImport() {
            document.getElementById('duplicate-modal').style.display = 'none';
            pendingImportData = null;
            duplicateResults = [];
            alert('Import cancelled.');
        }

        // Process final import with user choices
        function processFinalImport() {
            if (!pendingImportData) return;
            
            const { validComponents, duplicates, errors } = pendingImportData;
            let importedCount = 0;
            let reusedCount = 0;
            let reassignedCount = 0;
            let componentsToAdd = [];
            let kpnCounter = 0; // Initialize counter for KPN generation
            
            // Add all non-duplicate components
            validComponents.forEach(component => {
                // Generate KPN for new component
                const kpn = generateKPNForComponent(component, kpnCounter);
                kpnCounter++;
                component.kpn = kpn;
                componentsToAdd.push(component);
                importedCount++;
            });
            
            // Process duplicate choices
            duplicates.forEach(duplicate => {
                if (duplicate.choice === 'new') {
                    // User chose to assign new KPN
                    const kpn = generateKPNForComponent(duplicate.component, importedCount + reassignedCount);
                    duplicate.component.kpn = kpn;
                    componentsToAdd.push(duplicate.component);
                    reassignedCount++;
                } else {
                    // User chose to keep existing - do nothing (reuse existing)
                    reusedCount++;
                }
            });
            
            // Add components to data
            data.components.push(...componentsToAdd);
            
            // Save and refresh UI
            if (componentsToAdd.length > 0) {
                saveData();
                renderComponents();
            }
            
            // Show comprehensive import summary
            showImportSummary(importedCount, reusedCount, reassignedCount, errors.length);
            
            // Reset pending data
            pendingImportData = null;
            duplicateResults = [];
        }

        // Generate KPN for a component during import
        function generateKPNForComponent(component, offset = 0) {
            const { category, subcategory } = component;
            const config = categoryConfigs[category];
            
            const existingKPNs = data.components
                .filter(c => c.kpn.startsWith(`${config.code}-${subcategory}`))
                .map(c => parseInt(c.kpn.split('-')[2]))
                .filter(n => !isNaN(n));
            
            const nextNumber = existingKPNs.length > 0 ? existingKPNs.reduce((max, n) => Math.max(max, n), -Infinity) + 1 + offset : 1 + offset;
            return `${config.code}-${subcategory}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Show detailed import summary
        function showImportSummary(newCount, reusedCount, reassignedCount, errorCount) {
            const totalProcessed = newCount + reusedCount + reassignedCount;
            
            let message = '📊 Import Summary:\n\n';
            message += `✅ New components created: ${newCount}\n`;
            message += `🔄 Existing components reused: ${reusedCount}\n`;
            message += `➕ Components force-assigned new KPN: ${reassignedCount}\n`;
            message += `📋 Total components processed: ${totalProcessed}\n`;
            
            if (errorCount > 0) {
                message += `❌ Validation errors: ${errorCount} (check console)\n`;
            }
            
            message += '\n🎉 Import completed successfully!';
            
            alert(message);
        }

        // Export CSV template for component import
        function exportTemplate() {
            // Create template with all possible fields from all categories
            const allFields = new Set(['Category', 'Subcategory']);
            Object.values(categoryConfigs).forEach(config => {
                config.fields.forEach(field => {
                    allFields.add(field.label);
                });
            });
            
            const headers = Array.from(allFields);
            let csv = headers.join(',') + '\n';
            
            // Add comprehensive example rows for ALL component categories
            const examples = [
                // RESISTORS - Standard, Precision, Variable, Networks
                {
                    category: 'resistors',
                    subcategory: 'STD',
                    data: {
                        'Value': '10k',
                        'Package': '0805', 
                        'Tolerance': '1%',
                        'Temp Rating': '-55°C to +125°C',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                {
                    category: 'resistors',
                    subcategory: 'PRE',
                    data: {
                        'Value': '4.7k',
                        'Package': '0603', 
                        'Tolerance': '0.1%',
                        'Temp Rating': '-55°C to +155°C',
                        'Preferred Vendor': 'Digi-Key'
                    }
                },
                {
                    category: 'resistors',
                    subcategory: 'VAR',
                    data: {
                        'Value': '10k',
                        'Package': '3296W', 
                        'Tolerance': '10%',
                        'Temp Rating': '-40°C to +85°C',
                        'Preferred Vendor': 'Newark'
                    }
                },
                
                // CAPACITORS - Ceramic, Electrolytic, Tantalum, Film
                {
                    category: 'capacitors', 
                    subcategory: 'CER',
                    data: {
                        'Value': '100nF',
                        'Package': '0805',
                        'Tolerance': '10%', 
                        'Voltage': '50V',
                        'Rating': 'X7R',
                        'Preferred Vendor': 'Digi-Key'
                    }
                },
                {
                    category: 'capacitors', 
                    subcategory: 'ELE',
                    data: {
                        'Value': '470uF',
                        'Package': '8x12mm',
                        'Tolerance': '20%', 
                        'Voltage': '25V',
                        'Rating': 'Low ESR',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                {
                    category: 'capacitors', 
                    subcategory: 'TAN',
                    data: {
                        'Value': '22uF',
                        'Package': '1206',
                        'Tolerance': '10%', 
                        'Voltage': '16V',
                        'Rating': 'Industrial',
                        'Preferred Vendor': 'Arrow'
                    }
                },
                {
                    category: 'capacitors', 
                    subcategory: 'FIL',
                    data: {
                        'Value': '1uF',
                        'Package': '1210',
                        'Tolerance': '5%', 
                        'Voltage': '250V',
                        'Rating': 'X2',
                        'Preferred Vendor': 'Farnell'
                    }
                },
                
                // INTEGRATED CIRCUITS - MCU, Analog, Digital, Power
                {
                    category: 'ics',
                    subcategory: 'MCU', 
                    data: {
                        'Manufacturer PN': 'STM32F103C8T6',
                        'Description': '32-bit ARM Cortex-M3 MCU 72MHz',
                        'Package': 'LQFP-48',
                        'Rating': 'Industrial',
                        'Datasheet/Product Link': 'https://www.st.com/stm32f103c8',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                {
                    category: 'ics',
                    subcategory: 'ANA', 
                    data: {
                        'Manufacturer PN': 'LM358DR',
                        'Description': 'Dual Operational Amplifier',
                        'Package': 'SOIC-8',
                        'Rating': 'Industrial',
                        'Datasheet/Product Link': 'https://www.ti.com/product/LM358',
                        'Preferred Vendor': 'Digi-Key'
                    }
                },
                {
                    category: 'ics',
                    subcategory: 'DIG', 
                    data: {
                        'Manufacturer PN': '74HC595D',
                        'Description': '8-bit Serial-In Parallel-Out Shift Register',
                        'Package': 'SOIC-16',
                        'Rating': 'Commercial',
                        'Datasheet/Product Link': 'https://www.nxp.com/products/logic/shift-registers',
                        'Preferred Vendor': 'Newark'
                    }
                },
                {
                    category: 'ics',
                    subcategory: 'PWR', 
                    data: {
                        'Manufacturer PN': 'LM2596S-5.0',
                        'Description': 'Step-Down Voltage Regulator 5V 3A',
                        'Package': 'TO-263-5',
                        'Rating': 'Industrial',
                        'Datasheet/Product Link': 'https://www.ti.com/product/LM2596',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                
                // INDUCTORS - Power, Choke, Ferrite
                {
                    category: 'inductors',
                    subcategory: 'PWR',
                    data: {
                        'Value': '22uH',
                        'Package': '1210',
                        'Tolerance': '20%',
                        'Current Rating': '2A',
                        'Preferred Vendor': 'Coilcraft'
                    }
                },
                {
                    category: 'inductors',
                    subcategory: 'CHK',
                    data: {
                        'Value': '100uH',
                        'Package': '0805',
                        'Tolerance': '10%',
                        'Current Rating': '500mA',
                        'Preferred Vendor': 'Murata'
                    }
                },
                {
                    category: 'inductors',
                    subcategory: 'FER',
                    data: {
                        'Value': '220nH',
                        'Package': '0603',
                        'Tolerance': '25%',
                        'Current Rating': '200mA',
                        'Preferred Vendor': 'TDK'
                    }
                },
                
                // DIODES - Standard, LED, Zener, Schottky
                {
                    category: 'diodes',
                    subcategory: 'STD',
                    data: {
                        'Manufacturer PN': '1N4148WS',
                        'Package': 'SOD-323',
                        'Voltage Rating': '75V',
                        'Current Rating': '150mA',
                        'Preferred Vendor': 'Vishay'
                    }
                },
                {
                    category: 'diodes',
                    subcategory: 'LED',
                    data: {
                        'Manufacturer PN': 'LTST-C170KRKT',
                        'Package': '0805',
                        'Voltage Rating': '2.1V',
                        'Current Rating': '20mA',
                        'Preferred Vendor': 'Lite-On'
                    }
                },
                {
                    category: 'diodes',
                    subcategory: 'ZEN',
                    data: {
                        'Manufacturer PN': 'BZX84C5V1',
                        'Package': 'SOT-23',
                        'Voltage Rating': '5.1V',
                        'Current Rating': '250mA',
                        'Preferred Vendor': 'NXP'
                    }
                },
                {
                    category: 'diodes',
                    subcategory: 'SCH',
                    data: {
                        'Manufacturer PN': 'BAT54S',
                        'Package': 'SOT-23',
                        'Voltage Rating': '30V',
                        'Current Rating': '200mA',
                        'Preferred Vendor': 'Infineon'
                    }
                },
                
                // TRANSISTORS - BJT, FET, MOSFET
                {
                    category: 'transistors',
                    subcategory: 'BJT',
                    data: {
                        'Manufacturer PN': 'MMBT3904',
                        'Package': 'SOT-23',
                        'Voltage Rating': '40V',
                        'Current Rating': '200mA',
                        'Preferred Vendor': 'ON Semi'
                    }
                },
                {
                    category: 'transistors',
                    subcategory: 'FET',
                    data: {
                        'Manufacturer PN': '2N7002K',
                        'Package': 'SOT-23',
                        'Voltage Rating': '60V',
                        'Current Rating': '300mA',
                        'Preferred Vendor': 'Nexperia'
                    }
                },
                {
                    category: 'transistors',
                    subcategory: 'MOS',
                    data: {
                        'Manufacturer PN': 'BSS138',
                        'Package': 'SOT-23',
                        'Voltage Rating': '50V',
                        'Current Rating': '220mA',
                        'Preferred Vendor': 'Fairchild'
                    }
                },
                
                // CONNECTORS - Header, JST, USB, RJ45
                {
                    category: 'connectors',
                    subcategory: 'HDR',
                    data: {
                        'Manufacturer PN': 'TSW-102-07-G-S',
                        'Description': '2-pin 0.1" header socket',
                        'Pitch': '2.54mm',
                        'Pins': '2',
                        'Preferred Vendor': 'Samtec'
                    }
                },
                {
                    category: 'connectors',
                    subcategory: 'JST',
                    data: {
                        'Manufacturer PN': 'B4B-XH-A(LF)(SN)',
                        'Description': '4-pin JST XH connector',
                        'Pitch': '2.5mm',
                        'Pins': '4',
                        'Preferred Vendor': 'JST'
                    }
                },
                {
                    category: 'connectors',
                    subcategory: 'USB',
                    data: {
                        'Manufacturer PN': 'USB4085-GF-A',
                        'Description': 'USB-C receptacle',
                        'Pitch': '0.5mm',
                        'Pins': '24',
                        'Preferred Vendor': 'GCT'
                    }
                },
                {
                    category: 'connectors',
                    subcategory: 'RJ45',
                    data: {
                        'Manufacturer PN': 'SI-60062-F',
                        'Description': 'RJ45 Ethernet connector with LEDs',
                        'Pitch': '1.27mm',
                        'Pins': '8',
                        'Preferred Vendor': 'Bel Fuse'
                    }
                },
                
                // SWITCHES - Tactile, DIP, Rotary, Slide
                {
                    category: 'switches',
                    subcategory: 'TAC',
                    data: {
                        'Manufacturer PN': 'SKHHPNA010',
                        'Description': 'Tactile switch 4.3x4.3mm',
                        'Package': '4.3x4.3mm',
                        'Actuation Force': '160gf',
                        'Preferred Vendor': 'Alps'
                    }
                },
                {
                    category: 'switches',
                    subcategory: 'DIP',
                    data: {
                        'Manufacturer PN': 'DS01-254-1-04BK-SMT',
                        'Description': '4-position DIP switch',
                        'Package': 'SMT',
                        'Actuation Force': '250gf',
                        'Preferred Vendor': 'CTS'
                    }
                },
                {
                    category: 'switches',
                    subcategory: 'ROT',
                    data: {
                        'Manufacturer PN': 'PEC11R-4015F-S0024',
                        'Description': 'Rotary encoder with switch',
                        'Package': 'Through-hole',
                        'Actuation Force': '200gf',
                        'Preferred Vendor': 'Bourns'
                    }
                },
                {
                    category: 'switches',
                    subcategory: 'SLI',
                    data: {
                        'Manufacturer PN': 'SS12D00G3',
                        'Description': 'SPDT slide switch',
                        'Package': '4.5x1.8mm',
                        'Actuation Force': '120gf',
                        'Preferred Vendor': 'E-Switch'
                    }
                }
            ];
            
            examples.forEach(example => {
                const row = headers.map(header => {
                    if (header === 'Category') return example.category;
                    if (header === 'Subcategory') return example.subcategory;
                    return example.data[header] || '';
                });
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            downloadCSV(csv, 'kinben-components-template.csv');
        }

        // Current BOM items for PCB form
        let currentBOM = [];

        // Add BOM item
        function addBOMItem() {
            const kpn = document.getElementById('bom-kpn').value;
            const quantity = parseInt(document.getElementById('bom-quantity').value);
            const refdes = document.getElementById('bom-refdes').value;
            
            if (!kpn || !quantity || !refdes) {
                alert('Please fill in all BOM fields');
                return;
            }
            
            const component = data.components.find(c => c.kpn === kpn);
            if (!component) {
                alert('Component not found');
                return;
            }
            
            const bomItem = {
                kpn,
                componentName: `${component.manufacturer} ${component.partNumber}`,
                quantity,
                refdes
            };
            
            currentBOM.push(bomItem);
            renderBOMItems();
            
            // Clear form
            document.getElementById('bom-kpn').value = '';
            document.getElementById('bom-quantity').value = '1';
            document.getElementById('bom-refdes').value = '';
        }

        // Remove BOM item
        function removeBOMItem(index) {
            currentBOM.splice(index, 1);
            renderBOMItems();
        }

        // Render BOM items
        function renderBOMItems() {
            const container = document.getElementById('bom-items');
            container.innerHTML = '';
            
            currentBOM.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bom-row';
                div.innerHTML = `
                    <span>${item.componentName}</span>
                    <span>Qty: ${item.quantity}</span>
                    <span>RefDes: ${item.refdes}</span>
                    <button class="remove-btn" onclick="removeBOMItem(${index})">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        // Add Assembly
        function addAssembly() {
            const name = document.getElementById('assembly-name').value;
            const version = document.getElementById('assembly-version').value;
            const status = document.getElementById('assembly-status').value;
            const description = document.getElementById('assembly-description').value;
            
            if (!name || !version || currentBOM.length === 0) {
                alert('Please fill in assembly details and add at least one item');
                return;
            }
            
            const assembly = {
                name,
                version,
                status,
                description,
                bom: [...currentBOM],
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            data.assemblies.push(assembly);
            saveData();
            renderAssemblies();
            
            // Clear form
            document.getElementById('assembly-name').value = '';
            document.getElementById('assembly-version').value = '';
            document.getElementById('assembly-description').value = '';
            currentBOM = [];
            renderBOMItems();
        }

        // Current system items
        let currentSystemItems = [];

        // Add system item
        function addSystemItem() {
            const itemType = document.getElementById('system-item-type').value;
            const itemValue = document.getElementById('system-pcb').value;
            const quantity = parseInt(document.getElementById('system-pcb-quantity').value);
            
            if (!itemType || !itemValue || !quantity) {
                alert('Please select item type, item, and quantity');
                return;
            }
            
            let itemName = '';
            let itemVersion = '';
            
            if (itemType === 'assembly') {
                const assembly = data.assemblies.find(a => a.name === itemValue);
                if (!assembly) {
                    alert('Assembly not found');
                    return;
                }
                itemName = assembly.name;
                itemVersion = assembly.version;
            } else if (['mechanical', 'printed3d', 'cable'].includes(itemType)) {
                const component = data.components.find(c => c.kpn === itemValue);
                if (!component) {
                    alert('Component not found');
                    return;
                }
                itemName = component.kpn;
                itemVersion = component.description || component.manufacturer_pn || 'Unknown';
            } else if (itemType === 'system') {
                const system = data.systems.find(s => s.name === itemValue);
                if (!system) {
                    alert('System not found');
                    return;
                }
                itemName = system.name;
                itemVersion = system.version;
            }
            
            const systemItem = {
                type: itemType,
                value: itemValue,
                name: itemName,
                version: itemVersion,
                quantity
            };
            
            currentSystemItems.push(systemItem);
            renderSystemItems();
            
            // Clear form
            document.getElementById('system-item-type').value = '';
            document.getElementById('system-pcb').value = '';
            document.getElementById('system-pcb-quantity').value = '1';
            updateSystemItemOptions();
        }

        // Remove system item
        function removeSystemItem(index) {
            currentSystemItems.splice(index, 1);
            renderSystemItems();
        }

        // Render system items
        function renderSystemItems() {
            const container = document.getElementById('system-items');
            container.innerHTML = '';
            
            currentSystemItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bom-row';
                let displayText = '';
                switch(item.type) {
                    case 'assembly':
                        displayText = `Assembly: ${item.name} (${item.version})`;
                        break;
                    case 'mechanical':
                        displayText = `Mechanical: ${item.name} - ${item.version}`;
                        break;
                    case 'printed3d':
                        displayText = `3D-Printed: ${item.name} - ${item.version}`;
                        break;
                    case 'cable':
                        displayText = `Cable: ${item.name} - ${item.version}`;
                        break;
                    case 'system':
                        displayText = `System: ${item.name} (${item.version})`;
                        break;
                }
                div.innerHTML = `
                    <span>${displayText}</span>
                    <span>Qty: ${item.quantity}</span>
                    <span></span>
                    <button class="remove-btn" onclick="removeSystemItem(${index})">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        // Add system
        function addSystem() {
            const name = document.getElementById('system-name').value;
            const version = document.getElementById('system-version').value;
            const status = document.getElementById('system-status').value;
            const description = document.getElementById('system-description').value;
            
            if (!name || !version || currentSystemItems.length === 0) {
                alert('Please fill in system details and add at least one item');
                return;
            }
            
            const system = {
                name,
                version,
                status,
                description,
                items: [...currentSystemItems],
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            data.systems.push(system);
            saveData();
            renderSystems();
            
            // Clear form
            document.getElementById('system-name').value = '';
            document.getElementById('system-version').value = '';
            document.getElementById('system-description').value = '';
            currentSystemItems = [];
            renderSystemItems();
        }

        // Update dropdowns
        // Update system item options based on selected type
        function updateSystemItemOptions() {
            const type = document.getElementById('system-item-type').value;
            const itemSelect = document.getElementById('system-pcb');
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (type === 'assembly') {
                // Show assemblies
                data.assemblies.forEach(assembly => {
                    if (assembly.status === 'Active') {
                        const option = document.createElement('option');
                        option.value = assembly.name;
                        option.textContent = `${assembly.name} (${assembly.version})`;
                        itemSelect.appendChild(option);
                    }
                });
            } else if (['mechanical', 'printed3d', 'cable'].includes(type)) {
                // Show components of the selected type
                data.components.forEach(comp => {
                    if (comp.status === 'Active' && comp.category === type) {
                        const option = document.createElement('option');
                        option.value = comp.kpn;
                        option.textContent = `${comp.kpn} - ${comp.description || comp.manufacturer_pn || 'Unknown'}`;
                        itemSelect.appendChild(option);
                    }
                });
            } else if (type === 'system') {
                // Show other systems (excluding current one being edited if applicable)
                data.systems.forEach(system => {
                    if (system.status === 'Active') {
                        const option = document.createElement('option');
                        option.value = system.name;
                        option.textContent = `${system.name} (${system.version})`;
                        itemSelect.appendChild(option);
                    }
                });
            }
        }

        // Update BOM item options based on selected type
        function updateBOMItemOptions() {
            const type = document.getElementById('bom-type').value;
            const bomSelect = document.getElementById('bom-kpn');
            bomSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (type === 'component') {
                // Show electronic components (excluding PCB, mechanical, 3D-printed, cable categories)
                data.components.forEach(comp => {
                    if (comp.status === 'Active' && !['pcb', 'mechanical', 'printed3d', 'cable'].includes(comp.category)) {
                        const option = document.createElement('option');
                        option.value = comp.kpn;
                        option.textContent = `${comp.kpn} - ${comp.manufacturer || comp.manufacturer_pn || 'Unknown'} ${comp.partNumber || comp.value || ''}`;
                        bomSelect.appendChild(option);
                    }
                });
            } else if (['pcb', 'mechanical', 'printed3d', 'cable'].includes(type)) {
                // Show components of the selected type
                data.components.forEach(comp => {
                    if (comp.status === 'Active' && comp.category === type) {
                        const option = document.createElement('option');
                        option.value = comp.kpn;
                        option.textContent = `${comp.kpn} - ${comp.description || comp.manufacturer_pn || 'Unknown'}`;
                        bomSelect.appendChild(option);
                    }
                });
            }
        }

        function updateDropdowns() {
            // Update BOM KPN dropdown - now handled by updateBOMItemOptions
            updateBOMItemOptions();
            
            // Update system item dropdown
            updateSystemItemOptions();
        }

        // Render functions
        // Sorting state
        let componentSortColumn = null;
        let componentSortDirection = 'asc';
        let assemblySortColumn = null;
        let assemblySortDirection = 'asc';
        let systemSortColumn = null;
        let systemSortDirection = 'asc';
        
        // Sort components table
        function sortComponents(column) {
            // Toggle direction if same column, otherwise default to ascending
            if (componentSortColumn === column) {
                componentSortDirection = componentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                componentSortColumn = column;
                componentSortDirection = 'asc';
            }
            
            // Update header styling
            document.querySelectorAll('#components-table .sortable').forEach(th => {
                th.className = 'sortable';
            });
            document.querySelector(`#components-table .sortable:nth-child(${getComponentColumnIndex(column)})`).className = 
                `sortable sort-${componentSortDirection}`;
            
            // Sort the data
            data.components.sort((a, b) => {
                let aVal = getComponentValue(a, column);
                let bVal = getComponentValue(b, column);
                
                // Handle numeric sorting for KPN
                if (column === 'kpn') {
                    const aNum = parseInt(aVal.split('-').pop());
                    const bNum = parseInt(bVal.split('-').pop());
                    aVal = aNum || 0;
                    bVal = bNum || 0;
                }
                
                let comparison = 0;
                if (aVal < bVal) comparison = -1;
                if (aVal > bVal) comparison = 1;
                
                return componentSortDirection === 'desc' ? -comparison : comparison;
            });
            
            renderComponents();
        }
        
        // Sort assemblies table
        function sortAssemblies(column) {
            if (assemblySortColumn === column) {
                assemblySortDirection = assemblySortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                assemblySortColumn = column;
                assemblySortDirection = 'asc';
            }
            
            // Update header styling
            document.querySelectorAll('#assemblies-table .sortable').forEach(th => {
                th.className = 'sortable';
            });
            document.querySelector(`#assemblies-table .sortable:nth-child(${getAssemblyColumnIndex(column)})`).className = 
                `sortable sort-${assemblySortDirection}`;
            
            // Sort the data
            data.assemblies.sort((a, b) => {
                let aVal = getAssemblyValue(a, column);
                let bVal = getAssemblyValue(b, column);
                
                let comparison = 0;
                if (aVal < bVal) comparison = -1;
                if (aVal > bVal) comparison = 1;
                
                return assemblySortDirection === 'desc' ? -comparison : comparison;
            });
            
            renderAssemblies();
        }
        
        // Sort systems table
        function sortSystems(column) {
            if (systemSortColumn === column) {
                systemSortDirection = systemSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                systemSortColumn = column;
                systemSortDirection = 'asc';
            }
            
            // Update header styling
            document.querySelectorAll('#systems-table .sortable').forEach(th => {
                th.className = 'sortable';
            });
            document.querySelector(`#systems-table .sortable:nth-child(${getSystemColumnIndex(column)})`).className = 
                `sortable sort-${systemSortDirection}`;
            
            // Sort the data
            data.systems.sort((a, b) => {
                let aVal = getSystemValue(a, column);
                let bVal = getSystemValue(b, column);
                
                let comparison = 0;
                if (aVal < bVal) comparison = -1;
                if (aVal > bVal) comparison = 1;
                
                return systemSortDirection === 'desc' ? -comparison : comparison;
            });
            
            renderSystems();
        }
        
        // Helper functions for sorting
        function getComponentValue(component, column) {
            switch(column) {
                case 'kpn': return component.kpn || '';
                case 'category': return component.category || '';
                case 'subcategory': return component.subcategory || '';
                case 'value': return component.value || component.manufacturerPn || '';
                case 'package': return component.package || '';
                case 'manufacturer': return component.manufacturer || '';
                case 'preferredVendor': return component.preferredVendor || '';
                default: return '';
            }
        }
        
        function getAssemblyValue(assembly, column) {
            switch(column) {
                case 'name': return assembly.name || '';
                case 'version': return assembly.version || '';
                case 'description': return assembly.description || '';
                case 'itemCount': return assembly.bom ? assembly.bom.length : 0;
                case 'status': return assembly.status || '';
                default: return '';
            }
        }
        
        function getSystemValue(system, column) {
            switch(column) {
                case 'name': return system.name || '';
                case 'version': return system.version || '';
                case 'description': return system.description || '';
                case 'itemCount': return system.items ? system.items.length : (system.pcbs ? system.pcbs.length : 0);
                case 'status': return system.status || '';
                default: return '';
            }
        }
        
        function getComponentColumnIndex(column) {
            const columns = ['', 'kpn', 'category', 'subcategory', 'value', 'package', 'manufacturer', 'preferredVendor'];
            return columns.indexOf(column) + 1;
        }
        
        function getAssemblyColumnIndex(column) {
            const columns = ['name', 'version', 'description', 'itemCount', 'status'];
            return columns.indexOf(column) + 1;
        }
        
        function getSystemColumnIndex(column) {
            const columns = ['name', 'version', 'description', 'itemCount', 'status'];
            return columns.indexOf(column) + 1;
        }

        function renderComponents() {
            const tbody = document.getElementById('components-tbody');
            tbody.innerHTML = '';
            
            data.components.forEach(comp => {
                const row = document.createElement('tr');
                
                // Add archived styling if component is archived
                if (comp.status === 'Archived') {
                    row.className = 'archived-row';
                }
                
                // Get category config for this component
                const config = categoryConfigs[comp.category];
                
                // Determine value/PN field
                let valuePn = comp.value || comp.manufacturer_pn || comp.manufacturer_PN || '';
                
                // Determine package
                let packageValue = comp.package || '';
                
                // Build specs string
                let specs = [];
                if (comp.tolerance) specs.push(`±${comp.tolerance}`);
                if (comp.voltage) specs.push(`${comp.voltage}`);
                if (comp.rating) specs.push(`${comp.rating}`);
                if (comp.temp_rating) specs.push(`${comp.temp_rating}`);
                if (comp.current_rating) specs.push(`${comp.current_rating}`);
                if (comp.voltage_rating) specs.push(`${comp.voltage_rating}`);
                if (comp.actuation_force) specs.push(`${comp.actuation_force}`);
                if (comp.pitch) specs.push(`${comp.pitch}`);
                if (comp.pins) specs.push(`${comp.pins}P`);
                
                // Get vendor
                let vendor = comp.preferred_vendor || '';
                
                // Build action buttons based on user role and component status
                let actionButtons = '';
                if (comp.status !== 'Archived') {
                    actionButtons += `<button class="btn" onclick="editComponent('${comp.kpn}')" style="background: #ff9800; color: white; padding: 4px 8px; font-size: 12px; margin-right: 5px;">Edit</button>`;
                    
                    if (currentUser.role === 'team') {
                        actionButtons += `<button class="archive-btn" onclick="archiveComponent('${comp.kpn}')">Archive</button>`;
                    } else if (currentUser.role === 'admin') {
                        actionButtons += `<button class="archive-btn" onclick="archiveComponent('${comp.kpn}')">Archive</button>`;
                        actionButtons += `<button class="delete-btn" onclick="deleteComponent('${comp.kpn}')">Delete</button>`;
                    }
                } else {
                    // Show status for archived components
                    actionButtons = '<span class="status-archived">Archived</span>';
                    if (currentUser.role === 'admin') {
                        actionButtons += ` <button class="delete-btn" onclick="deleteComponent('${comp.kpn}')">Delete</button>`;
                    }
                }
                
                // Build checkbox column if in bulk selection mode
                let checkboxColumn = '';
                if (bulkSelectionMode) {
                    checkboxColumn = `<td><input type="checkbox" class="component-checkbox" value="${comp.kpn}"></td>`;
                }
                
                row.innerHTML = `
                    ${checkboxColumn}
                    <td><strong>${comp.kpn}</strong></td>
                    <td>${comp.category.charAt(0).toUpperCase() + comp.category.slice(1)}</td>
                    <td>${comp.subcategory}</td>
                    <td>${valuePn}</td>
                    <td>${packageValue}</td>
                    <td>${specs.join(', ')}</td>
                    <td>${vendor}</td>
                    <td>
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAssemblies() {
            const tbody = document.getElementById('assemblies-tbody');
            tbody.innerHTML = '';
            
            data.assemblies.forEach(assembly => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${assembly.name}</td>
                    <td>${assembly.version}</td>
                    <td>${assembly.description}</td>
                    <td>${assembly.bom.length} items</td>
                    <td><span class="status-${assembly.status.toLowerCase()}">${assembly.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSystems() {
            const tbody = document.getElementById('systems-tbody');
            tbody.innerHTML = '';
            
            data.systems.forEach(system => {
                const row = document.createElement('tr');
                // Handle backward compatibility - migrate pcbs to items if needed
                const itemCount = system.items ? system.items.length : (system.pcbs ? system.pcbs.length : 0);
                row.innerHTML = `
                    <td>${system.name}</td>
                    <td>${system.version}</td>
                    <td>${system.description}</td>
                    <td>${itemCount} items</td>
                    <td><span class="status-${system.status.toLowerCase()}">${system.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAll() {
            renderComponents();
            renderAssemblies();
            renderSystems();
            renderVendors();
            updateDropdowns();
        }

        // Filter functions
        function filterComponents() {
            const search = document.getElementById('comp-search').value.toLowerCase();
            const rows = document.querySelectorAll('#components-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterAssemblies() {
            const search = document.getElementById('assembly-search').value.toLowerCase();
            const rows = document.querySelectorAll('#assemblies-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterSystems() {
            const search = document.getElementById('system-search').value.toLowerCase();
            const rows = document.querySelectorAll('#systems-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Update statistics
        function updateStats() {
            document.getElementById('total-components').textContent = data.components.length;
            document.getElementById('total-assemblies').textContent = data.assemblies.length;
            document.getElementById('total-systems').textContent = data.systems.length;
            
            document.getElementById('export-components').textContent = data.components.length;
            document.getElementById('export-assemblies').textContent = data.assemblies.length;
            document.getElementById('export-systems').textContent = data.systems.length;
        }

        // Export functions
        function exportComponents() {
            if (data.components.length === 0) {
                alert('No components to export');
                return;
            }
            
            // Get all possible field names
            const allFields = new Set(['KPN', 'Category', 'Subcategory', 'Date Added']);
            Object.values(categoryConfigs).forEach(config => {
                config.fields.forEach(field => {
                    allFields.add(field.label);
                });
            });
            
            const headers = Array.from(allFields);
            let csv = headers.join(',') + '\n';
            
            csv += data.components.map(c => {
                return headers.map(header => {
                    let value = '';
                    switch(header) {
                        case 'KPN': value = c.kpn; break;
                        case 'Category': value = c.category; break;
                        case 'Subcategory': value = c.subcategory; break;
                        case 'Date Added': value = c.dateAdded; break;
                        case 'Value': value = c.value || ''; break;
                        case 'Package': value = c.package || ''; break;
                        case 'Tolerance': value = c.tolerance || ''; break;
                        case 'Temp Rating': value = c.temp_rating || ''; break;
                        case 'Preferred Vendor': value = c.preferred_vendor || ''; break;
                        case 'Voltage': value = c.voltage || ''; break;
                        case 'Rating': value = c.rating || ''; break;
                        case 'Manufacturer PN': value = c.manufacturer_pn || ''; break;
                        case 'Description': value = c.description || ''; break;
                        case 'Datasheet/Product Link': value = c.datasheet_link || ''; break;
                        case 'Current Rating': value = c.current_rating || ''; break;
                        case 'Voltage Rating': value = c.voltage_rating || ''; break;
                        case 'Pitch': value = c.pitch || ''; break;
                        case 'Pins': value = c.pins || ''; break;
                        case 'Actuation Force': value = c.actuation_force || ''; break;
                        case 'Dimensions': value = c.dimensions || ''; break;
                        case 'Layers': value = c.layers || ''; break;
                        case 'Thickness': value = c.thickness || ''; break;
                        case 'Material': value = c.material || ''; break;
                        case 'Finish': value = c.finish || ''; break;
                        case 'Color': value = c.color || ''; break;
                        case 'CAD File Link': value = c.file_link || ''; break;
                        case 'Length': value = c.length || ''; break;
                        case 'Connectors': value = c.connectors || ''; break;
                        case 'Wire Gauge': value = c.wire_gauge || ''; break;
                        case 'Manufacturer': value = c.manufacturer || ''; break;
                        default: value = '';
                    }
                    return `"${value}"`;
                }).join(',');
            }).join('\n');
            
            downloadCSV(csv, 'kinben-components.csv');
        }

        function exportAssemblies() {
            if (data.assemblies.length === 0) {
                alert('No assemblies to export');
                return;
            }
            
            const csv = 'Assembly Name,Version,Status,Description,Assembly Items,Date Added\n' +
                data.assemblies.map(a => 
                    `"${a.name}",${a.version},${a.status},"${a.description}",${a.bom.length},${a.dateAdded}`
                ).join('\n');
            
            downloadCSV(csv, 'kinben-assemblies.csv');
        }

        function exportSystems() {
            if (data.systems.length === 0) {
                alert('No systems to export');
                return;
            }
            
            const csv = 'System Name,Version,Status,Description,Item Count,Date Added\n' +
                data.systems.map(s => {
                    const itemCount = s.items ? s.items.length : (s.pcbs ? s.pcbs.length : 0);
                    return `"${s.name}",${s.version},${s.status},"${s.description}",${itemCount},${s.dateAdded}`;
                }).join('\n');
            
            downloadCSV(csv, 'kinben-systems.csv');
        }

        function exportAll() {
            exportComponents();
            exportAssemblies();
            exportSystems();
        }

        // Vendor management functions
        function addVendor() {
            const vendorName = document.getElementById('new-vendor-name').value.trim();
            if (!vendorName) {
                alert('Please enter a vendor name');
                return;
            }
            
            if (data.vendors.includes(vendorName)) {
                alert('Vendor already exists');
                return;
            }
            
            data.vendors.push(vendorName);
            data.vendors.sort(); // Keep vendors sorted
            saveData();
            renderVendors();
            
            // Clear input
            document.getElementById('new-vendor-name').value = '';
            
            alert(`Added vendor: ${vendorName}`);
        }
        
        function removeVendor(vendorName) {
            if (confirm(`Remove vendor "${vendorName}"?`)) {
                data.vendors = data.vendors.filter(v => v !== vendorName);
                saveData();
                renderVendors();
            }
        }
        
        function renderVendors() {
            const container = document.getElementById('vendors-container');
            if (!container) return;
            
            container.innerHTML = '';
            data.vendors.forEach(vendor => {
                const vendorTag = document.createElement('div');
                vendorTag.style.cssText = 'background: #e3f2fd; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px;';
                vendorTag.innerHTML = `
                    <span>${vendor}</span>
                    <button onclick="removeVendor('${vendor}')" style="background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">×</button>
                `;
                container.appendChild(vendorTag);
            });
        }
        
        // Component editing functionality
        function editComponent(kpn) {
            const component = data.components.find(c => c.kpn === kpn);
            if (!component) {
                alert('Component not found');
                return;
            }
            
            // Switch to components tab
            showTab('components');
            
            // Set category and subcategory
            document.getElementById('comp-category').value = component.category;
            updateComponentSubcategories();
            document.getElementById('comp-subcategory').value = component.subcategory;
            updateComponentFields();
            generateComponentKPN();
            
            // Fill in the dynamic fields
            const config = categoryConfigs[component.category];
            if (config) {
                config.fields.forEach(field => {
                    const fieldElement = document.getElementById(`comp-${field.id}`);
                    if (fieldElement) {
                        const value = component[field.id.replace('-', '_')] || '';
                        if (field.type === 'vendor-select') {
                            fieldElement.value = value;
                        } else {
                            fieldElement.value = value;
                        }
                    }
                });
            }
            
            // Change the add button to update mode
            const addButton = document.querySelector('button[onclick="addComponent()"]');
            addButton.textContent = 'Update Component';
            addButton.setAttribute('onclick', `updateComponent('${kpn}')`);
            
            // Show cancel edit button
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            
            // Scroll to form
            document.getElementById('components').scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateComponent(originalKPN) {
            const category = document.getElementById('comp-category').value;
            const subcategory = document.getElementById('comp-subcategory').value;
            
            if (!category || !subcategory) {
                alert('Please select category and subcategory first');
                return;
            }
            
            // Find component index
            const componentIndex = data.components.findIndex(c => c.kpn === originalKPN);
            if (componentIndex === -1) {
                alert('Component not found');
                return;
            }
            
            const kpn = document.getElementById('comp-kpn').value || document.getElementById('comp-kpn-preview').textContent;
            
            // Collect data from dynamic fields
            const component = {
                kpn,
                category,
                subcategory,
                status: data.components[componentIndex].status || 'Active', // Keep original status
                dateAdded: data.components[componentIndex].dateAdded, // Keep original date
                archivedDate: data.components[componentIndex].archivedDate, // Keep archived date if exists
                archivedBy: data.components[componentIndex].archivedBy // Keep archived by if exists
            };
            
            // Validate required fields and collect data
            const config = categoryConfigs[category];
            let missingRequired = [];
            
            config.fields.forEach(field => {
                const fieldElement = document.getElementById(`comp-${field.id}`);
                if (fieldElement) {
                    const value = fieldElement.value.trim();
                    if (field.required && !value) {
                        missingRequired.push(field.label);
                    }
                    component[field.id.replace('-', '_')] = value;
                }
            });
            
            if (missingRequired.length > 0) {
                alert(`Please fill in all required fields: ${missingRequired.join(', ')}`);
                return;
            }
            
            // Update component
            data.components[componentIndex] = component;
            saveData();
            renderComponents();
            
            // Reset form
            resetComponentForm();
            
            alert('Component updated successfully!');
        }
        
        function resetComponentForm() {
            document.getElementById('comp-category').value = '';
            document.getElementById('comp-subcategory').value = '';
            document.getElementById('comp-kpn-preview').textContent = 'Select category and subcategory';
            
            // Clear dynamic fields
            const dynamicFieldsContainer = document.getElementById('component-dynamic-fields');
            dynamicFieldsContainer.innerHTML = `
                <p style="color: #666; text-align: center; margin: 40px 0;">
                    Select a category and subcategory to display component-specific fields
                </p>
            `;
            
            // Reset button
            const addButton = document.querySelector('button[onclick^="updateComponent"], button[onclick="addComponent()"]');
            addButton.textContent = 'Add Component';
            addButton.setAttribute('onclick', 'addComponent()');
            
            // Hide cancel edit button
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        // Archive component (Team and Admin can do this)
        // Global variable to track bulk selection mode
        let bulkSelectionMode = false;

        // Toggle bulk selection mode
        function toggleBulkSelection() {
            bulkSelectionMode = !bulkSelectionMode;
            const bulkBtn = document.getElementById('bulk-select-btn');
            const bulkActions = document.getElementById('bulk-actions');
            const bulkHeader = document.getElementById('bulk-select-header');
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            
            if (bulkSelectionMode) {
                bulkBtn.textContent = 'Exit Bulk Select';
                bulkBtn.style.background = '#dc3545';
                bulkActions.style.display = 'block';
                bulkHeader.style.display = '';
                
                // Show delete button only for admin users
                if (currentUser.role === 'admin') {
                    bulkDeleteBtn.style.display = '';
                }
                
                renderComponents(); // Re-render to show checkboxes
            } else {
                bulkBtn.textContent = 'Enable Bulk Select';
                bulkBtn.style.background = '#6c757d';
                bulkActions.style.display = 'none';
                bulkHeader.style.display = 'none';
                bulkDeleteBtn.style.display = 'none';
                
                // Clear all selections
                document.getElementById('select-all-checkbox').checked = false;
                renderComponents(); // Re-render to hide checkboxes
            }
        }

        // Toggle all checkboxes
        function toggleAllCheckboxes(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.component-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = masterCheckbox.checked;
            });
        }

        // Select all components
        function selectAllComponents() {
            const masterCheckbox = document.getElementById('select-all-checkbox');
            masterCheckbox.checked = true;
            toggleAllCheckboxes(masterCheckbox);
        }

        // Deselect all components
        function deselectAllComponents() {
            const masterCheckbox = document.getElementById('select-all-checkbox');
            masterCheckbox.checked = false;
            toggleAllCheckboxes(masterCheckbox);
        }

        // Get selected component KPNs
        function getSelectedComponentKPNs() {
            const selectedKPNs = [];
            const checkboxes = document.querySelectorAll('.component-checkbox:checked');
            checkboxes.forEach(checkbox => {
                selectedKPNs.push(checkbox.value);
            });
            return selectedKPNs;
        }

        // Bulk archive components
        function bulkArchiveComponents() {
            const selectedKPNs = getSelectedComponentKPNs();
            
            if (selectedKPNs.length === 0) {
                alert('Please select components to archive.');
                return;
            }
            
            if (confirm(`Are you sure you want to archive ${selectedKPNs.length} selected components? Archived components cannot be used in new BOMs.`)) {
                let archivedCount = 0;
                
                selectedKPNs.forEach(kpn => {
                    const componentIndex = data.components.findIndex(c => c.kpn === kpn);
                    if (componentIndex !== -1 && data.components[componentIndex].status !== 'Archived') {
                        data.components[componentIndex].status = 'Archived';
                        data.components[componentIndex].archivedDate = new Date().toISOString().split('T')[0];
                        data.components[componentIndex].archivedBy = currentUser.username;
                        archivedCount++;
                    }
                });
                
                if (archivedCount > 0) {
                    saveData();
                    renderComponents();
                    updateDropdowns();
                    alert(`Successfully archived ${archivedCount} components.`);
                    
                    // Clear selections
                    deselectAllComponents();
                } else {
                    alert('No components were archived (they may already be archived).');
                }
            }
        }

        // Bulk delete components (Admin only)
        function bulkDeleteComponents() {
            if (currentUser.role !== 'admin') {
                alert('Only Admin users can delete components.');
                return;
            }
            
            const selectedKPNs = getSelectedComponentKPNs();
            
            if (selectedKPNs.length === 0) {
                alert('Please select components to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to PERMANENTLY DELETE ${selectedKPNs.length} selected components? This will allow their KPNs to be reused for new components.`)) {
                let deletedCount = 0;
                
                // Delete in reverse order to avoid index issues
                for (let i = data.components.length - 1; i >= 0; i--) {
                    if (selectedKPNs.includes(data.components[i].kpn)) {
                        data.components.splice(i, 1);
                        deletedCount++;
                    }
                }
                
                if (deletedCount > 0) {
                    saveData();
                    renderComponents();
                    updateDropdowns();
                    alert(`Successfully deleted ${deletedCount} components. Their KPNs can now be reused.`);
                    
                    // Clear selections
                    deselectAllComponents();
                } else {
                    alert('No components were deleted.');
                }
            }
        }

        function archiveComponent(kpn) {
            if (confirm(`Are you sure you want to archive component ${kpn}? Archived components cannot be used in new BOMs.`)) {
                const componentIndex = data.components.findIndex(c => c.kpn === kpn);
                if (componentIndex !== -1) {
                    data.components[componentIndex].status = 'Archived';
                    data.components[componentIndex].archivedDate = new Date().toISOString().split('T')[0];
                    data.components[componentIndex].archivedBy = currentUser.username;
                    saveData();
                    renderComponents();
                    updateDropdowns(); // Refresh dropdowns to exclude archived components
                    alert(`Component ${kpn} has been archived.`);
                }
            }
        }

        // Delete component (Admin only - allows KPN reuse)
        function deleteComponent(kpn) {
            if (currentUser.role !== 'admin') {
                alert('Only Admin users can delete components.');
                return;
            }
            
            if (confirm(`Are you sure you want to PERMANENTLY DELETE component ${kpn}? This will allow the KPN to be reused for new components.`)) {
                const componentIndex = data.components.findIndex(c => c.kpn === kpn);
                if (componentIndex !== -1) {
                    // Remove from components array completely
                    data.components.splice(componentIndex, 1);
                    saveData();
                    renderComponents();
                    updateDropdowns();
                    alert(`Component ${kpn} has been permanently deleted. The KPN can now be reused.`);
                }
            }
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize CSV system first
            initializeCSVSystem();
            
            // Load data - will use localStorage as fallback if CSV not available
            loadData();
        });
    </script>
</body>
</html>