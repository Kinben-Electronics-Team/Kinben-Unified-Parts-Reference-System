<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kinben KPN System - Simplified</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Production Edition - Direct CSV file integration with localStorage fallback -->
    
    <style>
        body { 
            font-family: Calibri, Arial, sans-serif; 
            margin: 0; 
            background: #f5f5f5;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            color: #666;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e3f2fd;
        }
        
        .tab.active {
            background: #0078d4;
            color: white;
        }
        
        .content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        

        /* Value with unit input styles - consistent sizing */
        .value-unit-container {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .value-unit-container input {
            flex: 2;
            min-width: 0;
        }

        .value-unit-container select {
            flex: 1;
            min-width: 80px;
            max-width: 120px;
        }

        /* Required field indicator */
        .required-field {
            color: #dc3545;
            margin-left: 2px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #0078d4;
            color: white;
        }
        
        .btn-primary:hover {
            background: #106ebe;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .table th {
            background: #0078d4;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .table tr:hover {
            background: #e3f2fd;
        }
        
        /* Sortable table headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px !important;
        }
        
        .sortable:hover {
            background: #106ebe !important;
        }
        
        .sortable::after {
            content: '‚ÜïÔ∏è';
            position: absolute;
            right: 8px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        .sortable.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
            font-weight: bold;
        }
        
        .sortable.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
            font-weight: bold;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #0078d4;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .kpn-preview {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            color: #0078d4;
            text-align: center;
            margin: 10px 0;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .actions .btn {
            flex-shrink: 0;
        }
        
        #bulk-actions {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
        }
        
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }
        
        .bom-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .expand-btn {
            background: none;
            border: none;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 6px;
            margin-right: 8px;
            color: #0066cc;
            border-radius: 3px;
        }
        
        .expand-btn:hover {
            background: #f0f8ff;
        }
        
        .bom-detail-row {
            background: #f8f9fa !important;
        }
        
        .bom-detail-container {
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin: 5px 0;
        }
        
        .bom-detail-container h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .bom-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .bom-item-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
        }
        
        .bom-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .quantity-badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .bom-item-details {
            font-size: 13px;
            color: #6c757d;
        }
        
        .bom-item-details div {
            margin-bottom: 4px;
        }
        
        .bom-item-details .notes {
            font-style: italic;
            color: #868e96;
        }
        
        .mother-component-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }
        
        .mother-component-info {
            flex: 1;
        }
        
        .mother-component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .mother-component-details {
            font-size: 13px;
            color: #6c757d;
        }
        
        .component-type {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .component-type-badge {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .mother-component-card {
            border-left: 4px solid #28a745;
        }
        
        .mother-quantity-badge {
            background: #28a745;
        }
        
        .mother-components-section, .bom-components-section {
            margin-bottom: 20px;
        }
        
        .mother-components-section h5, .bom-components-section h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .quantity-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 4px;
        }
        
        .stat-label {
            display: block;
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .system-assemblies-grid, .consolidated-components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .system-assembly-card, .consolidated-component-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
        }
        
        .assembly-card-header, .component-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .system-quantity-badge {
            background: #17a2b8;
        }
        
        .consolidated-quantity-badge {
            background: #6f42c1;
        }
        
        .assembly-card-details, .component-card-details {
            font-size: 13px;
            color: #6c757d;
        }
        
        .assembly-breakdown {
            margin-bottom: 8px;
        }
        
        .breakdown-item {
            display: block;
            margin-bottom: 4px;
        }
        
        .breakdown-icon {
            margin-right: 6px;
        }
        
        .total-calculation {
            font-weight: 600;
            color: #495057;
            border-top: 1px solid #e9ecef;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .component-kpn {
            font-weight: 500;
            margin-bottom: 8px;
            color: #495857;
        }
        
        .component-breakdown {
            margin-top: 8px;
        }
        
        .assembly-contribution {
            display: block;
            font-size: 12px;
            margin-bottom: 3px;
            padding: 2px 6px;
            background: #f8f9fa;
            border-radius: 3px;
            margin-bottom: 4px;
        }
        
        .system-assemblies-section, .consolidated-components-section {
            margin-bottom: 20px;
        }
        
        .system-assemblies-section h5, .consolidated-components-section h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* System Item Preview Styles */
        .system-item-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .system-item-preview h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .quantity-info {
            font-size: 12px;
            color: #6c757d;
            font-weight: normal;
        }
        
        .item-preview-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .item-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .item-preview-name {
            font-weight: 600;
            color: #495057;
        }
        
        .item-preview-quantity {
            background: #17a2b8;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .item-preview-details {
            font-size: 13px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .item-preview-calculation {
            background: #e9f7ef;
            border-left: 3px solid #28a745;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 13px;
        }
        
        /* System Items Grid and Cards */
        .system-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .system-item-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s ease;
        }
        
        .system-item-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .system-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .system-item-icon {
            font-size: 18px;
        }
        
        .system-item-name {
            flex: 1;
            font-weight: 600;
            color: #495057;
        }
        
        .system-item-quantity {
            background: #17a2b8;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .system-item-details {
            font-size: 13px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .system-item-type {
            font-weight: 500;
            color: #495057;
            margin-bottom: 4px;
        }
        
        .system-item-version {
            margin-bottom: 6px;
        }
        
        .item-calculation {
            background: #f8f9fa;
            border-left: 3px solid #17a2b8;
            padding: 6px 10px;
            border-radius: 0 4px 4px 0;
        }
        
        /* System Build Summary */
        .system-build-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .system-build-summary h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
        }
        
        .system-summary-stats {
            display: flex;
            gap: 20px;
            justify-content: space-around;
        }
        
        .summary-stat {
            text-align: center;
            flex: 1;
        }
        
        .summary-stat .stat-value {
            display: block;
            font-size: 24px;
            font-weight: 700;
            line-height: 1;
        }
        
        .summary-stat .stat-label {
            display: block;
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        .total-stat {
            border-left: 2px solid rgba(255,255,255,0.3);
            padding-left: 20px;
        }
        
        .total-stat .stat-value {
            font-size: 28px;
            color: #fff;
        }
        
        @media (max-width: 768px) {
            .system-items-grid {
                grid-template-columns: 1fr;
            }
            
            .system-summary-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .total-stat {
                border-left: none;
                border-top: 2px solid rgba(255,255,255,0.3);
                padding-left: 0;
                padding-top: 10px;
            }
        }
        
        /* Bulk Operations Panel */
        .bulk-operations-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bulk-ops-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bulk-ops-actions {
            display: flex;
            gap: 8px;
        }
        
        .bulk-ops-actions .btn {
            padding: 4px 12px;
            font-size: 13px;
        }
        
        .bulk-ops-actions .btn-sm {
            background: #6c757d;
            color: white;
            border: none;
        }
        
        .bulk-ops-actions .btn-sm:hover {
            background: #5a6268;
        }
        
        .bulk-ops-actions .btn-danger {
            background: #dc3545 !important;
        }
        
        .bulk-ops-actions .btn-danger:hover {
            background: #c82333 !important;
        }
        
        .bulk-ops-actions .btn-secondary {
            background: #6c757d !important;
        }
        
        .bulk-ops-actions .btn-secondary:hover {
            background: #5a6268 !important;
        }
        
        /* System table action buttons */
        .btn-edit, .btn-delete {
            background: none;
            border: none;
            font-size: 16px;
            padding: 4px 6px;
            margin: 0 2px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .btn-edit:hover {
            background-color: #ffc107;
        }
        
        .btn-delete:hover {
            background-color: #dc3545;
        }
        
        /* Cross-System Analysis Styles */
        .cross-system-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
            padding: 10px 12px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
            color: #155724;
        }
        
        .cross-system-analysis {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .cross-system-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: #856404;
        }
        
        .systems-count {
            background: #ffc107;
            color: #212529;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .cross-system-usage {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .system-usage-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .system-name {
            font-weight: 500;
            color: #495057;
        }
        
        .system-quantity {
            background: #6c757d;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
        }
        
        .impact-summary {
            border-top: 1px solid #ffeaa7;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .impact-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            font-size: 12px;
        }
        
        .impact-row.total-impact {
            border-top: 1px solid #ffeaa7;
            padding-top: 6px;
            margin-top: 6px;
            font-weight: 600;
            color: #856404;
        }
        
        .impact-row strong {
            color: #495057;
        }
        
        .total-impact strong {
            color: #856404;
        }
        
        /* Quantity Dashboard Styles */
        .dashboard-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .usage-section {
            margin-bottom: 30px;
        }
        
        .usage-section h4 {
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .usage-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .usage-item.has-variance {
            border-left: 4px solid #ffc107;
            background: #fffbf0;
        }
        
        .usage-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .usage-header strong {
            color: #495057;
            font-size: 14px;
        }
        
        .total-usage {
            background: #17a2b8;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .component-impact {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .component-type {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .system-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .system-use {
            background: white;
            border: 1px solid #dee2e6;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        }
        
        .variance-warning {
            color: #856404;
            font-size: 12px;
            font-style: italic;
            margin-top: 8px;
            padding: 4px 8px;
            background: #fff3cd;
            border-radius: 4px;
        }
        
        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px 20px;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .login-container h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 24px;
        }
        
        .login-container p {
            margin: 0 0 30px 0;
            color: #666;
            font-size: 14px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-form input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #0078d4;
        }
        
        .login-form button {
            padding: 12px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-form button:hover {
            background: #106ebe;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        /* Archived component styles */
        .status-archived {
            color: #6c757d;
            font-weight: bold;
        }
        
        .archived-row {
            opacity: 0.5;
            background-color: #f8f9fa !important;
        }
        
        .archived-row td {
            color: #6c757d !important;
        }
        
        /* Role-based action buttons */
        .archive-btn {
            background: #ffc107 !important;
            color: #212529 !important;
        }
        
        .archive-btn:hover {
            background: #e0a800 !important;
        }
        
        .delete-btn {
            background: #dc3545 !important;
            color: white !important;
        }
        
        .delete-btn:hover {
            background: #c82333 !important;
        }

        /* Duplicate Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .modal-header h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 20px;
        }

        .modal-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .modal-body {
            padding: 20px 30px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .duplicate-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .duplicate-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .duplicate-item-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .duplicate-item-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .duplicate-item-existing {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .duplicate-item-existing strong {
            color: #0078d4;
        }

        .duplicate-choices {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .duplicate-choices input[type="radio"] {
            margin-right: 5px;
        }

        .duplicate-choices label {
            cursor: pointer;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .duplicate-choices label:hover {
            background: #e9ecef;
        }

        .duplicate-choices input[type="radio"]:checked + label {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }
        
        /* Assembly Management Styles */
        .assembly-management-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .assembly-management-section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .assembly-mgmt-tools {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .assembly-mgmt-tools .btn {
            font-size: 14px;
            padding: 8px 16px;
        }
        
        /* Assembly Health Dashboard */
        .assembly-health-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
        }
        
        .assembly-health-item.warning {
            border-left: 4px solid #ffc107;
            background: #fffbf0;
        }
        
        .assembly-health-item.error {
            border-left: 4px solid #dc3545;
            background: #ffeaea;
        }
        
        .assembly-health-item.success {
            border-left: 4px solid #28a745;
            background: #eafaf1;
        }
        
        .assembly-status-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .assembly-status-indicator.active {
            background: #d4edda;
            color: #155724;
        }
        
        .assembly-status-indicator.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .assembly-replacement-form {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .replacement-preview {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .usage-analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .analytics-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .analytics-card h5 {
            margin-top: 0;
            color: #495057;
        }
        
        .validation-results {
            margin-top: 15px;
        }
        
        .validation-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
        }
        
        .validation-item.valid {
            background: #d4edda;
            color: #155724;
        }
        
        .validation-item.invalid {
            background: #f8d7da;
            color: #721c24;
        }
        
        .validation-item.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        /* System BOM Rollup Styles */
        .system-bom-section {
            margin-top: 30px;
            padding: 20px;
            background: #e8f4fd;
            border-radius: 8px;
            border: 1px solid #b8daef;
        }
        
        .system-bom-section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .system-bom-tools {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .system-bom-tools .btn {
            font-size: 14px;
            padding: 8px 16px;
        }
        
        /* BOM Preview Modal */
        .bom-preview-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .bom-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .bom-stat-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        
        .bom-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0078d4;
        }
        
        .bom-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .bom-component-list {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .bom-component-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }
        
        .bom-component-item {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr 1fr;
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f4;
            align-items: center;
        }
        
        .bom-component-item:last-child {
            border-bottom: none;
        }
        
        .bom-component-item:hover {
            background: #f8f9fa;
        }
        
        .bom-component-kpn {
            font-weight: bold;
            color: #0078d4;
        }
        
        .bom-component-description {
            color: #495057;
        }
        
        .bom-component-quantity {
            font-weight: bold;
            color: #28a745;
        }
        
        .bom-component-source {
            font-size: 12px;
            color: #666;
        }
        
        .bom-component-vendor {
            font-size: 12px;
            color: #6c757d;
        }
        
        .bom-analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .purchase-bom-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .vendor-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .vendor-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
        
        .vendor-card h5 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="login-modal" class="login-modal">
        <div class="login-container">
            <h2>üîê Login to KPN System</h2>
            <p id="login-description">Enter your credentials to access the system</p>
            <div class="login-form">
                <!-- Local Authentication Form -->
                <div id="local-auth-form">
                    <input type="text" id="username" placeholder="Username" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                    <input type="password" id="password" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                    <button onclick="signInLocal()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 10px;">
                        üîë Sign In
                    </button>
                </div>
                
                <div id="login-status" style="text-align: center; color: #666; font-size: 14px;"></div>
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
                <strong>Note:</strong><br>
                <span id="auth-note">Contact your administrator for login credentials.</span>
            </div>
        </div>
    </div>
    
    <!-- User Info Display -->
    <div id="user-info" class="user-info" style="display: none;">
        <span id="current-user"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üîß Kinben Parts Reference System - Local CSV Edition</h1>
            <p>Direct CSV File Integration - Offline Capable ERP System</p>
            
            <!-- CSV Directory Access Controls -->
            <div id="csv-controls" style="margin-top: 20px;">
                <button id="csv-access-btn" class="btn btn-primary" onclick="setupCSVAccess()" style="margin-right: 10px;">
                    üìÅ Select CSV Files Directory
                </button>
                <button id="csv-change-btn" class="btn btn-info" onclick="changeCSVDirectory()" style="margin-right: 10px; display: none;">
                    üîÑ Change Directory
                </button>
                <span id="csv-status" style="color: #666; font-size: 14px;">
                    Not connected to CSV files - Using localStorage
                </span>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-components">0</div>
                <div class="stat-label">Components</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-assemblies">0</div>
                <div class="stat-label">Assemblies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-systems">0</div>
                <div class="stat-label">Systems</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('components')">üìã Components</button>
            <button class="tab" onclick="showTab('assemblies')">üîß Assemblies</button>
            <button class="tab" onclick="showTab('systems')">üèóÔ∏è Systems</button>
            <button class="tab" onclick="showTab('export')">üìä Export</button>
            <button class="tab" onclick="showTab('config')">‚öôÔ∏è Config</button>
        </div>
        
        <div class="content" id="simplified-structure">
            <!-- Components Tab -->
            <div id="components" class="tab-panel active">
                <h2>KPN Components</h2>
                <p>Basic electronic parts catalog with auto-generated KPNs</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="comp-category" onchange="updateComponentSubcategories()">
                            <option value="">Select Category</option>
                            <option value="capacitors">Capacitors</option>
                            <option value="resistors">Resistors</option>
                            <option value="inductors">Inductors</option>
                            <option value="diodes">Diodes</option>
                            <option value="transistors">Transistors</option>
                            <option value="ics">Integrated Circuits</option>
                            <option value="connectors">Connectors</option>
                            <option value="switches">Switches</option>
                            <option value="pcb">PCBs</option>
                            <option value="mechanical">Mechanical Parts</option>
                            <option value="printed3d">3D-Printed Parts</option>
                            <option value="cable">Cable Assemblies</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subcategory</label>
                        <select id="comp-subcategory" onchange="generateComponentKPN()">
                            <option value="">Select Subcategory</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>KPN (Auto-generated)</label>
                        <div class="kpn-preview" id="comp-kpn-preview">Select category and subcategory</div>
                    </div>
                </div>
                
                <!-- Dynamic component fields based on category -->
                <div id="component-dynamic-fields">
                    <p style="color: #666; text-align: center; margin: 40px 0;">
                        Select a category and subcategory to display component-specific fields
                    </p>
                </div>
                
                <div class="actions">
                    <!-- Main Action Buttons -->
                    <button class="btn btn-primary" onclick="addComponent()">Add Component</button>
                    <button class="btn" onclick="resetComponentForm()" style="background: #6c757d; color: white; display: none;" id="cancel-edit-btn">Cancel Edit</button>
                    <button class="btn btn-success" onclick="exportComponents()">Export CSV</button>
                    <input type="file" id="csv-import-input" accept=".csv" style="display: none;" onchange="importCSV()">
                    <button class="btn btn-info" onclick="document.getElementById('csv-import-input').click()">Import CSV</button>
                    <button class="btn" onclick="exportTemplate()" style="background: #6c757d; color: white;">Download Template</button>
                    
                    <!-- Bulk Select Button -->
                    <button class="btn" onclick="toggleBulkSelection()" style="background: #6c757d; color: white;" id="bulk-select-btn">Enable Bulk Select</button>
                </div>
                
                <!-- Bulk Actions Container -->
                <div id="bulk-actions" class="actions" style="display: none;">
                    <button class="btn btn-info" onclick="selectAllComponents()">Select All</button>
                    <button class="btn" onclick="deselectAllComponents()" style="background: #6c757d; color: white;">Deselect All</button>
                    <button class="btn archive-btn" onclick="bulkArchiveComponents()">Archive Selected</button>
                    <button class="btn delete-btn" onclick="bulkDeleteComponents()" id="bulk-delete-btn" style="display: none;">Delete Selected</button>
                </div>
                
                <input type="text" class="search-box" id="comp-search" placeholder="Search components..." onkeyup="filterComponents()">
                
                <table class="table" id="components-table">
                    <thead>
                        <tr>
                            <th id="bulk-select-header" style="display: none;">
                                <input type="checkbox" id="select-all-checkbox" onchange="toggleAllCheckboxes(this)">
                            </th>
                            <th class="sortable" onclick="sortComponents('kpn')">KPN</th>
                            <th class="sortable" onclick="sortComponents('category')">Category</th>
                            <th class="sortable" onclick="sortComponents('subcategory')">Subcategory</th>
                            <th class="sortable" onclick="sortComponents('value')">Value/PN</th>
                            <th class="sortable" onclick="sortComponents('package')">Package</th>
                            <th class="sortable" onclick="sortComponents('manufacturer')">Specs</th>
                            <th class="sortable" onclick="sortComponents('preferredVendor')">Vendor</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="components-tbody">
                    </tbody>
                </table>
            </div>
            
            <!-- PCBs Tab -->
            <div id="assemblies" class="tab-panel">
                <h2>Assembly Management</h2>
                <p>Assembly definitions with multiple item types (PCBs, mechanical parts, 3D-printed parts, components)</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Assembly Name</label>
                        <input type="text" id="assembly-name" placeholder="e.g., Main Controller Assembly">
                    </div>
                    <div class="form-group">
                        <label for="assemblyType">Assembly Type <span class="text-danger">*</span></label>
                        <select id="assemblyType" class="form-control" required onchange="toggleAssemblyFields()">
                            <option value="pcb">PCB Assembly</option>
                            <option value="cable">Cable Assembly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Version</label>
                        <input type="text" id="assembly-version" placeholder="e.g., v1.0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="assembly-status">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="assembly-description" placeholder="Assembly description and purpose">
                </div>
                
                <!-- Cable Assembly specific fields -->
                <div id="cableFields" class="cable-assembly-fields" style="display: none;">
                    <div class="form-group">
                        <label for="cableLength">Cable Length (mm)</label>
                        <input type="number" id="cableLength" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="cableType">Cable Type</label>
                        <input type="text" id="cableType" class="form-control">
                    </div>
                </div>
                
                <h3>Assembly Items</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Item Type</label>
                        <select id="bom-type" onchange="updateBOMItemOptions()">
                            <option value="">Select Item Type</option>
                            <option value="component">Electronic Component</option>
                            <option value="pcb">PCB</option>
                            <option value="mechanical">Mechanical Part</option>
                            <option value="printed3d">3D-Printed Part</option>
                            <option value="cable">Cable Assembly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item KPN</label>
                        <select id="bom-kpn">
                            <option value="">Select Item Type First</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="bom-quantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>Reference Designator</label>
                        <input type="text" id="bom-refdes" placeholder="e.g., R1, C2, U3">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addBOMItem()">Add to Assembly</button>
                    </div>
                </div>
                
                <div id="bom-items"></div>
                
                <!-- BOM CSV Import Section -->
                <div class="csv-import-section" style="margin: 20px 0; padding: 20px; border: 2px dashed #007bff; border-radius: 8px; background-color: #f8f9fa;">
                    <h3>üìÅ BOM CSV Import</h3>
                    <p>Upload a Bill of Materials CSV file to bulk import assembly items with assigned KPNs</p>
                    <div class="form-group">
                        <label for="bom-csv-file">Select BOM CSV File:</label>
                        <input type="file" id="bom-csv-file" accept=".csv" onchange="handleBOMCSVUpload(event)" style="margin: 10px 0;">
                        <div style="margin: 10px 0;">
                            <button class="btn btn-secondary" onclick="downloadBOMTemplate()">üì• Download BOM Template</button>
                        </div>
                    </div>
                    <div id="bom-import-status" style="margin: 10px 0; font-weight: bold;"></div>
                    <div id="bom-preview-section" style="display: none; margin: 15px 0;">
                        <h4>üìã BOM Preview</h4>
                        <div id="bom-preview-content"></div>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-success" onclick="confirmBOMImport()">Import Items to Assembly</button>
                            <button class="btn btn-secondary" onclick="cancelBOMImport()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <h3>üèóÔ∏è Assembly-Level Components</h3>
                <p>Add enclosures, hardware, and other components needed at the assembly level</p>
                <div id="mother-items"></div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Component Type</label>
                        <select id="mother-type" onchange="updateMotherItemOptions()">
                            <option value="">Select Component Type</option>
                            <option value="enclosure">Enclosure/Housing</option>
                            <option value="hardware">Hardware (Screws, Standoffs)</option>
                            <option value="mounting">Mounting Components</option>
                            <option value="cable">External Cables</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Component KPN</label>
                        <select id="mother-kpn" onchange="updateMotherComponentName()">
                            <option value="">Select Component Type First</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="mother-quantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="mother-notes" placeholder="Optional notes">
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="addMotherComponent()">Add Assembly Component</button>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="addAssembly()">Add Assembly</button>
                    <button class="btn btn-success" onclick="exportAssemblies()">Export CSV</button>
                </div>
                
                <input type="text" class="search-box" id="assembly-search" placeholder="Search Assemblies..." onkeyup="filterAssemblies()">
                
                <table class="table" id="assemblies-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortAssemblies('name')">Name</th>
                            <th class="sortable" onclick="sortAssemblies('version')">Version</th>
                            <th class="sortable" onclick="sortAssemblies('description')">Description</th>
                            <th class="sortable" onclick="sortAssemblies('itemCount')">Assembly Items</th>
                            <th class="sortable" onclick="sortAssemblies('status')">Status</th>
                        </tr>
                    </thead>
                    <tbody id="assemblies-tbody">
                    </tbody>
                </table>
            </div>
            
            <!-- Systems Tab -->
            <div id="systems" class="tab-panel">
                <h2>System Hierarchy</h2>
                <p>Systems containing assemblies, mechanical/3D-printed parts, cable assemblies, and other systems</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>System Name</label>
                        <input type="text" id="system-name" placeholder="e.g., IoT Environmental Monitor">
                    </div>
                    <div class="form-group">
                        <label>Version</label>
                        <input type="text" id="system-version" placeholder="e.g., v1.0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="system-status">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="system-description" placeholder="System description and purpose">
                </div>
                
                <h3>System Items</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Item Type</label>
                        <select id="system-item-type" onchange="updateSystemItemOptions()">
                            <option value="">Select Item Type</option>
                            <option value="assembly">Assembly</option>
                            <option value="mechanical">Mechanical Part</option>
                            <option value="printed3d">3D-Printed Part</option>
                            <option value="cable">Cable Assembly</option>
                            <option value="system">Other System</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item</label>
                        <select id="system-pcb" onchange="updateSystemItemPreviewWithCrossSystem()">
                            <option value="">Select Item Type First</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>System Quantity <span class="quantity-info" id="system-quantity-info"></span></label>
                        <input type="number" id="system-pcb-quantity" min="1" value="1" onchange="updateSystemItemPreviewWithCrossSystem()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addSystemItem()">Add Item</button>
                    </div>
                </div>
                
                <!-- System Item Preview -->
                <div id="system-item-preview" class="system-item-preview" style="display: none;">
                    <h4>üìã Item Preview</h4>
                    <div id="system-item-preview-content"></div>
                </div>
                
                <div id="system-items"></div>
                
                <!-- Assembly Management Section -->
                <div class="assembly-management-section" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3>üîß Assembly Management</h3>
                    <div class="assembly-mgmt-tools">
                        <button class="btn btn-info" onclick="showAssemblyHealthDashboard()">üìä Assembly Health</button>
                        <button class="btn btn-warning" onclick="showAssemblyReplacementTool()">üîÑ Replace Assembly</button>
                        <button class="btn btn-secondary" onclick="showAssemblyUsageAnalytics()">üìà Usage Analytics</button>
                        <button class="btn btn-primary" onclick="validateAllAssemblies()">‚úÖ Validate Assemblies</button>
                    </div>
                </div>
                
                <!-- System BOM Rollup Section -->
                <div class="system-bom-section" style="margin-top: 30px; padding: 20px; background: #e8f4fd; border-radius: 8px; border: 1px solid #b8daef;">
                    <h3>üìã System BOM Rollup</h3>
                    <p style="margin-bottom: 15px; color: #495057;">Generate consolidated Bills of Materials for systems with nested assemblies and components</p>
                    <div class="system-bom-tools">
                        <button class="btn btn-primary" onclick="showSystemBOMPreview()">üîç Preview System BOM</button>
                        <button class="btn btn-success" onclick="exportSystemBOM()">üì§ Export System BOM</button>
                        <button class="btn btn-info" onclick="showSystemBOMAnalytics()">üìä BOM Analytics</button>
                        <button class="btn btn-secondary" onclick="generatePurchasingBOM()">üõí Purchase BOM</button>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="addSystem()">Add System</button>
                    <button class="btn btn-success" onclick="exportSystems()">Export CSV</button>
                </div>
                
                <input type="text" class="search-box" id="system-search" placeholder="Search systems..." onkeyup="filterSystems()">
                
                <!-- Bulk Operations Panel -->
                <div id="bulk-operations-panel" class="bulk-operations-panel" style="display: none;">
                    <div class="bulk-ops-content">
                        <span id="selected-count">0 systems selected</span>
                        <div class="bulk-ops-actions">
                            <button class="btn btn-sm" onclick="bulkUpdateStatus('Active')">Set Active</button>
                            <button class="btn btn-sm" onclick="bulkUpdateStatus('Inactive')">Set Inactive</button>
                            <button class="btn btn-sm btn-danger" onclick="bulkDeleteSystems()">Delete Selected</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear Selection</button>
                        </div>
                    </div>
                </div>
                
                <table class="table" id="systems-table">
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="select-all-systems" onchange="toggleSelectAllSystems()" title="Select all systems">
                            </th>
                            <th class="sortable" onclick="sortSystems('name')">Name</th>
                            <th class="sortable" onclick="sortSystems('version')">Version</th>
                            <th class="sortable" onclick="sortSystems('description')">Description</th>
                            <th class="sortable" onclick="sortSystems('itemCount')">Item Count</th>
                            <th class="sortable" onclick="sortSystems('status')">Status</th>
                            <th width="100">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="systems-tbody">
                    </tbody>
                </table>
            </div>
            
            <!-- Export Tab -->
            <div id="export" class="tab-panel">
                <h2>Data Export</h2>
                <p>Export your data in CSV format for external tools</p>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="export-components">0</div>
                        <div class="stat-label">Components to Export</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="export-assemblies">0</div>
                        <div class="stat-label">Assemblies to Export</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="export-systems">0</div>
                        <div class="stat-label">Systems to Export</div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="exportAll()">Export All Data</button>
                    <button class="btn btn-success" onclick="exportComponents()">Export Components Only</button>
                    <button class="btn btn-success" onclick="exportAssemblies()">Export Assemblies Only</button>
                    <button class="btn btn-success" onclick="exportSystems()">Export Systems Only</button>
                </div>
            </div>
            
            <!-- Config Tab -->
            <div id="config" class="tab-panel">
                <h2>Configuration</h2>
                <p>Manage system settings and preferred vendors</p>
                
                <div style="max-width: 800px;">
                    <!-- User Management Section (Admin Only) -->
                    <div id="user-management-section" style="display: none;">
                        <h3>üë• User Management</h3>
                        <p>Manage user accounts and permissions (Admin only)</p>
                        
                        <!-- Current Users -->
                        <div style="margin-bottom: 30px;">
                            <h4>Current Users</h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Username</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Display Name</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Role</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <!-- Users will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Add New User -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                            <h4>Add New User</h4>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label>Username <span style="color: red;">*</span></label>
                                    <input type="text" id="new-username" placeholder="e.g., john.doe">
                                </div>
                                <div class="form-group">
                                    <label>Display Name <span style="color: red;">*</span></label>
                                    <input type="text" id="new-displayname" placeholder="e.g., John Doe">
                                </div>
                                <div class="form-group">
                                    <label>Password <span style="color: red;">*</span></label>
                                    <input type="password" id="new-password" placeholder="Minimum 6 characters">
                                </div>
                                <div class="form-group">
                                    <label>Role <span style="color: red;">*</span></label>
                                    <select id="new-role">
                                        <option value="team">Team</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="btn btn-primary" onclick="addUser()">Add User</button>
                                <button class="btn" onclick="clearUserForm()" style="background: #6c757d; color: white;">Clear</button>
                            </div>
                            <div style="margin-top: 15px; font-size: 12px; color: #666;">
                                <strong>Note:</strong> Maximum 5 additional users (team + admin combined). One admin user is required.
                            </div>
                        </div>
                        
                        <!-- Role Descriptions -->
                        <div style="padding: 15px; background: #e3f2fd; border-radius: 5px; margin-bottom: 20px;">
                            <h4>Role Descriptions</h4>
                            <ul style="margin: 10px 0;">
                                <li><strong>Team:</strong> Can create and archive components, create PCBs and systems</li>
                                <li><strong>Admin:</strong> All team permissions plus ability to delete components and manage users</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Team User Profile Section -->
                    <div id="user-profile-section" style="display: none;">
                        <h3>üë§ My Profile</h3>
                        <p>Update your personal information</p>
                        
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; max-width: 400px;">
                            <div class="form-group">
                                <label>Display Name</label>
                                <input type="text" id="profile-displayname" placeholder="Your display name">
                            </div>
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="profile-current-password" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label>New Password (leave blank to keep current)</label>
                                <input type="password" id="profile-new-password" placeholder="Enter new password">
                            </div>
                            <div class="actions">
                                <button class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
                            </div>
                        </div>
                    </div>

                    <h3>Preferred Vendors</h3>
                    <p>Add and manage your preferred component vendors for dropdown selection</p>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr auto; align-items: end;">
                        <div class="form-group">
                            <label>Vendor Name</label>
                            <input type="text" id="new-vendor-name" placeholder="e.g., Mouser, Digi-Key, Arrow">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="addVendor()">Add Vendor</button>
                        </div>
                    </div>
                    
                    <div id="vendors-list" style="margin-top: 20px;">
                        <h4>Current Vendors:</h4>
                        <div id="vendors-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Duplicate Confirmation Modal -->
    <div id="duplicate-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîç Duplicate Components Found</h3>
                <p>The following components already exist in your database. Choose your action for each:</p>
            </div>
            <div class="modal-body">
                <div id="duplicate-list" class="duplicate-list">
                    <!-- Duplicate items will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="processDuplicateChoices()">Apply Choices</button>
                <button class="btn" onclick="cancelDuplicateImport()" style="background: #6c757d; color: white;">Cancel Import</button>
            </div>
        </div>
    </div>

    <script>
        // Local user management system
        // User data stored in localStorage
        
        // CSV File System Integration
        let csvDirectoryHandle = null;
        let csvFileHandles = {};
        let supportsFileSystemAccess = false;
        
        // CSV file names and their component categories
        const csvFileMap = {
            'CAPACITORS.csv': 'capacitors',
            'RESISTORS.csv': 'resistors', 
            'INDUCTORS.csv': 'inductors',
            'DIODES.csv': 'diodes',
            'TRANSISTORS.csv': 'transistors',
            'INTEGRATED_CIRCUITS.csv': 'integrated_circuits',
            'CONNECTORS.csv': 'connectors',
            'SWITCHES.csv': 'switches',
            'CRYSTALS_OSCILLATORS.csv': 'crystals_oscillators',
            'LEDS.csv': 'leds',
            'FUSES.csv': 'fuses',
            'RELAYS.csv': 'relays',
            'SENSORS.csv': 'sensors',
            'OPTOCOUPLERS.csv': 'optocouplers',
            'HARDWARE.csv': 'hardware',
            'MECHANICAL.csv': 'mechanical'
        };

        // Simplified data storage
        let data = {
            components: [],
            assemblies: [],
            systems: [],
            vendors: ['Mouser', 'Digi-Key', 'Arrow', 'Newark', 'Farnell', 'RS Components', 'Avnet', 'Future Electronics']
        };

        // Current user object
        let currentUser = { role: 'none', email: '', uid: '', displayName: '', username: null };

        // Load users from localStorage or initialize with default admin
        function loadUsers() {
            const saved = localStorage.getItem('kpn_users');
            if (saved) {
                return JSON.parse(saved);
            } else {
                // Initialize with default admin user
                return {
                    'admin': { 
                        password: 'admin123', 
                        role: 'admin', 
                        email: 'admin@kinben.local', 
                        displayName: 'Administrator',
                        created: new Date().toISOString()
                    }
                };
            }
        }

        // Save users to localStorage
        function saveUsers() {
            localStorage.setItem('kpn_users', JSON.stringify(localUsers));
        }

        // Local user accounts
        let localUsers = loadUsers();

        // Handle local authentication
        function signInLocal() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showLoginError('Please enter both username and password.');
                return;
            }
            
            const user = localUsers[username];
            if (user && user.password === password) {
                // Successful local login
                currentUser = {
                    uid: 'local_' + username,
                    username: username,
                    email: user.email,
                    displayName: user.displayName,
                    role: user.role
                };
                
                hideLogin();
                showUserInfo();
                loadData(); // Load app data
                
                // Show appropriate features based on role
                updateUIForRole(user.role);
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                console.log('Local authentication successful for:', username);
            } else {
                showLoginError('Invalid username or password.');
            }
        }

        // Update UI based on user role
        function updateUIForRole(role) {
            const userMgmtSection = document.getElementById('user-management-section');
            const userProfileSection = document.getElementById('user-profile-section');
            
            if (role === 'admin') {
                userMgmtSection.style.display = 'block';
                userProfileSection.style.display = 'block';
                loadUsersTable();
            } else if (role === 'team') {
                userMgmtSection.style.display = 'none';
                userProfileSection.style.display = 'block';
                loadUserProfile();
            } else {
                userMgmtSection.style.display = 'none';
                userProfileSection.style.display = 'none';
            }
        }

        // Load users table for admin
        function loadUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            Object.keys(localUsers).forEach(username => {
                const user = localUsers[username];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd;">${username}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${user.displayName}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <span style="background: ${user.role === 'admin' ? '#dc3545' : '#28a745'}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">
                            ${user.role.toUpperCase()}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        ${username === 'admin' ? 
                            '<span style="color: #666; font-style: italic;">Protected</span>' : 
                            `<button class="btn" onclick="editUser('${username}')" style="background: #ffc107; color: black; padding: 4px 8px; font-size: 12px; margin-right: 5px;">Edit</button>
                             <button class="btn" onclick="deleteUser('${username}')" style="background: #dc3545; color: white; padding: 4px 8px; font-size: 12px;">Delete</button>`
                        }
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Load user profile for team users
        function loadUserProfile() {
            const user = localUsers[currentUser.username];
            if (user) {
                document.getElementById('profile-displayname').value = user.displayName;
            }
        }

        // Add new user (admin only)
        function addUser() {
            if (currentUser.role !== 'admin') {
                alert('Only administrators can add users.');
                return;
            }
            
            const username = document.getElementById('new-username').value.trim();
            const displayName = document.getElementById('new-displayname').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            
            // Validation
            if (!username || !displayName || !password || !role) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }
            
            if (localUsers[username]) {
                alert('Username already exists. Please choose a different username.');
                return;
            }
            
            // Check user limit (max 6 total: 1 admin + 5 others)
            const userCount = Object.keys(localUsers).length;
            if (userCount >= 6) {
                alert('Maximum number of users (6) reached. Please delete a user before adding a new one.');
                return;
            }
            
            // Add user
            localUsers[username] = {
                password: password,
                role: role,
                email: `${username}@kinben.local`,
                displayName: displayName,
                created: new Date().toISOString()
            };
            
            saveUsers();
            loadUsersTable();
            clearUserForm();
            alert(`User "${username}" added successfully.`);
        }

        // Clear user form
        function clearUserForm() {
            document.getElementById('new-username').value = '';
            document.getElementById('new-displayname').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-role').value = 'team';
        }

        // Edit user (admin only)
        function editUser(username) {
            if (currentUser.role !== 'admin') {
                alert('Only administrators can edit users.');
                return;
            }
            
            const user = localUsers[username];
            if (!user) return;
            
            const newDisplayName = prompt('Enter new display name:', user.displayName);
            if (newDisplayName && newDisplayName.trim() !== user.displayName) {
                user.displayName = newDisplayName.trim();
                saveUsers();
                loadUsersTable();
                alert('Display name updated successfully.');
            }
        }

        // Delete user (admin only)
        function deleteUser(username) {
            if (currentUser.role !== 'admin') {
                alert('Only administrators can delete users.');
                return;
            }
            
            if (username === 'admin') {
                alert('Cannot delete the admin user.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                delete localUsers[username];
                saveUsers();
                loadUsersTable();
                alert('User deleted successfully.');
            }
        }

        // Update user profile (team users can update their own info)
        function updateProfile() {
            const user = localUsers[currentUser.username];
            if (!user) {
                alert('User not found.');
                return;
            }
            
            const newDisplayName = document.getElementById('profile-displayname').value.trim();
            const currentPassword = document.getElementById('profile-current-password').value;
            const newPassword = document.getElementById('profile-new-password').value;
            
            // Verify current password
            if (user.password !== currentPassword) {
                alert('Current password is incorrect.');
                return;
            }
            
            // Update display name
            if (newDisplayName && newDisplayName !== user.displayName) {
                user.displayName = newDisplayName;
            }
            
            // Update password if provided
            if (newPassword) {
                if (newPassword.length < 6) {
                    alert('New password must be at least 6 characters long.');
                    return;
                }
                user.password = newPassword;
            }
            
            saveUsers();
            
            // Update current user object
            currentUser.displayName = user.displayName;
            showUserInfo();
            
            // Clear password fields
            document.getElementById('profile-current-password').value = '';
            document.getElementById('profile-new-password').value = '';
            
            alert('Profile updated successfully.');
        }

        // Handle user sign out
        function handleUserSignOut() {
            currentUser = { username: null, role: null, uid: null, email: null, displayName: null };
            showLogin();
            hideUserInfo();
        }

        // Sign out user
        function signOutUser() {
            handleUserSignOut();
        }

        // Show login error
        function showLoginError(message) {
            document.getElementById('login-status').innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 3px; margin-top: 10px;">
                    ${message}
                </div>
            `;
        }

        // Check authentication status
        function checkAuth() {
            return currentUser.role && currentUser.role !== 'none';
        }

        // Logout function
        function logout() {
            signOutUser();
        }

        // Show/hide login modal
        function showLogin() {
            document.getElementById('login-modal').style.display = 'flex';
        }

        function hideLogin() {
            document.getElementById('login-modal').style.display = 'none';
        }

        // Show/hide user info
        function showUserInfo() {
            const userInfo = document.getElementById('user-info');
            const currentUserSpan = document.getElementById('current-user');
            currentUserSpan.textContent = `${currentUser.username.charAt(0).toUpperCase() + currentUser.username.slice(1)} User (${currentUser.role === 'admin' ? 'Admin' : 'Team'})`;
            userInfo.style.display = 'block';
            updateUIForRole(currentUser.role);
        }

        function hideUserInfo() {
            document.getElementById('user-info').style.display = 'none';
        }

        // Initialize authentication on page load
        window.addEventListener('load', function() {
            showLogin();
        });

        // Add keyboard support for login modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('login-modal').style.display !== 'none') {
                signInLocal();
            }
        });

        // Load data from localStorage
        // File System Access API Functions
        
        // Check if File System Access API is supported
        function checkFileSystemSupport() {
            supportsFileSystemAccess = 'showDirectoryPicker' in window;
            return supportsFileSystemAccess;
        }
        
        // Request access to CSV files directory
        async function requestCSVDirectory() {
            try {
                if (!checkFileSystemSupport()) {
                    throw new Error('File System Access API not supported in this browser');
                }
                
                // Request directory access
                csvDirectoryHandle = await window.showDirectoryPicker({
                    mode: 'readwrite',
                    id: 'kpn-csv-directory'
                });
                
                console.log('Directory access granted:', csvDirectoryHandle.name);
                
                // Try to load CSV files
                await loadCSVFiles();
                
                return true;
            } catch (error) {
                console.error('Failed to access directory:', error);
                if (error.name === 'AbortError') {
                    alert('Directory access was cancelled. Using localStorage fallback.');
                } else {
                    alert('Failed to access CSV files: ' + error.message + '\nUsing localStorage fallback.');
                }
                return false;
            }
        }
        
        // Load all CSV files from the directory
        async function loadCSVFiles() {
            try {
                // Clear existing data
                data.components = [];
                
                // Look for CSV_Files subdirectory first
                let csvDir = csvDirectoryHandle;
                let foundCSVDir = false;
                
                try {
                    // Try to find CSV_Files subdirectory
                    for await (const [name, handle] of csvDirectoryHandle.entries()) {
                        if (name === 'KPN Master Reference Sheet' && handle.kind === 'directory') {
                            const masterDir = handle;
                            for await (const [subName, subHandle] of masterDir.entries()) {
                                if (subName === 'CSV_Files' && subHandle.kind === 'directory') {
                                    csvDir = subHandle;
                                    foundCSVDir = true;
                                    console.log('Found CSV_Files directory');
                                    break;
                                }
                            }
                            break;
                        }
                    }
                } catch (e) {
                    console.log('Using root directory for CSV files');
                }
                
                // Check if directory has any CSV files
                let foundAnyCSV = false;
                let missingFiles = [];
                
                // First pass: check what exists
                for (const [fileName, category] of Object.entries(csvFileMap)) {
                    try {
                        const fileHandle = await csvDir.getFileHandle(fileName);
                        foundAnyCSV = true;
                    } catch (error) {
                        missingFiles.push(fileName);
                    }
                }
                
                // If no CSV files found, offer to create them
                if (!foundAnyCSV) {
                    const createFiles = confirm(
                        `No CSV files found in the selected directory.\n\n` +
                        `Would you like to create blank CSV files with proper headers?\n\n` +
                        `This will create ${Object.keys(csvFileMap).length} files:\n` +
                        Object.keys(csvFileMap).join(', ') + '\n\n' +
                        `Click OK to create files, or Cancel to go back.`
                    );
                    
                    if (!createFiles) {
                        // User chose not to create files - reset to initial state
                        csvDirectoryHandle = null;
                        csvFileHandles = {};
                        document.getElementById('csv-access-btn').textContent = 'üìÅ Select CSV Files Directory';
                        document.getElementById('csv-access-btn').onclick = setupCSVAccess;
                        document.getElementById('csv-change-btn').style.display = 'none';
                        updateCSVStatus('No CSV files found - Using localStorage fallback', 'orange');
                        return;
                    }
                    
                    // Create all CSV files with headers
                    updateCSVStatus('Creating blank CSV files...', 'orange');
                    for (const [fileName, category] of Object.entries(csvFileMap)) {
                        try {
                            const fileHandle = await csvDir.getFileHandle(fileName, { create: true });
                            csvFileHandles[fileName] = fileHandle;
                            await writeCSVHeader(fileHandle);
                            console.log(`Created ${fileName}`);
                        } catch (createError) {
                            console.error(`Failed to create ${fileName}:`, createError);
                        }
                    }
                    updateCSVStatus(`‚úÖ Created ${Object.keys(csvFileMap).length} blank CSV files`, 'green');
                    return;
                }
                
                // Load each CSV file
                for (const [fileName, category] of Object.entries(csvFileMap)) {
                    try {
                        const fileHandle = await csvDir.getFileHandle(fileName);
                        csvFileHandles[fileName] = fileHandle;
                        
                        const file = await fileHandle.getFile();
                        const content = await file.text();
                        
                        if (content.trim()) {
                            const components = parseCSVContent(content, category);
                            data.components.push(...components);
                            console.log(`Loaded ${components.length} components from ${fileName}`);
                        }
                    } catch (error) {
                        console.log(`File ${fileName} not found:`, error.message);
                        // Create missing file with header
                        if (missingFiles.includes(fileName)) {
                            try {
                                const fileHandle = await csvDir.getFileHandle(fileName, { create: true });
                                csvFileHandles[fileName] = fileHandle;
                                await writeCSVHeader(fileHandle);
                                console.log(`Created missing file: ${fileName}`);
                            } catch (createError) {
                                console.error(`Failed to create ${fileName}:`, createError);
                            }
                        }
                    }
                }
                
                console.log(`Total components loaded: ${data.components.length}`);
                updateStats();
                renderAll();
                
            } catch (error) {
                console.error('Error loading CSV files:', error);
                throw error;
            }
        }
        
        // Parse CSV content into components
        function parseCSVContent(csvContent, category) {
            const lines = csvContent.trim().split('\n');
            if (lines.length <= 1) return []; // Only header or empty
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const components = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === 0 || !values[0]) continue; // Skip empty rows
                
                const component = {};
                headers.forEach((header, index) => {
                    component[header] = values[index] || '';
                });
                
                // Ensure required fields exist
                if (!component.Kinben_PN) continue;
                
                // Map to internal structure
                const mappedComponent = {
                    kpn: component.Kinben_PN,
                    category: getCategoryFromKPN(component.Kinben_PN) || category,
                    subcategory: component.Subcategory || getSubcategoryFromKPN(component.Kinben_PN) || '',
                    value: component.Value || '',
                    package: component.Package || '',
                    manufacturer: component.Manufacturer || '',
                    manufacturerPn: component.Manufacturer_PN || '',
                    description: component.Description || '',
                    preferredVendor: component.Preferred_Supplier || '',
                    status: component.Status || 'Active',
                    // Store all original CSV fields for round-trip compatibility
                    _csvData: component
                };
                
                components.push(mappedComponent);
            }
            
            return components;
        }
        
        // Parse a single CSV line handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // Extract category from KPN (e.g., "RES-STD-001" -> "resistors")
        function getCategoryFromKPN(kpn) {
            if (!kpn) return null;
            const prefix = kpn.split('-')[0];
            const categoryMap = {
                'CAP': 'capacitors',
                'RES': 'resistors',
                'IND': 'inductors',
                'DIO': 'diodes',
                'TRA': 'transistors',
                'IC': 'integrated_circuits',
                'CON': 'connectors',
                'SW': 'switches',
                'OSC': 'crystals_oscillators',
                'LED': 'leds',
                'FUS': 'fuses',
                'REL': 'relays',
                'SEN': 'sensors',
                'OPT': 'optocouplers',
                'HW': 'hardware',
                'MEC': 'mechanical'
            };
            return categoryMap[prefix] || null;
        }
        
        // Extract subcategory from KPN (e.g., "RES-STD-001" -> "STD")
        function getSubcategoryFromKPN(kpn) {
            if (!kpn) return null;
            const parts = kpn.split('-');
            return parts.length > 1 ? parts[1] : null;
        }
        
        // Write CSV header to a new file
        async function writeCSVHeader(fileHandle) {
            const headers = [
                'Kinben_PN', 'Category', 'Subcategory', 'Value', 'Package', 'Manufacturer', 
                'Manufacturer_PN', 'Description', 'Voltage_Rating', 'Current_Rating', 
                'Tolerance', 'Mounting', 'Preferred_Supplier', 'Mouser_PN', 'DigiKey_PN',
                'Unit_Cost', 'Stock_Level', 'Symbol_File', 'Footprint_File', '3D_Model_File',
                'Datasheet_URL', 'Status', 'Created_Date', 'Notes'
            ];
            
            const csvContent = headers.join(',') + '\n';
            const writable = await fileHandle.createWritable();
            await writable.write(csvContent);
            await writable.close();
        }
        
        // Setup CSV access - main function called by UI button
        async function setupCSVAccess() {
            updateCSVStatus('Requesting directory access...', 'orange');
            
            const success = await requestCSVDirectory();
            if (success) {
                updateCSVStatus('‚úÖ Connected to CSV files', 'green');
                document.getElementById('csv-access-btn').textContent = 'üîÑ Reload CSV Files';
                document.getElementById('csv-access-btn').onclick = reloadCSVFiles;
                document.getElementById('csv-change-btn').style.display = 'inline-block';
            } else {
                updateCSVStatus('‚ùå CSV access failed - Using localStorage', 'red');
            }
        }
        
        // Change CSV directory - allows user to select a different folder
        async function changeCSVDirectory() {
            if (confirm('Changing CSV directory will reload all data from the new location. Any unsaved changes will be lost. Continue?')) {
                // Reset CSV handles
                csvDirectoryHandle = null;
                csvFileHandles = {};
                
                // Reset UI
                document.getElementById('csv-access-btn').textContent = 'üìÅ Select CSV Files Directory';
                document.getElementById('csv-access-btn').onclick = setupCSVAccess;
                document.getElementById('csv-change-btn').style.display = 'none';
                updateCSVStatus('Requesting new directory access...', 'orange');
                
                // Request new directory
                const success = await requestCSVDirectory();
                if (success) {
                    updateCSVStatus('‚úÖ Connected to new CSV directory', 'green');
                    document.getElementById('csv-access-btn').textContent = 'üîÑ Reload CSV Files';
                    document.getElementById('csv-access-btn').onclick = reloadCSVFiles;
                    document.getElementById('csv-change-btn').style.display = 'inline-block';
                } else {
                    updateCSVStatus('‚ùå Directory change failed - Using localStorage', 'red');
                }
            }
        }
        
        // Reload CSV files
        async function reloadCSVFiles() {
            if (!csvDirectoryHandle) {
                await setupCSVAccess();
                return;
            }
            
            updateCSVStatus('Reloading CSV files...', 'orange');
            try {
                await loadCSVFiles();
                updateCSVStatus('‚úÖ CSV files reloaded', 'green');
            } catch (error) {
                console.error('Failed to reload CSV files:', error);
                updateCSVStatus('‚ùå Failed to reload CSV files', 'red');
            }
        }
        
        // Update CSV status display
        function updateCSVStatus(message, color = '#666') {
            const statusElement = document.getElementById('csv-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = color;
            }
        }
        
        // Initialize CSV system on page load
        function initializeCSVSystem() {
            // Check browser support and update UI
            if (checkFileSystemSupport()) {
                updateCSVStatus('Ready for CSV file access', '#666');
            } else {
                updateCSVStatus('‚ö†Ô∏è Browser doesn\'t support direct file access - Using localStorage only', 'orange');
                document.getElementById('csv-access-btn').style.display = 'none';
            }
        }

        // Modified loadData function to support CSV files
        async function loadData() {
            // Try to load from CSV files first if directory access is available
            if (csvDirectoryHandle) {
                try {
                    await loadCSVFiles();
                    return;
                } catch (error) {
                    console.error('Failed to load CSV files, falling back to localStorage:', error);
                }
            }
            
            // Fallback to localStorage
            const saved = localStorage.getItem('kinben-simple-data');
            if (saved) {
                data = JSON.parse(saved);
                // Ensure vendors array exists for backward compatibility
                if (!data.vendors) {
                    data.vendors = ['Mouser', 'Digi-Key', 'Arrow', 'Newark', 'Farnell', 'RS Components', 'Avnet', 'Future Electronics'];
                    saveData();
                }
                // Migrate pcbs to assemblies for backward compatibility
                if (data.pcbs && !data.assemblies) {
                    data.assemblies = data.pcbs;
                    delete data.pcbs;
                    saveData();
                }
                // Ensure assemblies array exists
                if (!data.assemblies) {
                    data.assemblies = [];
                    saveData();
                }
                // Migrate system pcbs to items for backward compatibility
                if (data.systems) {
                    data.systems.forEach(system => {
                        if (system.pcbs && !system.items) {
                            system.items = system.pcbs.map(pcb => ({
                                type: 'assembly',
                                value: pcb.name,
                                name: pcb.name,
                                version: pcb.version,
                                quantity: pcb.quantity
                            }));
                            delete system.pcbs;
                        }
                    });
                    saveData();
                }
                // Migrate assemblies to include type field (default to PCB)
                if (data.assemblies) {
                    let migrationNeeded = false;
                    data.assemblies.forEach(assembly => {
                        if (!assembly.type) {
                            assembly.type = 'pcb'; // Default existing assemblies to PCB type
                            assembly.pcbData = {
                                bom: assembly.bom || []
                            };
                            assembly.cableData = null;
                            migrationNeeded = true;
                        }
                    });
                    if (migrationNeeded) {
                        saveData();
                    }
                }
            }
            updateStats();
            renderAll();
        }

        // Save data to localStorage and CSV files (if connected)
        async function saveData() {
            // Always save to localStorage as backup
            localStorage.setItem('kinben-simple-data', JSON.stringify(data));
            
            // If CSV files are connected, sync to CSV files
            if (csvDirectoryHandle && Object.keys(csvFileHandles).length > 0) {
                try {
                    await syncComponentsToCSV();
                } catch (error) {
                    console.error('Failed to sync to CSV files:', error);
                    updateCSVStatus('‚ö†Ô∏è CSV sync failed - Data saved to localStorage only', 'orange');
                }
            }
            
            updateStats();
        }
        
        // Sync all components to their respective CSV files
        async function syncComponentsToCSV() {
            updateCSVStatus('üîÑ Syncing to CSV files...', 'orange');
            
            // Group components by category for CSV file writing
            const componentsByCategory = {};
            
            // Initialize empty arrays for all categories
            Object.values(csvFileMap).forEach(category => {
                componentsByCategory[category] = [];
            });
            
            // Group components by their category
            data.components.forEach(component => {
                const category = component.category || getCategoryFromKPN(component.kpn);
                if (category && componentsByCategory[category]) {
                    componentsByCategory[category].push(component);
                }
            });
            
            let syncedCount = 0;
            // Write each category to its CSV file
            for (const [fileName, category] of Object.entries(csvFileMap)) {
                if (csvFileHandles[fileName]) {
                    try {
                        await writeComponentsToCSV(csvFileHandles[fileName], componentsByCategory[category]);
                        syncedCount++;
                    } catch (error) {
                        console.error(`Failed to write to ${fileName}:`, error);
                        throw error;
                    }
                }
            }
            
            updateCSVStatus(`‚úÖ ${data.components.length} components synced to ${syncedCount} CSV files`, 'green');
            console.log('CSV files synchronized successfully');
        }
        
        // Write components to a specific CSV file
        async function writeComponentsToCSV(fileHandle, components) {
            // Create CSV content with headers
            const headers = [
                'Kinben_PN', 'Category', 'Subcategory', 'Value', 'Package', 'Manufacturer', 
                'Manufacturer_PN', 'Description', 'Voltage_Rating', 'Current_Rating', 
                'Tolerance', 'Mounting', 'Preferred_Supplier', 'Mouser_PN', 'DigiKey_PN',
                'Unit_Cost', 'Stock_Level', 'Symbol_File', 'Footprint_File', '3D_Model_File',
                'Datasheet_URL', 'Status', 'Created_Date', 'Notes'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            // Add each component as a CSV row
            components.forEach(component => {
                const csvRow = headers.map(header => {
                    let value = '';
                    
                    // Map internal fields to CSV headers
                    switch (header) {
                        case 'Kinben_PN': value = component.kpn || ''; break;
                        case 'Category': value = component.category || ''; break;
                        case 'Subcategory': value = component.subcategory || ''; break;
                        case 'Value': value = component.value || component.resistance_value || component.capacitance_value || ''; break;
                        case 'Package': value = component.package || ''; break;
                        case 'Manufacturer': value = component.manufacturer || ''; break;
                        case 'Manufacturer_PN': value = component.manufacturerPn || component.manufacturer_pn || ''; break;
                        case 'Description': value = component.description || ''; break;
                        case 'Preferred_Supplier': value = component.preferredVendor || component.preferred_vendor || ''; break;
                        case 'Status': value = component.status || 'Active'; break;
                        case 'Created_Date': value = component.dateAdded || component.created_date || ''; break;
                        case 'Voltage_Rating': value = component.voltage_rating || component.voltage || ''; break;
                        case 'Current_Rating': value = component.current_rating || component.current || ''; break;
                        case 'Tolerance': value = component.tolerance || ''; break;
                        case 'Mounting': value = component.mounting || ''; break;
                        case 'Notes': value = component.notes || ''; break;
                        default:
                            // Check if the field exists in _csvData (original CSV data)
                            if (component._csvData && component._csvData[header]) {
                                value = component._csvData[header];
                            }
                            break;
                    }
                    
                    // Escape and quote the value if it contains commas or quotes
                    if (value.toString().includes(',') || value.toString().includes('"') || value.toString().includes('\n')) {
                        value = '"' + value.toString().replace(/"/g, '""') + '"';
                    }
                    
                    return value;
                });
                
                csvContent += csvRow.join(',') + '\n';
            });
            
            // Write to file
            const writable = await fileHandle.createWritable();
            await writable.write(csvContent);
            await writable.close();
        }

        // Category configurations with component-specific fields
        const categoryConfigs = {
            resistors: { 
                code: 'RES', 
                subcategories: ['STD', 'PRE', 'VAR', 'NET'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Yageo, Vishay' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., RC0805FR-0710KL' },
                    { id: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 10k, 4.7k' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 0805, 1206' },
                    { id: 'tolerance', label: 'Tolerance', type: 'text', required: true, placeholder: 'e.g., 1%, 5%' },
                    { id: 'temp-rating', label: 'Temp Rating', type: 'text', required: false, placeholder: 'e.g., -55¬∞C to +125¬∞C' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            capacitors: { 
                code: 'CAP', 
                subcategories: ['CER', 'ELE', 'TAN', 'FIL'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Murata, TDK' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., GRM21BR71H104KA01L' },
                    { id: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 10uF, 100nF' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 0805, 1206' },
                    { id: 'tolerance', label: 'Tolerance', type: 'text', required: false, placeholder: 'e.g., 10%, 20%' },
                    { id: 'voltage', label: 'Voltage', type: 'text', required: true, placeholder: 'e.g., 25V, 50V' },
                    { id: 'rating', label: 'Rating', type: 'text', required: false, placeholder: 'e.g., X7R, X5R, Y5V' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            ics: { 
                code: 'IC', 
                subcategories: ['MCU', 'ANA', 'DIG', 'PWR'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., STMicroelectronics, TI' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., STM32F103C8T6' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., 32-bit ARM Cortex-M3 MCU' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., LQFP-48, QFN-32' },
                    { id: 'rating', label: 'Rating', type: 'text', required: false, placeholder: 'e.g., Automotive, Industrial' },
                    { id: 'datasheet-link', label: 'Datasheet/Product Link', type: 'url', required: false, placeholder: 'https://...' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            inductors: { 
                code: 'IND', 
                subcategories: ['PWR', 'CHK', 'FER'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Murata, Coilcraft' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., LQM18FN1R0M00D' },
                    { id: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 10uH, 220nH' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 0805, 1210' },
                    { id: 'tolerance', label: 'Tolerance', type: 'text', required: false, placeholder: 'e.g., 10%, 20%' },
                    { id: 'current-rating', label: 'Current Rating', type: 'text', required: false, placeholder: 'e.g., 1A, 500mA' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            diodes: { 
                code: 'DIO', 
                subcategories: ['STD', 'LED', 'ZEN', 'SCH'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Vishay, Diodes Inc' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., 1N4148WS' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., SOD-323, SOT-23' },
                    { id: 'voltage-rating', label: 'Voltage Rating', type: 'text', required: false, placeholder: 'e.g., 75V, 100V' },
                    { id: 'current-rating', label: 'Current Rating', type: 'text', required: false, placeholder: 'e.g., 150mA, 1A' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            transistors: { 
                code: 'TRA', 
                subcategories: ['BJT', 'FET', 'MOS'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Infineon, ON Semi' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., 2N7002K' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., SOT-23, TO-220' },
                    { id: 'voltage-rating', label: 'Voltage Rating', type: 'text', required: false, placeholder: 'e.g., 60V, 100V' },
                    { id: 'current-rating', label: 'Current Rating', type: 'text', required: false, placeholder: 'e.g., 300mA, 1A' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            connectors: { 
                code: 'CON', 
                subcategories: ['HDR', 'JST', 'USB', 'RJ45'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., JST, Molex' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., B2B-XH-A(LF)(SN)' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., 2-pin JST XH connector' },
                    { id: 'pitch', label: 'Pitch', type: 'text', required: false, placeholder: 'e.g., 2.54mm, 1.25mm' },
                    { id: 'pins', label: 'Pins', type: 'number', required: false, placeholder: 'e.g., 2, 4, 8' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            switches: { 
                code: 'SWI', 
                subcategories: ['TAC', 'DIP', 'ROT', 'SLI'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., ALPS, Omron' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., SKHHPNA010' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., Tactile switch 4.3x4.3mm' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 4.3x4.3mm, SMD' },
                    { id: 'actuation-force', label: 'Actuation Force', type: 'text', required: false, placeholder: 'e.g., 160gf, 260gf' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            pcb: { 
                code: 'PCB', 
                subcategories: ['STD', 'FLX', 'RIG', 'MLB'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., JLCPCB, PCBWay' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., PCB-MAIN-V1.0' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., Main Controller PCB 2-layer' },
                    { id: 'dimensions', label: 'Dimensions', type: 'text', required: false, placeholder: 'e.g., 50x30mm, 100x80mm' },
                    { id: 'layers', label: 'Layers', type: 'text', required: false, placeholder: 'e.g., 2, 4, 6' },
                    { id: 'thickness', label: 'Thickness', type: 'text', required: false, placeholder: 'e.g., 1.6mm, 0.8mm' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            mechanical: { 
                code: 'MEC', 
                subcategories: ['SCR', 'NUT', 'WSH', 'BRK', 'SPR'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., McMaster-Carr, Fastenal' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., 91292A110' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., M3x10mm Phillips Head Screw' },
                    { id: 'material', label: 'Material', type: 'text', required: false, placeholder: 'e.g., Stainless Steel, Aluminum' },
                    { id: 'finish', label: 'Finish', type: 'text', required: false, placeholder: 'e.g., Black Oxide, Zinc Plated' },
                    { id: 'dimensions', label: 'Dimensions', type: 'text', required: false, placeholder: 'e.g., M3x10mm, 6.35x12.7mm' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            printed3d: { 
                code: 'P3D', 
                subcategories: ['CAS', 'BRK', 'SPA', 'MNT'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Internal, Shapeways' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., CASE-001-V1.2' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., Sensor Housing Top Cover' },
                    { id: 'material', label: 'Material', type: 'text', required: false, placeholder: 'e.g., PLA, ABS, PETG' },
                    { id: 'color', label: 'Color', type: 'text', required: false, placeholder: 'e.g., Black, White, Clear' },
                    { id: 'dimensions', label: 'Dimensions', type: 'text', required: false, placeholder: 'e.g., 80x60x25mm' },
                    { id: 'file-link', label: 'CAD File Link', type: 'url', required: false, placeholder: 'https://...' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            cable: { 
                code: 'CAB', 
                subcategories: ['PWR', 'DATA', 'SIG', 'CUS'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Amphenol, TE Connectivity' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., USB-A-TO-C-1M' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., USB-A to USB-C Cable 1m' },
                    { id: 'length', label: 'Length', type: 'text', required: false, placeholder: 'e.g., 1m, 500mm, 6ft' },
                    { id: 'connectors', label: 'Connectors', type: 'text', required: false, placeholder: 'e.g., USB-A to USB-C, JST-XH 2pin' },
                    { id: 'wire-gauge', label: 'Wire Gauge', type: 'text', required: false, placeholder: 'e.g., 24AWG, 20AWG' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            }
        };

        // ============ VALIDATION FRAMEWORK ============
        
        // Standard package options per category
        const packageOptions = {
            resistors: ['0402', '0603', '0805', '1206', '1210', '2010', '2512', 'AXIAL'],
            capacitors: ['0402', '0603', '0805', '1206', '1210', '1812', '2220', 'RADIAL'],
            inductors: ['0402', '0603', '0805', '1206', '1210', '1812', 'RADIAL'],
            diodes: ['SOD-123', 'SOD-323', 'SOD-523', 'SMA', 'SMB', 'SMC', 'DO-214'],
            transistors: ['SOT-23', 'SOT-223', 'TO-220', 'DPAK', 'D2PAK', 'SO-8'],
            ics: ['SOIC-8', 'SOIC-14', 'SOIC-16', 'TSSOP-14', 'QFN-16', 'BGA-256'],
            connectors: ['THT', 'SMD', '2.54mm', '1.27mm', 'USB', 'RJ45']
        };

        // Standard unit options
        const unitOptions = {
            resistance: ['Œ©', 'kŒ©', 'MŒ©', 'GŒ©'],
            capacitance: ['pF', 'nF', '¬µF', 'mF'],
            inductance: ['nH', '¬µH', 'mH', 'H'],
            voltage: ['mV', 'V', 'kV'],
            current: ['¬µA', 'mA', 'A']
        };


        // Tab management
        function showTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected panel and tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Update component dropdowns when switching tabs
            if (tabName === 'pcbs' || tabName === 'systems') {
                updateDropdowns();
            }
        }

        // Update subcategories based on category selection
        function updateComponentSubcategories() {
            const category = document.getElementById('comp-category').value;
            const subcategorySelect = document.getElementById('comp-subcategory');
            
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (category && categoryConfigs[category]) {
                categoryConfigs[category].subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
            
            // Update dynamic fields
            updateComponentFields();
            generateComponentKPN();
        }

        // Update component fields based on selected category
        function updateComponentFields() {
            const category = document.getElementById('comp-category').value;
            const dynamicFieldsContainer = document.getElementById('component-dynamic-fields');
            
            if (!category || !categoryConfigs[category]) {
                dynamicFieldsContainer.innerHTML = `
                    <p style="color: #666; text-align: center; margin: 40px 0;">
                        Select a category and subcategory to display component-specific fields
                    </p>
                `;
                return;
            }
            
            const config = categoryConfigs[category];
            let fieldsHTML = '<div class="form-grid">';
            
            // Add KPN field (always present)
            fieldsHTML += `
                <div class="form-group">
                    <label>KPN <span class="required-field">*</span></label>
                    <input type="text" id="comp-kpn" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Category <span class="required-field">*</span></label>
                    <input type="text" id="comp-category-display" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Subcategory <span class="required-field">*</span></label>
                    <input type="text" id="comp-subcategory-display" readonly style="background: #f5f5f5;">
                </div>
            `;
            
            // Add category-specific fields
            config.fields.forEach(field => {
                const requiredMark = field.required ? '<span class="required-field">*</span>' : '';
                
                if (field.type === 'vendor-select') {
                    // Create vendor dropdown
                    let vendorOptions = '<option value="">Select Vendor</option>';
                    data.vendors.forEach(vendor => {
                        vendorOptions += `<option value="${vendor}">${vendor}</option>`;
                    });
                    
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <select id="comp-${field.id}" ${field.required ? 'required' : ''}>
                                ${vendorOptions}
                            </select>
                        </div>
                    `;
                } else if (field.id === 'value' && ['resistors', 'capacitors', 'inductors'].includes(category)) {
                    // Special value field with unit dropdown for passive components
                    const categoryUnitMap = {
                        resistors: { unitType: 'resistance', unitList: unitOptions.resistance },
                        capacitors: { unitType: 'capacitance', unitList: unitOptions.capacitance },
                        inductors: { unitType: 'inductance', unitList: unitOptions.inductance }
                    };
                    
                    const { unitType, unitList } = categoryUnitMap[category] || { unitType: '', unitList: [] };
                    
                    let unitOptionsHTML = unitList.map(unit => 
                        `<option value="${unit}">${unit}</option>`
                    ).join('');
                    
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <div class="value-unit-container">
                                <input type="text" 
                                       id="comp-${field.id}" 
                                       placeholder="Enter numeric value"
                                       ${field.required ? 'required' : ''}>
                                <select id="comp-${field.id}-unit">
                                    <option value="${unitList[0]}" selected>${unitList[0]}</option>
                                    ${unitOptionsHTML}
                                </select>
                            </div>
                        </div>
                    `;
                } else if (field.id === 'package') {
                    // Package field with dropdown suggestions
                    const packages = packageOptions[category] || [];
                    let packageOptionsHTML = packages.map(pkg => 
                        `<option value="${pkg}">${pkg}</option>`
                    ).join('');
                    
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <select id="comp-${field.id}" ${field.required ? 'required' : ''}>
                                <option value="">Select Package</option>
                                ${packageOptionsHTML}
                                <option value="custom">Other (specify)</option>
                            </select>
                        </div>
                    `;
                } else {
                    // Regular input field
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <input type="${field.type}" 
                                   id="comp-${field.id}" 
                                   placeholder="${field.placeholder || ''}"
                                   ${field.required ? 'required' : ''}>
                        </div>
                    `;
                }
            });
            
            fieldsHTML += '</div>';
            dynamicFieldsContainer.innerHTML = fieldsHTML;
            
            // Update readonly fields if category/subcategory are already selected
            const categorySelect = document.getElementById('comp-category');
            const subcategorySelect = document.getElementById('comp-subcategory');
            if (categorySelect.value) {
                document.getElementById('comp-category-display').value = categorySelect.options[categorySelect.selectedIndex].text;
            }
            if (subcategorySelect.value) {
                document.getElementById('comp-subcategory-display').value = subcategorySelect.value;
            }
            
        }

        // Generate KPN for component
        // Check if a component with the same identifying fields already exists
        function findDuplicateComponent(componentData) {
            const { category, subcategory } = componentData;
            
            // Core identifying fields that must match for all components
            const coreFields = ['category', 'subcategory'];
            
            // Additional identifying fields per category - comprehensive list based on schema
            const categoryIdentifyingFields = {
                resistors: ['value', 'package', 'tolerance', 'temp_rating', 'manufacturer', 'manufacturer_pn'],
                capacitors: ['value', 'package', 'tolerance', 'voltage_rating', 'rating', 'manufacturer', 'manufacturer_pn'],
                inductors: ['value', 'package', 'tolerance', 'current_rating', 'manufacturer', 'manufacturer_pn'],
                ics: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                diodes: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                transistors: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                connectors: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                switches: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer']
            };
            
            // Get all fields to check for this category
            const allFieldsToCheck = [
                ...coreFields,
                ...(categoryIdentifyingFields[category] || (() => {
                    console.warn(`Unknown category "${category}" encountered. Using fallback fields.`);
                    return ['manufacturer_pn', 'description', 'package'];
                })())
            ];
            
            // Find existing components with same category and subcategory first
            const similarComponents = data.components.filter(comp => 
                comp.category === category && 
                comp.subcategory === subcategory &&
                comp.status === 'Active' // Only check active components
            );
            
            // Check if any existing component has ALL matching identifying fields
            for (const existingComp of similarComponents) {
                let isMatch = true;
                
                for (const field of allFieldsToCheck) {
                    const newValue = (componentData[field] || '').toString().toLowerCase().trim();
                    const existingValue = (existingComp[field] || '').toString().toLowerCase().trim();
                    
                    // Track if at least one field is non-empty for both components
                    const isFieldIdentifying = newValue !== '' || existingValue !== '';
                    
                    if (!isFieldIdentifying) {
                        continue; // Skip non-identifying fields
                    }
                    
                    if (newValue !== existingValue) {
                        isMatch = false;
                        break;
                    }
                }
                
                if (isMatch) {
                    return existingComp;
                }
            }
            
            return null;
        }

        function generateComponentKPN() {
            const category = document.getElementById('comp-category').value;
            const subcategory = document.getElementById('comp-subcategory').value;
            const preview = document.getElementById('comp-kpn-preview');
            
            if (category && subcategory) {
                const config = categoryConfigs[category];
                const existingKPNs = data.components
                    .filter(c => c.kpn.startsWith(`${config.code}-${subcategory}`))
                    .map(c => parseInt(c.kpn.split('-')[2]))
                    .filter(n => !isNaN(n))
                    .sort((a, b) => a - b); // Sort to find gaps
                
                let nextNumber = 1;
                
                // Find the first available number (allows reuse of deleted KPNs)
                for (let i = 0; i < existingKPNs.length; i++) {
                    if (existingKPNs[i] === nextNumber) {
                        nextNumber++;
                    } else {
                        // Found a gap, use this number
                        break;
                    }
                }
                
                const kpn = `${config.code}-${subcategory}-${nextNumber.toString().padStart(3, '0')}`;
                
                preview.textContent = kpn;
                
                // Update KPN in dynamic form if it exists
                const compKpnField = document.getElementById('comp-kpn');
                if (compKpnField) {
                    compKpnField.value = kpn;
                }
                
                // Update category and subcategory display fields
                const compCategoryDisplay = document.getElementById('comp-category-display');
                const compSubcategoryDisplay = document.getElementById('comp-subcategory-display');
                if (compCategoryDisplay) {
                    const categorySelect = document.getElementById('comp-category');
                    compCategoryDisplay.value = categorySelect.options[categorySelect.selectedIndex].text;
                }
                if (compSubcategoryDisplay) {
                    compSubcategoryDisplay.value = subcategory;
                }
            } else {
                preview.textContent = 'Select category and subcategory';
                // Clear dynamic form KPN field
                const compKpnField = document.getElementById('comp-kpn');
                if (compKpnField) {
                    compKpnField.value = '';
                }
            }
        }

        // Add component
        async function addComponent() {
            const category = document.getElementById('comp-category').value;
            const subcategory = document.getElementById('comp-subcategory').value;
            
            if (!category || !subcategory) {
                alert('Please select category and subcategory first');
                return;
            }
            
            const kpn = document.getElementById('comp-kpn').value || document.getElementById('comp-kpn-preview').textContent;
            
            
            // Collect data from dynamic fields
            const component = {
                kpn,
                category,
                subcategory,
                status: 'Active', // Default status for new components
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            // Collect and validate field data
            const config = categoryConfigs[category];
            let missingRequired = [];
            
            config.fields.forEach(field => {
                const fieldElement = document.getElementById(`comp-${field.id}`);
                if (fieldElement) {
                    let value = fieldElement.value.trim();
                    
                    // Handle value + unit combination for passive components
                    if (field.id === 'value' && ['resistors', 'capacitors', 'inductors'].includes(category)) {
                        const unitElement = document.getElementById(`comp-${field.id}-unit`);
                        if (unitElement && unitElement.value) {
                            value = value + unitElement.value;
                        }
                    }
                    
                    if (field.required && !value) {
                        missingRequired.push(field.label);
                    }
                    component[field.id.replace('-', '_')] = value;
                }
            });
            
            if (missingRequired.length > 0) {
                alert(`Please fill in all required fields: ${missingRequired.join(', ')}`);
                return;
            }
            
            // Check for duplicate components
            const duplicateComponent = findDuplicateComponent(component);
            if (duplicateComponent) {
                alert(`A component with matching specifications already exists with KPN: ${duplicateComponent.kpn}. Cannot create duplicate.`);
                return;
            }
            
            data.components.push(component);
            await saveData();
            renderComponents();
            
            // Clear form
            document.getElementById('comp-category').value = '';
            document.getElementById('comp-subcategory').value = '';
            document.getElementById('comp-kpn-preview').textContent = 'Select category and subcategory';
            
            // Clear dynamic fields
            const dynamicFieldsContainer = document.getElementById('component-dynamic-fields');
            dynamicFieldsContainer.innerHTML = `
                <p style="color: #666; text-align: center; margin: 40px 0;">
                    Select a category and subcategory to display component-specific fields
                </p>
            `;
            
            // Show success message
            alert('Component added successfully!');
        }

        // Global variables for import process
        let pendingImportData = null;
        let duplicateResults = [];

        // Import components from CSV with duplicate detection
        function importCSV() {
            const fileInput = document.getElementById('csv-import-input');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file must have at least a header row and one data row');
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    let errors = [];
                    let validComponents = [];
                    let duplicates = [];
                    
                    // Check for required headers
                    const requiredHeaders = ['category', 'subcategory'];
                    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                    if (missingHeaders.length > 0) {
                        alert(`Missing required columns: ${missingHeaders.join(', ')}`);
                        return;
                    }
                    
                    // Phase 1: Parse and validate all rows, detect duplicates
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        if (values.length !== headers.length) continue;
                        
                        const rowData = {};
                        headers.forEach((header, index) => {
                            rowData[header] = values[index];
                        });
                        
                        // Validate category and subcategory
                        const category = rowData.category?.toLowerCase();
                        const subcategory = rowData.subcategory?.toUpperCase();
                        
                        if (!category || !categoryConfigs[category]) {
                            errors.push(`Row ${i + 1}: Invalid category "${rowData.category}"`);
                            continue;
                        }
                        
                        if (!subcategory || !categoryConfigs[category].subcategories.includes(subcategory)) {
                            errors.push(`Row ${i + 1}: Invalid subcategory "${rowData.subcategory}" for category "${category}"`);
                            continue;
                        }
                        
                        // Create component object (without KPN for now)
                        const component = {
                            category,
                            subcategory,
                            dateAdded: new Date().toISOString().split('T')[0],
                            status: 'Active',
                            rowNumber: i + 1
                        };
                        
                        // Map CSV fields to component fields - improved mapping logic
                        const config = categoryConfigs[category];
                        config.fields.forEach(field => {
                            // Get the field label and find the matching CSV field
                            const fieldLabel = field.label.toLowerCase();
                            const value = findMatchingCSVField(fieldLabel, field, rowData);
                            
                            // Store with underscored field name
                            component[field.id.replace(/-/g, '_')] = value || '';
                        });
                        
                        // Function to find matching CSV field
                        function findMatchingCSVField(fieldLabel, field, rowData) {
                            // Try exact match with the field label
                            for (const [csvKey, csvValue] of Object.entries(rowData)) {
                                if (csvKey.toLowerCase() === fieldLabel) {
                                    return csvValue;
                                }
                            }
                            
                            // Try common variations
                            const variations = [
                                fieldLabel.replace(/\s+/g, '-'),   // "manufacturer pn" -> "manufacturer-pn"
                                fieldLabel.replace(/\s+/g, '_'),   // "manufacturer pn" -> "manufacturer_pn" 
                                fieldLabel.replace(/\s+/g, ''),    // "manufacturer pn" -> "manufacturerpn"
                                field.id.replace(/-/g, '_'),       // "manufacturer-pn" -> "manufacturer_pn"
                                field.id                            // "manufacturer-pn"
                            ];
                            
                            for (const variation of variations) {
                                if (rowData[variation] !== undefined) {
                                    return rowData[variation];
                                }
                            }
                            
                            // Return empty string if no match is found
                            return '';
                        }
                        
                        // Check for duplicate components
                        const duplicateComponent = findDuplicateComponent(component);
                        if (duplicateComponent) {
                            duplicates.push({
                                component,
                                existingComponent: duplicateComponent,
                                choice: 'keep' // default choice
                            });
                        } else {
                            validComponents.push(component);
                        }
                    }
                    
                    // Show errors if any
                    if (errors.length > 0) {
                        console.log('Import validation errors:', errors);
                        alert(`Found ${errors.length} validation errors. Check console for details.`);
                    }
                    
                    // Store data for processing after user choices
                    pendingImportData = {
                        validComponents,
                        duplicates,
                        errors
                    };
                    
                    // Phase 2: If duplicates found, show modal for user choice
                    if (duplicates.length > 0) {
                        showDuplicateModal(duplicates);
                    } else {
                        // No duplicates, proceed with direct import
                        processFinalImport();
                    }
                    
                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
                
                // Clear the input
                fileInput.value = '';
            };
            
            reader.readAsText(file);
        }

        // Show duplicate confirmation modal
        function showDuplicateModal(duplicates) {
            const modal = document.getElementById('duplicate-modal');
            const duplicateList = document.getElementById('duplicate-list');
            
            // Clear previous content
            duplicateList.innerHTML = '';
            
            // Populate duplicate items
            duplicates.forEach((duplicate, index) => {
                const component = duplicate.component;
                const existing = duplicate.existingComponent;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'duplicate-item';
                
                // Create a user-friendly component description
                const componentDesc = createComponentDescription(component);
                const existingDesc = createComponentDescription(existing);
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'duplicate-item-header';
                const headerSpan = document.createElement('span');
                headerSpan.textContent = `‚ö†Ô∏è Row ${component.rowNumber}: ${componentDesc}`;
                headerDiv.appendChild(headerSpan);
                
                const existingDiv = document.createElement('div');
                existingDiv.className = 'duplicate-item-existing';
                const existingKpnStrong = document.createElement('strong');
                existingKpnStrong.textContent = 'Existing KPN:';
                existingDiv.appendChild(existingKpnStrong);
                existingDiv.appendChild(document.createTextNode(` ${existing.kpn}`));
                existingDiv.appendChild(document.createElement('br'));
                const detailsStrong = document.createElement('strong');
                detailsStrong.textContent = 'Details:';
                existingDiv.appendChild(detailsStrong);
                existingDiv.appendChild(document.createTextNode(` ${existingDesc}`));
                
                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'duplicate-choices';
                const keepInput = document.createElement('input');
                keepInput.type = 'radio';
                keepInput.id = `keep-${index}`;
                keepInput.name = `choice-${index}`;
                keepInput.value = 'keep';
                keepInput.checked = true;
                const keepLabel = document.createElement('label');
                keepLabel.htmlFor = `keep-${index}`;
                keepLabel.textContent = `‚úÖ Keep Existing KPN (${existing.kpn})`;
                choicesDiv.appendChild(keepInput);
                choicesDiv.appendChild(keepLabel);
                
                const newInput = document.createElement('input');
                newInput.type = 'radio';
                newInput.id = `new-${index}`;
                newInput.name = `choice-${index}`;
                newInput.value = 'new';
                const newLabel = document.createElement('label');
                newLabel.htmlFor = `new-${index}`;
                newLabel.textContent = '‚ûï Assign New KPN';
                choicesDiv.appendChild(newInput);
                choicesDiv.appendChild(newLabel);
                
                itemDiv.appendChild(headerDiv);
                itemDiv.appendChild(existingDiv);
                itemDiv.appendChild(choicesDiv);
                
                duplicateList.appendChild(itemDiv);
            });
            
            // Show modal
            modal.style.display = 'flex';
        }

        // Create user-friendly component description
        function createComponentDescription(component) {
            const category = component.category?.charAt(0).toUpperCase() + component.category?.slice(1);
            const subcategory = component.subcategory;
            
            // Create description based on component type
            switch(component.category) {
                case 'resistors':
                case 'inductors':
                    return `${category} ${component.value || 'N/A'} ${component.package || 'N/A'} ${component.tolerance || ''}`.trim();
                case 'capacitors':
                    return `${category} ${component.value || 'N/A'} ${component.package || 'N/A'} ${component.voltage_rating || ''}`.trim();
                case 'ics':
                case 'diodes':
                case 'transistors':
                case 'connectors':
                case 'switches':
                    return `${category} ${component.manufacturer_pn || component.description || 'N/A'}`.trim();
                default:
                    return `${category} ${subcategory}`;
            }
        }

        // Process user choices and handle final import
        function processDuplicateChoices() {
            const duplicates = pendingImportData.duplicates;
            
            // Collect user choices
            duplicates.forEach((duplicate, index) => {
                const keepRadio = document.getElementById(`keep-${index}`);
                const newRadio = document.getElementById(`new-${index}`);
                
                if (keepRadio.checked) {
                    duplicate.choice = 'keep';
                } else if (newRadio.checked) {
                    duplicate.choice = 'new';
                }
            });
            
            // Hide modal and process import
            document.getElementById('duplicate-modal').style.display = 'none';
            processFinalImport();
        }

        // Cancel import process
        function cancelDuplicateImport() {
            document.getElementById('duplicate-modal').style.display = 'none';
            pendingImportData = null;
            duplicateResults = [];
            alert('Import cancelled.');
        }

        // Process final import with user choices
        function processFinalImport() {
            if (!pendingImportData) return;
            
            const { validComponents, duplicates, errors } = pendingImportData;
            let importedCount = 0;
            let reusedCount = 0;
            let reassignedCount = 0;
            let componentsToAdd = [];
            let kpnCounter = 0; // Initialize counter for KPN generation
            
            // Add all non-duplicate components
            validComponents.forEach(component => {
                // Generate KPN for new component
                const kpn = generateKPNForComponent(component, kpnCounter);
                kpnCounter++;
                component.kpn = kpn;
                componentsToAdd.push(component);
                importedCount++;
            });
            
            // Process duplicate choices
            duplicates.forEach(duplicate => {
                if (duplicate.choice === 'new') {
                    // User chose to assign new KPN
                    const kpn = generateKPNForComponent(duplicate.component, importedCount + reassignedCount);
                    duplicate.component.kpn = kpn;
                    componentsToAdd.push(duplicate.component);
                    reassignedCount++;
                } else {
                    // User chose to keep existing - do nothing (reuse existing)
                    reusedCount++;
                }
            });
            
            // Add components to data
            data.components.push(...componentsToAdd);
            
            // Save and refresh UI
            if (componentsToAdd.length > 0) {
                saveData();
                renderComponents();
            }
            
            // Show comprehensive import summary
            showImportSummary(importedCount, reusedCount, reassignedCount, errors.length);
            
            // Reset pending data
            pendingImportData = null;
            duplicateResults = [];
        }

        // Generate KPN for a component during import
        function generateKPNForComponent(component, offset = 0) {
            const { category, subcategory } = component;
            const config = categoryConfigs[category];
            
            const existingKPNs = data.components
                .filter(c => c.kpn.startsWith(`${config.code}-${subcategory}`))
                .map(c => parseInt(c.kpn.split('-')[2]))
                .filter(n => !isNaN(n));
            
            const nextNumber = existingKPNs.length > 0 ? existingKPNs.reduce((max, n) => Math.max(max, n), -Infinity) + 1 + offset : 1 + offset;
            return `${config.code}-${subcategory}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Show detailed import summary
        function showImportSummary(newCount, reusedCount, reassignedCount, errorCount) {
            const totalProcessed = newCount + reusedCount + reassignedCount;
            
            let message = 'üìä Import Summary:\n\n';
            message += `‚úÖ New components created: ${newCount}\n`;
            message += `üîÑ Existing components reused: ${reusedCount}\n`;
            message += `‚ûï Components force-assigned new KPN: ${reassignedCount}\n`;
            message += `üìã Total components processed: ${totalProcessed}\n`;
            
            if (errorCount > 0) {
                message += `‚ùå Validation errors: ${errorCount} (check console)\n`;
            }
            
            message += '\nüéâ Import completed successfully!';
            
            alert(message);
        }

        // Export CSV template for component import
        function exportTemplate() {
            // Create template with all possible fields from all categories
            const allFields = new Set(['Category', 'Subcategory']);
            Object.values(categoryConfigs).forEach(config => {
                config.fields.forEach(field => {
                    allFields.add(field.label);
                });
            });
            
            const headers = Array.from(allFields);
            let csv = headers.join(',') + '\n';
            
            // Add comprehensive example rows for ALL component categories
            const examples = [
                // RESISTORS - Standard, Precision, Variable, Networks
                {
                    category: 'resistors',
                    subcategory: 'STD',
                    data: {
                        'Value': '10k',
                        'Package': '0805', 
                        'Tolerance': '1%',
                        'Temp Rating': '-55¬∞C to +125¬∞C',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                {
                    category: 'resistors',
                    subcategory: 'PRE',
                    data: {
                        'Value': '4.7k',
                        'Package': '0603', 
                        'Tolerance': '0.1%',
                        'Temp Rating': '-55¬∞C to +155¬∞C',
                        'Preferred Vendor': 'Digi-Key'
                    }
                },
                {
                    category: 'resistors',
                    subcategory: 'VAR',
                    data: {
                        'Value': '10k',
                        'Package': '3296W', 
                        'Tolerance': '10%',
                        'Temp Rating': '-40¬∞C to +85¬∞C',
                        'Preferred Vendor': 'Newark'
                    }
                },
                
                // CAPACITORS - Ceramic, Electrolytic, Tantalum, Film
                {
                    category: 'capacitors', 
                    subcategory: 'CER',
                    data: {
                        'Value': '100nF',
                        'Package': '0805',
                        'Tolerance': '10%', 
                        'Voltage': '50V',
                        'Rating': 'X7R',
                        'Preferred Vendor': 'Digi-Key'
                    }
                },
                {
                    category: 'capacitors', 
                    subcategory: 'ELE',
                    data: {
                        'Value': '470uF',
                        'Package': '8x12mm',
                        'Tolerance': '20%', 
                        'Voltage': '25V',
                        'Rating': 'Low ESR',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                {
                    category: 'capacitors', 
                    subcategory: 'TAN',
                    data: {
                        'Value': '22uF',
                        'Package': '1206',
                        'Tolerance': '10%', 
                        'Voltage': '16V',
                        'Rating': 'Industrial',
                        'Preferred Vendor': 'Arrow'
                    }
                },
                {
                    category: 'capacitors', 
                    subcategory: 'FIL',
                    data: {
                        'Value': '1uF',
                        'Package': '1210',
                        'Tolerance': '5%', 
                        'Voltage': '250V',
                        'Rating': 'X2',
                        'Preferred Vendor': 'Farnell'
                    }
                },
                
                // INTEGRATED CIRCUITS - MCU, Analog, Digital, Power
                {
                    category: 'ics',
                    subcategory: 'MCU', 
                    data: {
                        'Manufacturer PN': 'STM32F103C8T6',
                        'Description': '32-bit ARM Cortex-M3 MCU 72MHz',
                        'Package': 'LQFP-48',
                        'Rating': 'Industrial',
                        'Datasheet/Product Link': 'https://www.st.com/stm32f103c8',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                {
                    category: 'ics',
                    subcategory: 'ANA', 
                    data: {
                        'Manufacturer PN': 'LM358DR',
                        'Description': 'Dual Operational Amplifier',
                        'Package': 'SOIC-8',
                        'Rating': 'Industrial',
                        'Datasheet/Product Link': 'https://www.ti.com/product/LM358',
                        'Preferred Vendor': 'Digi-Key'
                    }
                },
                {
                    category: 'ics',
                    subcategory: 'DIG', 
                    data: {
                        'Manufacturer PN': '74HC595D',
                        'Description': '8-bit Serial-In Parallel-Out Shift Register',
                        'Package': 'SOIC-16',
                        'Rating': 'Commercial',
                        'Datasheet/Product Link': 'https://www.nxp.com/products/logic/shift-registers',
                        'Preferred Vendor': 'Newark'
                    }
                },
                {
                    category: 'ics',
                    subcategory: 'PWR', 
                    data: {
                        'Manufacturer PN': 'LM2596S-5.0',
                        'Description': 'Step-Down Voltage Regulator 5V 3A',
                        'Package': 'TO-263-5',
                        'Rating': 'Industrial',
                        'Datasheet/Product Link': 'https://www.ti.com/product/LM2596',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                
                // INDUCTORS - Power, Choke, Ferrite
                {
                    category: 'inductors',
                    subcategory: 'PWR',
                    data: {
                        'Value': '22uH',
                        'Package': '1210',
                        'Tolerance': '20%',
                        'Current Rating': '2A',
                        'Preferred Vendor': 'Coilcraft'
                    }
                },
                {
                    category: 'inductors',
                    subcategory: 'CHK',
                    data: {
                        'Value': '100uH',
                        'Package': '0805',
                        'Tolerance': '10%',
                        'Current Rating': '500mA',
                        'Preferred Vendor': 'Murata'
                    }
                },
                {
                    category: 'inductors',
                    subcategory: 'FER',
                    data: {
                        'Value': '220nH',
                        'Package': '0603',
                        'Tolerance': '25%',
                        'Current Rating': '200mA',
                        'Preferred Vendor': 'TDK'
                    }
                },
                
                // DIODES - Standard, LED, Zener, Schottky
                {
                    category: 'diodes',
                    subcategory: 'STD',
                    data: {
                        'Manufacturer PN': '1N4148WS',
                        'Package': 'SOD-323',
                        'Voltage Rating': '75V',
                        'Current Rating': '150mA',
                        'Preferred Vendor': 'Vishay'
                    }
                },
                {
                    category: 'diodes',
                    subcategory: 'LED',
                    data: {
                        'Manufacturer PN': 'LTST-C170KRKT',
                        'Package': '0805',
                        'Voltage Rating': '2.1V',
                        'Current Rating': '20mA',
                        'Preferred Vendor': 'Lite-On'
                    }
                },
                {
                    category: 'diodes',
                    subcategory: 'ZEN',
                    data: {
                        'Manufacturer PN': 'BZX84C5V1',
                        'Package': 'SOT-23',
                        'Voltage Rating': '5.1V',
                        'Current Rating': '250mA',
                        'Preferred Vendor': 'NXP'
                    }
                },
                {
                    category: 'diodes',
                    subcategory: 'SCH',
                    data: {
                        'Manufacturer PN': 'BAT54S',
                        'Package': 'SOT-23',
                        'Voltage Rating': '30V',
                        'Current Rating': '200mA',
                        'Preferred Vendor': 'Infineon'
                    }
                },
                
                // TRANSISTORS - BJT, FET, MOSFET
                {
                    category: 'transistors',
                    subcategory: 'BJT',
                    data: {
                        'Manufacturer PN': 'MMBT3904',
                        'Package': 'SOT-23',
                        'Voltage Rating': '40V',
                        'Current Rating': '200mA',
                        'Preferred Vendor': 'ON Semi'
                    }
                },
                {
                    category: 'transistors',
                    subcategory: 'FET',
                    data: {
                        'Manufacturer PN': '2N7002K',
                        'Package': 'SOT-23',
                        'Voltage Rating': '60V',
                        'Current Rating': '300mA',
                        'Preferred Vendor': 'Nexperia'
                    }
                },
                {
                    category: 'transistors',
                    subcategory: 'MOS',
                    data: {
                        'Manufacturer PN': 'BSS138',
                        'Package': 'SOT-23',
                        'Voltage Rating': '50V',
                        'Current Rating': '220mA',
                        'Preferred Vendor': 'Fairchild'
                    }
                },
                
                // CONNECTORS - Header, JST, USB, RJ45
                {
                    category: 'connectors',
                    subcategory: 'HDR',
                    data: {
                        'Manufacturer PN': 'TSW-102-07-G-S',
                        'Description': '2-pin 0.1" header socket',
                        'Pitch': '2.54mm',
                        'Pins': '2',
                        'Preferred Vendor': 'Samtec'
                    }
                },
                {
                    category: 'connectors',
                    subcategory: 'JST',
                    data: {
                        'Manufacturer PN': 'B4B-XH-A(LF)(SN)',
                        'Description': '4-pin JST XH connector',
                        'Pitch': '2.5mm',
                        'Pins': '4',
                        'Preferred Vendor': 'JST'
                    }
                },
                {
                    category: 'connectors',
                    subcategory: 'USB',
                    data: {
                        'Manufacturer PN': 'USB4085-GF-A',
                        'Description': 'USB-C receptacle',
                        'Pitch': '0.5mm',
                        'Pins': '24',
                        'Preferred Vendor': 'GCT'
                    }
                },
                {
                    category: 'connectors',
                    subcategory: 'RJ45',
                    data: {
                        'Manufacturer PN': 'SI-60062-F',
                        'Description': 'RJ45 Ethernet connector with LEDs',
                        'Pitch': '1.27mm',
                        'Pins': '8',
                        'Preferred Vendor': 'Bel Fuse'
                    }
                },
                
                // SWITCHES - Tactile, DIP, Rotary, Slide
                {
                    category: 'switches',
                    subcategory: 'TAC',
                    data: {
                        'Manufacturer PN': 'SKHHPNA010',
                        'Description': 'Tactile switch 4.3x4.3mm',
                        'Package': '4.3x4.3mm',
                        'Actuation Force': '160gf',
                        'Preferred Vendor': 'Alps'
                    }
                },
                {
                    category: 'switches',
                    subcategory: 'DIP',
                    data: {
                        'Manufacturer PN': 'DS01-254-1-04BK-SMT',
                        'Description': '4-position DIP switch',
                        'Package': 'SMT',
                        'Actuation Force': '250gf',
                        'Preferred Vendor': 'CTS'
                    }
                },
                {
                    category: 'switches',
                    subcategory: 'ROT',
                    data: {
                        'Manufacturer PN': 'PEC11R-4015F-S0024',
                        'Description': 'Rotary encoder with switch',
                        'Package': 'Through-hole',
                        'Actuation Force': '200gf',
                        'Preferred Vendor': 'Bourns'
                    }
                },
                {
                    category: 'switches',
                    subcategory: 'SLI',
                    data: {
                        'Manufacturer PN': 'SS12D00G3',
                        'Description': 'SPDT slide switch',
                        'Package': '4.5x1.8mm',
                        'Actuation Force': '120gf',
                        'Preferred Vendor': 'E-Switch'
                    }
                }
            ];
            
            examples.forEach(example => {
                const row = headers.map(header => {
                    if (header === 'Category') return example.category;
                    if (header === 'Subcategory') return example.subcategory;
                    return example.data[header] || '';
                });
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            downloadCSV(csv, 'kinben-components-template.csv');
        }

        // Current BOM items for PCB form
        let currentBOM = [];
        let currentMotherComponents = [];

        // Add BOM item
        function addBOMItem() {
            const kpn = document.getElementById('bom-kpn').value;
            const quantity = parseInt(document.getElementById('bom-quantity').value);
            const refdes = document.getElementById('bom-refdes').value;
            
            if (!kpn || !quantity || !refdes) {
                alert('Please fill in all BOM fields');
                return;
            }
            
            const component = data.components.find(c => c.kpn === kpn);
            if (!component) {
                alert('Component not found');
                return;
            }
            
            const bomItem = {
                kpn,
                componentName: `${component.manufacturer} ${component.partNumber}`,
                quantity,
                refdes
            };
            
            currentBOM.push(bomItem);
            renderBOMItems();
            
            // Clear form
            document.getElementById('bom-kpn').value = '';
            document.getElementById('bom-quantity').value = '1';
            document.getElementById('bom-refdes').value = '';
        }

        // Remove BOM item
        function removeBOMItem(index) {
            currentBOM.splice(index, 1);
            renderBOMItems();
        }

        // Render BOM items
        function renderBOMItems() {
            const container = document.getElementById('bom-items');
            container.innerHTML = '';
            
            currentBOM.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bom-row';
                div.innerHTML = `
                    <span>${item.componentName}</span>
                    <span>Qty: ${item.quantity}</span>
                    <span>RefDes: ${item.refdes}</span>
                    <button class="remove-btn" onclick="removeBOMItem(${index})">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        // Add Assembly
        function addAssembly() {
            const name = document.getElementById('assembly-name').value;
            const assemblyType = document.getElementById('assemblyType').value;
            const version = document.getElementById('assembly-version').value;
            const status = document.getElementById('assembly-status').value;
            const description = document.getElementById('assembly-description').value;
            
            // Collect cable-specific data if cable assembly
            const cableLength = document.getElementById('cableLength').value;
            const cableType = document.getElementById('cableType').value;
            
            if (!name || !assemblyType || !version || (currentBOM.length === 0 && currentMotherComponents.length === 0)) {
                alert('Please fill in assembly details and add at least one BOM item or assembly component');
                return;
            }
            
            const assembly = {
                name,
                type: assemblyType,
                version,
                status,
                description,
                // Type-specific data
                pcbData: assemblyType === 'pcb' ? {
                    bom: [...currentBOM]
                } : null,
                cableData: assemblyType === 'cable' ? {
                    length: cableLength ? parseInt(cableLength) : null,
                    cableType: cableType || null,
                    bom: [...currentBOM]
                } : null,
                // Assembly-level components (mother view)
                motherComponents: [...currentMotherComponents],
                // Legacy field for backward compatibility
                bom: [...currentBOM],
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            data.assemblies.push(assembly);
            saveData();
            renderAssemblies();
            
            // Clear form
            document.getElementById('assembly-name').value = '';
            document.getElementById('assemblyType').selectedIndex = 0;
            document.getElementById('assembly-version').value = '';
            document.getElementById('assembly-description').value = '';
            document.getElementById('cableLength').value = '';
            document.getElementById('cableType').value = '';
            currentBOM = [];
            currentMotherComponents = [];
            renderBOMItems();
            renderMotherComponents();
            toggleAssemblyFields(); // Reset field visibility
        }

        // Toggle assembly type-specific fields
        function toggleAssemblyFields() {
            const assemblyType = document.getElementById('assemblyType').value;
            const cableFields = document.getElementById('cableFields');
            
            if (assemblyType === 'cable') {
                cableFields.style.display = 'block';
            } else {
                cableFields.style.display = 'none';
            }
        }

        // Current system items
        let currentSystemItems = [];

        // Add system item
        function addSystemItem() {
            const itemType = document.getElementById('system-item-type').value;
            const itemValue = document.getElementById('system-pcb').value;
            const quantity = parseInt(document.getElementById('system-pcb-quantity').value);
            
            if (!itemType || !itemValue || !quantity) {
                alert('Please select item type, item, and quantity');
                return;
            }
            
            let itemName = '';
            let itemVersion = '';
            
            if (itemType === 'assembly') {
                const assembly = data.assemblies.find(a => a.name === itemValue);
                if (!assembly) {
                    alert('Assembly not found');
                    return;
                }
                itemName = assembly.name;
                itemVersion = assembly.version;
            } else if (['mechanical', 'printed3d', 'cable'].includes(itemType)) {
                const component = data.components.find(c => c.kpn === itemValue);
                if (!component) {
                    alert('Component not found');
                    return;
                }
                itemName = component.kpn;
                itemVersion = component.description || component.manufacturer_pn || 'Unknown';
            } else if (itemType === 'system') {
                const system = data.systems.find(s => s.name === itemValue);
                if (!system) {
                    alert('System not found');
                    return;
                }
                itemName = system.name;
                itemVersion = system.version;
            }
            
            const systemItem = {
                type: itemType,
                value: itemValue,
                name: itemName,
                version: itemVersion,
                quantity
            };
            
            currentSystemItems.push(systemItem);
            renderSystemItems();
            
            // Clear form
            document.getElementById('system-item-type').value = '';
            document.getElementById('system-pcb').value = '';
            document.getElementById('system-pcb-quantity').value = '1';
            updateSystemItemOptions();
        }

        // Remove system item
        function removeSystemItem(index) {
            currentSystemItems.splice(index, 1);
            renderSystemItems();
        }

        // Render system items with enhanced display and calculations
        function renderSystemItems() {
            const container = document.getElementById('system-items');
            
            if (currentSystemItems.length === 0) {
                container.innerHTML = `
                    <div class="system-items-empty">
                        <p style="text-align: center; color: #6c757d; padding: 20px; font-style: italic;">
                            No items added to this system yet. Use the form above to add assemblies, components, or other systems.
                        </p>
                    </div>
                `;
                return;
            }
            
            // Calculate totals for the system
            let totalComponents = 0;
            let totalAssemblies = 0;
            let totalOtherItems = 0;
            
            let itemsHtml = '<div class="system-items-grid">';
            
            currentSystemItems.forEach((item, index) => {
                let itemIcon = '';
                let itemType = '';
                let calculationDetails = '';
                let componentImpact = 0;
                
                switch(item.type) {
                    case 'assembly':
                        const assembly = data.assemblies.find(a => a.name === item.name);
                        if (assembly) {
                            const calc = calculateAssemblyQuantities(assembly);
                            componentImpact = calc.totalQuantity * item.quantity;
                            totalComponents += componentImpact;
                            totalAssemblies += item.quantity;
                            itemIcon = 'üèóÔ∏è';
                            itemType = `${assembly.type === 'pcb' ? 'PCB' : 'Cable'} Assembly`;
                            calculationDetails = `
                                <div class="item-calculation">
                                    <small>Components: ${calc.totalQuantity} √ó ${item.quantity} = <strong>${componentImpact}</strong></small>
                                </div>
                            `;
                        }
                        break;
                    case 'mechanical':
                    case 'printed3d':
                    case 'cable':
                        componentImpact = item.quantity;
                        totalComponents += componentImpact;
                        totalOtherItems += item.quantity;
                        itemIcon = 'üîß';
                        itemType = `${item.type.charAt(0).toUpperCase() + item.type.slice(1)} Part`;
                        calculationDetails = `
                            <div class="item-calculation">
                                <small>Direct parts: <strong>${item.quantity}</strong></small>
                            </div>
                        `;
                        break;
                    case 'system':
                        const system = data.systems.find(s => s.name === item.name);
                        if (system) {
                            const systemTotals = calculateSystemTotals(system);
                            componentImpact = systemTotals.totalQuantity * item.quantity;
                            totalComponents += componentImpact;
                            totalOtherItems += item.quantity;
                            itemIcon = 'üè¢';
                            itemType = 'Nested System';
                            calculationDetails = `
                                <div class="item-calculation">
                                    <small>System components: ${systemTotals.totalQuantity} √ó ${item.quantity} = <strong>${componentImpact}</strong></small>
                                </div>
                            `;
                        }
                        break;
                }
                
                itemsHtml += `
                    <div class="system-item-card">
                        <div class="system-item-header">
                            <span class="system-item-icon">${itemIcon}</span>
                            <span class="system-item-name">${item.name}</span>
                            <span class="system-item-quantity">√ó ${item.quantity}</span>
                            <button class="remove-btn" onclick="removeSystemItem(${index})" title="Remove item">√ó</button>
                        </div>
                        <div class="system-item-details">
                            <div class="system-item-type">${itemType}</div>
                            <div class="system-item-version">Version: ${item.version || 'N/A'}</div>
                            ${calculationDetails}
                        </div>
                    </div>
                `;
            });
            
            itemsHtml += '</div>';
            
            // Add system summary
            const summaryHtml = `
                <div class="system-build-summary">
                    <h4>üìä System Build Summary</h4>
                    <div class="system-summary-stats">
                        <div class="summary-stat">
                            <span class="stat-value">${totalAssemblies}</span>
                            <span class="stat-label">Assemblies</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-value">${totalOtherItems}</span>
                            <span class="stat-label">Other Items</span>
                        </div>
                        <div class="summary-stat total-stat">
                            <span class="stat-value">${totalComponents}</span>
                            <span class="stat-label">Total Components</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = summaryHtml + itemsHtml;
            
            // Enable inline quantity editing
            setTimeout(() => {
                addQuickQuantityEdit();
            }, 100);
        }

        // Add or update system
        function addSystem() {
            const name = document.getElementById('system-name').value.trim();
            const version = document.getElementById('system-version').value.trim();
            const status = document.getElementById('system-status').value;
            const description = document.getElementById('system-description').value.trim();
            const isEditing = typeof window.editingSystemIndex !== 'undefined';
            
            if (!name || !version || currentSystemItems.length === 0) {
                alert('Please fill in system details and add at least one item');
                return;
            }
            
            // Check for duplicate name (exclude current system if editing)
            const existingSystem = data.systems.find((sys, index) => 
                sys.name.toLowerCase() === name.toLowerCase() && 
                (!isEditing || index !== window.editingSystemIndex)
            );
            
            if (existingSystem) {
                alert(`A system with the name "${name}" already exists. Please choose a different name.`);
                return;
            }
            
            const systemData = {
                name,
                version,
                status,
                description,
                items: [...currentSystemItems],
                dateAdded: isEditing ? data.systems[window.editingSystemIndex].dateAdded : new Date().toISOString().split('T')[0],
                lastModified: new Date().toISOString().split('T')[0]
            };
            
            if (isEditing) {
                // Update existing system
                data.systems[window.editingSystemIndex] = systemData;
                alert(`System "${name}" has been updated successfully.`);
                cancelSystemEdit(); // Reset form and edit mode
            } else {
                // Add new system
                data.systems.push(systemData);
                alert(`System "${name}" has been added successfully.`);
                
                // Clear form
                document.getElementById('system-name').value = '';
                document.getElementById('system-version').value = '';
                document.getElementById('system-description').value = '';
                document.getElementById('system-status').value = 'Active';
                currentSystemItems = [];
                renderSystemItems();
            }
            
            saveData();
            renderSystems();
            updateStats();
        }

        // Update dropdowns
        // Update system item options based on selected type
        function updateSystemItemOptions() {
            const type = document.getElementById('system-item-type').value;
            const itemSelect = document.getElementById('system-pcb');
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            
            // Clear preview when type changes
            document.getElementById('system-item-preview').style.display = 'none';
            document.getElementById('system-quantity-info').textContent = '';
            
            if (type === 'assembly') {
                // Show assemblies
                data.assemblies.forEach(assembly => {
                    if (assembly.status === 'Active') {
                        const option = document.createElement('option');
                        option.value = assembly.name;
                        option.textContent = `${assembly.name} (${assembly.version})`;
                        itemSelect.appendChild(option);
                    }
                });
            } else if (['mechanical', 'printed3d', 'cable'].includes(type)) {
                // Show components of the selected type
                data.components.forEach(comp => {
                    if (comp.status === 'Active' && comp.category === type) {
                        const option = document.createElement('option');
                        option.value = comp.kpn;
                        option.textContent = `${comp.kpn} - ${comp.description || comp.manufacturer_pn || 'Unknown'}`;
                        itemSelect.appendChild(option);
                    }
                });
            } else if (type === 'system') {
                // Show other systems (excluding current one being edited to prevent circular references)
                const currentSystemName = document.getElementById('system-name').value.trim();
                let availableSystems = 0;
                
                data.systems.forEach(system => {
                    if (system.status === 'Active' && system.name !== currentSystemName) {
                        const option = document.createElement('option');
                        option.value = system.name;
                        option.textContent = `${system.name} (${system.version})`;
                        itemSelect.appendChild(option);
                        availableSystems++;
                    }
                });
                
                // Show message if no systems available
                if (availableSystems === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = currentSystemName ? 
                        'No other systems available (circular reference prevention)' : 
                        'No other systems available';
                    option.disabled = true;
                    itemSelect.appendChild(option);
                }
            }
        }
        
        // Update system item preview with quantity calculations
        function updateSystemItemPreview() {
            const type = document.getElementById('system-item-type').value;
            const itemValue = document.getElementById('system-pcb').value;
            const quantity = parseInt(document.getElementById('system-pcb-quantity').value) || 1;
            const previewDiv = document.getElementById('system-item-preview');
            const previewContent = document.getElementById('system-item-preview-content');
            const quantityInfo = document.getElementById('system-quantity-info');
            
            // Clear preview if no item selected
            if (!type || !itemValue) {
                previewDiv.style.display = 'none';
                quantityInfo.textContent = '';
                return;
            }
            
            let previewHtml = '';
            let infoText = '';
            
            if (type === 'assembly') {
                const assembly = data.assemblies.find(a => a.name === itemValue);
                if (assembly) {
                    const calculations = calculateAssemblyQuantities(assembly);
                    const totalComponents = calculations.totalQuantity;
                    const totalSystemComponents = totalComponents * quantity;
                    
                    infoText = `(${totalComponents} components √ó ${quantity} = ${totalSystemComponents} total)`;
                    
                    previewHtml = `
                        <div class="item-preview-card">
                            <div class="item-preview-header">
                                <span class="item-preview-name">üèóÔ∏è ${assembly.name} (${assembly.version})</span>
                                <span class="item-preview-quantity">√ó ${quantity}</span>
                            </div>
                            <div class="item-preview-details">
                                <strong>Type:</strong> ${assembly.type === 'pcb' ? 'PCB Assembly' : 'Cable Assembly'}<br>
                                <strong>Description:</strong> ${assembly.description}<br>
                                <strong>Status:</strong> ${assembly.status}
                            </div>
                            <div class="item-preview-calculation">
                                <strong>Component Impact:</strong><br>
                                ‚Ä¢ BOM Components: ${calculations.bomComponents.length} items (${calculations.bomComponents.reduce((sum, c) => sum + c.calculatedQuantity, 0)} total qty)<br>
                                ‚Ä¢ Assembly Components: ${calculations.motherComponents.length} items (${calculations.motherComponents.reduce((sum, c) => sum + c.calculatedQuantity, 0)} total qty)<br>
                                ‚Ä¢ System Multiplier: ${totalComponents} √ó ${quantity} = <strong>${totalSystemComponents} total components</strong>
                            </div>
                        </div>
                    `;
                }
            } else if (['mechanical', 'printed3d', 'cable'].includes(type)) {
                const component = data.components.find(c => c.kpn === itemValue);
                if (component) {
                    infoText = `(${quantity} ${type} part${quantity > 1 ? 's' : ''})`;
                    
                    previewHtml = `
                        <div class="item-preview-card">
                            <div class="item-preview-header">
                                <span class="item-preview-name">üîß ${component.kpn}</span>
                                <span class="item-preview-quantity">√ó ${quantity}</span>
                            </div>
                            <div class="item-preview-details">
                                <strong>Type:</strong> ${type.charAt(0).toUpperCase() + type.slice(1)} Part<br>
                                <strong>Description:</strong> ${component.description || 'N/A'}<br>
                                <strong>Manufacturer:</strong> ${component.manufacturer || 'N/A'}<br>
                                <strong>Status:</strong> ${component.status}
                            </div>
                            <div class="item-preview-calculation">
                                <strong>System Impact:</strong> ${quantity} √ó ${component.kpn} = <strong>${quantity} total units</strong>
                            </div>
                        </div>
                    `;
                }
            } else if (type === 'system') {
                const system = data.systems.find(s => s.name === itemValue);
                if (system) {
                    const systemTotals = calculateSystemTotals(system);
                    const totalSystemComponents = systemTotals.totalQuantity * quantity;
                    
                    infoText = `(${systemTotals.totalQuantity} components √ó ${quantity} = ${totalSystemComponents} total)`;
                    
                    previewHtml = `
                        <div class="item-preview-card">
                            <div class="item-preview-header">
                                <span class="item-preview-name">üè¢ ${system.name} (${system.version})</span>
                                <span class="item-preview-quantity">√ó ${quantity}</span>
                            </div>
                            <div class="item-preview-details">
                                <strong>Type:</strong> System<br>
                                <strong>Description:</strong> ${system.description}<br>
                                <strong>Status:</strong> ${system.status}<br>
                                <strong>Contains:</strong> ${systemTotals.totalAssemblies} assemblies, ${systemTotals.consolidatedComponents.size} unique components
                            </div>
                            <div class="item-preview-calculation">
                                <strong>System Impact:</strong><br>
                                ‚Ä¢ Nested System: ${systemTotals.totalQuantity} components<br>
                                ‚Ä¢ System Multiplier: ${systemTotals.totalQuantity} √ó ${quantity} = <strong>${totalSystemComponents} total components</strong>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Update the UI
            quantityInfo.textContent = infoText;
            previewContent.innerHTML = previewHtml;
            previewDiv.style.display = previewHtml ? 'block' : 'none';
        }

        // Update BOM item options based on selected type
        function updateBOMItemOptions() {
            const type = document.getElementById('bom-type').value;
            const bomSelect = document.getElementById('bom-kpn');
            bomSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (type === 'component') {
                // Show electronic components (excluding PCB, mechanical, 3D-printed, cable categories)
                data.components.forEach(comp => {
                    if (comp.status === 'Active' && !['pcb', 'mechanical', 'printed3d', 'cable'].includes(comp.category)) {
                        const option = document.createElement('option');
                        option.value = comp.kpn;
                        option.textContent = `${comp.kpn} - ${comp.manufacturer || comp.manufacturer_pn || 'Unknown'} ${comp.partNumber || comp.value || ''}`;
                        bomSelect.appendChild(option);
                    }
                });
            } else if (['pcb', 'mechanical', 'printed3d', 'cable'].includes(type)) {
                // Show components of the selected type
                data.components.forEach(comp => {
                    if (comp.status === 'Active' && comp.category === type) {
                        const option = document.createElement('option');
                        option.value = comp.kpn;
                        option.textContent = `${comp.kpn} - ${comp.description || comp.manufacturer_pn || 'Unknown'}`;
                        bomSelect.appendChild(option);
                    }
                });
            }
        }

        function updateDropdowns() {
            // Update BOM KPN dropdown - now handled by updateBOMItemOptions
            updateBOMItemOptions();
            
            // Update system item dropdown
            updateSystemItemOptions();
        }

        // Render functions
        // Sorting state
        let componentSortColumn = null;
        let componentSortDirection = 'asc';
        let assemblySortColumn = null;
        let assemblySortDirection = 'asc';
        let systemSortColumn = null;
        let systemSortDirection = 'asc';
        
        // Sort components table
        function sortComponents(column) {
            // Toggle direction if same column, otherwise default to ascending
            if (componentSortColumn === column) {
                componentSortDirection = componentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                componentSortColumn = column;
                componentSortDirection = 'asc';
            }
            
            // Update header styling
            document.querySelectorAll('#components-table .sortable').forEach(th => {
                th.className = 'sortable';
            });
            document.querySelector(`#components-table .sortable:nth-child(${getComponentColumnIndex(column)})`).className = 
                `sortable sort-${componentSortDirection}`;
            
            // Sort the data
            data.components.sort((a, b) => {
                let aVal = getComponentValue(a, column);
                let bVal = getComponentValue(b, column);
                
                // Handle numeric sorting for KPN
                if (column === 'kpn') {
                    const aNum = parseInt(aVal.split('-').pop());
                    const bNum = parseInt(bVal.split('-').pop());
                    aVal = aNum || 0;
                    bVal = bNum || 0;
                }
                
                let comparison = 0;
                if (aVal < bVal) comparison = -1;
                if (aVal > bVal) comparison = 1;
                
                return componentSortDirection === 'desc' ? -comparison : comparison;
            });
            
            renderComponents();
        }
        
        // Sort assemblies table
        function sortAssemblies(column) {
            if (assemblySortColumn === column) {
                assemblySortDirection = assemblySortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                assemblySortColumn = column;
                assemblySortDirection = 'asc';
            }
            
            // Update header styling
            document.querySelectorAll('#assemblies-table .sortable').forEach(th => {
                th.className = 'sortable';
            });
            document.querySelector(`#assemblies-table .sortable:nth-child(${getAssemblyColumnIndex(column)})`).className = 
                `sortable sort-${assemblySortDirection}`;
            
            // Sort the data
            data.assemblies.sort((a, b) => {
                let aVal = getAssemblyValue(a, column);
                let bVal = getAssemblyValue(b, column);
                
                let comparison = 0;
                if (aVal < bVal) comparison = -1;
                if (aVal > bVal) comparison = 1;
                
                return assemblySortDirection === 'desc' ? -comparison : comparison;
            });
            
            renderAssemblies();
        }
        
        // Sort systems table
        function sortSystems(column) {
            if (systemSortColumn === column) {
                systemSortDirection = systemSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                systemSortColumn = column;
                systemSortDirection = 'asc';
            }
            
            // Update header styling
            document.querySelectorAll('#systems-table .sortable').forEach(th => {
                th.className = 'sortable';
            });
            document.querySelector(`#systems-table .sortable:nth-child(${getSystemColumnIndex(column)})`).className = 
                `sortable sort-${systemSortDirection}`;
            
            // Sort the data
            data.systems.sort((a, b) => {
                let aVal = getSystemValue(a, column);
                let bVal = getSystemValue(b, column);
                
                let comparison = 0;
                if (aVal < bVal) comparison = -1;
                if (aVal > bVal) comparison = 1;
                
                return systemSortDirection === 'desc' ? -comparison : comparison;
            });
            
            renderSystems();
        }
        
        // Helper functions for sorting
        function getComponentValue(component, column) {
            switch(column) {
                case 'kpn': return component.kpn || '';
                case 'category': return component.category || '';
                case 'subcategory': return component.subcategory || '';
                case 'value': return component.value || component.manufacturerPn || '';
                case 'package': return component.package || '';
                case 'manufacturer': return component.manufacturer || '';
                case 'preferredVendor': return component.preferredVendor || '';
                default: return '';
            }
        }
        
        function getAssemblyValue(assembly, column) {
            switch(column) {
                case 'name': return assembly.name || '';
                case 'version': return assembly.version || '';
                case 'description': return assembly.description || '';
                case 'itemCount': return assembly.bom ? assembly.bom.length : 0;
                case 'status': return assembly.status || '';
                default: return '';
            }
        }
        
        function getSystemValue(system, column) {
            switch(column) {
                case 'name': return system.name || '';
                case 'version': return system.version || '';
                case 'description': return system.description || '';
                case 'itemCount': return system.items ? system.items.length : (system.pcbs ? system.pcbs.length : 0);
                case 'status': return system.status || '';
                default: return '';
            }
        }
        
        function getComponentColumnIndex(column) {
            const columns = ['', 'kpn', 'category', 'subcategory', 'value', 'package', 'manufacturer', 'preferredVendor'];
            return columns.indexOf(column) + 1;
        }
        
        function getAssemblyColumnIndex(column) {
            const columns = ['name', 'version', 'description', 'itemCount', 'status'];
            return columns.indexOf(column) + 1;
        }
        
        function getSystemColumnIndex(column) {
            const columns = ['name', 'version', 'description', 'itemCount', 'status'];
            return columns.indexOf(column) + 1;
        }

        function renderComponents() {
            const tbody = document.getElementById('components-tbody');
            tbody.innerHTML = '';
            
            data.components.forEach(comp => {
                const row = document.createElement('tr');
                
                // Add archived styling if component is archived
                if (comp.status === 'Archived') {
                    row.className = 'archived-row';
                }
                
                // Get category config for this component
                const config = categoryConfigs[comp.category];
                
                // Determine value/PN field
                let valuePn = comp.value || comp.manufacturer_pn || comp.manufacturer_PN || '';
                
                // Determine package
                let packageValue = comp.package || '';
                
                // Build specs string
                let specs = [];
                if (comp.tolerance) specs.push(`¬±${comp.tolerance}`);
                if (comp.voltage) specs.push(`${comp.voltage}`);
                if (comp.rating) specs.push(`${comp.rating}`);
                if (comp.temp_rating) specs.push(`${comp.temp_rating}`);
                if (comp.current_rating) specs.push(`${comp.current_rating}`);
                if (comp.voltage_rating) specs.push(`${comp.voltage_rating}`);
                if (comp.actuation_force) specs.push(`${comp.actuation_force}`);
                if (comp.pitch) specs.push(`${comp.pitch}`);
                if (comp.pins) specs.push(`${comp.pins}P`);
                
                // Get vendor
                let vendor = comp.preferred_vendor || '';
                
                // Build action buttons based on user role and component status
                let actionButtons = '';
                if (comp.status !== 'Archived') {
                    actionButtons += `<button class="btn" onclick="editComponent('${comp.kpn}')" style="background: #ff9800; color: white; padding: 4px 8px; font-size: 12px; margin-right: 5px;">Edit</button>`;
                    
                    if (currentUser.role === 'team') {
                        actionButtons += `<button class="archive-btn" onclick="archiveComponent('${comp.kpn}')">Archive</button>`;
                    } else if (currentUser.role === 'admin') {
                        actionButtons += `<button class="archive-btn" onclick="archiveComponent('${comp.kpn}')">Archive</button>`;
                        actionButtons += `<button class="delete-btn" onclick="deleteComponent('${comp.kpn}')">Delete</button>`;
                    }
                } else {
                    // Show status for archived components
                    actionButtons = '<span class="status-archived">Archived</span>';
                    if (currentUser.role === 'admin') {
                        actionButtons += ` <button class="delete-btn" onclick="deleteComponent('${comp.kpn}')">Delete</button>`;
                    }
                }
                
                // Build checkbox column if in bulk selection mode
                let checkboxColumn = '';
                if (bulkSelectionMode) {
                    checkboxColumn = `<td><input type="checkbox" class="component-checkbox" value="${comp.kpn}"></td>`;
                }
                
                row.innerHTML = `
                    ${checkboxColumn}
                    <td><strong>${comp.kpn}</strong></td>
                    <td>${comp.category.charAt(0).toUpperCase() + comp.category.slice(1)}</td>
                    <td>${comp.subcategory}</td>
                    <td>${valuePn}</td>
                    <td>${packageValue}</td>
                    <td>${specs.join(', ')}</td>
                    <td>${vendor}</td>
                    <td>
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAssemblies() {
            const tbody = document.getElementById('assemblies-tbody');
            tbody.innerHTML = '';
            
            data.assemblies.forEach((assembly, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <button class="expand-btn" onclick="toggleAssemblyBOM(${index})" id="expand-btn-${index}">
                            ‚ñ∂
                        </button>
                        ${assembly.name}
                    </td>
                    <td>${assembly.version}</td>
                    <td>${assembly.description}</td>
                    <td>${(assembly.bom?.length || 0) + (assembly.motherComponents?.length || 0)} items</td>
                    <td><span class="status-${assembly.status.toLowerCase()}">${assembly.status}</span></td>
                `;
                tbody.appendChild(row);
                
                // Create hidden BOM detail row
                const bomRow = document.createElement('tr');
                bomRow.id = `bom-detail-${index}`;
                bomRow.className = 'bom-detail-row';
                bomRow.style.display = 'none';
                bomRow.innerHTML = `
                    <td colspan="5">
                        <div class="bom-detail-container">
                            <h4>Assembly Details - ${assembly.name}</h4>
                            ${renderAssemblyQuantitySummary(assembly)}
                            ${assembly.motherComponents && assembly.motherComponents.length > 0 ? `
                                <div class="mother-components-section">
                                    <h5>üèóÔ∏è Assembly-Level Components</h5>
                                    <div class="bom-items-list">
                                        ${renderAssemblyMotherComponents(assembly.motherComponents)}
                                    </div>
                                </div>
                            ` : ''}
                            ${assembly.bom && assembly.bom.length > 0 ? `
                                <div class="bom-components-section">
                                    <h5>üîß PCB/Cable Components</h5>
                                    <div class="bom-items-list">
                                        ${renderAssemblyBOMItems(assembly.bom)}
                                    </div>
                                </div>
                            ` : ''}
                            ${(!assembly.bom || assembly.bom.length === 0) && (!assembly.motherComponents || assembly.motherComponents.length === 0) ? '<p>No components defined</p>' : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(bomRow);
            });
        }

        // Render BOM items for assembly detail view
        function renderAssemblyBOMItems(bomItems) {
            if (!bomItems || bomItems.length === 0) {
                return '<p>No BOM items</p>';
            }
            
            let html = '<div class="bom-items-grid">';
            bomItems.forEach(item => {
                html += `
                    <div class="bom-item-card">
                        <div class="bom-item-header">
                            <strong>${item.componentName || item.kpn}</strong>
                            <span class="quantity-badge">Qty: ${item.quantity}</span>
                        </div>
                        <div class="bom-item-details">
                            <div>KPN: ${item.kpn}</div>
                            ${item.refdes ? `<div>RefDes: ${item.refdes}</div>` : ''}
                            ${item.notes ? `<div class="notes">Notes: ${item.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // Toggle assembly BOM detail view
        function toggleAssemblyBOM(index) {
            const bomRow = document.getElementById(`bom-detail-${index}`);
            const expandBtn = document.getElementById(`expand-btn-${index}`);
            
            if (bomRow.style.display === 'none') {
                bomRow.style.display = 'table-row';
                expandBtn.textContent = '‚ñº';
            } else {
                bomRow.style.display = 'none';
                expandBtn.textContent = '‚ñ∂';
            }
        }

        // Mother component management functions
        function updateMotherItemOptions() {
            const type = document.getElementById('mother-type').value;
            const kpnSelect = document.getElementById('mother-kpn');
            
            kpnSelect.innerHTML = '<option value="">Select Component</option>';
            
            if (!type) return;
            
            // Map mother component types to component categories
            const categoryMap = {
                'enclosure': ['mechanical'],
                'hardware': ['mechanical', 'hardware'],
                'mounting': ['mechanical', 'hardware'],
                'cable': ['connectors', 'cable'],
                'other': ['mechanical', 'hardware', 'connectors']
            };
            
            const relevantCategories = categoryMap[type] || [];
            
            // Get components from DOM table
            const tableRows = document.querySelectorAll('#components-tbody tr');
            const availableComponents = [];
            
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    const category = cells[1].textContent.trim().toLowerCase();
                    if (relevantCategories.includes(category)) {
                        availableComponents.push({
                            kpn: cells[0].textContent.trim(),
                            name: cells[3].textContent.trim() || cells[5].textContent.trim(),
                            category: category
                        });
                    }
                }
            });
            
            // Populate dropdown
            availableComponents.forEach(comp => {
                const option = document.createElement('option');
                option.value = comp.kpn;
                option.textContent = `${comp.kpn} - ${comp.name}`;
                kpnSelect.appendChild(option);
            });
        }
        
        function addMotherComponent() {
            const type = document.getElementById('mother-type').value;
            const kpn = document.getElementById('mother-kpn').value;
            const quantity = parseInt(document.getElementById('mother-quantity').value);
            const notes = document.getElementById('mother-notes').value;
            
            if (!type || !kpn || !quantity || quantity < 1) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Get component name from dropdown
            const kpnSelect = document.getElementById('mother-kpn');
            const selectedOption = kpnSelect.options[kpnSelect.selectedIndex];
            const componentName = selectedOption.textContent.split(' - ')[1] || kpn;
            
            const motherComponent = {
                type,
                kpn,
                componentName,
                quantity,
                notes
            };
            
            currentMotherComponents.push(motherComponent);
            renderMotherComponents();
            
            // Clear form
            document.getElementById('mother-type').selectedIndex = 0;
            document.getElementById('mother-kpn').innerHTML = '<option value="">Select Component Type First</option>';
            document.getElementById('mother-quantity').value = 1;
            document.getElementById('mother-notes').value = '';
        }
        
        function renderMotherComponents() {
            const container = document.getElementById('mother-items');
            container.innerHTML = '';
            
            if (currentMotherComponents.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; font-style: italic;">No assembly-level components added</p>';
                return;
            }
            
            currentMotherComponents.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'mother-component-row';
                div.innerHTML = `
                    <div class="mother-component-info">
                        <div class="mother-component-header">
                            <strong>${item.componentName}</strong>
                            <span class="quantity-badge">Qty: ${item.quantity}</span>
                        </div>
                        <div class="mother-component-details">
                            <span class="component-type">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</span> | 
                            <span class="component-kpn">KPN: ${item.kpn}</span>
                            ${item.notes ? ` | <span class="component-notes">${item.notes}</span>` : ''}
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeMotherComponent(${index})">Remove</button>
                `;
                container.appendChild(div);
            });
        }
        
        function removeMotherComponent(index) {
            currentMotherComponents.splice(index, 1);
            renderMotherComponents();
        }
        
        // Render mother components for assembly detail view
        function renderAssemblyMotherComponents(motherComponents) {
            if (!motherComponents || motherComponents.length === 0) {
                return '<p>No assembly-level components</p>';
            }
            
            let html = '<div class="bom-items-grid">';
            motherComponents.forEach(item => {
                html += `
                    <div class="bom-item-card mother-component-card">
                        <div class="bom-item-header">
                            <strong>${item.componentName || item.kpn}</strong>
                            <span class="quantity-badge mother-quantity-badge">Qty: ${item.quantity}</span>
                        </div>
                        <div class="bom-item-details">
                            <div><span class="component-type-badge">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</span></div>
                            <div>KPN: ${item.kpn}</div>
                            ${item.notes ? `<div class="notes">Notes: ${item.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }
        
        // Render assembly quantity summary
        function renderAssemblyQuantitySummary(assembly) {
            const calculations = calculateAssemblyQuantities(assembly, 1);
            
            return `
                <div class="quantity-summary">
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-value">${calculations.totalItems}</span>
                            <span class="stat-label">Component Types</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${calculations.totalQuantity}</span>
                            <span class="stat-label">Total Quantity</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${calculations.bomComponents.length}</span>
                            <span class="stat-label">BOM Items</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${calculations.motherComponents.length}</span>
                            <span class="stat-label">Assembly Items</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Quantity Calculation Engine
        function calculateAssemblyQuantities(assembly, assemblyQuantity = 1) {
            const result = {
                bomComponents: [],
                motherComponents: [],
                totalItems: 0,
                totalQuantity: 0
            };
            
            // Calculate BOM component quantities
            if (assembly.bom && assembly.bom.length > 0) {
                assembly.bom.forEach(bomItem => {
                    const calculatedQuantity = bomItem.quantity * assemblyQuantity;
                    result.bomComponents.push({
                        ...bomItem,
                        calculatedQuantity,
                        assemblyQuantity
                    });
                    result.totalQuantity += calculatedQuantity;
                });
            }
            
            // Calculate mother component quantities
            if (assembly.motherComponents && assembly.motherComponents.length > 0) {
                assembly.motherComponents.forEach(motherItem => {
                    const calculatedQuantity = motherItem.quantity * assemblyQuantity;
                    result.motherComponents.push({
                        ...motherItem,
                        calculatedQuantity,
                        assemblyQuantity
                    });
                    result.totalQuantity += calculatedQuantity;
                });
            }
            
            result.totalItems = result.bomComponents.length + result.motherComponents.length;
            return result;
        }
        
        function calculateSystemTotals(system) {
            const systemTotals = {
                assemblies: [],
                consolidatedComponents: new Map(),
                totalAssemblies: 0,
                totalComponents: 0,
                totalQuantity: 0
            };
            
            if (!system.items || system.items.length === 0) return systemTotals;
            
            system.items.forEach(systemItem => {
                if (systemItem.type === 'assembly') {
                    // Find the referenced assembly
                    const assembly = data.assemblies.find(a => a.name === systemItem.value);
                    if (assembly) {
                        const assemblyCalc = calculateAssemblyQuantities(assembly, systemItem.quantity);
                        systemTotals.assemblies.push({
                            name: assembly.name,
                            quantity: systemItem.quantity,
                            calculations: assemblyCalc
                        });
                        
                        systemTotals.totalAssemblies += systemItem.quantity;
                        systemTotals.totalQuantity += assemblyCalc.totalQuantity;
                        
                        // Add to consolidated components
                        [...assemblyCalc.bomComponents, ...assemblyCalc.motherComponents].forEach(comp => {
                            const key = comp.kpn;
                            if (systemTotals.consolidatedComponents.has(key)) {
                                const existing = systemTotals.consolidatedComponents.get(key);
                                existing.totalQuantity += comp.calculatedQuantity;
                                existing.assemblies.push({
                                    assemblyName: assembly.name,
                                    assemblyQuantity: systemItem.quantity,
                                    componentQuantity: comp.quantity,
                                    calculatedQuantity: comp.calculatedQuantity
                                });
                            } else {
                                systemTotals.consolidatedComponents.set(key, {
                                    kpn: comp.kpn,
                                    componentName: comp.componentName,
                                    totalQuantity: comp.calculatedQuantity,
                                    assemblies: [{
                                        assemblyName: assembly.name,
                                        assemblyQuantity: systemItem.quantity,
                                        componentQuantity: comp.quantity,
                                        calculatedQuantity: comp.calculatedQuantity
                                    }]
                                });
                            }
                        });
                        
                        systemTotals.totalComponents += assemblyCalc.totalItems;
                    }
                }
            });
            
            return systemTotals;
        }
        
        function getComponentTotalAcrossAssemblies(kpn, assemblies) {
            let total = 0;
            assemblies.forEach(assembly => {
                // Check BOM components
                if (assembly.bom) {
                    const bomItem = assembly.bom.find(item => item.kpn === kpn);
                    if (bomItem) total += bomItem.quantity;
                }
                // Check mother components
                if (assembly.motherComponents) {
                    const motherItem = assembly.motherComponents.find(item => item.kpn === kpn);
                    if (motherItem) total += motherItem.quantity;
                }
            });
            return total;
        }

        function renderSystems() {
            const tbody = document.getElementById('systems-tbody');
            tbody.innerHTML = '';
            
            data.systems.forEach((system, index) => {
                const systemTotals = calculateSystemTotals(system);
                const itemCount = system.items ? system.items.length : (system.pcbs ? system.pcbs.length : 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="system-checkbox" data-system-index="${index}" onchange="updateSystemSelection()">
                    </td>
                    <td>
                        <button class="expand-btn" onclick="toggleSystemDetails(${index})" id="system-expand-btn-${index}">
                            ‚ñ∂
                        </button>
                        ${system.name}
                    </td>
                    <td>${system.version}</td>
                    <td>${system.description}</td>
                    <td>${itemCount} items (${systemTotals.totalQuantity} qty)</td>
                    <td><span class="status-${system.status.toLowerCase()}">${system.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-edit" onclick="editSystem(${index})" title="Edit system">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-delete" onclick="deleteSystem(${index})" title="Delete system">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Create hidden system detail row
                const detailRow = document.createElement('tr');
                detailRow.id = `system-detail-${index}`;
                detailRow.className = 'bom-detail-row';
                detailRow.style.display = 'none';
                detailRow.innerHTML = `
                    <td colspan="7">
                        <div class="bom-detail-container">
                            <h4>System Details - ${system.name}</h4>
                            ${renderSystemQuantitySummary(systemTotals)}
                            ${systemTotals.assemblies.length > 0 ? `
                                <div class="system-assemblies-section">
                                    <h5>üìã Assemblies in System</h5>
                                    ${renderSystemAssemblies(systemTotals.assemblies)}
                                </div>
                            ` : ''}
                            ${systemTotals.consolidatedComponents.size > 0 ? `
                                <div class="consolidated-components-section">
                                    <h5>üîß Consolidated Component Requirements</h5>
                                    ${renderConsolidatedComponents(systemTotals.consolidatedComponents)}
                                </div>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(detailRow);
            });
            
            // Add quantity dashboard button if not present
            setTimeout(() => {
                addQuantityDashboardButton();
            }, 100);
        }
        
        function toggleSystemDetails(index) {
            const detailRow = document.getElementById(`system-detail-${index}`);
            const expandBtn = document.getElementById(`system-expand-btn-${index}`);
            
            if (detailRow.style.display === 'none') {
                detailRow.style.display = 'table-row';
                expandBtn.textContent = '‚ñº';
            } else {
                detailRow.style.display = 'none';
                expandBtn.textContent = '‚ñ∂';
            }
        }
        
        function renderSystemQuantitySummary(systemTotals) {
            return `
                <div class="quantity-summary">
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-value">${systemTotals.totalAssemblies}</span>
                            <span class="stat-label">Total Assemblies</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${systemTotals.consolidatedComponents.size}</span>
                            <span class="stat-label">Unique Components</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${systemTotals.totalQuantity}</span>
                            <span class="stat-label">Total Quantity</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${systemTotals.assemblies.length}</span>
                            <span class="stat-label">Assembly Types</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderSystemAssemblies(assemblies) {
            let html = '<div class="system-assemblies-grid">';
            assemblies.forEach(assemblyItem => {
                const calc = assemblyItem.calculations;
                html += `
                    <div class="system-assembly-card">
                        <div class="assembly-card-header">
                            <strong>${assemblyItem.name}</strong>
                            <span class="quantity-badge system-quantity-badge">Qty: ${assemblyItem.quantity}</span>
                        </div>
                        <div class="assembly-card-details">
                            <div class="assembly-breakdown">
                                <span class="breakdown-item">
                                    <i class="breakdown-icon">üîß</i>
                                    ${calc.bomComponents.length} BOM items (${calc.bomComponents.reduce((sum, c) => sum + c.calculatedQuantity, 0)} qty)
                                </span>
                                <span class="breakdown-item">
                                    <i class="breakdown-icon">üèóÔ∏è</i>
                                    ${calc.motherComponents.length} Assembly items (${calc.motherComponents.reduce((sum, c) => sum + c.calculatedQuantity, 0)} qty)
                                </span>
                            </div>
                            <div class="total-calculation">
                                Total: ${calc.totalQuantity} components
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }
        
        function renderConsolidatedComponents(consolidatedMap) {
            let html = '<div class="consolidated-components-grid">';
            
            // Convert Map to array and sort by total quantity (descending)
            const sortedComponents = Array.from(consolidatedMap.values())
                .sort((a, b) => b.totalQuantity - a.totalQuantity);
            
            sortedComponents.forEach(comp => {
                html += `
                    <div class="consolidated-component-card">
                        <div class="component-card-header">
                            <strong>${comp.componentName}</strong>
                            <span class="quantity-badge consolidated-quantity-badge">Total: ${comp.totalQuantity}</span>
                        </div>
                        <div class="component-card-details">
                            <div class="component-kpn">KPN: ${comp.kpn}</div>
                            <div class="component-breakdown">
                                ${comp.assemblies.map(asm => 
                                    `<span class="assembly-contribution">
                                        ${asm.assemblyName}: ${asm.componentQuantity} √ó ${asm.assemblyQuantity} = ${asm.calculatedQuantity}
                                    </span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }
        
        // System bulk operations and enhanced management functions
        function updateSystemSelection() {
            const checkboxes = document.querySelectorAll('.system-checkbox');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const bulkPanel = document.getElementById('bulk-operations-panel');
            const selectedCountSpan = document.getElementById('selected-count');
            const selectAllCheckbox = document.getElementById('select-all-systems');
            
            // Update selected count display
            selectedCountSpan.textContent = `${selectedCount} system${selectedCount !== 1 ? 's' : ''} selected`;
            
            // Show/hide bulk operations panel
            if (selectedCount > 0) {
                bulkPanel.style.display = 'block';
            } else {
                bulkPanel.style.display = 'none';
            }
            
            // Update select all checkbox state
            if (selectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCount === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        function toggleSelectAllSystems() {
            const selectAllCheckbox = document.getElementById('select-all-systems');
            const checkboxes = document.querySelectorAll('.system-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSystemSelection();
        }
        
        function clearSelection() {
            const checkboxes = document.querySelectorAll('.system-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('select-all-systems').checked = false;
            updateSystemSelection();
        }
        
        function bulkUpdateStatus(newStatus) {
            const selectedIndices = getSelectedSystemIndices();
            if (selectedIndices.length === 0) return;
            
            const confirmMessage = `Are you sure you want to set ${selectedIndices.length} system${selectedIndices.length !== 1 ? 's' : ''} to ${newStatus}?`;
            if (!confirm(confirmMessage)) return;
            
            selectedIndices.forEach(index => {
                data.systems[index].status = newStatus;
            });
            
            saveData();
            renderSystems();
            clearSelection();
            alert(`${selectedIndices.length} system${selectedIndices.length !== 1 ? 's' : ''} updated to ${newStatus}.`);
        }
        
        function bulkDeleteSystems() {
            const selectedIndices = getSelectedSystemIndices();
            if (selectedIndices.length === 0) return;
            
            const confirmMessage = `Are you sure you want to delete ${selectedIndices.length} system${selectedIndices.length !== 1 ? 's' : ''}?\n\nThis action cannot be undone.`;
            if (!confirm(confirmMessage)) return;
            
            // Sort indices in descending order to delete from end to beginning
            selectedIndices.sort((a, b) => b - a);
            
            selectedIndices.forEach(index => {
                data.systems.splice(index, 1);
            });
            
            saveData();
            renderSystems();
            clearSelection();
            updateStats();
            alert(`${selectedIndices.length} system${selectedIndices.length !== 1 ? 's' : ''} deleted.`);
        }
        
        function getSelectedSystemIndices() {
            const checkboxes = document.querySelectorAll('.system-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.dataset.systemIndex));
        }
        
        function editSystem(index) {
            const system = data.systems[index];
            if (!system) return;
            
            // Populate form with system data
            document.getElementById('system-name').value = system.name;
            document.getElementById('system-version').value = system.version;
            document.getElementById('system-description').value = system.description;
            document.getElementById('system-status').value = system.status;
            
            // Load system items
            currentSystemItems = system.items ? [...system.items] : [];
            renderSystemItems();
            
            // Store edit mode
            window.editingSystemIndex = index;
            
            // Update add button to show "Update System"
            const addButton = document.querySelector('button[onclick="addSystem()"]');
            addButton.textContent = 'Update System';
            addButton.style.background = '#ffc107';
            
            // Add cancel button
            if (!document.getElementById('cancel-edit-system')) {
                const cancelButton = document.createElement('button');
                cancelButton.id = 'cancel-edit-system';
                cancelButton.className = 'btn btn-secondary';
                cancelButton.textContent = 'Cancel Edit';
                cancelButton.onclick = cancelSystemEdit;
                addButton.parentNode.insertBefore(cancelButton, addButton.nextSibling);
            }
            
            // Scroll to form
            document.getElementById('system-name').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelSystemEdit() {
            // Clear form
            document.getElementById('system-name').value = '';
            document.getElementById('system-version').value = '';
            document.getElementById('system-description').value = '';
            document.getElementById('system-status').value = 'Active';
            currentSystemItems = [];
            renderSystemItems();
            
            // Reset add button
            const addButton = document.querySelector('button[onclick="addSystem()"]');
            addButton.textContent = 'Add System';
            addButton.style.background = '';
            
            // Remove cancel button
            const cancelButton = document.getElementById('cancel-edit-system');
            if (cancelButton) cancelButton.remove();
            
            // Clear edit mode
            delete window.editingSystemIndex;
        }
        
        function deleteSystem(index) {
            const system = data.systems[index];
            if (!system) return;
            
            const confirmMessage = `Are you sure you want to delete the system "${system.name}"?\n\nThis action cannot be undone.`;
            if (!confirm(confirmMessage)) return;
            
            data.systems.splice(index, 1);
            saveData();
            renderSystems();
            updateStats();
            alert(`System "${system.name}" has been deleted.`);
        }
        
        // TASK 3.2: System-Level Quantity Management Functions
        
        // Analyze cross-system usage of assemblies and components
        function analyzeCrossSystemUsage(itemName, itemType = 'assembly') {
            const usage = [];
            
            data.systems.forEach((system, systemIndex) => {
                if (system.items) {
                    system.items.forEach((item, itemIndex) => {
                        if (item.name === itemName && item.type === itemType) {
                            usage.push({
                                systemIndex,
                                systemName: system.name,
                                systemVersion: system.version,
                                quantity: item.quantity,
                                itemIndex,
                                assemblyVersion: item.version
                            });
                        }
                    });
                }
            });
            
            return usage;
        }
        
        // Get comprehensive quantity analysis for an assembly across all systems
        function getAssemblyQuantityAnalysis(assemblyName) {
            const usage = analyzeCrossSystemUsage(assemblyName, 'assembly');
            const assembly = data.assemblies.find(a => a.name === assemblyName);
            
            if (!assembly) return null;
            
            const calculations = calculateAssemblyQuantities(assembly);
            const baseComponentTotal = calculations.totalQuantity;
            
            let totalSystemQuantity = 0;
            let totalComponentImpact = 0;
            let quantityVariance = { min: Infinity, max: 0 };
            
            usage.forEach(use => {
                totalSystemQuantity += use.quantity;
                totalComponentImpact += baseComponentTotal * use.quantity;
                quantityVariance.min = Math.min(quantityVariance.min, use.quantity);
                quantityVariance.max = Math.max(quantityVariance.max, use.quantity);
            });
            
            // Reset min if no usage found
            if (quantityVariance.min === Infinity) quantityVariance.min = 0;
            
            return {
                assemblyName,
                baseComponentTotal,
                systemUsage: usage,
                totalSystems: usage.length,
                totalSystemQuantity,
                totalComponentImpact,
                quantityVariance,
                hasVariance: quantityVariance.max > quantityVariance.min,
                averageQuantity: usage.length > 0 ? (totalSystemQuantity / usage.length).toFixed(1) : 0
            };
        }
        
        // Show multi-system impact analysis in preview
        function showMultiSystemImpact(itemName, itemType, newQuantity, currentSystemName = null) {
            const usage = analyzeCrossSystemUsage(itemName, itemType);
            
            // Filter out current system if editing
            const otherSystemUsage = usage.filter(use => use.systemName !== currentSystemName);
            
            if (otherSystemUsage.length === 0) {
                return '<div class="cross-system-info">‚úÖ <strong>Single System Usage</strong> - This item is only used in this system.</div>';
            }
            
            let impactHtml = `
                <div class="cross-system-analysis">
                    <div class="cross-system-header">
                        <strong>üîÑ Cross-System Impact Analysis</strong>
                        <span class="systems-count">${otherSystemUsage.length} other system${otherSystemUsage.length !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="cross-system-usage">
            `;
            
            otherSystemUsage.forEach(use => {
                impactHtml += `
                    <div class="system-usage-item">
                        <span class="system-name">${use.systemName}</span>
                        <span class="system-quantity">Qty: ${use.quantity}</span>
                    </div>
                `;
            });
            
            // Calculate total impact if assembly
            if (itemType === 'assembly') {
                const assembly = data.assemblies.find(a => a.name === itemName);
                if (assembly) {
                    const calc = calculateAssemblyQuantities(assembly);
                    const componentImpact = calc.totalQuantity;
                    const totalCurrentImpact = otherSystemUsage.reduce((sum, use) => sum + (componentImpact * use.quantity), 0);
                    const newSystemImpact = componentImpact * newQuantity;
                    const totalNewImpact = totalCurrentImpact + newSystemImpact;
                    
                    impactHtml += `
                    </div>
                    <div class="impact-summary">
                        <div class="impact-row">
                            <span>Other Systems Impact:</span>
                            <span><strong>${totalCurrentImpact} components</strong></span>
                        </div>
                        <div class="impact-row">
                            <span>This System Impact:</span>
                            <span><strong>${newSystemImpact} components</strong></span>
                        </div>
                        <div class="impact-row total-impact">
                            <span>Total System-wide Impact:</span>
                            <span><strong>${totalNewImpact} components</strong></span>
                        </div>
                    </div>
                    `;
                }
            } else {
                impactHtml += '</div>';
            }
            
            impactHtml += '</div>';
            
            return impactHtml;
        }
        
        // Enhanced system item preview with cross-system analysis
        function updateSystemItemPreviewWithCrossSystem() {
            const type = document.getElementById('system-item-type').value;
            const itemValue = document.getElementById('system-pcb').value;
            const quantity = parseInt(document.getElementById('system-pcb-quantity').value) || 1;
            const previewDiv = document.getElementById('system-item-preview');
            const previewContent = document.getElementById('system-item-preview-content');
            const quantityInfo = document.getElementById('system-quantity-info');
            
            // Clear preview if no item selected
            if (!type || !itemValue) {
                previewDiv.style.display = 'none';
                quantityInfo.textContent = '';
                return;
            }
            
            let previewHtml = '';
            let infoText = '';
            const currentSystemName = document.getElementById('system-name').value.trim();
            
            if (type === 'assembly') {
                const assembly = data.assemblies.find(a => a.name === itemValue);
                if (assembly) {
                    const calculations = calculateAssemblyQuantities(assembly);
                    const totalComponents = calculations.totalQuantity;
                    const totalSystemComponents = totalComponents * quantity;
                    
                    infoText = `(${totalComponents} components √ó ${quantity} = ${totalSystemComponents} total)`;
                    
                    previewHtml = `
                        <div class="item-preview-card">
                            <div class="item-preview-header">
                                <span class="item-preview-name">üèóÔ∏è ${assembly.name} (${assembly.version})</span>
                                <span class="item-preview-quantity">√ó ${quantity}</span>
                            </div>
                            <div class="item-preview-details">
                                <strong>Type:</strong> ${assembly.type === 'pcb' ? 'PCB Assembly' : 'Cable Assembly'}<br>
                                <strong>Description:</strong> ${assembly.description}<br>
                                <strong>Status:</strong> ${assembly.status}
                            </div>
                            <div class="item-preview-calculation">
                                <strong>Component Impact:</strong><br>
                                ‚Ä¢ BOM Components: ${calculations.bomComponents.length} items (${calculations.bomComponents.reduce((sum, c) => sum + c.calculatedQuantity, 0)} total qty)<br>
                                ‚Ä¢ Assembly Components: ${calculations.motherComponents.length} items (${calculations.motherComponents.reduce((sum, c) => sum + c.calculatedQuantity, 0)} total qty)<br>
                                ‚Ä¢ System Multiplier: ${totalComponents} √ó ${quantity} = <strong>${totalSystemComponents} total components</strong>
                            </div>
                            ${showMultiSystemImpact(itemValue, type, quantity, currentSystemName)}
                        </div>
                    `;
                }
            } else if (['mechanical', 'printed3d', 'cable'].includes(type)) {
                const component = data.components.find(c => c.kpn === itemValue);
                if (component) {
                    infoText = `(${quantity} ${type} part${quantity > 1 ? 's' : ''})`;
                    
                    previewHtml = `
                        <div class="item-preview-card">
                            <div class="item-preview-header">
                                <span class="item-preview-name">üîß ${component.kpn}</span>
                                <span class="item-preview-quantity">√ó ${quantity}</span>
                            </div>
                            <div class="item-preview-details">
                                <strong>Type:</strong> ${type.charAt(0).toUpperCase() + type.slice(1)} Part<br>
                                <strong>Description:</strong> ${component.description || 'N/A'}<br>
                                <strong>Manufacturer:</strong> ${component.manufacturer || 'N/A'}<br>
                                <strong>Status:</strong> ${component.status}
                            </div>
                            <div class="item-preview-calculation">
                                <strong>System Impact:</strong> ${quantity} √ó ${component.kpn} = <strong>${quantity} total units</strong>
                            </div>
                            ${showMultiSystemImpact(component.kpn, type, quantity, currentSystemName)}
                        </div>
                    `;
                }
            } else if (type === 'system') {
                const system = data.systems.find(s => s.name === itemValue);
                if (system) {
                    const systemTotals = calculateSystemTotals(system);
                    const totalSystemComponents = systemTotals.totalQuantity * quantity;
                    
                    infoText = `(${systemTotals.totalQuantity} components √ó ${quantity} = ${totalSystemComponents} total)`;
                    
                    previewHtml = `
                        <div class="item-preview-card">
                            <div class="item-preview-header">
                                <span class="item-preview-name">üè¢ ${system.name} (${system.version})</span>
                                <span class="item-preview-quantity">√ó ${quantity}</span>
                            </div>
                            <div class="item-preview-details">
                                <strong>Type:</strong> Nested System<br>
                                <strong>Description:</strong> ${system.description}<br>
                                <strong>Status:</strong> ${system.status}<br>
                                <strong>Contains:</strong> ${systemTotals.totalAssemblies} assemblies, ${systemTotals.consolidatedComponents.size} unique components
                            </div>
                            <div class="item-preview-calculation">
                                <strong>System Impact:</strong><br>
                                ‚Ä¢ Nested System: ${systemTotals.totalQuantity} components<br>
                                ‚Ä¢ System Multiplier: ${systemTotals.totalQuantity} √ó ${quantity} = <strong>${totalSystemComponents} total components</strong>
                            </div>
                            ${showMultiSystemImpact(itemValue, type, quantity, currentSystemName)}
                        </div>
                    `;
                }
            }
            
            // Update the UI
            quantityInfo.textContent = infoText;
            previewContent.innerHTML = previewHtml;
            previewDiv.style.display = previewHtml ? 'block' : 'none';
        }
        
        // Enhancement 2: Live Quantity Persistence
        
        // Update quantity in existing system item with immediate persistence
        function updateSystemItemQuantity(systemIndex, itemIndex, newQuantity) {
            if (!data.systems[systemIndex] || !data.systems[systemIndex].items[itemIndex]) {
                console.error('Invalid system or item index');
                return false;
            }
            
            const oldQuantity = data.systems[systemIndex].items[itemIndex].quantity;
            data.systems[systemIndex].items[itemIndex].quantity = newQuantity;
            data.systems[systemIndex].lastModified = new Date().toISOString().split('T')[0];
            
            // Save immediately
            saveData();
            
            // Update displays
            renderSystems();
            
            console.log(`Updated ${data.systems[systemIndex].items[itemIndex].name} quantity from ${oldQuantity} to ${newQuantity} in system ${data.systems[systemIndex].name}`);
            return true;
        }
        
        // Add quick quantity edit functionality to system items
        function addQuickQuantityEdit() {
            // This will be called when rendering system items to add inline editing
            const systemItemCards = document.querySelectorAll('.system-item-card');
            
            systemItemCards.forEach((card, index) => {
                const quantitySpan = card.querySelector('.system-item-quantity');
                if (quantitySpan) {
                    quantitySpan.style.cursor = 'pointer';
                    quantitySpan.title = 'Click to edit quantity';
                    quantitySpan.onclick = function() {
                        editQuantityInline(this, index);
                    };
                }
            });
        }
        
        // Inline quantity editing for system items
        function editQuantityInline(quantityElement, itemIndex) {
            const currentQuantity = parseInt(quantityElement.textContent.replace('√ó ', ''));
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '1';
            input.value = currentQuantity;
            input.className = 'inline-quantity-edit';
            input.style.width = '60px';
            input.style.padding = '2px 6px';
            input.style.border = '1px solid #17a2b8';
            input.style.borderRadius = '12px';
            input.style.fontSize = '12px';
            input.style.textAlign = 'center';
            
            // Handle save
            const saveEdit = () => {
                const newQuantity = parseInt(input.value);
                if (newQuantity && newQuantity > 0 && newQuantity !== currentQuantity) {
                    // Update in currentSystemItems for unsaved systems
                    if (itemIndex < currentSystemItems.length) {
                        currentSystemItems[itemIndex].quantity = newQuantity;
                        renderSystemItems();
                        
                        // If editing an existing system, also update the data
                        if (typeof window.editingSystemIndex !== 'undefined') {
                            updateSystemItemQuantity(window.editingSystemIndex, itemIndex, newQuantity);
                        }
                    }
                } else {
                    // Restore original display
                    quantityElement.textContent = `√ó ${currentQuantity}`;
                    quantityElement.style.display = 'inline';
                }
                input.remove();
            };
            
            // Handle escape
            const cancelEdit = () => {
                quantityElement.textContent = `√ó ${currentQuantity}`;
                quantityElement.style.display = 'inline';
                input.remove();
            };
            
            // Event listeners
            input.onblur = saveEdit;
            input.onkeydown = function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            };
            
            // Replace quantity display with input
            quantityElement.style.display = 'none';
            quantityElement.parentNode.insertBefore(input, quantityElement.nextSibling);
            input.focus();
            input.select();
        }
        
        // Auto-save functionality for system building
        let autoSaveTimeout;
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                if (typeof window.editingSystemIndex !== 'undefined') {
                    // Auto-save existing system
                    const systemData = {
                        name: document.getElementById('system-name').value.trim(),
                        version: document.getElementById('system-version').value.trim(),
                        status: document.getElementById('system-status').value,
                        description: document.getElementById('system-description').value.trim(),
                        items: [...currentSystemItems],
                        dateAdded: data.systems[window.editingSystemIndex].dateAdded,
                        lastModified: new Date().toISOString().split('T')[0]
                    };
                    
                    data.systems[window.editingSystemIndex] = systemData;
                    saveData();
                    
                    // Show auto-save indicator
                    showAutoSaveIndicator();
                }
            }, 2000); // Auto-save after 2 seconds of inactivity
        }
        
        // Show auto-save indicator
        function showAutoSaveIndicator() {
            let indicator = document.getElementById('auto-save-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'auto-save-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                indicator.textContent = '‚úì Auto-saved';
                document.body.appendChild(indicator);
            }
            
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 2000);
        }
        
        // Enhancement 3: Quantity Override System & Multi-System Dashboard
        
        // Create a comprehensive system-wide component usage dashboard
        function createSystemWideQuantityDashboard() {
            const modal = document.createElement('div');
            modal.id = 'quantity-dashboard-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const dashboard = document.createElement('div');
            dashboard.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            // Generate dashboard content
            const dashboardContent = generateQuantityDashboardContent();
            dashboard.innerHTML = `
                <div class="dashboard-header">
                    <h3>üîÑ System-Wide Quantity Analysis</h3>
                    <button onclick="closeQuantityDashboard()" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 4px;
                        cursor: pointer;
                        float: right;
                    ">Close</button>
                </div>
                ${dashboardContent}
            `;
            
            modal.appendChild(dashboard);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeQuantityDashboard();
                }
            };
        }
        
        // Generate comprehensive quantity analysis content
        function generateQuantityDashboardContent() {
            const assemblyUsage = new Map();
            const componentUsage = new Map();
            
            // Analyze all systems
            data.systems.forEach(system => {
                if (system.items) {
                    system.items.forEach(item => {
                        if (item.type === 'assembly') {
                            if (!assemblyUsage.has(item.name)) {
                                assemblyUsage.set(item.name, []);
                            }
                            assemblyUsage.get(item.name).push({
                                system: system.name,
                                quantity: item.quantity,
                                version: item.version
                            });
                        } else {
                            if (!componentUsage.has(item.name)) {
                                componentUsage.set(item.name, []);
                            }
                            componentUsage.get(item.name).push({
                                system: system.name,
                                quantity: item.quantity,
                                type: item.type
                            });
                        }
                    });
                }
            });
            
            let content = '<div class="dashboard-content">';
            
            // Assembly usage analysis
            if (assemblyUsage.size > 0) {
                content += '<div class="usage-section"><h4>üèóÔ∏è Assembly Usage Across Systems</h4>';
                
                assemblyUsage.forEach((usage, assemblyName) => {
                    const assembly = data.assemblies.find(a => a.name === assemblyName);
                    const totalQuantity = usage.reduce((sum, u) => sum + u.quantity, 0);
                    const hasVariance = usage.length > 1 && !usage.every(u => u.quantity === usage[0].quantity);
                    
                    let componentImpact = 0;
                    if (assembly) {
                        const calc = calculateAssemblyQuantities(assembly);
                        componentImpact = calc.totalQuantity * totalQuantity;
                    }
                    
                    content += `
                        <div class="usage-item ${hasVariance ? 'has-variance' : ''}">
                            <div class="usage-header">
                                <strong>${assemblyName}</strong>
                                <span class="total-usage">Total: ${totalQuantity} units</span>
                                ${componentImpact > 0 ? `<span class="component-impact">${componentImpact} components</span>` : ''}
                            </div>
                            <div class="system-breakdown">
                                ${usage.map(u => `
                                    <span class="system-use ${hasVariance ? 'quantity-' + u.quantity : ''}">
                                        ${u.system}: ${u.quantity}x
                                    </span>
                                `).join('')}
                            </div>
                            ${hasVariance ? '<div class="variance-warning">‚ö†Ô∏è Quantity variance detected across systems</div>' : ''}
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            // Component usage analysis
            if (componentUsage.size > 0) {
                content += '<div class="usage-section"><h4>üîß Component Usage Across Systems</h4>';
                
                componentUsage.forEach((usage, componentName) => {
                    const totalQuantity = usage.reduce((sum, u) => sum + u.quantity, 0);
                    const hasVariance = usage.length > 1 && !usage.every(u => u.quantity === usage[0].quantity);
                    
                    content += `
                        <div class="usage-item ${hasVariance ? 'has-variance' : ''}">
                            <div class="usage-header">
                                <strong>${componentName}</strong>
                                <span class="total-usage">Total: ${totalQuantity} units</span>
                                <span class="component-type">${usage[0].type}</span>
                            </div>
                            <div class="system-breakdown">
                                ${usage.map(u => `
                                    <span class="system-use ${hasVariance ? 'quantity-' + u.quantity : ''}">
                                        ${u.system}: ${u.quantity}x
                                    </span>
                                `).join('')}
                            </div>
                            ${hasVariance ? '<div class="variance-warning">‚ö†Ô∏è Quantity variance detected across systems</div>' : ''}
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            if (assemblyUsage.size === 0 && componentUsage.size === 0) {
                content += '<div class="no-data">No cross-system usage found. Create some systems with shared assemblies or components to see analysis.</div>';
            }
            
            content += '</div>';
            
            return content;
        }
        
        // Close quantity dashboard
        function closeQuantityDashboard() {
            const modal = document.getElementById('quantity-dashboard-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ===== TASK 3.3: ASSEMBLY MANAGEMENT IN SYSTEMS =====
        
        // Show Assembly Health Dashboard
        function showAssemblyHealthDashboard() {
            const modal = document.createElement('div');
            modal.id = 'assembly-health-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const dashboard = document.createElement('div');
            dashboard.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            `;
            
            dashboard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üìä Assembly Health Dashboard</h3>
                    <button onclick="closeAssemblyHealthModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div id="assembly-health-content">${generateAssemblyHealthContent()}</div>
            `;
            
            modal.appendChild(dashboard);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeAssemblyHealthModal();
                }
            };
        }
        
        function generateAssemblyHealthContent() {
            const assemblyHealth = analyzeAssemblyHealth();
            let content = '<div class="assembly-health-dashboard">';
            
            // Summary statistics
            content += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="analytics-card">
                        <h5>Total Assemblies</h5>
                        <div style="font-size: 24px; font-weight: bold; color: #0078d4;">${assemblyHealth.total}</div>
                    </div>
                    <div class="analytics-card">
                        <h5>Used in Systems</h5>
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${assemblyHealth.used}</div>
                    </div>
                    <div class="analytics-card">
                        <h5>Health Issues</h5>
                        <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${assemblyHealth.issues}</div>
                    </div>
                    <div class="analytics-card">
                        <h5>Version Mismatches</h5>
                        <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${assemblyHealth.versionIssues}</div>
                    </div>
                </div>
            `;
            
            // Assembly health details
            if (assemblyHealth.details.length > 0) {
                content += '<h4>Assembly Health Details</h4>';
                assemblyHealth.details.forEach(detail => {
                    const statusClass = detail.status === 'error' ? 'error' : 
                                      detail.status === 'warning' ? 'warning' : 'success';
                    
                    content += `
                        <div class="assembly-health-item ${statusClass}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong>${detail.name}</strong>
                                <span class="assembly-status-indicator ${detail.assembly ? detail.assembly.status.toLowerCase() : 'inactive'}">
                                    ${detail.assembly ? detail.assembly.status : 'Missing'}
                                </span>
                            </div>
                            <div style="color: #666; margin-bottom: 8px;">
                                Version: ${detail.version || 'Unknown'} | Used in ${detail.systemCount} system(s)
                            </div>
                            <div style="color: ${statusClass === 'error' ? '#721c24' : statusClass === 'warning' ? '#856404' : '#155724'};">
                                ${detail.message}
                            </div>
                            ${detail.systems ? `
                                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                    Systems: ${detail.systems.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                content += '<div style="text-align: center; padding: 40px; color: #666;">All assemblies are healthy! ‚úÖ</div>';
            }
            
            content += '</div>';
            return content;
        }
        
        function analyzeAssemblyHealth() {
            const allAssemblies = data.assemblies || [];
            const usedAssemblies = new Map();
            const health = {
                total: allAssemblies.length,
                used: 0,
                issues: 0,
                versionIssues: 0,
                details: []
            };
            
            // Collect usage data from systems
            data.systems.forEach(system => {
                if (system.items) {
                    system.items.forEach(item => {
                        if (item.type === 'assembly') {
                            if (!usedAssemblies.has(item.name)) {
                                usedAssemblies.set(item.name, []);
                            }
                            usedAssemblies.get(item.name).push({
                                system: system.name,
                                version: item.version,
                                quantity: item.quantity
                            });
                        }
                    });
                }
            });
            
            health.used = usedAssemblies.size;
            
            // Check each used assembly for health issues
            usedAssemblies.forEach((usage, assemblyName) => {
                const assembly = allAssemblies.find(a => a.name === assemblyName);
                const systemCount = usage.length;
                const systems = usage.map(u => u.system);
                const versions = [...new Set(usage.map(u => u.version))];
                
                let status = 'success';
                let message = 'Assembly is healthy';
                
                if (!assembly) {
                    status = 'error';
                    message = 'Assembly definition not found - may have been deleted';
                    health.issues++;
                } else if (assembly.status !== 'Active') {
                    status = 'warning'; 
                    message = `Assembly status is ${assembly.status} but still used in systems`;
                    health.issues++;
                } else if (versions.length > 1) {
                    status = 'warning';
                    message = `Version mismatch detected - used as: ${versions.join(', ')}`;
                    health.versionIssues++;
                } else if (versions[0] !== assembly.version) {
                    status = 'warning';
                    message = `Version mismatch - systems use v${versions[0]} but assembly is v${assembly.version}`;
                    health.versionIssues++;
                }
                
                if (status !== 'success') {
                    health.details.push({
                        name: assemblyName,
                        assembly: assembly,
                        version: versions.join(', '),
                        systemCount: systemCount,
                        systems: systems,
                        status: status,
                        message: message
                    });
                }
            });
            
            // Check for unused assemblies
            allAssemblies.forEach(assembly => {
                if (!usedAssemblies.has(assembly.name)) {
                    health.details.push({
                        name: assembly.name,
                        assembly: assembly,
                        version: assembly.version,
                        systemCount: 0,
                        systems: [],
                        status: 'warning',
                        message: 'Assembly is not used in any systems'
                    });
                }
            });
            
            return health;
        }
        
        function closeAssemblyHealthModal() {
            const modal = document.getElementById('assembly-health-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Show Assembly Replacement Tool
        function showAssemblyReplacementTool() {
            const modal = document.createElement('div');
            modal.id = 'assembly-replacement-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 600px;
                width: 90%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            `;
            
            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üîÑ Assembly Replacement Tool</h3>
                    <button onclick="closeAssemblyReplacementModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div class="assembly-replacement-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Replace Assembly</label>
                            <select id="replace-from-assembly" onchange="updateReplacementPreview()">
                                <option value="">Select assembly to replace</option>
                                ${generateAssemblyOptions()}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>With Assembly</label>
                            <select id="replace-to-assembly" onchange="updateReplacementPreview()">
                                <option value="">Select replacement assembly</option>
                                ${generateAssemblyOptions()}
                            </select>
                        </div>
                    </div>
                    
                    <div id="replacement-preview"></div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="executeAssemblyReplacement()" id="execute-replacement-btn" disabled>
                            Execute Replacement
                        </button>
                        <button class="btn btn-secondary" onclick="closeAssemblyReplacementModal()" style="margin-left: 10px;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeAssemblyReplacementModal();
                }
            };
        }
        
        function generateAssemblyOptions() {
            const assemblies = data.assemblies || [];
            return assemblies.map(assembly => 
                `<option value="${assembly.name}">${assembly.name} (v${assembly.version})</option>`
            ).join('');
        }
        
        function updateReplacementPreview() {
            const fromAssembly = document.getElementById('replace-from-assembly').value;
            const toAssembly = document.getElementById('replace-to-assembly').value;
            const previewDiv = document.getElementById('replacement-preview');
            const executeBtn = document.getElementById('execute-replacement-btn');
            
            if (!fromAssembly || !toAssembly) {
                previewDiv.innerHTML = '';
                executeBtn.disabled = true;
                return;
            }
            
            if (fromAssembly === toAssembly) {
                previewDiv.innerHTML = '<div style="color: #dc3545; padding: 10px;">Cannot replace assembly with itself</div>';
                executeBtn.disabled = true;
                return;
            }
            
            const affectedSystems = findSystemsUsingAssembly(fromAssembly);
            
            if (affectedSystems.length === 0) {
                previewDiv.innerHTML = '<div style="color: #856404; padding: 10px;">Assembly is not used in any systems</div>';
                executeBtn.disabled = true;
                return;
            }
            
            previewDiv.innerHTML = `
                <div class="replacement-preview">
                    <h5>Replacement Preview</h5>
                    <p><strong>Replace:</strong> ${fromAssembly}</p>
                    <p><strong>With:</strong> ${toAssembly}</p>
                    <p><strong>Affected Systems:</strong> ${affectedSystems.length}</p>
                    <ul>
                        ${affectedSystems.map(system => 
                            `<li>${system.name} (${system.quantity} units)</li>`
                        ).join('')}
                    </ul>
                </div>
            `;
            
            executeBtn.disabled = false;
        }
        
        function findSystemsUsingAssembly(assemblyName) {
            const affectedSystems = [];
            data.systems.forEach(system => {
                if (system.items) {
                    system.items.forEach(item => {
                        if (item.type === 'assembly' && item.name === assemblyName) {
                            affectedSystems.push({
                                name: system.name,
                                quantity: item.quantity
                            });
                        }
                    });
                }
            });
            return affectedSystems;
        }
        
        function executeAssemblyReplacement() {
            const fromAssembly = document.getElementById('replace-from-assembly').value;
            const toAssembly = document.getElementById('replace-to-assembly').value;
            
            if (!fromAssembly || !toAssembly || fromAssembly === toAssembly) {
                return;
            }
            
            const affectedSystems = findSystemsUsingAssembly(fromAssembly);
            
            if (!confirm(`Replace "${fromAssembly}" with "${toAssembly}" in ${affectedSystems.length} system(s)?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            let replacementCount = 0;
            
            // Perform replacement
            data.systems.forEach(system => {
                if (system.items) {
                    system.items.forEach(item => {
                        if (item.type === 'assembly' && item.name === fromAssembly) {
                            item.name = toAssembly;
                            const newAssembly = data.assemblies.find(a => a.name === toAssembly);
                            if (newAssembly) {
                                item.version = newAssembly.version;
                            }
                            replacementCount++;
                        }
                    });
                }
            });
            
            // Save changes
            saveData();
            
            // Update displays
            renderSystems();
            updateStats();
            
            alert(`Successfully replaced "${fromAssembly}" with "${toAssembly}" in ${replacementCount} system item(s).`);
            closeAssemblyReplacementModal();
        }
        
        function closeAssemblyReplacementModal() {
            const modal = document.getElementById('assembly-replacement-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Show Assembly Usage Analytics
        function showAssemblyUsageAnalytics() {
            const modal = document.createElement('div');
            modal.id = 'assembly-analytics-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const dashboard = document.createElement('div');
            dashboard.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            `;
            
            dashboard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üìà Assembly Usage Analytics</h3>
                    <button onclick="closeAssemblyAnalyticsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div id="assembly-analytics-content">${generateAssemblyAnalyticsContent()}</div>
            `;
            
            modal.appendChild(dashboard);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeAssemblyAnalyticsModal();
                }
            };
        }
        
        function generateAssemblyAnalyticsContent() {
            const analytics = analyzeAssemblyUsage();
            let content = '<div class="usage-analytics-dashboard">';
            
            // Usage statistics grid
            content += `
                <div class="usage-analytics-grid">
                    <div class="analytics-card">
                        <h5>Most Used Assembly</h5>
                        <div style="font-size: 18px; font-weight: bold; color: #0078d4;">
                            ${analytics.mostUsed ? analytics.mostUsed.name : 'None'}
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            ${analytics.mostUsed ? `${analytics.mostUsed.totalQuantity} units across ${analytics.mostUsed.systemCount} systems` : ''}
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h5>Average Usage</h5>
                        <div style="font-size: 18px; font-weight: bold; color: #28a745;">
                            ${analytics.averageUsage.toFixed(1)} units
                        </div>
                        <div style="color: #666; font-size: 14px;">per assembly</div>
                    </div>
                    
                    <div class="analytics-card">
                        <h5>Unused Assemblies</h5>
                        <div style="font-size: 18px; font-weight: bold; color: #ffc107;">
                            ${analytics.unused.length}
                        </div>
                        <div style="color: #666; font-size: 14px;">not used in any system</div>
                    </div>
                    
                    <div class="analytics-card">
                        <h5>Multi-System Assemblies</h5>
                        <div style="font-size: 18px; font-weight: bold; color: #6f42c1;">
                            ${analytics.multiSystem.length}
                        </div>
                        <div style="color: #666; font-size: 14px;">used in multiple systems</div>
                    </div>
                </div>
            `;
            
            // Detailed usage breakdown
            if (analytics.usage.length > 0) {
                content += '<h4>Detailed Usage Breakdown</h4>';
                
                // Sort by total quantity descending
                const sortedUsage = analytics.usage.sort((a, b) => b.totalQuantity - a.totalQuantity);
                
                sortedUsage.forEach(item => {
                    content += `
                        <div class="analytics-card" style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong>${item.name}</strong>
                                <span style="color: #666;">${item.totalQuantity} total units</span>
                            </div>
                            <div style="color: #666; margin-bottom: 8px;">
                                Used in ${item.systemCount} system(s) | Avg: ${(item.totalQuantity / item.systemCount).toFixed(1)} units/system
                            </div>
                            <div style="font-size: 12px;">
                                Systems: ${item.systems.map(s => `${s.system} (${s.quantity})`).join(', ')}
                            </div>
                        </div>
                    `;
                });
            }
            
            // Unused assemblies
            if (analytics.unused.length > 0) {
                content += '<h4>Unused Assemblies</h4>';
                content += '<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 15px;">';
                content += '<p>The following assemblies are defined but not used in any systems:</p>';
                content += '<ul>';
                analytics.unused.forEach(assembly => {
                    content += `<li>${assembly.name} (v${assembly.version})</li>`;
                });
                content += '</ul>';
                content += '</div>';
            }
            
            content += '</div>';
            return content;
        }
        
        function analyzeAssemblyUsage() {
            const allAssemblies = data.assemblies || [];
            const usageMap = new Map();
            
            // Collect usage data
            data.systems.forEach(system => {
                if (system.items) {
                    system.items.forEach(item => {
                        if (item.type === 'assembly') {
                            if (!usageMap.has(item.name)) {
                                usageMap.set(item.name, []);
                            }
                            usageMap.get(item.name).push({
                                system: system.name,
                                quantity: item.quantity
                            });
                        }
                    });
                }
            });
            
            // Process usage data
            const usage = [];
            let totalUsage = 0;
            let mostUsed = null;
            
            usageMap.forEach((systemUsage, assemblyName) => {
                const totalQuantity = systemUsage.reduce((sum, s) => sum + s.quantity, 0);
                const systemCount = systemUsage.length;
                
                const usageItem = {
                    name: assemblyName,
                    systems: systemUsage,
                    systemCount: systemCount,
                    totalQuantity: totalQuantity
                };
                
                usage.push(usageItem);
                totalUsage += totalQuantity;
                
                if (!mostUsed || totalQuantity > mostUsed.totalQuantity) {
                    mostUsed = usageItem;
                }
            });
            
            // Find unused assemblies
            const unused = allAssemblies.filter(assembly => !usageMap.has(assembly.name));
            
            // Find multi-system assemblies
            const multiSystem = usage.filter(item => item.systemCount > 1);
            
            return {
                usage: usage,
                unused: unused,
                multiSystem: multiSystem,
                mostUsed: mostUsed,
                averageUsage: usage.length > 0 ? totalUsage / usage.length : 0
            };
        }
        
        function closeAssemblyAnalyticsModal() {
            const modal = document.getElementById('assembly-analytics-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Validate All Assemblies
        function validateAllAssemblies() {
            const modal = document.createElement('div');
            modal.id = 'assembly-validation-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 600px;
                width: 90%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            `;
            
            const validationResults = performAssemblyValidation();
            
            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>‚úÖ Assembly Validation Results</h3>
                    <button onclick="closeAssemblyValidationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="analytics-card" style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${validationResults.valid}</div>
                        <div>Valid</div>
                    </div>
                    <div class="analytics-card" style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${validationResults.warnings}</div>
                        <div>Warnings</div>
                    </div>
                    <div class="analytics-card" style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${validationResults.errors}</div>
                        <div>Errors</div>
                    </div>
                </div>
                
                <div class="validation-results">
                    ${validationResults.details.map(result => `
                        <div class="validation-item ${result.type}">
                            <div style="font-weight: bold;">${result.assembly}</div>
                            <div>${result.message}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-secondary" onclick="closeAssemblyValidationModal()">Close</button>
                </div>
            `;
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeAssemblyValidationModal();
                }
            };
        }
        
        function performAssemblyValidation() {
            const results = {
                valid: 0,
                warnings: 0,
                errors: 0,
                details: []
            };
            
            const assemblies = data.assemblies || [];
            const systems = data.systems || [];
            
            // Create usage map
            const usageMap = new Map();
            systems.forEach(system => {
                if (system.items) {
                    system.items.forEach(item => {
                        if (item.type === 'assembly') {
                            if (!usageMap.has(item.name)) {
                                usageMap.set(item.name, []);
                            }
                            usageMap.get(item.name).push({
                                system: system.name,
                                version: item.version
                            });
                        }
                    });
                }
            });
            
            // Check each assembly
            assemblies.forEach(assembly => {
                const usage = usageMap.get(assembly.name) || [];
                let hasIssues = false;
                
                // Check if assembly has valid BOM
                if (!assembly.bom || assembly.bom.length === 0) {
                    results.details.push({
                        assembly: assembly.name,
                        type: 'warning',
                        message: 'Assembly has no BOM components defined'
                    });
                    results.warnings++;
                    hasIssues = true;
                }
                
                // Check if assembly is inactive but used
                if (assembly.status !== 'Active' && usage.length > 0) {
                    results.details.push({
                        assembly: assembly.name,
                        type: 'error',
                        message: `Assembly is ${assembly.status} but used in ${usage.length} system(s)`
                    });
                    results.errors++;
                    hasIssues = true;
                }
                
                // Check version mismatches
                const versions = [...new Set(usage.map(u => u.version))];
                if (versions.length > 1) {
                    results.details.push({
                        assembly: assembly.name,
                        type: 'warning',
                        message: `Version mismatch - used as: ${versions.join(', ')}`
                    });
                    results.warnings++;
                    hasIssues = true;
                } else if (versions.length === 1 && versions[0] !== assembly.version) {
                    results.details.push({
                        assembly: assembly.name,
                        type: 'warning',
                        message: `Version mismatch - systems use v${versions[0]} but assembly is v${assembly.version}`
                    });
                    results.warnings++;
                    hasIssues = true;
                }
                
                // Check if assembly is unused
                if (usage.length === 0) {
                    results.details.push({
                        assembly: assembly.name,
                        type: 'warning',
                        message: 'Assembly is not used in any systems'
                    });
                    results.warnings++;
                    hasIssues = true;
                }
                
                if (!hasIssues) {
                    results.details.push({
                        assembly: assembly.name,
                        type: 'valid',
                        message: 'Assembly is healthy and properly used'
                    });
                    results.valid++;
                }
            });
            
            // Check for missing assemblies referenced in systems
            usageMap.forEach((usage, assemblyName) => {
                if (!assemblies.find(a => a.name === assemblyName)) {
                    results.details.push({
                        assembly: assemblyName,
                        type: 'error',
                        message: 'Assembly referenced in systems but definition not found'
                    });
                    results.errors++;
                }
            });
            
            return results;
        }
        
        function closeAssemblyValidationModal() {
            const modal = document.getElementById('assembly-validation-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ===== TASK 3.4: SYSTEM BOM ROLLUP CALCULATIONS =====
        
        // Enhanced recursive system BOM calculation with nested system support
        function calculateSystemBOM(system, systemQuantity = 1, processedSystems = new Set()) {
            const bomResult = {
                consolidatedComponents: new Map(),
                assemblyBreakdown: [],
                systemBreakdown: [],
                totalAssemblies: 0,
                totalComponents: 0,
                totalQuantity: 0,
                nestedSystemCount: 0,
                maxDepth: 0,
                currentDepth: processedSystems.size
            };
            
            // Prevent infinite recursion in circular references
            if (processedSystems.has(system.name)) {
                console.warn(`Circular reference detected for system: ${system.name}`);
                return bomResult;
            }
            
            processedSystems.add(system.name);
            bomResult.maxDepth = Math.max(bomResult.maxDepth, processedSystems.size);
            
            if (!system.items || system.items.length === 0) {
                processedSystems.delete(system.name);
                return bomResult;
            }
            
            system.items.forEach(systemItem => {
                if (systemItem.type === 'assembly') {
                    // Handle assemblies
                    const assembly = data.assemblies.find(a => a.name === systemItem.value);
                    if (assembly) {
                        const assemblyCalc = calculateAssemblyQuantities(assembly, systemItem.quantity * systemQuantity);
                        
                        bomResult.assemblyBreakdown.push({
                            name: assembly.name,
                            type: assembly.type,
                            version: assembly.version,
                            quantity: systemItem.quantity * systemQuantity,
                            systemQuantity: systemQuantity,
                            itemQuantity: systemItem.quantity,
                            calculations: assemblyCalc,
                            depth: processedSystems.size
                        });
                        
                        bomResult.totalAssemblies += systemItem.quantity * systemQuantity;
                        bomResult.totalQuantity += assemblyCalc.totalQuantity;
                        
                        // Add assembly components to consolidated BOM
                        [...assemblyCalc.bomComponents, ...assemblyCalc.motherComponents].forEach(comp => {
                            const key = comp.kpn;
                            if (bomResult.consolidatedComponents.has(key)) {
                                const existing = bomResult.consolidatedComponents.get(key);
                                existing.totalQuantity += comp.calculatedQuantity;
                                existing.sources.push({
                                    sourceType: 'assembly',
                                    sourceName: assembly.name,
                                    systemName: system.name,
                                    assemblyQuantity: systemItem.quantity * systemQuantity,
                                    componentQuantity: comp.quantity,
                                    calculatedQuantity: comp.calculatedQuantity,
                                    depth: processedSystems.size
                                });
                            } else {
                                bomResult.consolidatedComponents.set(key, {
                                    kpn: comp.kpn,
                                    componentName: comp.componentName,
                                    category: comp.category,
                                    subcategory: comp.subcategory,
                                    value: comp.value,
                                    package: comp.package,
                                    manufacturer: comp.manufacturer,
                                    preferredVendor: comp.preferredVendor,
                                    totalQuantity: comp.calculatedQuantity,
                                    sources: [{
                                        sourceType: 'assembly',
                                        sourceName: assembly.name,
                                        systemName: system.name,
                                        assemblyQuantity: systemItem.quantity * systemQuantity,
                                        componentQuantity: comp.quantity,
                                        calculatedQuantity: comp.calculatedQuantity,
                                        depth: processedSystems.size
                                    }]
                                });
                            }
                        });
                        
                        bomResult.totalComponents += assemblyCalc.totalItems;
                    }
                } else if (systemItem.type === 'system') {
                    // Handle nested systems (RECURSIVE)
                    const nestedSystem = data.systems.find(s => s.name === systemItem.value);
                    if (nestedSystem) {
                        const nestedBOM = calculateSystemBOM(nestedSystem, systemItem.quantity * systemQuantity, new Set(processedSystems));
                        
                        bomResult.systemBreakdown.push({
                            name: nestedSystem.name,
                            version: nestedSystem.version,
                            quantity: systemItem.quantity * systemQuantity,
                            systemQuantity: systemQuantity,
                            itemQuantity: systemItem.quantity,
                            nestedBOM: nestedBOM,
                            depth: processedSystems.size
                        });
                        
                        bomResult.nestedSystemCount += 1;
                        bomResult.totalAssemblies += nestedBOM.totalAssemblies;
                        bomResult.totalComponents += nestedBOM.totalComponents;
                        bomResult.totalQuantity += nestedBOM.totalQuantity;
                        bomResult.maxDepth = Math.max(bomResult.maxDepth, nestedBOM.maxDepth);
                        
                        // Merge nested system components into consolidated BOM
                        nestedBOM.consolidatedComponents.forEach((comp, key) => {
                            if (bomResult.consolidatedComponents.has(key)) {
                                const existing = bomResult.consolidatedComponents.get(key);
                                existing.totalQuantity += comp.totalQuantity;
                                // Add nested system sources
                                comp.sources.forEach(source => {
                                    existing.sources.push({
                                        ...source,
                                        nestedSystemName: nestedSystem.name,
                                        depth: source.depth + 1
                                    });
                                });
                            } else {
                                bomResult.consolidatedComponents.set(key, {
                                    ...comp,
                                    sources: comp.sources.map(source => ({
                                        ...source,
                                        nestedSystemName: nestedSystem.name,
                                        depth: source.depth + 1
                                    }))
                                });
                            }
                        });
                    }
                }
                // Note: mechanical, printed3d, cable types are handled at assembly level as mother components
            });
            
            processedSystems.delete(system.name);
            return bomResult;
        }
        
        // Generate exportable system BOM data
        function generateSystemBOMExport(systemName) {
            const system = data.systems.find(s => s.name === systemName);
            if (!system) {
                console.error(`System ${systemName} not found`);
                return null;
            }
            
            const bomData = calculateSystemBOM(system);
            const exportData = [];
            
            // Convert consolidated components to export format
            bomData.consolidatedComponents.forEach((comp, kpn) => {
                const sourceDetails = comp.sources.map(source => {
                    if (source.nestedSystemName) {
                        return `${source.nestedSystemName}‚Üí${source.sourceName}`;
                    } else {
                        return source.sourceName;
                    }
                }).join(', ');
                
                exportData.push({
                    'KPN': kpn,
                    'Component Name': comp.componentName || '',
                    'Category': comp.category || '',
                    'Subcategory': comp.subcategory || '',
                    'Value': comp.value || '',
                    'Package': comp.package || '',
                    'Manufacturer': comp.manufacturer || '',
                    'Preferred Vendor': comp.preferredVendor || '',
                    'Total Quantity': comp.totalQuantity,
                    'Source Assemblies': sourceDetails,
                    'System': systemName,
                    'Max Nesting Depth': bomData.maxDepth,
                    'Export Date': new Date().toISOString().split('T')[0]
                });
            });
            
            // Sort by total quantity descending
            exportData.sort((a, b) => b['Total Quantity'] - a['Total Quantity']);
            
            return {
                exportData: exportData,
                bomAnalysis: bomData,
                metadata: {
                    systemName: systemName,
                    totalComponents: bomData.consolidatedComponents.size,
                    totalQuantity: bomData.totalQuantity,
                    totalAssemblies: bomData.totalAssemblies,
                    nestedSystems: bomData.nestedSystemCount,
                    maxDepth: bomData.maxDepth,
                    generatedAt: new Date().toISOString()
                }
            };
        }
        
        // Show System BOM Preview Modal
        function showSystemBOMPreview() {
            if (data.systems.length === 0) {
                alert('No systems available for BOM preview');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'system-bom-preview-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 95%;
                width: 1200px;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            `;
            
            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üîç System BOM Preview</h3>
                    <button onclick="closeSystemBOMPreviewModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Select System:</label>
                    <select id="bom-preview-system" onchange="updateBOMPreview()" style="width: 100%; padding: 8px;">
                        <option value="">Select a system to preview BOM</option>
                        ${data.systems.map(system => 
                            `<option value="${system.name}">${system.name} (v${system.version})</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div id="bom-preview-content"></div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="exportSelectedSystemBOM()" id="export-bom-btn" disabled>
                        üì§ Export This BOM
                    </button>
                    <button class="btn btn-secondary" onclick="closeSystemBOMPreviewModal()" style="margin-left: 10px;">
                        Close
                    </button>
                </div>
            `;
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeSystemBOMPreviewModal();
                }
            };
        }
        
        function updateBOMPreview() {
            const systemName = document.getElementById('bom-preview-system').value;
            const previewContent = document.getElementById('bom-preview-content');
            const exportBtn = document.getElementById('export-bom-btn');
            
            if (!systemName) {
                previewContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Select a system to preview its BOM</div>';
                exportBtn.disabled = true;
                return;
            }
            
            const bomExport = generateSystemBOMExport(systemName);
            if (!bomExport) {
                previewContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">Error generating BOM for selected system</div>';
                exportBtn.disabled = true;
                return;
            }
            
            exportBtn.disabled = false;
            
            const { exportData, bomAnalysis, metadata } = bomExport;
            
            let content = '<div class="bom-preview-content">';
            
            // BOM Summary Statistics
            content += `
                <div class="bom-summary-stats">
                    <div class="bom-stat-card">
                        <div class="bom-stat-value">${metadata.totalComponents}</div>
                        <div class="bom-stat-label">Unique Components</div>
                    </div>
                    <div class="bom-stat-card">
                        <div class="bom-stat-value">${metadata.totalQuantity}</div>
                        <div class="bom-stat-label">Total Quantity</div>
                    </div>
                    <div class="bom-stat-card">
                        <div class="bom-stat-value">${metadata.totalAssemblies}</div>
                        <div class="bom-stat-label">Total Assemblies</div>
                    </div>
                    <div class="bom-stat-card">
                        <div class="bom-stat-value">${metadata.nestedSystems}</div>
                        <div class="bom-stat-label">Nested Systems</div>
                    </div>
                    <div class="bom-stat-card">
                        <div class="bom-stat-value">${metadata.maxDepth}</div>
                        <div class="bom-stat-label">Max Depth</div>
                    </div>
                </div>
            `;
            
            // BOM Component List
            if (exportData.length > 0) {
                content += `
                    <div class="bom-component-list">
                        <div class="bom-component-header" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr;">
                            <div>KPN</div>
                            <div>Component</div>
                            <div>Quantity</div>
                            <div>Source</div>
                            <div>Vendor</div>
                        </div>
                `;
                
                exportData.forEach(item => {
                    content += `
                        <div class="bom-component-item">
                            <div class="bom-component-kpn">${item.KPN}</div>
                            <div class="bom-component-description">
                                <strong>${item['Component Name']}</strong><br>
                                <small>${item.Category} ‚Ä∫ ${item.Subcategory} ‚Ä∫ ${item.Value} ‚Ä∫ ${item.Package}</small>
                            </div>
                            <div class="bom-component-quantity">${item['Total Quantity']}</div>
                            <div class="bom-component-source">${item['Source Assemblies']}</div>
                            <div class="bom-component-vendor">${item['Preferred Vendor']}</div>
                        </div>
                    `;
                });
                
                content += '</div>';
            } else {
                content += '<div style="text-align: center; padding: 40px; color: #666;">No components found in system BOM</div>';
            }
            
            content += '</div>';
            previewContent.innerHTML = content;
        }
        
        function exportSelectedSystemBOM() {
            const systemName = document.getElementById('bom-preview-system').value;
            if (!systemName) return;
            
            const bomExport = generateSystemBOMExport(systemName);
            if (!bomExport) return;
            
            // Create CSV content
            const { exportData } = bomExport;
            const headers = Object.keys(exportData[0]);
            const csvContent = [
                headers.join(','),
                ...exportData.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        // Escape commas and quotes in CSV
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${systemName}_BOM_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`System BOM exported successfully!\nFile: ${systemName}_BOM_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function closeSystemBOMPreviewModal() {
            const modal = document.getElementById('system-bom-preview-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Export System BOM (quick export without preview)
        function exportSystemBOM() {
            if (data.systems.length === 0) {
                alert('No systems available for BOM export');
                return;
            }
            
            // If only one system, export directly
            if (data.systems.length === 1) {
                const bomExport = generateSystemBOMExport(data.systems[0].name);
                if (bomExport) {
                    const { exportData } = bomExport;
                    const headers = Object.keys(exportData[0]);
                    const csvContent = [
                        headers.join(','),
                        ...exportData.map(row => 
                            headers.map(header => {
                                const value = row[header];
                                if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                                    return `"${value.replace(/"/g, '""')}"`;
                                }
                                return value;
                            }).join(',')
                        )
                    ].join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${data.systems[0].name}_BOM_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert(`System BOM exported successfully!`);
                }
                return;
            }
            
            // Multiple systems - show selection dialog
            showSystemBOMPreview();
        }
       
        // Show System BOM Analytics
        function showSystemBOMAnalytics() {
            if (data.systems.length === 0) {
                alert('No systems available for BOM analytics');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'system-bom-analytics-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const dashboard = document.createElement('div');
            dashboard.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            `;
            
            dashboard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üìä System BOM Analytics</h3>
                    <button onclick="closeSystemBOMAnalyticsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div id="system-bom-analytics-content">${generateSystemBOMAnalyticsContent()}</div>
            `;
            
            modal.appendChild(dashboard);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeSystemBOMAnalyticsModal();
                }
            };
        }
        
        function generateSystemBOMAnalyticsContent() {
            const analytics = analyzeSystemBOMs();
            let content = '<div class="bom-analytics-dashboard">';
            
            // Overall BOM statistics
            content += `
                <div class="bom-analytics-grid">
                    <div class="analytics-card">
                        <h5>System with Most Components</h5>
                        <div style="font-size: 18px; font-weight: bold; color: #0078d4;">
                            ${analytics.mostComplexSystem ? analytics.mostComplexSystem.name : 'None'}
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            ${analytics.mostComplexSystem ? `${analytics.mostComplexSystem.componentCount} unique components` : ''}
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h5>Highest Component Reuse</h5>
                        <div style="font-size: 18px; font-weight: bold; color: #28a745;">
                            ${analytics.mostReusedComponent ? analytics.mostReusedComponent.kpn : 'None'}
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            ${analytics.mostReusedComponent ? `Used in ${analytics.mostReusedComponent.systemCount} systems` : ''}
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h5>Average Components/System</h5>
                        <div style="font-size: 18px; font-weight: bold; color: #6f42c1;">
                            ${analytics.averageComponentsPerSystem.toFixed(1)}
                        </div>
                        <div style="color: #666; font-size: 14px;">unique components</div>
                    </div>
                    
                    <div class="analytics-card">
                        <h5>Systems with Nesting</h5>
                        <div style="font-size: 18px; font-weight: bold; color: #ffc107;">
                            ${analytics.nestedSystems.length}
                        </div>
                        <div style="color: #666; font-size: 14px;">have nested systems</div>
                    </div>
                </div>
            `;
            
            // System-by-system breakdown
            if (analytics.systemBreakdown.length > 0) {
                content += '<h4>System BOM Breakdown</h4>';
                
                analytics.systemBreakdown.forEach(system => {
                    content += `
                        <div class="analytics-card" style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong>${system.name}</strong>
                                <span style="color: #666;">${system.componentCount} components, ${system.totalQuantity} total qty</span>
                            </div>
                            <div style="color: #666; margin-bottom: 8px;">
                                Assemblies: ${system.assemblyCount} | Nested Systems: ${system.nestedSystemCount} | Max Depth: ${system.maxDepth}
                            </div>
                            ${system.topComponents.length > 0 ? `
                                <div style="font-size: 12px;">
                                    Top Components: ${system.topComponents.map(c => `${c.kpn} (${c.quantity})`).join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            // Component reuse analysis
            if (analytics.componentReuse.length > 0) {
                content += '<h4>Component Reuse Analysis</h4>';
                content += '<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px;">';
                content += '<p>Components used across multiple systems (optimization opportunities):</p>';
                
                analytics.componentReuse.slice(0, 10).forEach(comp => {
                    content += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f1f3f4;">
                            <span><strong>${comp.kpn}</strong> - ${comp.componentName}</span>
                            <span>${comp.systemCount} systems (${comp.totalQuantity} total qty)</span>
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            content += '</div>';
            return content;
        }
        
        function analyzeSystemBOMs() {
            const analytics = {
                systemBreakdown: [],
                componentReuse: [],
                nestedSystems: [],
                mostComplexSystem: null,
                mostReusedComponent: null,
                averageComponentsPerSystem: 0
            };
            
            const globalComponentMap = new Map();
            let totalComponents = 0;
            
            data.systems.forEach(system => {
                const bomData = calculateSystemBOM(system);
                
                const systemAnalysis = {
                    name: system.name,
                    componentCount: bomData.consolidatedComponents.size,
                    totalQuantity: bomData.totalQuantity,
                    assemblyCount: bomData.totalAssemblies,
                    nestedSystemCount: bomData.nestedSystemCount,
                    maxDepth: bomData.maxDepth,
                    topComponents: []
                };
                
                // Get top 3 components by quantity
                const sortedComponents = Array.from(bomData.consolidatedComponents.values())
                    .sort((a, b) => b.totalQuantity - a.totalQuantity)
                    .slice(0, 3);
                
                systemAnalysis.topComponents = sortedComponents.map(comp => ({
                    kpn: comp.kpn,
                    quantity: comp.totalQuantity
                }));
                
                analytics.systemBreakdown.push(systemAnalysis);
                totalComponents += bomData.consolidatedComponents.size;
                
                if (bomData.nestedSystemCount > 0) {
                    analytics.nestedSystems.push(systemAnalysis);
                }
                
                if (!analytics.mostComplexSystem || bomData.consolidatedComponents.size > analytics.mostComplexSystem.componentCount) {
                    analytics.mostComplexSystem = systemAnalysis;
                }
                
                // Track global component usage
                bomData.consolidatedComponents.forEach((comp, kpn) => {
                    if (globalComponentMap.has(kpn)) {
                        const existing = globalComponentMap.get(kpn);
                        existing.systemCount++;
                        existing.totalQuantity += comp.totalQuantity;
                        existing.systems.push(system.name);
                    } else {
                        globalComponentMap.set(kpn, {
                            kpn: kpn,
                            componentName: comp.componentName,
                            systemCount: 1,
                            totalQuantity: comp.totalQuantity,
                            systems: [system.name]
                        });
                    }
                });
            });
            
            // Calculate averages
            analytics.averageComponentsPerSystem = data.systems.length > 0 ? totalComponents / data.systems.length : 0;
            
            // Find most reused components
            analytics.componentReuse = Array.from(globalComponentMap.values())
                .filter(comp => comp.systemCount > 1)
                .sort((a, b) => b.systemCount - a.systemCount);
            
            if (analytics.componentReuse.length > 0) {
                analytics.mostReusedComponent = analytics.componentReuse[0];
            }
            
            return analytics;
        }
        
        function closeSystemBOMAnalyticsModal() {
            const modal = document.getElementById('system-bom-analytics-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Generate Purchase BOM (vendor-organized BOM for procurement)
        function generatePurchasingBOM() {
            if (data.systems.length === 0) {
                alert('No systems available for purchasing BOM');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'purchasing-bom-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 95%;
                width: 1000px;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            `;
            
            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üõí Purchase BOM Generator</h3>
                    <button onclick="closePurchasingBOMModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Select Systems for Purchase BOM:</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                        ${data.systems.map((system, index) => `
                            <div style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" class="purchase-system-checkbox" data-system-name="${system.name}" onchange="updatePurchaseBOMPreview()">
                                    <span style="margin-left: 8px;">${system.name} (v${system.version})</span>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div id="purchase-bom-content"></div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="exportPurchaseBOM()" id="export-purchase-btn" disabled>
                        üì§ Export Purchase BOM
                    </button>
                    <button class="btn btn-secondary" onclick="closePurchasingBOMModal()" style="margin-left: 10px;">
                        Close
                    </button>
                </div>
            `;
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closePurchasingBOMModal();
                }
            };
        }
        
        function updatePurchaseBOMPreview() {
            const checkboxes = document.querySelectorAll('.purchase-system-checkbox:checked');
            const selectedSystems = Array.from(checkboxes).map(cb => cb.dataset.systemName);
            const previewContent = document.getElementById('purchase-bom-content');
            const exportBtn = document.getElementById('export-purchase-btn');
            
            if (selectedSystems.length === 0) {
                previewContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Select systems to generate purchase BOM</div>';
                exportBtn.disabled = true;
                return;
            }
            
            exportBtn.disabled = false;
            
            // Generate consolidated BOM across selected systems
            const consolidatedBOM = new Map();
            const vendorBreakdown = new Map();
            let totalComponents = 0;
            let totalQuantity = 0;
            
            selectedSystems.forEach(systemName => {
                const system = data.systems.find(s => s.name === systemName);
                if (system) {
                    const bomData = calculateSystemBOM(system);
                    
                    bomData.consolidatedComponents.forEach((comp, kpn) => {
                        if (consolidatedBOM.has(kpn)) {
                            consolidatedBOM.get(kpn).totalQuantity += comp.totalQuantity;
                        } else {
                            consolidatedBOM.set(kpn, { ...comp });
                        }
                        
                        // Group by vendor
                        const vendor = comp.preferredVendor || 'No Vendor Specified';
                        if (!vendorBreakdown.has(vendor)) {
                            vendorBreakdown.set(vendor, []);
                        }
                        vendorBreakdown.get(vendor).push({
                            kpn: kpn,
                            componentName: comp.componentName,
                            totalQuantity: consolidatedBOM.get(kpn).totalQuantity,
                            category: comp.category,
                            value: comp.value,
                            package: comp.package
                        });
                    });
                }
            });
            
            totalComponents = consolidatedBOM.size;
            totalQuantity = Array.from(consolidatedBOM.values()).reduce((sum, comp) => sum + comp.totalQuantity, 0);
            
            let content = `
                <div class="purchase-bom-section">
                    <h4>Purchase BOM Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="bom-stat-card">
                            <div class="bom-stat-value">${selectedSystems.length}</div>
                            <div class="bom-stat-label">Systems</div>
                        </div>
                        <div class="bom-stat-card">
                            <div class="bom-stat-value">${totalComponents}</div>
                            <div class="bom-stat-label">Components</div>
                        </div>
                        <div class="bom-stat-card">
                            <div class="bom-stat-value">${totalQuantity}</div>
                            <div class="bom-stat-label">Total Qty</div>
                        </div>
                        <div class="bom-stat-card">
                            <div class="bom-stat-value">${vendorBreakdown.size}</div>
                            <div class="bom-stat-label">Vendors</div>
                        </div>
                    </div>
            `;
            
            // Vendor breakdown
            if (vendorBreakdown.size > 0) {
                content += '<h5>Vendor Breakdown</h5>';
                content += '<div class="vendor-breakdown">';
                
                vendorBreakdown.forEach((components, vendor) => {
                    const vendorQuantity = components.reduce((sum, comp) => sum + comp.totalQuantity, 0);
                    content += `
                        <div class="vendor-card">
                            <h5>${vendor}</h5>
                            <div style="margin-bottom: 10px;">
                                <strong>${components.length}</strong> components, <strong>${vendorQuantity}</strong> total quantity
                            </div>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${components.map(comp => `
                                    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 2px;">
                                        <span>${comp.kpn}</span>
                                        <span>Qty: ${comp.totalQuantity}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            content += '</div>';
            previewContent.innerHTML = content;
        }
        
        function exportPurchaseBOM() {
            const checkboxes = document.querySelectorAll('.purchase-system-checkbox:checked');
            const selectedSystems = Array.from(checkboxes).map(cb => cb.dataset.systemName);
            
            if (selectedSystems.length === 0) return;
            
            // Generate consolidated purchase BOM
            const consolidatedBOM = new Map();
            
            selectedSystems.forEach(systemName => {
                const system = data.systems.find(s => s.name === systemName);
                if (system) {
                    const bomData = calculateSystemBOM(system);
                    
                    bomData.consolidatedComponents.forEach((comp, kpn) => {
                        if (consolidatedBOM.has(kpn)) {
                            consolidatedBOM.get(kpn).totalQuantity += comp.totalQuantity;
                        } else {
                            consolidatedBOM.set(kpn, { ...comp });
                        }
                    });
                }
            });
            
            // Create export data
            const exportData = [];
            consolidatedBOM.forEach((comp, kpn) => {
                exportData.push({
                    'KPN': kpn,
                    'Component Name': comp.componentName || '',
                    'Category': comp.category || '',
                    'Subcategory': comp.subcategory || '',
                    'Value': comp.value || '',
                    'Package': comp.package || '',
                    'Manufacturer': comp.manufacturer || '',
                    'Preferred Vendor': comp.preferredVendor || '',
                    'Total Quantity': comp.totalQuantity,
                    'Systems': selectedSystems.join(', '),
                    'Export Type': 'Purchase BOM',
                    'Export Date': new Date().toISOString().split('T')[0]
                });
            });
            
            // Sort by vendor, then by total quantity
            exportData.sort((a, b) => {
                const vendorCompare = (a['Preferred Vendor'] || '').localeCompare(b['Preferred Vendor'] || '');
                if (vendorCompare !== 0) return vendorCompare;
                return b['Total Quantity'] - a['Total Quantity'];
            });
            
            // Create CSV
            const headers = Object.keys(exportData[0]);
            const csvContent = [
                headers.join(','),
                ...exportData.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Purchase_BOM_${selectedSystems.join('_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Purchase BOM exported successfully for ${selectedSystems.length} system(s)!`);
        }
        
        function closePurchasingBOMModal() {
            const modal = document.getElementById('purchasing-bom-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Add button to open quantity dashboard
        function addQuantityDashboardButton() {
            const actionsDiv = document.querySelector('#systems .actions');
            if (actionsDiv && !document.getElementById('quantity-dashboard-btn')) {
                const dashboardBtn = document.createElement('button');
                dashboardBtn.id = 'quantity-dashboard-btn';
                dashboardBtn.className = 'btn btn-info';
                dashboardBtn.textContent = 'üìä Quantity Analysis';
                dashboardBtn.onclick = createSystemWideQuantityDashboard;
                dashboardBtn.title = 'View system-wide quantity analysis and cross-usage patterns';
                actionsDiv.appendChild(dashboardBtn);
            }
        }

        function renderAll() {
            renderComponents();
            renderAssemblies();
            renderSystems();
            renderVendors();
            updateDropdowns();
        }

        // Filter functions
        function filterComponents() {
            const search = document.getElementById('comp-search').value.toLowerCase();
            const rows = document.querySelectorAll('#components-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterAssemblies() {
            const search = document.getElementById('assembly-search').value.toLowerCase();
            const rows = document.querySelectorAll('#assemblies-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterSystems() {
            const search = document.getElementById('system-search').value.toLowerCase();
            const rows = document.querySelectorAll('#systems-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Update statistics
        function updateStats() {
            document.getElementById('total-components').textContent = data.components.length;
            document.getElementById('total-assemblies').textContent = data.assemblies.length;
            document.getElementById('total-systems').textContent = data.systems.length;
            
            document.getElementById('export-components').textContent = data.components.length;
            document.getElementById('export-assemblies').textContent = data.assemblies.length;
            document.getElementById('export-systems').textContent = data.systems.length;
        }

        // Export functions
        function exportComponents() {
            if (data.components.length === 0) {
                alert('No components to export');
                return;
            }
            
            // Get all possible field names
            const allFields = new Set(['KPN', 'Category', 'Subcategory', 'Date Added']);
            Object.values(categoryConfigs).forEach(config => {
                config.fields.forEach(field => {
                    allFields.add(field.label);
                });
            });
            
            const headers = Array.from(allFields);
            let csv = headers.join(',') + '\n';
            
            csv += data.components.map(c => {
                return headers.map(header => {
                    let value = '';
                    switch(header) {
                        case 'KPN': value = c.kpn; break;
                        case 'Category': value = c.category; break;
                        case 'Subcategory': value = c.subcategory; break;
                        case 'Date Added': value = c.dateAdded; break;
                        case 'Value': value = c.value || ''; break;
                        case 'Package': value = c.package || ''; break;
                        case 'Tolerance': value = c.tolerance || ''; break;
                        case 'Temp Rating': value = c.temp_rating || ''; break;
                        case 'Preferred Vendor': value = c.preferred_vendor || ''; break;
                        case 'Voltage': value = c.voltage || ''; break;
                        case 'Rating': value = c.rating || ''; break;
                        case 'Manufacturer PN': value = c.manufacturer_pn || ''; break;
                        case 'Description': value = c.description || ''; break;
                        case 'Datasheet/Product Link': value = c.datasheet_link || ''; break;
                        case 'Current Rating': value = c.current_rating || ''; break;
                        case 'Voltage Rating': value = c.voltage_rating || ''; break;
                        case 'Pitch': value = c.pitch || ''; break;
                        case 'Pins': value = c.pins || ''; break;
                        case 'Actuation Force': value = c.actuation_force || ''; break;
                        case 'Dimensions': value = c.dimensions || ''; break;
                        case 'Layers': value = c.layers || ''; break;
                        case 'Thickness': value = c.thickness || ''; break;
                        case 'Material': value = c.material || ''; break;
                        case 'Finish': value = c.finish || ''; break;
                        case 'Color': value = c.color || ''; break;
                        case 'CAD File Link': value = c.file_link || ''; break;
                        case 'Length': value = c.length || ''; break;
                        case 'Connectors': value = c.connectors || ''; break;
                        case 'Wire Gauge': value = c.wire_gauge || ''; break;
                        case 'Manufacturer': value = c.manufacturer || ''; break;
                        default: value = '';
                    }
                    return `"${value}"`;
                }).join(',');
            }).join('\n');
            
            downloadCSV(csv, 'kinben-components.csv');
        }

        function exportAssemblies() {
            if (data.assemblies.length === 0) {
                alert('No assemblies to export');
                return;
            }
            
            const csv = 'Assembly Name,Version,Status,Description,Assembly Items,Date Added\n' +
                data.assemblies.map(a => 
                    `"${a.name}",${a.version},${a.status},"${a.description}",${a.bom.length},${a.dateAdded}`
                ).join('\n');
            
            downloadCSV(csv, 'kinben-assemblies.csv');
        }

        function exportSystems() {
            if (data.systems.length === 0) {
                alert('No systems to export');
                return;
            }
            
            const csv = 'System Name,Version,Status,Description,Item Count,Date Added\n' +
                data.systems.map(s => {
                    const itemCount = s.items ? s.items.length : (s.pcbs ? s.pcbs.length : 0);
                    return `"${s.name}",${s.version},${s.status},"${s.description}",${itemCount},${s.dateAdded}`;
                }).join('\n');
            
            downloadCSV(csv, 'kinben-systems.csv');
        }

        function exportAll() {
            exportComponents();
            exportAssemblies();
            exportSystems();
        }

        // Vendor management functions
        function addVendor() {
            const vendorName = document.getElementById('new-vendor-name').value.trim();
            if (!vendorName) {
                alert('Please enter a vendor name');
                return;
            }
            
            if (data.vendors.includes(vendorName)) {
                alert('Vendor already exists');
                return;
            }
            
            data.vendors.push(vendorName);
            data.vendors.sort(); // Keep vendors sorted
            saveData();
            renderVendors();
            
            // Clear input
            document.getElementById('new-vendor-name').value = '';
            
            alert(`Added vendor: ${vendorName}`);
        }
        
        function removeVendor(vendorName) {
            if (confirm(`Remove vendor "${vendorName}"?`)) {
                data.vendors = data.vendors.filter(v => v !== vendorName);
                saveData();
                renderVendors();
            }
        }
        
        function renderVendors() {
            const container = document.getElementById('vendors-container');
            if (!container) return;
            
            container.innerHTML = '';
            data.vendors.forEach(vendor => {
                const vendorTag = document.createElement('div');
                vendorTag.style.cssText = 'background: #e3f2fd; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px;';
                vendorTag.innerHTML = `
                    <span>${vendor}</span>
                    <button onclick="removeVendor('${vendor}')" style="background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
                `;
                container.appendChild(vendorTag);
            });
        }
        
        // Component editing functionality
        function editComponent(kpn) {
            const component = data.components.find(c => c.kpn === kpn);
            if (!component) {
                alert('Component not found');
                return;
            }
            
            // Switch to components tab
            showTab('components');
            
            // Set category and subcategory
            document.getElementById('comp-category').value = component.category;
            updateComponentSubcategories();
            document.getElementById('comp-subcategory').value = component.subcategory;
            updateComponentFields();
            generateComponentKPN();
            
            // Fill in the dynamic fields
            const config = categoryConfigs[component.category];
            if (config) {
                config.fields.forEach(field => {
                    const fieldElement = document.getElementById(`comp-${field.id}`);
                    if (fieldElement) {
                        const value = component[field.id.replace('-', '_')] || '';
                        if (field.type === 'vendor-select') {
                            fieldElement.value = value;
                        } else {
                            fieldElement.value = value;
                        }
                    }
                });
            }
            
            // Change the add button to update mode
            const addButton = document.querySelector('button[onclick="addComponent()"]');
            addButton.textContent = 'Update Component';
            addButton.setAttribute('onclick', `updateComponent('${kpn}')`);
            
            // Show cancel edit button
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            
            // Scroll to form
            document.getElementById('components').scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateComponent(originalKPN) {
            const category = document.getElementById('comp-category').value;
            const subcategory = document.getElementById('comp-subcategory').value;
            
            if (!category || !subcategory) {
                alert('Please select category and subcategory first');
                return;
            }
            
            // Find component index
            const componentIndex = data.components.findIndex(c => c.kpn === originalKPN);
            if (componentIndex === -1) {
                alert('Component not found');
                return;
            }
            
            const kpn = document.getElementById('comp-kpn').value || document.getElementById('comp-kpn-preview').textContent;
            
            // Collect data from dynamic fields
            const component = {
                kpn,
                category,
                subcategory,
                status: data.components[componentIndex].status || 'Active', // Keep original status
                dateAdded: data.components[componentIndex].dateAdded, // Keep original date
                archivedDate: data.components[componentIndex].archivedDate, // Keep archived date if exists
                archivedBy: data.components[componentIndex].archivedBy // Keep archived by if exists
            };
            
            // Validate required fields and collect data
            const config = categoryConfigs[category];
            let missingRequired = [];
            
            config.fields.forEach(field => {
                const fieldElement = document.getElementById(`comp-${field.id}`);
                if (fieldElement) {
                    const value = fieldElement.value.trim();
                    if (field.required && !value) {
                        missingRequired.push(field.label);
                    }
                    component[field.id.replace('-', '_')] = value;
                }
            });
            
            if (missingRequired.length > 0) {
                alert(`Please fill in all required fields: ${missingRequired.join(', ')}`);
                return;
            }
            
            // Update component
            data.components[componentIndex] = component;
            saveData();
            renderComponents();
            
            // Reset form
            resetComponentForm();
            
            alert('Component updated successfully!');
        }
        
        function resetComponentForm() {
            document.getElementById('comp-category').value = '';
            document.getElementById('comp-subcategory').value = '';
            document.getElementById('comp-kpn-preview').textContent = 'Select category and subcategory';
            
            // Clear dynamic fields
            const dynamicFieldsContainer = document.getElementById('component-dynamic-fields');
            dynamicFieldsContainer.innerHTML = `
                <p style="color: #666; text-align: center; margin: 40px 0;">
                    Select a category and subcategory to display component-specific fields
                </p>
            `;
            
            // Reset button
            const addButton = document.querySelector('button[onclick^="updateComponent"], button[onclick="addComponent()"]');
            addButton.textContent = 'Add Component';
            addButton.setAttribute('onclick', 'addComponent()');
            
            // Hide cancel edit button
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        // Archive component (Team and Admin can do this)
        // Global variable to track bulk selection mode
        let bulkSelectionMode = false;

        // Toggle bulk selection mode
        function toggleBulkSelection() {
            bulkSelectionMode = !bulkSelectionMode;
            const bulkBtn = document.getElementById('bulk-select-btn');
            const bulkActions = document.getElementById('bulk-actions');
            const bulkHeader = document.getElementById('bulk-select-header');
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            
            if (bulkSelectionMode) {
                bulkBtn.textContent = 'Exit Bulk Select';
                bulkBtn.style.background = '#dc3545';
                bulkActions.style.display = 'block';
                bulkHeader.style.display = '';
                
                // Show delete button only for admin users
                if (currentUser.role === 'admin') {
                    bulkDeleteBtn.style.display = '';
                }
                
                renderComponents(); // Re-render to show checkboxes
            } else {
                bulkBtn.textContent = 'Enable Bulk Select';
                bulkBtn.style.background = '#6c757d';
                bulkActions.style.display = 'none';
                bulkHeader.style.display = 'none';
                bulkDeleteBtn.style.display = 'none';
                
                // Clear all selections
                document.getElementById('select-all-checkbox').checked = false;
                renderComponents(); // Re-render to hide checkboxes
            }
        }

        // Toggle all checkboxes
        function toggleAllCheckboxes(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.component-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = masterCheckbox.checked;
            });
        }

        // Select all components
        function selectAllComponents() {
            const masterCheckbox = document.getElementById('select-all-checkbox');
            masterCheckbox.checked = true;
            toggleAllCheckboxes(masterCheckbox);
        }

        // Deselect all components
        function deselectAllComponents() {
            const masterCheckbox = document.getElementById('select-all-checkbox');
            masterCheckbox.checked = false;
            toggleAllCheckboxes(masterCheckbox);
        }

        // Get selected component KPNs
        function getSelectedComponentKPNs() {
            const selectedKPNs = [];
            const checkboxes = document.querySelectorAll('.component-checkbox:checked');
            checkboxes.forEach(checkbox => {
                selectedKPNs.push(checkbox.value);
            });
            return selectedKPNs;
        }

        // Bulk archive components
        function bulkArchiveComponents() {
            const selectedKPNs = getSelectedComponentKPNs();
            
            if (selectedKPNs.length === 0) {
                alert('Please select components to archive.');
                return;
            }
            
            if (confirm(`Are you sure you want to archive ${selectedKPNs.length} selected components? Archived components cannot be used in new BOMs.`)) {
                let archivedCount = 0;
                
                selectedKPNs.forEach(kpn => {
                    const componentIndex = data.components.findIndex(c => c.kpn === kpn);
                    if (componentIndex !== -1 && data.components[componentIndex].status !== 'Archived') {
                        data.components[componentIndex].status = 'Archived';
                        data.components[componentIndex].archivedDate = new Date().toISOString().split('T')[0];
                        data.components[componentIndex].archivedBy = currentUser.username;
                        archivedCount++;
                    }
                });
                
                if (archivedCount > 0) {
                    saveData();
                    renderComponents();
                    updateDropdowns();
                    alert(`Successfully archived ${archivedCount} components.`);
                    
                    // Clear selections
                    deselectAllComponents();
                } else {
                    alert('No components were archived (they may already be archived).');
                }
            }
        }

        // Bulk delete components (Admin only)
        function bulkDeleteComponents() {
            if (currentUser.role !== 'admin') {
                alert('Only Admin users can delete components.');
                return;
            }
            
            const selectedKPNs = getSelectedComponentKPNs();
            
            if (selectedKPNs.length === 0) {
                alert('Please select components to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to PERMANENTLY DELETE ${selectedKPNs.length} selected components? This will allow their KPNs to be reused for new components.`)) {
                let deletedCount = 0;
                
                // Delete in reverse order to avoid index issues
                for (let i = data.components.length - 1; i >= 0; i--) {
                    if (selectedKPNs.includes(data.components[i].kpn)) {
                        data.components.splice(i, 1);
                        deletedCount++;
                    }
                }
                
                if (deletedCount > 0) {
                    saveData();
                    renderComponents();
                    updateDropdowns();
                    alert(`Successfully deleted ${deletedCount} components. Their KPNs can now be reused.`);
                    
                    // Clear selections
                    deselectAllComponents();
                } else {
                    alert('No components were deleted.');
                }
            }
        }

        function archiveComponent(kpn) {
            if (confirm(`Are you sure you want to archive component ${kpn}? Archived components cannot be used in new BOMs.`)) {
                const componentIndex = data.components.findIndex(c => c.kpn === kpn);
                if (componentIndex !== -1) {
                    data.components[componentIndex].status = 'Archived';
                    data.components[componentIndex].archivedDate = new Date().toISOString().split('T')[0];
                    data.components[componentIndex].archivedBy = currentUser.username;
                    saveData();
                    renderComponents();
                    updateDropdowns(); // Refresh dropdowns to exclude archived components
                    alert(`Component ${kpn} has been archived.`);
                }
            }
        }

        // Delete component (Admin only - allows KPN reuse)
        function deleteComponent(kpn) {
            if (currentUser.role !== 'admin') {
                alert('Only Admin users can delete components.');
                return;
            }
            
            if (confirm(`Are you sure you want to PERMANENTLY DELETE component ${kpn}? This will allow the KPN to be reused for new components.`)) {
                const componentIndex = data.components.findIndex(c => c.kpn === kpn);
                if (componentIndex !== -1) {
                    // Remove from components array completely
                    data.components.splice(componentIndex, 1);
                    saveData();
                    renderComponents();
                    updateDropdowns();
                    alert(`Component ${kpn} has been permanently deleted. The KPN can now be reused.`);
                }
            }
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize CSV system first
            initializeCSVSystem();
            
            // Load data - will use localStorage as fallback if CSV not available
            loadData();
        });

        // ============ BOM CSV IMPORT FUNCTIONALITY ============
        
        let currentBOMData = [];
        
        function handleBOMCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('bom-import-status');
            statusDiv.innerHTML = 'üîÑ Processing BOM CSV file...';
            statusDiv.style.color = '#007bff';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const parsedData = Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: function(header) {
                            // Normalize headers to expected format
                            const headerMap = {
                                'refdes': 'RefDes',
                                'reference designator': 'RefDes',
                                'ref': 'RefDes',
                                'kpn': 'KPN',
                                'part number': 'KPN',
                                'kinben_pn': 'KPN',
                                'quantity': 'Quantity',
                                'qty': 'Quantity',
                                'description': 'Description',
                                'desc': 'Description',
                                'notes': 'Notes',
                                'comment': 'Notes'
                            };
                            return headerMap[header.toLowerCase()] || header;
                        }
                    });
                    
                    if (parsedData.errors && parsedData.errors.length > 0) {
                        throw new Error('CSV parsing errors: ' + parsedData.errors.map(e => e.message).join(', '));
                    }
                    
                    currentBOMData = parsedData.data;
                    
                    // Validate and process the BOM data
                    const validationResult = validateBOMData(currentBOMData);
                    
                    if (validationResult.valid) {
                        showBOMPreview(currentBOMData, validationResult);
                        statusDiv.innerHTML = `‚úÖ Successfully parsed ${currentBOMData.length} BOM items`;
                        statusDiv.style.color = '#28a745';
                    } else {
                        statusDiv.innerHTML = `‚ùå ${validationResult.message}`;
                        statusDiv.style.color = '#dc3545';
                    }
                    
                } catch (error) {
                    statusDiv.innerHTML = `‚ùå Error parsing CSV: ${error.message}`;
                    statusDiv.style.color = '#dc3545';
                }
            };
            
            reader.readAsText(file);
        }
        
        function validateBOMData(data) {
            if (!data || data.length === 0) {
                return { valid: false, message: 'No data found in CSV file' };
            }
            
            // Check for required columns
            const firstRow = data[0];
            const requiredColumns = ['RefDes', 'KPN', 'Quantity'];
            const missingColumns = requiredColumns.filter(col => !(col in firstRow));
            
            if (missingColumns.length > 0) {
                return { 
                    valid: false, 
                    message: `Missing required columns: ${missingColumns.join(', ')}. Expected: RefDes, KPN, Quantity` 
                };
            }
            
            // Validate data types and cross-reference KPNs
            let validItems = 0;
            let missingKPNs = [];
            let invalidQuantities = [];
            
            // Get components from the actual loaded data (CSV system or localStorage fallback)
            let existingComponents = [];
            
            // Debug: Check what's available
            console.log('DEBUG: window.components exists?', typeof window.components);
            console.log('DEBUG: window.components structure:', window.components);
            console.log('DEBUG: typeof components?', typeof components);
            console.log('DEBUG: components structure:', components);
            
            // Try different ways to access the CSV components data
            if (typeof components !== 'undefined' && Array.isArray(components) && components.length > 0) {
                // Use global components variable if it's an array
                existingComponents = components;
                console.log('DEBUG: Using global components array:', existingComponents.length);
            } else if (typeof components !== 'undefined' && typeof components === 'object') {
                // If components is an object, try to extract all values
                existingComponents = Object.values(components).flat();
                console.log('DEBUG: Using components object values:', existingComponents.length);
                // If Object.values didn't work, fall through to DOM extraction
                if (existingComponents.length === 0) {
                    console.log('DEBUG: Object.values returned empty, trying DOM extraction...');
                }
            } else if (window.components && Array.isArray(window.components) && window.components.length > 0) {
                // Use window.components if it's an array
                existingComponents = window.components;
                console.log('DEBUG: Using window.components array:', existingComponents.length);
            } else if (window.components && typeof window.components === 'object') {
                // If window.components is an object, try to extract all values
                existingComponents = Object.values(window.components).flat();
                console.log('DEBUG: Using window.components object values:', existingComponents.length);
                // If Object.values didn't work, fall through to DOM extraction
                if (existingComponents.length === 0) {
                    console.log('DEBUG: Object.values returned empty, trying DOM extraction...');
                }
            }
            
            // If we still don't have components, try DOM extraction
            if (existingComponents.length === 0) {
                // Try to extract components from the DOM table (CSV system might store data here)
                const tableRows = document.querySelectorAll('#components-tbody tr');
                console.log('DEBUG: Found table rows:', tableRows.length);
                console.log('DEBUG: Components table exists?', !!document.getElementById('components-tbody'));
                console.log('DEBUG: Current active tab:', document.querySelector('.tab.active')?.textContent);
                
                // Force refresh components table if it's empty
                if (tableRows.length === 0) {
                    console.log('DEBUG: No table rows found, trying to trigger component load...');
                    // Try calling the function that loads components
                    if (typeof loadData === 'function') {
                        loadData();
                        // Re-check after loading
                        const newTableRows = document.querySelectorAll('#components-tbody tr');
                        console.log('DEBUG: Table rows after loadData:', newTableRows.length);
                    }
                }
                
                const finalTableRows = document.querySelectorAll('#components-tbody tr');
                if (finalTableRows.length > 0) {
                    existingComponents = [];
                    finalTableRows.forEach((row, index) => {
                        const cells = row.querySelectorAll('td');
                        console.log(`DEBUG: Row ${index + 1} has ${cells.length} cells`);
                        if (cells.length >= 7) { // Ensure we have enough columns
                            const component = {
                                kpn: cells[0].textContent.trim(),
                                category: cells[1].textContent.trim(),
                                subcategory: cells[2].textContent.trim(),
                                value: cells[3].textContent.trim(),
                                package: cells[4].textContent.trim(),
                                manufacturer: cells[5].textContent.trim(),
                                preferredVendor: cells[6].textContent.trim()
                            };
                            existingComponents.push(component);
                            if (index < 3) { // Log first 3 components
                                console.log(`DEBUG: Component ${index + 1}:`, component);
                            }
                        }
                    });
                    console.log('DEBUG: Extracted components from DOM table:', existingComponents.length);
                } else {
                    // Final fallback to localStorage
                    existingComponents = JSON.parse(localStorage.getItem('kinben-components') || '[]');
                    console.log('DEBUG: Using localStorage components:', existingComponents.length);
                }
            }
            console.log('DEBUG: First few components:', existingComponents.slice(0, 3));
            
            const kpnMap = {};
            existingComponents.forEach(comp => kpnMap[comp.kpn] = comp);
            console.log('DEBUG: KPN Map created:', Object.keys(kpnMap).slice(0, 5));
            
            data.forEach((row, index) => {
                console.log(`DEBUG: Checking row ${index + 1}:`, row);
                
                // Check KPN exists
                if (row.KPN && !kpnMap[row.KPN]) {
                    console.log(`DEBUG: Missing KPN: ${row.KPN}`);
                    missingKPNs.push(`${row.RefDes || `Row ${index + 1}`}: ${row.KPN}`);
                } else if (row.KPN && kpnMap[row.KPN]) {
                    console.log(`DEBUG: Found KPN: ${row.KPN}`);
                }
                
                // Check quantity is valid
                const qty = parseInt(row.Quantity);
                if (isNaN(qty) || qty <= 0) {
                    console.log(`DEBUG: Invalid quantity: ${row.Quantity}`);
                    invalidQuantities.push(`${row.RefDes || `Row ${index + 1}`}: ${row.Quantity}`);
                } else {
                    console.log(`DEBUG: Valid quantity: ${qty}`);
                    validItems++;
                }
            });
            
            console.log('DEBUG: Validation results:', {
                validItems,
                missingKPNs: missingKPNs.length,
                invalidQuantities: invalidQuantities.length
            });
            
            return {
                valid: true,
                validItems,
                missingKPNs,
                invalidQuantities,
                kpnMap
            };
        }
        
        function showBOMPreview(data, validationResult) {
            const previewSection = document.getElementById('bom-preview-section');
            const previewContent = document.getElementById('bom-preview-content');
            
            let previewHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>üìä Import Summary:</strong><br>
                    ‚Ä¢ Total items: ${data.length}<br>
                    ‚Ä¢ Valid items: ${validationResult.validItems}<br>
                    ‚Ä¢ Missing KPNs: ${validationResult.missingKPNs.length}<br>
                    ‚Ä¢ Invalid quantities: ${validationResult.invalidQuantities.length}
                </div>
            `;
            
            if (validationResult.missingKPNs.length > 0) {
                previewHTML += `
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                        <strong>‚ö†Ô∏è Missing KPNs (${validationResult.missingKPNs.length}):</strong><br>
                        ${validationResult.missingKPNs.slice(0, 5).join('<br>')}
                        ${validationResult.missingKPNs.length > 5 ? `<br>... and ${validationResult.missingKPNs.length - 5} more` : ''}
                    </div>
                `;
            }
            
            if (validationResult.invalidQuantities.length > 0) {
                previewHTML += `
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
                        <strong>‚ùå Invalid Quantities (${validationResult.invalidQuantities.length}):</strong><br>
                        ${validationResult.invalidQuantities.slice(0, 5).join('<br>')}
                        ${validationResult.invalidQuantities.length > 5 ? `<br>... and ${validationResult.invalidQuantities.length - 5} more` : ''}
                    </div>
                `;
            }
            
            // Show preview table of first 5 valid items
            const validItems = data.filter((row, index) => {
                const qty = parseInt(row.Quantity);
                return row.KPN && validationResult.kpnMap[row.KPN] && !isNaN(qty) && qty > 0;
            });
            
            if (validItems.length > 0) {
                previewHTML += `
                    <div style="margin-bottom: 15px;">
                        <strong>‚úÖ Preview of Valid Items (showing first 5):</strong>
                        <table class="table" style="margin-top: 10px;">
                            <thead>
                                <tr>
                                    <th>RefDes</th>
                                    <th>KPN</th>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                validItems.slice(0, 5).forEach(row => {
                    const component = validationResult.kpnMap[row.KPN];
                    previewHTML += `
                        <tr>
                            <td>${row.RefDes || 'N/A'}</td>
                            <td>${row.KPN}</td>
                            <td>${component.description || row.Description || 'N/A'}</td>
                            <td>${row.Quantity}</td>
                            <td>${row.Notes || ''}</td>
                        </tr>
                    `;
                });
                
                previewHTML += `
                            </tbody>
                        </table>
                        ${validItems.length > 5 ? `<p><em>... and ${validItems.length - 5} more valid items</em></p>` : ''}
                    </div>
                `;
            }
            
            previewContent.innerHTML = previewHTML;
            previewSection.style.display = 'block';
        }
        
        function confirmBOMImport() {
            if (!currentBOMData || currentBOMData.length === 0) {
                alert('No BOM data to import');
                return;
            }
            
            const validationResult = validateBOMData(currentBOMData);
            if (!validationResult.valid) {
                alert('BOM data validation failed: ' + validationResult.message);
                return;
            }
            
            let importedCount = 0;
            let skippedCount = 0;
            
            currentBOMData.forEach((row, index) => {
                const qty = parseInt(row.Quantity);
                
                console.log(`DEBUG: Processing import row ${index + 1}:`, row);
                console.log(`DEBUG: KPN exists in map?`, !!validationResult.kpnMap[row.KPN]);
                console.log(`DEBUG: Quantity valid?`, !isNaN(qty) && qty > 0);
                
                // Only import valid items with existing KPNs
                if (row.KPN && validationResult.kpnMap[row.KPN] && !isNaN(qty) && qty > 0) {
                    console.log(`DEBUG: Importing item:`, row.KPN);
                    // Add to current assembly BOM items display
                    addBOMItemFromImport({
                        type: 'component',
                        kpn: row.KPN,
                        quantity: qty,
                        refdes: row.RefDes || '',
                        notes: row.Notes || ''
                    });
                    importedCount++;
                } else {
                    console.log(`DEBUG: Skipping item:`, row.KPN, 'Reasons:', {
                        hasKPN: !!row.KPN,
                        kpnInMap: !!validationResult.kpnMap[row.KPN],  
                        validQty: !isNaN(qty) && qty > 0
                    });
                    skippedCount++;
                }
            });
            
            // Clear the import section
            cancelBOMImport();
            
            // Show success message
            const statusDiv = document.getElementById('bom-import-status');
            statusDiv.innerHTML = `‚úÖ Imported ${importedCount} items to assembly. ${skippedCount > 0 ? `Skipped ${skippedCount} invalid items.` : ''}`;
            statusDiv.style.color = '#28a745';
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }
        
        function cancelBOMImport() {
            document.getElementById('bom-preview-section').style.display = 'none';
            document.getElementById('bom-csv-file').value = '';
            currentBOMData = [];
        }
        
        function addBOMItemFromImport(itemData) {
            console.log('DEBUG: addBOMItemFromImport called with:', itemData);
            
            // Find the component from DOM data (same as validation)
            let existingComponents = [];
            const tableRows = document.querySelectorAll('#components-tbody tr');
            
            if (tableRows.length > 0) {
                tableRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        const component = {
                            kpn: cells[0].textContent.trim(),
                            category: cells[1].textContent.trim(),
                            subcategory: cells[2].textContent.trim(),
                            value: cells[3].textContent.trim(),
                            package: cells[4].textContent.trim(),
                            manufacturer: cells[5].textContent.trim(),
                            preferredVendor: cells[6].textContent.trim()
                        };
                        existingComponents.push(component);
                    }
                });
            }
            
            const component = existingComponents.find(c => c.kpn === itemData.kpn);
            if (!component) {
                console.log('DEBUG: Component not found for KPN:', itemData.kpn);
                return;
            }
            
            // Add to the same currentBOM array that manual items use
            const bomItem = {
                kpn: itemData.kpn,
                componentName: `${component.manufacturer || 'Unknown'} ${component.value || itemData.kpn}`,
                quantity: itemData.quantity,
                refdes: itemData.refdes,
                notes: itemData.notes || ''
            };
            
            console.log('DEBUG: Adding to currentBOM:', bomItem);
            currentBOM.push(bomItem);
            
            // Use the same render function as manual items
            renderBOMItems();
            
            console.log('DEBUG: currentBOM now has', currentBOM.length, 'items');
        }
        
        function downloadBOMTemplate() {
            // Get assembly type for context-aware template
            const assemblyType = document.getElementById('assemblyType').value || 'pcb';
            // Get existing components to create realistic examples
            let existingComponents = [];
            
            // Extract components from DOM table
            const tableRows = document.querySelectorAll('#components-tbody tr');
            if (tableRows.length > 0) {
                tableRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        const component = {
                            kpn: cells[0].textContent.trim(),
                            category: cells[1].textContent.trim(),
                            subcategory: cells[2].textContent.trim(),
                            value: cells[3].textContent.trim(),
                            package: cells[4].textContent.trim(),
                            manufacturer: cells[5].textContent.trim(),
                            preferredVendor: cells[6].textContent.trim()
                        };
                        existingComponents.push(component);
                    }
                });
            } else {
                existingComponents = JSON.parse(localStorage.getItem('kinben-components') || '[]');
            }
            
            let templateContent = 'RefDes,KPN,Quantity,Description,Notes\n';
            
            if (existingComponents.length > 0) {
                let exampleIndex = 1;
                
                if (assemblyType === 'cable') {
                    // Cable assembly template - prioritize connectors and cable components
                    const connectors = existingComponents.filter(c => c.category === 'connectors');
                    const mechanical = existingComponents.filter(c => c.category === 'mechanical');
                    const other = existingComponents.filter(c => !['connectors', 'mechanical'].includes(c.category));
                    
                    // Add connector examples
                    if (connectors.length > 0) {
                        const comp = connectors[0];
                        templateContent += `J1,${comp.kpn},1,"${comp.value || comp.description || 'Connector'}","Source connector"\n`;
                        exampleIndex++;
                    }
                    if (connectors.length > 1) {
                        const comp = connectors[1];
                        templateContent += `J2,${comp.kpn},1,"${comp.value || comp.description || 'Connector'}","Destination connector"\n`;
                        exampleIndex++;
                    }
                    
                    // Add mechanical components (wire, heat shrink, etc.)
                    if (mechanical.length > 0) {
                        const comp = mechanical[0];
                        templateContent += `W1,${comp.kpn},1,"${comp.value || comp.description || 'Wire/Cable'}","Main cable assembly"\n`;
                        exampleIndex++;
                    }
                    
                    // Add other components if available
                    if (other.length > 0 && exampleIndex <= 3) {
                        const comp = other[0];
                        const refdes = getExampleRefDes(comp.category, exampleIndex);
                        templateContent += `${refdes},${comp.kpn},1,"${comp.value || comp.description || 'Component'}","Additional component"\n`;
                        exampleIndex++;
                    }
                } else {
                    // PCB assembly template - use existing logic with electronic components
                    const resistors = existingComponents.filter(c => c.category === 'resistors');
                    const capacitors = existingComponents.filter(c => c.category === 'capacitors');
                    const inductors = existingComponents.filter(c => c.category === 'inductors');
                    const diodes = existingComponents.filter(c => c.category === 'diodes');
                    const transistors = existingComponents.filter(c => c.category === 'transistors');
                    const connectors = existingComponents.filter(c => c.category === 'connectors');
                    
                    // Add one example from each category if available
                    if (resistors.length > 0) {
                        const comp = resistors[0];
                        templateContent += `R${exampleIndex},${comp.kpn},1,"${comp.value || comp.description || 'Resistor'}","Example resistor"\n`;
                        exampleIndex++;
                    }
                    
                    if (capacitors.length > 0) {
                        const comp = capacitors[0];
                        templateContent += `C${exampleIndex},${comp.kpn},2,"${comp.value || comp.description || 'Capacitor'}","Decoupling capacitor"\n`;
                        exampleIndex++;
                    }
                    
                    if (inductors.length > 0) {
                        const comp = inductors[0];
                        templateContent += `L${exampleIndex},${comp.kpn},1,"${comp.value || comp.description || 'Inductor'}","Power supply filter"\n`;
                        exampleIndex++;
                    }
                    
                    if (diodes.length > 0) {
                        const comp = diodes[0];
                        templateContent += `D${exampleIndex},${comp.kpn},1,"${comp.value || comp.description || 'Diode'}","Protection diode"\n`;
                        exampleIndex++;
                    }
                    
                    if (transistors.length > 0) {
                        const comp = transistors[0];
                        templateContent += `Q${exampleIndex},${comp.kpn},1,"${comp.value || comp.description || 'Transistor'}","Switching transistor"\n`;
                        exampleIndex++;
                    }
                    
                    if (connectors.length > 0) {
                        const comp = connectors[0];
                        templateContent += `J${exampleIndex},${comp.kpn},1,"${comp.value || comp.description || 'Connector'}","Main connector"\n`;
                        exampleIndex++;
                    }
                }
                
                // If we still don't have enough examples, add more from any category
                if (exampleIndex <= 2 && existingComponents.length > 0) {
                    const remaining = existingComponents.slice(0, 5);
                    remaining.forEach((comp) => {
                        if (exampleIndex <= 5) {
                            const refdes = getExampleRefDes(comp.category, exampleIndex);
                            templateContent += `${refdes},${comp.kpn},1,"${comp.value || comp.description || comp.manufacturer || 'Component'}","Example component"\n`;
                            exampleIndex++;
                        }
                    });
                }
                
            } else {
                // Generic examples if no components exist
                templateContent += 'R1,RES-STD-001,1,"10kŒ© resistor ¬±5% 0603","Pull-up resistor"\n';
                templateContent += 'C1,CAP-CER-001,2,"100nF capacitor X7R 0603","Decoupling capacitor"\n';
                templateContent += 'U1,IC-MCU-001,1,"ARM Cortex-M4 MCU","Main processor"\n';
                templateContent += 'D1,LED-STD-001,1,"Red LED 0603","Status indicator"\n';
                templateContent += 'L1,IND-PWR-001,1,"10¬µH inductor","Power supply filter"\n';
            }
            
            // Create and download the file
            const blob = new Blob([templateContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'BOM_Template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show confirmation
            const statusDiv = document.getElementById('bom-import-status');
            statusDiv.innerHTML = '‚úÖ BOM template downloaded with YOUR actual KPNs! Ready to import.';
            statusDiv.style.color = '#28a745';
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }
        
        function getExampleRefDes(category, index) {
            const refDesMap = {
                'resistors': 'R',
                'capacitors': 'C', 
                'inductors': 'L',
                'diodes': 'D',
                'transistors': 'Q',
                'integrated-circuits': 'U',
                'connectors': 'J',
                'switches': 'SW',
                'crystals-oscillators': 'Y',
                'leds': 'LED',
                'fuses': 'F',
                'relays': 'K',
                'sensors': 'U',
                'optocouplers': 'U'
            };
            
            const prefix = refDesMap[category] || 'U';
            return `${prefix}${index}`;
        }

        // ============ END BOM CSV IMPORT FUNCTIONALITY ============
        
    </script>
</body>
</html>