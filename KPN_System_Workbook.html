<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kinben KPN System Master Workbook</title>
    <style>
        body { font-family: Calibri, Arial, sans-serif; margin: 0; }
        .workbook-container { padding: 20px; }
        .sheet-tabs { border-bottom: 2px solid #0078d4; margin-bottom: 20px; overflow-x: auto; white-space: nowrap; }
        .tab { display: inline-block; padding: 10px 20px; margin-right: 5px; background: #f5f5f5; border: 1px solid #ccc; cursor: pointer; border-radius: 5px 5px 0 0; transition: all 0.3s; }
        .tab:hover { background: #e3f2fd; }
        .tab.active { background: #0078d4; color: white; border-bottom: 2px solid #0078d4; }
        .sheet { display: none; }
        .sheet.active { display: block; }
        
        /* Enhanced Landing Page */
        .landing-page { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 10px; margin-bottom: 30px; }
        .landing-title { font-size: 32px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .landing-subtitle { font-size: 18px; text-align: center; margin-bottom: 30px; opacity: 0.9; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .info-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; }
        .info-card h3 { margin-top: 0; color: #fff; }
        .naming-convention { background: rgba(255,255,255,0.15); padding: 20px; border-radius: 8px; margin: 20px 0; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; color: #0078d4; }
        .stat-label { color: #666; font-size: 14px; margin-top: 5px; }
        
        /* Action Buttons */
        .action-buttons { display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; transition: all 0.3s; }
        .btn-primary { background: #0078d4; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        /* Search and Filter */
        .search-controls { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .search-input { width: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        .filter-select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        
        /* Tables */
        .category-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .category-table th { background: #0078d4; color: white; padding: 12px; text-align: left; font-weight: bold; }
        .category-table td { padding: 10px 12px; border-bottom: 1px solid #eee; }
        .category-table tr:nth-child(even) { background: #f9f9f9; }
        .category-table tr:hover { background: #e3f2fd; }
        .component-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .component-table th { background: #2c5aa0; color: white; padding: 8px; text-align: left; font-weight: bold; position: sticky; top: 0; }
        .component-table td { padding: 6px 8px; border-bottom: 1px solid #ddd; white-space: nowrap; }
        .component-table tr:nth-child(even) { background: #f8f9fa; }
        .component-table tr:hover { background: #e3f2fd; }
        
        /* Status indicators */
        .status-active { color: #28a745; font-weight: bold; }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-obsolete { color: #dc3545; font-weight: bold; }
        
        /* Section headers */
        .section-header { background: #f1f3f4; padding: 15px; margin: 20px 0 10px 0; border-left: 4px solid #0078d4; font-weight: bold; border-radius: 0 8px 8px 0; }
        
        /* Add Component Form */
        .add-component-form { background: #f8f9fa; padding: 30px; border-radius: 10px; margin: 20px 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }

        /* Bulk Import Interface */
        .bulk-import-container { background: #f8f9fa; padding: 30px; border-radius: 10px; margin: 20px 0; }
        .upload-area { border: 2px dashed #0078d4; border-radius: 10px; padding: 40px; text-align: center; margin: 20px 0; background: white; transition: all 0.3s; }
        .upload-area.dragover { background: #e3f2fd; border-color: #1976d2; }
        .upload-area input[type="file"] { display: none; }
        .upload-icon { font-size: 48px; color: #0078d4; margin-bottom: 15px; }
        .upload-text { font-size: 18px; color: #333; margin-bottom: 10px; }
        .upload-subtext { color: #666; font-size: 14px; }
        .import-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .import-option { background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
        .import-progress { display: none; margin: 20px 0; }
        .progress-bar { background: #f0f0f0; border-radius: 10px; height: 20px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: 0%; transition: width 0.3s; }
        .progress-text { text-align: center; margin-top: 10px; font-weight: bold; }
        .import-results { margin: 20px 0; display: none; }
        .result-summary { background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .result-item { padding: 10px; border-bottom: 1px solid #eee; }
        .result-success { color: #28a745; }
        .result-error { color: #dc3545; }
        .result-warning { color: #ffc107; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .action-buttons { flex-direction: column; }
            .info-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .search-input { width: 100%; margin-bottom: 10px; }
            .sheet-tabs { padding-bottom: 10px; }
        }
        
        /* Export styles */
        .export-options { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .export-button { margin: 5px; }
        
        /* Search Results styles */
        .search-results-header { display: flex; justify-content: between; align-items: center; margin-bottom: 20px; }
        .search-results-info { flex: 1; }
        .search-results-actions { display: flex; gap: 10px; }
        .search-results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .search-results-table th { background: #28a745; color: white; padding: 12px; text-align: left; font-weight: bold; }
        .search-results-table td { padding: 10px 12px; border-bottom: 1px solid #ddd; }
        .search-results-table tr:nth-child(even) { background: #f8f9fa; }
        .search-results-table tr:hover { background: #e3f2fd; }
        .category-badge { background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .search-highlight { background-color: #ffeb3b; font-weight: bold; }
        mark { background-color: #ffeb3b; padding: 1px 2px; border-radius: 2px; }
        
        /* Real-time search */
        .search-input-container { position: relative; display: inline-block; }
        .search-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 100; max-height: 200px; overflow-y: auto; display: none; }
        .search-suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-suggestion-item:hover { background: #f0f0f0; }
        .search-suggestion-item:last-child { border-bottom: none; }
        
        /* Category page filters */
        .category-filters { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #28a745; }
        .category-filters h4 { margin: 0 0 15px 0; color: #333; font-size: 16px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-weight: bold; color: #555; font-size: 14px; }
        .filter-input, .filter-select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .filter-actions { display: flex; gap: 10px; align-items: end; }
        .filter-stats { background: #e3f2fd; padding: 10px 15px; border-radius: 4px; margin-top: 10px; font-size: 14px; color: #1565c0; }
        .hidden-row { display: none !important; }
        
        /* Sortable columns */
        .sortable-header { cursor: pointer; user-select: none; position: relative; padding-right: 20px !important; }
        .sortable-header:hover { background-color: rgba(255, 255, 255, 0.1); }
        .sort-indicator { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 12px; opacity: 0.7; }
        .sort-asc::after { content: " ↑"; }
        .sort-desc::after { content: " ↓"; }
        
        /* Filter badges */
        .active-filters { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 8px; }
        .filter-badge { background: #007bff; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .filter-badge .remove-filter { cursor: pointer; background: rgba(255,255,255,0.3); border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .filter-badge .remove-filter:hover { background: rgba(255,255,255,0.5); }
        
        /* System-level management styles */
        .system-card { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #28a745; }
        .system-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .system-title { font-size: 18px; font-weight: bold; color: #333; }
        .system-kn { background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .system-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 10px 0; font-size: 14px; }
        .meta-item { display: flex; flex-direction: column; }
        .meta-label { font-weight: bold; color: #666; font-size: 12px; }
        .meta-value { color: #333; }
        .hierarchy-view { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .hierarchy-level { margin-left: 20px; border-left: 2px solid #dee2e6; padding-left: 15px; margin-bottom: 10px; }
        .file-attachments { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
        .file-badge { background: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; text-decoration: none; }
        .file-badge:hover { background: #138496; color: white; }
        
        /* BOM hierarchy styles */
        .bom-tree { font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .bom-level-0 { font-weight: bold; color: #28a745; }
        .bom-level-1 { margin-left: 20px; color: #0078d4; }
        .bom-level-2 { margin-left: 40px; color: #6c757d; }
        .bom-level-3 { margin-left: 60px; color: #6c757d; font-style: italic; }
        
        /* Enhanced dashboard for system-level */
        .system-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .overview-card { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .overview-number { font-size: 24px; font-weight: bold; }
        .overview-label { font-size: 14px; opacity: 0.9; }
        
        /* Migration-ready data attributes */
        [data-system-id] { cursor: pointer; }
        [data-assembly-id] { border-left: 3px solid #0078d4; }
        [data-component-id] { border-left: 2px solid #6c757d; }
        
        /* System details modal */
        .system-details { max-width: 100%; }
        .detail-section { margin: 20px 0; }
        .detail-section h4 { color: #333; border-bottom: 2px solid #0078d4; padding-bottom: 5px; margin-bottom: 15px; }
        .detail-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .detail-table td { padding: 8px 12px; border-bottom: 1px solid #eee; }
        .detail-table td:first-child { font-weight: bold; width: 150px; color: #555; }
        .detail-table td:last-child { color: #333; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn-secondary { background: #6c757d; color: white; }
        
        /* Image support styles */
        .image-upload-container { position: relative; border: 2px dashed #ddd; border-radius: 6px; padding: 20px; text-align: center; margin: 10px 0; }
        .image-upload-container:hover { border-color: #007bff; background-color: #f8f9fa; }
        .image-upload-text { color: #666; font-size: 14px; }
        .image-preview { max-width: 200px; max-height: 200px; border-radius: 4px; margin: 10px; border: 1px solid #ddd; }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin: 10px 0; }
        .image-item { position: relative; }
        .image-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .image-remove { position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; }
        .image-caption { font-size: 11px; color: #666; text-align: center; padding: 2px; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger:hover { background: #c82333; }
        
        /* Multiboard Wizard Styles */
        .wizard-steps { display: flex; justify-content: center; margin-bottom: 30px; }
        .wizard-step { 
            padding: 10px 20px; margin: 0 10px; border-radius: 20px; 
            background: #e9ecef; color: #6c757d; font-weight: bold;
            position: relative; transition: all 0.3s;
        }
        .wizard-step.active { background: #0078d4; color: white; }
        .wizard-step.completed { background: #28a745; color: white; }
        
        .wizard-content { min-height: 400px; }
        .wizard-panel { display: none; }
        .wizard-panel.active { display: block; }
        
        .wizard-actions { 
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;
        }
        
        .wizard-assembly-item, .wizard-component-item {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;
            padding: 15px; margin-bottom: 15px; position: relative;
        }
        
        .assembly-header, .component-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        
        .assembly-header h6, .component-header h6 {
            margin: 0; color: #495057; font-weight: bold;
        }
        
        .btn-remove {
            background: #dc3545; color: white; border: none;
            padding: 4px 8px; border-radius: 4px; cursor: pointer;
            font-size: 12px;
        }
        .btn-remove:hover { background: #c82333; }
        
        .wizard-section {
            background: #ffffff; border: 1px solid #dee2e6;
            border-radius: 8px; padding: 20px; margin-bottom: 20px;
        }
        .wizard-section h5 {
            margin: 0 0 15px 0; color: #495057;
            border-bottom: 2px solid #0078d4; padding-bottom: 8px;
        }
        
        .review-section {
            background: #f8f9fa; border-radius: 8px;
            padding: 20px; margin-bottom: 20px;
        }
        .review-section h5 {
            margin: 0 0 15px 0; color: #495057;
            border-bottom: 1px solid #dee2e6; padding-bottom: 8px;
        }
        
        .review-table {
            width: 100%; border-collapse: collapse;
        }
        .review-table td {
            padding: 8px 0; border-bottom: 1px solid #dee2e6;
        }
        .review-table td:first-child {
            width: 150px; font-weight: bold; color: #495057;
        }
        
        .review-item {
            padding: 10px; background: white; border-radius: 4px;
            margin-bottom: 8px; border-left: 3px solid #0078d4;
        }
        .review-item small { color: #6c757d; }
        
        .review-summary {
            background: #e3f2fd; border-radius: 8px; padding: 20px;
            border-left: 4px solid #0078d4;
        }
        .review-summary h5 { margin-top: 0; color: #1565c0; }
        .review-summary ul { margin: 10px 0; }
        .review-summary li { margin-bottom: 5px; }
        
        /* System Composition Styles */
        .composition-group {
            background: #ffffff; border: 1px solid #e3f2fd;
            border-radius: 6px; padding: 15px; margin-bottom: 15px;
        }
        .composition-group h5 {
            margin: 0 0 12px 0; color: #1565c0;
            font-size: 14px; font-weight: bold;
        }
        .composition-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; background: #f8f9fa; border-radius: 4px;
            margin-bottom: 6px; border-left: 3px solid #0078d4;
        }
        .qty-badge {
            background: #28a745; color: white; padding: 2px 8px;
            border-radius: 12px; font-size: 12px; font-weight: bold;
        }
        .refdes-badge {
            background: #17a2b8; color: white; padding: 2px 6px;
            border-radius: 10px; font-size: 11px; font-weight: bold;
            margin-right: 8px;
        }
    </style>
    <script>
        // Component data storage
        let componentData = {
            capacitors: [], resistors: [], inductors: [], diodes: [], transistors: [],
            ics: [], connectors: [], crystals: [], fuses: [], switches: [],
            relays: [], optocouplers: [], sensors: [], mechanical: [], hardware: [], cables: []
        };
        
        // System-level data storage
        let systemData = {
            systems: [        // SKN - Complete products/projects (can contain other systems)
                {
                    id: 1704099600000,
                    systemKN: 'SKN-PROD-001',
                    name: 'IoT Environmental Sensor Hub',
                    type: 'PROD',
                    version: 'v2.1',
                    status: 'Active',
                    assemblies: 3,
                    description: 'Complete IoT system with environmental sensors, wireless connectivity, and power management. Features temperature, humidity, air quality monitoring with LoRaWAN connectivity.',
                    owner: 'John Engineer',
                    files: ['system_architecture.pdf', 'user_manual.pdf', 'certification_docs.zip'],
                    images: [],
                    dateAdded: '2024-01-01',
                    systemAssemblies: [
                        {kn: 'AKN-PCBA-001', name: 'Main Controller PCBA', quantity: 1},
                        {kn: 'AKN-SENS-001', name: 'Sensor Assembly', quantity: 1},
                        {kn: 'AKN-MECH-001', name: 'Mounting Bracket Assembly', quantity: 1}
                    ],
                    systemComponents: [],
                    system3DParts: [
                        {kn: '3PN-ENCL-001', name: 'Main Enclosure Bottom', quantity: 1},
                        {kn: '3PN-ENCL-002', name: 'Main Enclosure Top', quantity: 1},
                        {kn: '3PN-BRKT-001', name: 'Sensor Mount Bracket', quantity: 2}
                    ],
                    systemCables: [
                        {kn: 'CAN-DATA-001', name: 'Sensor Data Cable', quantity: 2},
                        {kn: 'CAN-PWR-001', name: 'Power Distribution Cable', quantity: 1}
                    ]
                },
                {
                    id: 1704186000000,
                    systemKN: 'SKN-PROTO-001',
                    name: 'Smart Home Gateway',
                    type: 'PROTO',
                    version: 'v1.0',
                    status: 'Active',
                    assemblies: 2,
                    description: 'Prototype smart home gateway with WiFi, Zigbee, and Z-Wave support. Includes local processing and cloud connectivity.',
                    owner: 'Sarah Designer',
                    files: ['prototype_specs.pdf', 'test_plan.xlsx'],
                    images: [],
                    dateAdded: '2024-01-02',
                    systemAssemblies: [
                        {kn: 'AKN-PCBA-002', name: 'Gateway Main Board', quantity: 1},
                        {kn: 'AKN-PCBA-003', name: 'RF Module Assembly', quantity: 1}
                    ],
                    systemComponents: [],
                    system3DParts: [
                        {kn: '3PN-ENCL-003', name: 'Gateway Enclosure', quantity: 1}
                    ],
                    systemCables: [
                        {kn: 'CAN-RF-001', name: 'Antenna Coax Cable', quantity: 3}
                    ]
                },
                {
                    id: 1704272400000,
                    systemKN: 'SKN-EVAL-001',
                    name: 'Motor Control Evaluation Board',
                    type: 'EVAL',
                    version: 'v1.5',
                    status: 'Active',
                    assemblies: 1,
                    description: 'Evaluation board for BLDC motor control with integrated gate drivers, current sensing, and debug interfaces.',
                    owner: 'Mike Hardware',
                    files: ['eval_manual.pdf', 'software_examples.zip', 'schematic.pdf'],
                    images: [],
                    dateAdded: '2024-01-03',
                    systemAssemblies: [
                        {kn: 'AKN-PCBA-004', name: 'Motor Control PCBA', quantity: 1}
                    ],
                    systemComponents: [],
                    system3DParts: [
                        {kn: '3PN-BRKT-002', name: 'Heat Sink Mount', quantity: 1}
                    ],
                    systemCables: [
                        {kn: 'CAN-CTRL-001', name: 'Motor Phase Cable', quantity: 1}
                    ]
                }
            ],      
            assemblies: [     // AKN - PCBAs, mechanical assemblies (PCB + components + mechanical)
                {
                    id: 1704096600000,
                    assemblyKN: 'AKN-PCBA-001',
                    name: 'Main Controller PCBA',
                    type: 'PCBA',
                    version: 'v1.0',
                    status: 'Active',
                    components: 45,
                    description: 'Populated main controller board with ESP32-S3 MCU, power management (LDO + buck converter), LoRaWAN radio, and debug interfaces',
                    files: ['bom_v1.csv', 'assembly_drawing.pdf', 'test_procedure.pdf'],
                    images: [],
                    dateAdded: '2024-01-01',
                    assemblyComponents: [
                        {kpn: 'IC-MCU-001', name: 'ESP32-S3-WROOM-1', quantity: 1, refdes: 'U1'},
                        {kpn: 'IC-PWR-005', name: 'LM2596 Buck Converter', quantity: 1, refdes: 'U2'},
                        {kpn: 'CAP-CER-010', name: '10uF 25V Ceramic Cap', quantity: 8, refdes: 'C1-C8'}
                    ],
                    assembly3DParts: [],
                    assemblyCables: []
                },
                {
                    id: 1704183000000,
                    assemblyKN: 'AKN-SENS-001',
                    name: 'Environmental Sensor Assembly',
                    type: 'SENS',
                    version: 'v1.2',
                    status: 'Active',
                    components: 12,
                    description: 'Multi-sensor assembly with temperature/humidity (SHT30), air quality (SGP40), and pressure (BMP280) sensors on flex PCB',
                    files: ['sensor_bom.csv', 'calibration_data.xlsx'],
                    images: [],
                    dateAdded: '2024-01-01',
                    assemblyComponents: [
                        {kpn: 'SEN-TMP-003', name: 'SHT30 Temp/Humidity Sensor', quantity: 1, refdes: 'U1'},
                        {kpn: 'SEN-PRE-001', name: 'BMP280 Pressure Sensor', quantity: 1, refdes: 'U2'},
                        {kpn: 'SEN-ACC-005', name: 'SGP40 Air Quality Sensor', quantity: 1, refdes: 'U3'}
                    ],
                    assembly3DParts: [
                        {kn: '3PN-BRKT-001', name: 'Sensor Mount Bracket', quantity: 1}
                    ],
                    assemblyCables: []
                },
                {
                    id: 1704269400000,
                    assemblyKN: 'AKN-PCBA-002',
                    name: 'Smart Gateway Main Board',
                    type: 'PCBA',
                    version: 'v1.0',
                    status: 'Active',
                    components: 78,
                    description: 'High-performance gateway board with ARM Cortex-A72 processor, WiFi 6, Ethernet, and multiple wireless protocol support',
                    files: ['gateway_bom.csv', 'layout_guidelines.pdf', 'thermal_analysis.pdf'],
                    images: [],
                    dateAdded: '2024-01-02',
                    assemblyComponents: [
                        {kpn: 'IC-MCU-010', name: 'BCM2711 ARM Processor', quantity: 1, refdes: 'U1'},
                        {kpn: 'IC-PWR-012', name: 'MP2307 3A Buck Converter', quantity: 3, refdes: 'U2-U4'},
                        {kpn: 'CON-USB-003', name: 'USB 3.0 Type-A Connector', quantity: 2, refdes: 'J1-J2'}
                    ],
                    assembly3DParts: [],
                    assemblyCables: []
                },
                {
                    id: 1704355800000,
                    assemblyKN: 'AKN-PCBA-003',
                    name: 'Multi-Protocol RF Module',
                    type: 'PCBA',
                    version: 'v2.0',
                    status: 'Active',
                    components: 23,
                    description: 'RF module supporting Zigbee, Z-Wave, and Thread protocols with integrated antenna switching and power amplifiers',
                    files: ['rf_module_bom.csv', 'antenna_matching.pdf', 'fcc_test_report.pdf'],
                    images: [],
                    dateAdded: '2024-01-02',
                    assemblyComponents: [
                        {kpn: 'IC-RF-008', name: 'EFR32MG21 Zigbee SoC', quantity: 1, refdes: 'U1'},
                        {kpn: 'IC-RF-009', name: 'ZM5304 Z-Wave Module', quantity: 1, refdes: 'U2'},
                        {kpn: 'SWI-RF-001', name: 'RF Antenna Switch', quantity: 1, refdes: 'U3'}
                    ],
                    assembly3DParts: [],
                    assemblyCables: []
                },
                {
                    id: 1704442200000,
                    assemblyKN: 'AKN-PCBA-004',
                    name: 'BLDC Motor Control PCBA',
                    type: 'PCBA',
                    version: 'v1.5',
                    status: 'Active',
                    components: 67,
                    description: 'Three-phase BLDC motor controller with integrated gate drivers, current sensing, encoder interface, and CAN communication',
                    files: ['motor_control_bom.csv', 'gate_driver_layout.pdf', 'current_sensing_design.pdf'],
                    images: [],
                    dateAdded: '2024-01-03',
                    assemblyComponents: [
                        {kpn: 'IC-MCU-015', name: 'STM32F334 Motor Control MCU', quantity: 1, refdes: 'U1'},
                        {kpn: 'IC-DRV-003', name: 'DRV8323 Gate Driver', quantity: 1, refdes: 'U2'},
                        {kpn: 'TRA-FET-010', name: 'IPP320N20N3 Power MOSFET', quantity: 6, refdes: 'Q1-Q6'}
                    ],
                    assembly3DParts: [
                        {kn: '3PN-BRKT-002', name: 'Heat Sink Mount', quantity: 1}
                    ],
                    assemblyCables: []
                },
                {
                    id: 1704528600000,
                    assemblyKN: 'AKN-MECH-001',
                    name: 'Wall Mount Bracket Assembly',
                    type: 'MECH',
                    version: 'v1.0',
                    status: 'Active',
                    components: 8,
                    description: 'Adjustable wall mounting bracket with vibration dampening and weatherproofing for outdoor sensor installations',
                    files: ['mechanical_drawing.pdf', 'torque_specs.pdf'],
                    images: [],
                    dateAdded: '2024-01-01',
                    assemblyComponents: [
                        {kpn: 'HWR-SCR-001', name: 'M4x16 Stainless Steel Screw', quantity: 4, refdes: 'H1-H4'},
                        {kpn: 'HWR-WSH-002', name: 'M4 Spring Washer', quantity: 4, refdes: 'H5-H8'}
                    ],
                    assembly3DParts: [
                        {kn: '3PN-BRKT-003', name: 'Main Bracket', quantity: 1},
                        {kn: '3PN-BRKT-004', name: 'Pivot Arm', quantity: 1}
                    ],
                    assemblyCables: []
                }
            ],   
            pcbs: [           // PKN - Bare PCBs (before component assembly)
                {
                    id: 1704096000000,
                    pcbKN: 'PKN-4L-001',
                    name: 'Main Controller Board',
                    type: '4L',
                    layers: '4',
                    size: '100x80',
                    thickness: '1.6',
                    status: 'Active',
                    version: 'v1.0',
                    description: '4-layer main controller PCB with power and signal routing, controlled impedance traces for high-speed signals',
                    files: ['controller_v1.kicad_pcb', 'gerbers_v1.zip', 'drill_files.zip'],
                    images: [],
                    dateAdded: '2024-01-01',
                    pcbComponents: [],
                    pcbIsPopulated: false,
                    pcbSystemKN: null
                },
                {
                    id: 1704182400000,
                    pcbKN: 'PKN-FLEX-001',
                    name: 'Sensor Interface Flex PCB',
                    type: 'FLEX',
                    layers: '2',
                    size: '25x60',
                    thickness: '0.2',
                    status: 'Active',
                    version: 'v1.2',
                    description: '2-layer flexible PCB for sensor connections with bend radius optimized for compact installations',
                    files: ['flex_pcb_v1.2.kicad_pcb', 'flex_fab_notes.pdf', 'bend_test_results.pdf'],
                    images: [],
                    dateAdded: '2024-01-01',
                    pcbComponents: [],
                    pcbIsPopulated: false,
                    pcbSystemKN: null
                },
                {
                    id: 1704268800000,
                    pcbKN: 'PKN-6L-001',
                    name: 'Smart Gateway Main Board',
                    type: '6L',
                    layers: '6',
                    size: '120x100',
                    thickness: '1.6',
                    status: 'Active',
                    version: 'v1.0',
                    description: '6-layer high-density PCB with embedded processor, multiple power domains, and RF sections',
                    files: ['gateway_main_v1.kicad_pcb', 'impedance_control.pdf', 'via_spec.pdf'],
                    images: [],
                    dateAdded: '2024-01-02',
                    pcbComponents: [],
                    pcbIsPopulated: false,
                    pcbSystemKN: null
                },
                {
                    id: 1704355200000,
                    pcbKN: 'PKN-4L-002',
                    name: 'RF Module Board',
                    type: '4L',
                    layers: '4',
                    size: '30x40',
                    thickness: '0.8',
                    status: 'Active',
                    version: 'v2.0',
                    description: '4-layer RF-optimized PCB with coplanar waveguides and integrated antenna matching network',
                    files: ['rf_module_v2.kicad_pcb', 'antenna_tuning.pdf', 'emc_test_results.pdf'],
                    images: [],
                    dateAdded: '2024-01-02',
                    pcbComponents: [],
                    pcbIsPopulated: false,
                    pcbSystemKN: null
                },
                {
                    id: 1704441600000,
                    pcbKN: 'PKN-4L-003',
                    name: 'Motor Control Power Board',
                    type: '4L',
                    layers: '4',
                    size: '90x70',
                    thickness: '2.0',
                    status: 'Active',
                    version: 'v1.5',
                    description: '4-layer power PCB with heavy copper (2oz) for motor control, thermal vias, and reinforced mounting holes',
                    files: ['motor_power_v1.5.kicad_pcb', 'thermal_design.pdf', 'current_capacity.xlsx'],
                    images: [],
                    dateAdded: '2024-01-03',
                    pcbComponents: [],
                    pcbIsPopulated: false,
                    pcbSystemKN: null
                },
                {
                    id: 1704528000000,
                    pcbKN: 'PKN-2L-001',
                    name: 'LED Driver Board',
                    type: '2L',
                    layers: '2',
                    size: '50x30',
                    thickness: '1.6',
                    status: 'Active',
                    version: 'v1.0',
                    description: '2-layer cost-optimized PCB for LED strip driving with current regulation and PWM control',
                    files: ['led_driver_v1.kicad_pcb', 'cost_analysis.xlsx'],
                    images: [],
                    dateAdded: '2024-01-04',
                    pcbComponents: [],
                    pcbIsPopulated: false,
                    pcbSystemKN: null
                },
                {
                    id: 1704614400000,
                    pcbKN: 'PKN-RIGID-001',
                    name: 'Multi-Section Rigid-Flex',
                    type: 'RIGID',
                    layers: '4',
                    size: '80x120',
                    thickness: '1.2',
                    status: 'Active',
                    version: 'v1.0',
                    description: '4-layer rigid-flex PCB with 3 rigid sections connected by flexible links for compact folding applications',
                    files: ['rigid_flex_v1.kicad_pcb', 'fold_simulation.pdf', 'flex_life_test.pdf'],
                    images: [],
                    dateAdded: '2024-01-05',
                    pcbComponents: [],
                    pcbIsPopulated: false,
                    pcbSystemKN: null
                }
            ],         
            '3d-parts': [     // 3PN - 3D printed components
                {
                    id: 1704097200000,
                    partKN: '3PN-ENCL-001',
                    name: 'Main Enclosure Bottom',
                    type: 'ENCL',
                    material: 'ABS',
                    status: 'Active',
                    version: 'v1.2',
                    description: 'Bottom half of main system enclosure with mounting posts, cable routing channels, and gasket groove for IP65 rating',
                    files: ['enclosure_bottom_v1.2.stl', 'enclosure_drawing.pdf', 'ip65_test_report.pdf'],
                    images: [],
                    dateAdded: '2024-01-01'
                },
                {
                    id: 1704183600000,
                    partKN: '3PN-ENCL-002',
                    name: 'Main Enclosure Top',
                    type: 'ENCL',
                    material: 'ABS',
                    status: 'Active',
                    version: 'v1.2',
                    description: 'Top half of main enclosure with integrated antenna housing, status LED light pipe, and ventilation slots',
                    files: ['enclosure_top_v1.2.stl', 'antenna_clearance.pdf'],
                    images: [],
                    dateAdded: '2024-01-01'
                },
                {
                    id: 1704270000000,
                    partKN: '3PN-BRKT-001',
                    name: 'Sensor Mount Bracket',
                    type: 'BRKT',
                    material: 'PETG',
                    status: 'Active',
                    version: 'v1.0',
                    description: 'Adjustable sensor mounting bracket with 15-degree tilt range and vibration dampening features',
                    files: ['sensor_bracket_v1.stl', 'adjustment_mechanism.pdf'],
                    images: [],
                    dateAdded: '2024-01-01'
                },
                {
                    id: 1704356400000,
                    partKN: '3PN-ENCL-003',
                    name: 'Gateway Enclosure',
                    type: 'ENCL',
                    material: 'PC',
                    status: 'Active',
                    version: 'v1.0',
                    description: 'High-temperature polycarbonate enclosure for gateway with integrated heat dissipation fins and antenna mounts',
                    files: ['gateway_enclosure_v1.stl', 'thermal_simulation.pdf', 'uv_resistance_test.pdf'],
                    images: [],
                    dateAdded: '2024-01-02'
                },
                {
                    id: 1704442800000,
                    partKN: '3PN-BRKT-002',
                    name: 'Heat Sink Mount',
                    type: 'BRKT',
                    material: 'NYLON',
                    status: 'Active',
                    version: 'v1.0',
                    description: 'Nylon mounting bracket for aluminum heat sink with thermal isolation and vibration resistance',
                    files: ['heatsink_mount_v1.stl', 'thermal_isolation_analysis.pdf'],
                    images: [],
                    dateAdded: '2024-01-03'
                },
                {
                    id: 1704529200000,
                    partKN: '3PN-BRKT-003',
                    name: 'Wall Mount Main Bracket',
                    type: 'BRKT',
                    material: 'ABS',
                    status: 'Active',
                    version: 'v1.0',
                    description: 'Main structural bracket for wall mounting with integrated cable management and weatherproofing',
                    files: ['wall_bracket_main_v1.stl', 'load_test_results.pdf'],
                    images: [],
                    dateAdded: '2024-01-01'
                },
                {
                    id: 1704615600000,
                    partKN: '3PN-BRKT-004',
                    name: 'Adjustable Pivot Arm',
                    type: 'BRKT',
                    material: 'PETG',
                    status: 'Active',
                    version: 'v1.0',
                    description: 'Pivot arm for adjustable mounting with 90-degree rotation range and locking mechanism',
                    files: ['pivot_arm_v1.stl', 'pivot_mechanism.pdf'],
                    images: [],
                    dateAdded: '2024-01-01'
                },
                {
                    id: 1704702000000,
                    partKN: '3PN-CONN-001',
                    name: 'Waterproof Cable Gland',
                    type: 'CONN',
                    material: 'TPU',
                    status: 'Active',
                    version: 'v1.1',
                    description: 'Flexible TPU cable gland for waterproof cable entry with strain relief for 6-12mm cable diameter',
                    files: ['cable_gland_v1.1.stl', 'waterproof_test_results.pdf'],
                    images: [],
                    dateAdded: '2024-01-06'
                },
                {
                    id: 1704788400000,
                    partKN: '3PN-ENCL-004',
                    name: 'LED Strip Diffuser',
                    type: 'ENCL',
                    material: 'PLA',
                    status: 'Active',
                    version: 'v1.0',
                    description: 'Translucent PLA diffuser for LED strips with mounting clips and heat dissipation slots',
                    files: ['led_diffuser_v1.stl', 'light_transmission_test.pdf'],
                    images: [],
                    dateAdded: '2024-01-07'
                }
            ],   
            'cable-assemblies': [ // CAN - Cable harnesses
                {
                    id: 1704097800000,
                    cableKN: 'CAN-DATA-001',
                    name: 'Sensor Data Cable',
                    type: 'DATA',
                    length: '200mm',
                    connectors: 'JST-PH 6-pin to JST-XH 6-pin',
                    status: 'Active',
                    description: '6-wire data cable for sensor communication with color-coded wires and strain relief boots',
                    files: ['cable_wiring_diagram.pdf', 'continuity_test_results.xlsx'],
                    images: [],
                    dateAdded: '2024-01-01',
                    cableComponents: [
                        {kpn: 'CON-JST-006', name: 'JST-PH 6-pin Connector', quantity: 1},
                        {kpn: 'CON-JST-007', name: 'JST-XH 6-pin Connector', quantity: 1},
                        {kpn: 'CBL-SIG-002', name: '28AWG 6-conductor Cable', quantity: 1}
                    ]
                },
                {
                    id: 1704184200000,
                    cableKN: 'CAN-PWR-001',
                    name: 'Power Distribution Cable',
                    type: 'PWR',
                    length: '300mm',
                    connectors: 'XT60 to 2x JST-VH 2-pin',
                    status: 'Active',
                    description: 'Power distribution harness from main power input to system modules with overcurrent protection',
                    files: ['power_harness_diagram.pdf', 'current_rating_test.pdf'],
                    images: [],
                    dateAdded: '2024-01-01',
                    cableComponents: [
                        {kpn: 'CON-XT60-001', name: 'XT60 Power Connector', quantity: 1},
                        {kpn: 'CON-JST-VH-002', name: 'JST-VH 2-pin Connector', quantity: 2},
                        {kpn: 'CBL-PWR-005', name: '16AWG Power Cable Red/Black', quantity: 1}
                    ]
                },
                {
                    id: 1704270600000,
                    cableKN: 'CAN-RF-001',
                    name: 'Antenna Coax Cable',
                    type: 'RF',
                    length: '100mm',
                    connectors: 'U.FL to SMA Female',
                    status: 'Active',
                    description: 'Low-loss coaxial cable for antenna connections with 50-ohm impedance and flexible jacket',
                    files: ['rf_cable_specs.pdf', 'insertion_loss_measurements.xlsx'],
                    images: [],
                    dateAdded: '2024-01-02',
                    cableComponents: [
                        {kpn: 'CON-UFL-001', name: 'U.FL Connector Male', quantity: 1},
                        {kpn: 'CON-SMA-002', name: 'SMA Female Connector', quantity: 1},
                        {kpn: 'CBL-COA-003', name: 'RG178 Coaxial Cable', quantity: 1}
                    ]
                },
                {
                    id: 1704357000000,
                    cableKN: 'CAN-CTRL-001',
                    name: 'Motor Phase Cable',
                    type: 'CTRL',
                    length: '500mm',
                    connectors: 'Phoenix 3-pin to Motor Terminal',
                    status: 'Active',
                    description: 'Three-phase motor cable with heavy-duty conductors and EMI shielding for power transmission',
                    files: ['motor_cable_specs.pdf', 'emi_shielding_test.pdf'],
                    images: [],
                    dateAdded: '2024-01-03',
                    cableComponents: [
                        {kpn: 'CON-PHX-003', name: 'Phoenix 3-pin Terminal', quantity: 1},
                        {kpn: 'CON-MOTOR-001', name: 'Motor Terminal Block', quantity: 1},
                        {kpn: 'CBL-PWR-012', name: '12AWG 3-conductor Shielded Cable', quantity: 1}
                    ]
                },
                {
                    id: 1704443400000,
                    cableKN: 'CAN-DATA-002',
                    name: 'CAN Bus Cable',
                    type: 'DATA',
                    length: '250mm',
                    connectors: 'DB9 to 4-pin Terminal',
                    status: 'Active',
                    description: 'CAN bus communication cable with 120-ohm termination and twisted pair construction',
                    files: ['can_bus_wiring.pdf', 'impedance_verification.xlsx'],
                    images: [],
                    dateAdded: '2024-01-03',
                    cableComponents: [
                        {kpn: 'CON-DB9-001', name: 'DB9 Male Connector', quantity: 1},
                        {kpn: 'CON-TERM-004', name: '4-pin Screw Terminal', quantity: 1},
                        {kpn: 'CBL-SIG-008', name: 'CANbus Twisted Pair Cable', quantity: 1}
                    ]
                },
                {
                    id: 1704529800000,
                    cableKN: 'CAN-PWR-002',
                    name: 'USB-C Power Cable',
                    type: 'PWR',
                    length: '1500mm',
                    connectors: 'USB-C to USB-A',
                    status: 'Active',
                    description: 'USB-C power delivery cable supporting up to 60W with data lines for configuration',
                    files: ['usb_pd_cable_specs.pdf', 'pd_compliance_test.pdf'],
                    images: [],
                    dateAdded: '2024-01-04',
                    cableComponents: [
                        {kpn: 'CON-USBC-001', name: 'USB-C Connector Male', quantity: 1},
                        {kpn: 'CON-USBA-001', name: 'USB-A Connector Male', quantity: 1},
                        {kpn: 'CBL-USB-003', name: 'USB 3.1 Cable 20AWG', quantity: 1}
                    ]
                },
                {
                    id: 1704616200000,
                    cableKN: 'CAN-DATA-003',
                    name: 'Ethernet Patch Cable',
                    type: 'DATA',
                    length: '2000mm',
                    connectors: 'RJ45 to RJ45',
                    status: 'Active',
                    description: 'Cat6A ethernet cable with gold-plated connectors for gigabit data transmission',
                    files: ['ethernet_cable_specs.pdf', 'tdr_test_results.pdf'],
                    images: [],
                    dateAdded: '2024-01-05',
                    cableComponents: [
                        {kpn: 'CON-RJ45-001', name: 'RJ45 Connector', quantity: 2},
                        {kpn: 'CBL-ETH-006', name: 'Cat6A Ethernet Cable', quantity: 1}
                    ]
                },
                {
                    id: 1704702600000,
                    cableKN: 'CAN-RF-002',
                    name: 'WiFi Antenna Cable',
                    type: 'RF',
                    length: '150mm',
                    connectors: 'MMCX to RP-SMA',
                    status: 'Active',
                    description: 'Low-profile WiFi antenna cable for compact installations with bend-tolerant design',
                    files: ['wifi_antenna_cable_specs.pdf', 'vswr_measurements.xlsx'],
                    images: [],
                    dateAdded: '2024-01-06',
                    cableComponents: [
                        {kpn: 'CON-MMCX-001', name: 'MMCX Connector Male', quantity: 1},
                        {kpn: 'CON-RPSMA-001', name: 'RP-SMA Female Connector', quantity: 1},
                        {kpn: 'CBL-COA-001', name: 'RG316 Coaxial Cable', quantity: 1}
                    ]
                }
            ] 
        };
        
        // Category configurations
        const categoryConfigs = {
            capacitors: { code: 'CAP', subcategories: ['CER', 'ELE', 'TAN', 'FIL'] },
            resistors: { code: 'RES', subcategories: ['STD', 'PRE', 'VAR', 'NET'] },
            inductors: { code: 'IND', subcategories: ['PWR', 'CHK', 'FER'] },
            diodes: { code: 'DIO', subcategories: ['STD', 'LED', 'ZEN', 'SCH'] },
            transistors: { code: 'TRA', subcategories: ['BJT', 'FET', 'MOS'] },
            ics: { code: 'IC', subcategories: ['MCU', 'ANA', 'DIG', 'PWR'] },
            connectors: { code: 'CON', subcategories: ['HDR', 'JST', 'USB', 'RJ45'] },
            crystals: { code: 'CRY', subcategories: ['XTL', 'OSC', 'RES'] },
            fuses: { code: 'FUS', subcategories: ['STD', 'RST', 'PTC'] },
            switches: { code: 'SWI', subcategories: ['TAC', 'DIP', 'ROT', 'SLI'] },
            relays: { code: 'REL', subcategories: ['EMR', 'SSR'] },
            optocouplers: { code: 'OPT', subcategories: ['STD', 'HIS', 'DAR'] },
            sensors: { code: 'SEN', subcategories: ['TMP', 'PRE', 'ACC', 'GYR'] },
            mechanical: { code: 'MEC', subcategories: ['ENC', 'FAN', 'HEA', 'SPK'] },
            hardware: { code: 'HWR', subcategories: ['SCR', 'NUT', 'WSH', 'SPC'] },
            cables: { code: 'CBL', subcategories: ['PWR', 'SIG', 'COA', 'FFC'] }
        };
        
        // System-level configurations
        const systemConfigs = {
            systems: { code: 'SKN', subcategories: ['PROD', 'PROTO', 'EVAL', 'TEST'] },
            assemblies: { code: 'AKN', subcategories: ['PCBA', 'MECH', 'OPT', 'SENS'] },
            pcbs: { code: 'PKN', subcategories: ['2L', '4L', '6L', '8L', 'FLEX', 'RIGID'] },
            '3d-parts': { code: '3PN', subcategories: ['ENCL', 'BRKT', 'SPAC', 'CONN'] },
            'cable-assemblies': { code: 'CAN', subcategories: ['PWR', 'DATA', 'CTRL', 'RF'] }
        };

        // ==================== PRIORITY: SYSTEM-FIRST MANAGEMENT ====================

        // Generate system-level part numbers with priority for multiboard systems
        function generateSystemKN(category, subcategory) {
            const config = systemConfigs[category];
            if (!config) return '';
            
            let maxSequence = 0;
            systemData[category].forEach(item => {
                const kn = item.systemKN || item.assemblyKN || item.partKN || item.cableKN || item.pcbKN;
                if (kn && kn.startsWith(config.code)) {
                    const parts = kn.split('-');
                    if (parts.length >= 3) {
                        const sequence = parseInt(parts[2]);
                        if (sequence > maxSequence) maxSequence = sequence;
                    }
                }
            });
            
            const nextSequence = (maxSequence + 1).toString().padStart(3, '0');
            return `${config.code}-${subcategory}-${nextSequence}`;
        }

        // Update system statistics with multiboard focus
        function updateSystemStats() {
            let totalSystems = systemData.systems.length;
            let totalAssemblies = systemData.assemblies.length;
            let totalMultiboard = systemData.systems.filter(s => s.assemblies > 1).length;
            
            const systemsElement = document.getElementById('total-systems');
            const assembliesElement = document.getElementById('total-assemblies');
            const multiboardElement = document.getElementById('total-multiboard');
            
            if (systemsElement) systemsElement.textContent = totalSystems;
            if (assembliesElement) assembliesElement.textContent = totalAssemblies;
            if (multiboardElement) multiboardElement.textContent = totalMultiboard;
            
            Object.keys(systemData).forEach(category => {
                const total = systemData[category].length;
                const active = systemData[category].filter(item => item.status === 'Active').length;
                
                const totalElement = document.getElementById(`${category}-count`);
                const activeElement = document.getElementById(`${category}-active`);
                
                if (totalElement) totalElement.textContent = total;
                if (activeElement) activeElement.textContent = active;
            });
        }

        // Refresh system-level tables
        function refreshSystemTable(category) {
            let table;
            
            // Handle categories that start with numbers - use attribute selector
            if (category === '3d-parts') {
                table = document.querySelector('[id="3d-parts"] .component-table tbody');
            } else {
                table = document.querySelector(`#${category} .component-table tbody`);
            }
            
            if (!table) return;
            
            table.innerHTML = '';
            const items = systemData[category] || [];
            
            if (items.length === 0) {
                const colCount = table.closest('table').querySelector('thead tr').children.length;
                table.innerHTML = `<tr><td colspan="${colCount}" style="text-align: center; color: #666; padding: 20px;">No ${category.replace('-', ' ')} added yet. Click "Add ${category.charAt(0).toUpperCase() + category.slice(1).replace('-', ' ')}" to get started!</td></tr>`;
                return;
            }
            
            items.forEach(item => {
                const row = document.createElement('tr');
                row.setAttribute(`data-${category.slice(0, -1)}-id`, item.id || Date.now());
                
                // Build row based on category type
                switch(category) {
                    case 'systems':
                        row.innerHTML = `
                            <td>${item.systemKN}</td>
                            <td>${item.name}</td>
                            <td>${item.version}</td>
                            <td>${item.type}</td>
                            <td><span class="status-${item.status.toLowerCase()}">${item.status}</span></td>
                            <td>${item.assemblies || 0}</td>
                            <td>${item.description}</td>
                            <td>${item.owner || 'N/A'}</td>
                            <td><div class="file-attachments">${(item.files || []).map(f => `<a href="#" class="file-badge">${f}</a>`).join('')}</div></td>
                            <td><button class="btn btn-sm btn-info" onclick="viewSystemDetails('${item.systemKN}')">View</button></td>
                        `;
                        break;
                    case 'assemblies':
                        row.innerHTML = `
                            <td>${item.assemblyKN}</td>
                            <td>${item.name}</td>
                            <td>${item.type}</td>
                            <td>${item.version}</td>
                            <td><span class="status-${item.status.toLowerCase()}">${item.status}</span></td>
                            <td>${item.components || 0}</td>
                            <td>${item.description}</td>
                            <td><div class="file-attachments">${(item.files || []).map(f => `<a href="#" class="file-badge">${f}</a>`).join('')}</div></td>
                            <td><button class="btn btn-sm btn-info" onclick="viewSystemDetails('${item.assemblyKN}')">View</button></td>
                        `;
                        break;
                    case '3d-parts':
                        row.innerHTML = `
                            <td>${item.partKN}</td>
                            <td>${item.name}</td>
                            <td>${item.type}</td>
                            <td>${item.material}</td>
                            <td><span class="status-${item.status.toLowerCase()}">${item.status}</span></td>
                            <td>${item.version}</td>
                            <td>${item.description}</td>
                            <td><div class="file-attachments">${(item.files || []).map(f => `<a href="#" class="file-badge">${f}</a>`).join('')}</div></td>
                            <td><button class="btn btn-sm btn-info" onclick="viewSystemDetails('${item.partKN}')">View</button></td>
                        `;
                        break;
                    case 'pcbs':
                        row.innerHTML = `
                            <td>${item.pcbKN}</td>
                            <td>${item.name}</td>
                            <td>${item.type}</td>
                            <td>${item.layers || 'N/A'}</td>
                            <td>${item.size || 'N/A'}</td>
                            <td>${item.thickness || 'N/A'}</td>
                            <td><span class="status-${item.status.toLowerCase()}">${item.status}</span></td>
                            <td>${item.version}</td>
                            <td>${item.description}</td>
                            <td><div class="file-attachments">${(item.files || []).map(f => `<a href="#" class="file-badge">${f}</a>`).join('')}</div></td>
                            <td><button class="btn btn-sm btn-info" onclick="viewSystemDetails('${item.pcbKN}')">View</button></td>
                        `;
                        break;
                    case 'cable-assemblies':
                        row.innerHTML = `
                            <td>${item.cableKN}</td>
                            <td>${item.name}</td>
                            <td>${item.type}</td>
                            <td>${item.length}</td>
                            <td>${item.connectors}</td>
                            <td><span class="status-${item.status.toLowerCase()}">${item.status}</span></td>
                            <td>${item.description}</td>
                            <td><div class="file-attachments">${(item.files || []).map(f => `<a href="#" class="file-badge">${f}</a>`).join('')}</div></td>
                            <td><button class="btn btn-sm btn-info" onclick="viewSystemDetails('${item.cableKN}')">View</button></td>
                        `;
                        break;
                }
                
                table.appendChild(row);
            });
        }

        // Sort system-level tables
        function sortSystemTable(category, column) {
            let table;
            
            // Handle categories that start with numbers
            if (category === '3d-parts') {
                table = document.querySelector('[id="3d-parts"] .component-table');
            } else {
                table = document.querySelector(`#${category} .component-table`);
            }
            
            if (!table) return;
            
            const headers = table.querySelectorAll('th.sortable-header');
            const currentHeader = Array.from(headers).find(h => h.onclick && h.onclick.toString().includes(`'${column}'`));
            
            // Clear all sort indicators
            headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            
            // Determine sort direction
            let ascending = true;
            if (currentHeader && currentHeader.classList.contains('sort-asc')) {
                ascending = false;
                currentHeader.classList.add('sort-desc');
            } else if (currentHeader) {
                currentHeader.classList.add('sort-asc');
            }
            
            // Sort data
            systemData[category].sort((a, b) => {
                let valA = a[column] || '';
                let valB = b[column] || '';
                
                // Handle numeric values
                if (!isNaN(valA) && !isNaN(valB)) {
                    return ascending ? valA - valB : valB - valA;
                }
                
                // Handle string values
                valA = valA.toString().toLowerCase();
                valB = valB.toString().toLowerCase();
                
                if (ascending) {
                    return valA < valB ? -1 : valA > valB ? 1 : 0;
                } else {
                    return valA > valB ? -1 : valA < valB ? 1 : 0;
                }
            });
            
            refreshSystemTable(category);
        }
        function openAddSystemModal(category) {
            // Create dynamic modal based on category
            const modal = document.getElementById('addComponentModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Clear existing content
            modalContent.innerHTML = `<span class="close" onclick="closeAddComponentModal()">&times;</span>`;
            
            let title = '';
            let fields = '';
            
            switch(category) {
                case 'systems':
                    title = '🏗️ Add New System (SKN)';
                    fields = `
                        <h3>${title}</h3>
                        <form id="systemForm">
                            <div class="form-group">
                                <label>System Name *</label>
                                <input type="text" id="systemName" required placeholder="e.g., IoT Sensor Hub v2.1">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type *</label>
                                    <select id="systemType" required>
                                        <option value="">Select type...</option>
                                        <option value="PROD">Production System</option>
                                        <option value="PROTO">Prototype System</option>
                                        <option value="EVAL">Evaluation Board</option>
                                        <option value="TEST">Test Fixture</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Version *</label>
                                    <input type="text" id="systemVersion" required placeholder="e.g., v1.0, Rev A">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Number of Assemblies *</label>
                                    <input type="number" id="systemAssemblies" required min="1" value="1" placeholder="Number of PCBAs/assemblies">
                                </div>
                                <div class="form-group">
                                    <label>Project Owner</label>
                                    <input type="text" id="systemOwner" placeholder="Engineer name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <textarea id="systemDescription" required placeholder="Brief system description and key features"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Design Files (Optional)</label>
                                <input type="text" id="systemFiles" placeholder="Comma-separated file names (e.g., schematic.pdf, assembly.dwg)">
                            </div>
                            <div class="form-group">
                                <label>System Images (Optional)</label>
                                <div class="image-upload-container">
                                    <input type="file" id="systemImages" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'system-image-preview')">
                                    <div class="image-upload-text" onclick="document.getElementById('systemImages').click()">
                                        📷 Click to add images or drag & drop<br>
                                        <small>Supports: JPG, PNG, GIF (max 5MB each)</small>
                                    </div>
                                    <div id="system-image-preview" class="image-grid"></div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddComponentModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Add System</button>
                            </div>
                        </form>
                    `;
                    break;
                    
                case 'assemblies':
                    title = '🔧 Add New Assembly (AKN)';
                    fields = `
                        <h3>${title}</h3>
                        <form id="assemblyForm">
                            <div class="form-group">
                                <label>Assembly Name *</label>
                                <input type="text" id="assemblyName" required placeholder="e.g., Main Controller PCBA">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type *</label>
                                    <select id="assemblyType" required>
                                        <option value="">Select type...</option>
                                        <option value="PCBA">PCB Assembly</option>
                                        <option value="MECH">Mechanical Assembly</option>
                                        <option value="OPT">Optical Assembly</option>
                                        <option value="SENS">Sensor Assembly</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Version *</label>
                                    <input type="text" id="assemblyVersion" required placeholder="e.g., v1.0, Rev A">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Component Count (Estimated)</label>
                                <input type="number" id="assemblyComponents" min="0" placeholder="Approximate number of components">
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <textarea id="assemblyDescription" required placeholder="Assembly description and functionality"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Design Files (Optional)</label>
                                <input type="text" id="assemblyFiles" placeholder="Comma-separated file names (e.g., pcb.kicad_pcb, bom.csv)">
                            </div>
                            <div class="form-group">
                                <label>Assembly Images (Optional)</label>
                                <div class="image-upload-container">
                                    <input type="file" id="assemblyImages" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'assembly-image-preview')">
                                    <div class="image-upload-text" onclick="document.getElementById('assemblyImages').click()">
                                        📷 Click to add images or drag & drop<br>
                                        <small>Supports: JPG, PNG, GIF (max 5MB each)</small>
                                    </div>
                                    <div id="assembly-image-preview" class="image-grid"></div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddComponentModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Assembly</button>
                            </div>
                        </form>
                    `;
                    break;
                    
                case '3d-parts':
                    title = '🖨️ Add New 3D Part (3PN)';
                    fields = `
                        <h3>${title}</h3>
                        <form id="3dPartForm">
                            <div class="form-group">
                                <label>Part Name *</label>
                                <input type="text" id="partName" required placeholder="e.g., Custom Enclosure Bottom">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type *</label>
                                    <select id="partType" required>
                                        <option value="">Select type...</option>
                                        <option value="ENCL">Enclosure</option>
                                        <option value="BRKT">Bracket</option>
                                        <option value="CONN">Connector Housing</option>
                                        <option value="MISC">Miscellaneous</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Material *</label>
                                    <select id="partMaterial" required>
                                        <option value="">Select material...</option>
                                        <option value="PLA">PLA</option>
                                        <option value="ABS">ABS</option>
                                        <option value="PETG">PETG</option>
                                        <option value="TPU">TPU (Flexible)</option>
                                        <option value="NYLON">Nylon</option>
                                        <option value="PC">Polycarbonate</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Version</label>
                                <input type="text" id="partVersion" placeholder="e.g., v1.0, Rev A">
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <textarea id="partDescription" required placeholder="Part description and specifications"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Design Files (Optional)</label>
                                <input type="text" id="partFiles" placeholder="Comma-separated file names (e.g., part.stl, drawing.pdf)">
                            </div>
                            <div class="form-group">
                                <label>Part Images (Optional)</label>
                                <div class="image-upload-container">
                                    <input type="file" id="partImages" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'part-image-preview')">
                                    <div class="image-upload-text" onclick="document.getElementById('partImages').click()">
                                        📷 Click to add images or drag & drop<br>
                                        <small>Supports: JPG, PNG, GIF (max 5MB each)</small>
                                    </div>
                                    <div id="part-image-preview" class="image-grid"></div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddComponentModal()">Cancel</button>
                                <button type="submit" class="btn btn-warning">Add 3D Part</button>
                            </div>
                        </form>
                    `;
                    break;
                    
                case 'pcbs':
                    title = '🟩 Add New PCB (PKN)';
                    fields = `
                        <h3>${title}</h3>
                        <form id="pcbForm">
                            <div class="form-group">
                                <label>PCB Name *</label>
                                <input type="text" id="pcbName" required placeholder="e.g., Main Controller Board">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type *</label>
                                    <select id="pcbType" required>
                                        <option value="">Select type...</option>
                                        <option value="2L">2-Layer PCB</option>
                                        <option value="4L">4-Layer PCB</option>
                                        <option value="6L">6-Layer PCB</option>
                                        <option value="8L">8-Layer PCB</option>
                                        <option value="FLEX">Flexible PCB</option>
                                        <option value="RIGID">Rigid-Flex PCB</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Layer Count</label>
                                    <input type="number" id="pcbLayers" min="1" max="20" placeholder="Number of layers">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Size (mm)</label>
                                    <input type="text" id="pcbSize" placeholder="e.g., 50x30, 100x80">
                                </div>
                                <div class="form-group">
                                    <label>Thickness (mm)</label>
                                    <input type="text" id="pcbThickness" placeholder="e.g., 1.6, 0.8, 2.0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Version *</label>
                                <input type="text" id="pcbVersion" required placeholder="e.g., v1.0, Rev A">
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <textarea id="pcbDescription" required placeholder="PCB description, specifications, and special requirements"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Design Files (Optional)</label>
                                <input type="text" id="pcbFiles" placeholder="Comma-separated file names (e.g., pcb.kicad_pcb, gerbers.zip, fab.pdf)">
                            </div>
                            <div class="form-group">
                                <label>PCB Images (Optional)</label>
                                <div class="image-upload-container">
                                    <input type="file" id="pcbImages" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'pcb-image-preview')">
                                    <div class="image-upload-text" onclick="document.getElementById('pcbImages').click()">
                                        📷 Click to add images or drag & drop<br>
                                        <small>Supports: JPG, PNG, GIF (max 5MB each)</small>
                                    </div>
                                    <div id="pcb-image-preview" class="image-grid"></div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddComponentModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Add PCB</button>
                            </div>
                        </form>
                    `;
                    break;
                    
                case 'cable-assemblies':
                    title = '🔗 Add New Cable Assembly (CAN)';
                    fields = `
                        <h3>${title}</h3>
                        <form id="cableForm">
                            <div class="form-group">
                                <label>Cable Name *</label>
                                <input type="text" id="cableName" required placeholder="e.g., Power Distribution Harness">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type *</label>
                                    <select id="cableType" required>
                                        <option value="">Select type...</option>
                                        <option value="PWR">Power Cable</option>
                                        <option value="DATA">Data Cable</option>
                                        <option value="CTRL">Control Cable</option>
                                        <option value="RF">RF Cable</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Length</label>
                                    <input type="text" id="cableLength" placeholder="e.g., 150mm, 6 inches">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Connectors</label>
                                <input type="text" id="cableConnectors" placeholder="e.g., JST-PH 4-pin to Molex MicroFit 6-pin">
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <textarea id="cableDescription" required placeholder="Cable specifications and wiring details"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Design Files (Optional)</label>
                                <input type="text" id="cableFiles" placeholder="Comma-separated file names (e.g., wiring.pdf, diagram.dwg)">
                            </div>
                            <div class="form-group">
                                <label>Cable Images (Optional)</label>
                                <div class="image-upload-container">
                                    <input type="file" id="cableImages" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'cable-image-preview')">
                                    <div class="image-upload-text" onclick="document.getElementById('cableImages').click()">
                                        📷 Click to add images or drag & drop<br>
                                        <small>Supports: JPG, PNG, GIF (max 5MB each)</small>
                                    </div>
                                    <div id="cable-image-preview" class="image-grid"></div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddComponentModal()">Cancel</button>
                                <button type="submit" class="btn btn-info">Add Cable Assembly</button>
                            </div>
                        </form>
                    `;
                    break;
            }
            
            modalContent.innerHTML += fields;
            modal.style.display = 'block';
            
            // Add form submission handler
            const form = modalContent.querySelector('form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                addSystemItem(category);
            });
        }

        // Multiboard project wizard - Step-by-step system creation
        function openMultiboardWizard() {
            const modal = document.getElementById('addComponentModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <span class="close" onclick="closeAddComponentModal()">&times;</span>
                <h3>📋 Multiboard Project Wizard</h3>
                <div id="wizardContainer">
                    <div class="wizard-steps">
                        <div class="wizard-step active" data-step="1">1. Project Info</div>
                        <div class="wizard-step" data-step="2">2. Assemblies</div>
                        <div class="wizard-step" data-step="3">3. Components</div>
                        <div class="wizard-step" data-step="4">4. Review & Create</div>
                    </div>
                    
                    <div class="wizard-content">
                        <!-- Step 1: Project Information -->
                        <div class="wizard-panel active" id="wizardStep1">
                            <h4>Step 1: Project Information</h4>
                            <div class="form-group">
                                <label>Project Name *</label>
                                <input type="text" id="wizardProjectName" required placeholder="e.g., IoT Environmental Monitor">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Project Type *</label>
                                    <select id="wizardProjectType" required>
                                        <option value="">Select type...</option>
                                        <option value="PROD">Production System</option>
                                        <option value="PROTO">Prototype System</option>
                                        <option value="EVAL">Evaluation Board</option>
                                        <option value="TEST">Test Fixture</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Version *</label>
                                    <input type="text" id="wizardVersion" required placeholder="v1.0" value="v1.0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Project Owner</label>
                                    <input type="text" id="wizardOwner" placeholder="Lead Engineer">
                                </div>
                                <div class="form-group">
                                    <label>Expected Assembly Count</label>
                                    <input type="number" id="wizardAssemblyCount" min="1" value="2" placeholder="Number of PCBAs/assemblies">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Project Description *</label>
                                <textarea id="wizardDescription" required placeholder="Brief description of the complete system and its purpose"></textarea>
                            </div>
                        </div>
                        
                        <!-- Step 2: Assembly Planning -->
                        <div class="wizard-panel" id="wizardStep2">
                            <h4>Step 2: Plan Your Assemblies</h4>
                            <p style="color: #666; margin-bottom: 20px;">Define the PCBAs, mechanical assemblies, and other components your system will contain.</p>
                            <div id="wizardAssemblyList">
                                <!-- Dynamic assembly entries will be added here -->
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addWizardAssembly()">➕ Add Assembly</button>
                        </div>
                        
                        <!-- Step 3: Component Selection -->
                        <div class="wizard-panel" id="wizardStep3">
                            <h4>Step 3: Add Supporting Components</h4>
                            <p style="color: #666; margin-bottom: 20px;">Add 3D printed parts, cable assemblies, and direct components to your system.</p>
                            
                            <div class="wizard-section">
                                <h5>3D Printed Parts</h5>
                                <div id="wizard3DPartsList">
                                    <!-- Dynamic 3D parts will be added here -->
                                </div>
                                <button type="button" class="btn btn-warning" onclick="addWizard3DPart()">🖨️ Add 3D Part</button>
                            </div>
                            
                            <div class="wizard-section">
                                <h5>Cable Assemblies</h5>
                                <div id="wizardCablesList">
                                    <!-- Dynamic cable assemblies will be added here -->
                                </div>
                                <button type="button" class="btn btn-info" onclick="addWizardCable()">🔗 Add Cable Assembly</button>
                            </div>
                            
                            <div class="wizard-section">
                                <h5>Direct System Components</h5>
                                <div id="wizardComponentsList">
                                    <!-- Direct components will be added here -->
                                </div>
                                <button type="button" class="btn btn-secondary" onclick="addWizardComponent()">⚙️ Add Component</button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Review & Create -->
                        <div class="wizard-panel" id="wizardStep4">
                            <h4>Step 4: Review & Create System</h4>
                            <div id="wizardReview">
                                <!-- Review content will be generated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="wizard-actions">
                        <button type="button" class="btn btn-secondary" id="wizardPrevBtn" onclick="previousWizardStep()" style="display: none;">⬅️ Previous</button>
                        <button type="button" class="btn btn-primary" id="wizardNextBtn" onclick="nextWizardStep()">Next ➡️</button>
                        <button type="button" class="btn btn-success" id="wizardCreateBtn" onclick="createMultiboardSystem()" style="display: none;">🚀 Create System</button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Initialize wizard data storage
            window.wizardData = {
                step: 1,
                project: {},
                assemblies: [],
                parts3D: [],
                cables: [],
                components: []
            };
        }

        // View system details with hierarchical BOM and management
        function viewSystemDetails(kn) {
            const modal = document.getElementById('addComponentModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Find the item across all categories
            let item = null;
            let itemCategory = '';
            
            for (const [category, items] of Object.entries(systemData)) {
                item = items.find(i => 
                    i.systemKN === kn || i.assemblyKN === kn || i.partKN === kn || i.cableKN === kn
                );
                if (item) {
                    itemCategory = category;
                    break;
                }
            }
            
            if (!item) {
                alert('Item not found');
                return;
            }
            
            let title = '';
            let icon = '';
            let knLabel = '';
            
            switch(itemCategory) {
                case 'systems':
                    title = 'System Details';
                    icon = '🏗️';
                    knLabel = 'System KN';
                    break;
                case 'assemblies':
                    title = 'Assembly Details';
                    icon = '🔧';
                    knLabel = 'Assembly KN';
                    break;
                case '3d-parts':
                    title = '3D Part Details';
                    icon = '🖨️';
                    knLabel = 'Part KN';
                    break;
                case 'cable-assemblies':
                    title = 'Cable Assembly Details';
                    icon = '🔗';
                    knLabel = 'Cable KN';
                    break;
            }
            
            const files = item.files || [];
            const fileList = files.length > 0 ? 
                files.map(f => `<span class="file-badge">${f}</span>`).join(' ') : 
                '<em>No files attached</em>';
            
            modalContent.innerHTML = `
                <span class="close" onclick="closeAddComponentModal()">&times;</span>
                <h3>${icon} ${title}</h3>
                <div class="system-details">
                    <div class="detail-section">
                        <h4>Basic Information</h4>
                        <table class="detail-table">
                            <tr>
                                <td><strong>${knLabel}:</strong></td>
                                <td>${kn}</td>
                            </tr>
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>${item.name}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td><span class="status-${item.status.toLowerCase()}">${item.status}</span></td>
                            </tr>
                            ${item.version ? `<tr><td><strong>Version:</strong></td><td>${item.version}</td></tr>` : ''}
                            ${item.type ? `<tr><td><strong>Type:</strong></td><td>${item.type}</td></tr>` : ''}
                            ${item.material ? `<tr><td><strong>Material:</strong></td><td>${item.material}</td></tr>` : ''}
                            ${item.length ? `<tr><td><strong>Length:</strong></td><td>${item.length}</td></tr>` : ''}
                            ${item.connectors ? `<tr><td><strong>Connectors:</strong></td><td>${item.connectors}</td></tr>` : ''}
                            ${item.assemblies ? `<tr><td><strong>Assemblies:</strong></td><td>${item.assemblies}</td></tr>` : ''}
                            ${item.components ? `<tr><td><strong>Components:</strong></td><td>${item.components}</td></tr>` : ''}
                            ${item.owner ? `<tr><td><strong>Owner:</strong></td><td>${item.owner}</td></tr>` : ''}
                        </table>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Description</h4>
                        <p>${item.description}</p>
                    </div>
                    
                    ${item.systemAssemblies || item.systemComponents || item.system3DParts || item.systemCables ? `
                    <div class="detail-section">
                        <h4>System Composition</h4>
                        ${(item.systemAssemblies && item.systemAssemblies.length > 0) ? `
                            <div class="composition-group">
                                <h5>🔧 Assemblies (${item.systemAssemblies.length})</h5>
                                ${item.systemAssemblies.map(asm => `
                                    <div class="composition-item">
                                        <strong>${asm.kn}</strong> - ${asm.name} <span class="qty-badge">Qty: ${asm.quantity}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${(item.system3DParts && item.system3DParts.length > 0) ? `
                            <div class="composition-group">
                                <h5>🖨️ 3D Parts (${item.system3DParts.length})</h5>
                                ${item.system3DParts.map(part => `
                                    <div class="composition-item">
                                        <strong>${part.kn}</strong> - ${part.name} <span class="qty-badge">Qty: ${part.quantity}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${(item.systemCables && item.systemCables.length > 0) ? `
                            <div class="composition-group">
                                <h5>🔗 Cable Assemblies (${item.systemCables.length})</h5>
                                ${item.systemCables.map(cable => `
                                    <div class="composition-item">
                                        <strong>${cable.kn}</strong> - ${cable.name} <span class="qty-badge">Qty: ${cable.quantity}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${(item.systemComponents && item.systemComponents.length > 0) ? `
                            <div class="composition-group">
                                <h5>⚙️ Direct Components (${item.systemComponents.length})</h5>
                                ${item.systemComponents.map(comp => `
                                    <div class="composition-item">
                                        <strong>${comp.kpn}</strong> - ${comp.name} <span class="qty-badge">Qty: ${comp.quantity}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    ${item.assemblyComponents || item.assembly3DParts || item.assemblyCables ? `
                    <div class="detail-section">
                        <h4>Assembly Composition</h4>
                        ${(item.assemblyComponents && item.assemblyComponents.length > 0) ? `
                            <div class="composition-group">
                                <h5>⚙️ Components (${item.assemblyComponents.length})</h5>
                                ${item.assemblyComponents.map(comp => `
                                    <div class="composition-item">
                                        <strong>${comp.kpn}</strong> - ${comp.name} 
                                        ${comp.refdes ? `<span class="refdes-badge">${comp.refdes}</span>` : ''}
                                        <span class="qty-badge">Qty: ${comp.quantity}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${(item.assembly3DParts && item.assembly3DParts.length > 0) ? `
                            <div class="composition-group">
                                <h5>🖨️ 3D Parts (${item.assembly3DParts.length})</h5>
                                ${item.assembly3DParts.map(part => `
                                    <div class="composition-item">
                                        <strong>${part.kn}</strong> - ${part.name} <span class="qty-badge">Qty: ${part.quantity}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${(item.assemblyCables && item.assemblyCables.length > 0) ? `
                            <div class="composition-group">
                                <h5>🔗 Cables (${item.assemblyCables.length})</h5>
                                ${item.assemblyCables.map(cable => `
                                    <div class="composition-item">
                                        <strong>${cable.kn}</strong> - ${cable.name} <span class="qty-badge">Qty: ${cable.quantity}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    ${item.cableComponents && item.cableComponents.length > 0 ? `
                    <div class="detail-section">
                        <h4>Cable Components</h4>
                        <div class="composition-group">
                            <h5>⚙️ Components (${item.cableComponents.length})</h5>
                            ${item.cableComponents.map(comp => `
                                <div class="composition-item">
                                    <strong>${comp.kpn}</strong> - ${comp.name} <span class="qty-badge">Qty: ${comp.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="detail-section">
                        <h4>Design Files</h4>
                        <div class="file-attachments">${fileList}</div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddComponentModal()">Close</button>
                        <button type="button" class="btn btn-primary" onclick="editSystemItem('${kn}', '${itemCategory}')">Edit</button>
                        <button type="button" class="btn btn-danger" onclick="deleteSystemItem('${kn}', '${itemCategory}')">Delete</button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Load system data from localStorage
        function loadSystemData() {
            const saved = localStorage.getItem('kinbenSystemData');
            if (saved) {
                try {
                    systemData = JSON.parse(saved);
                } catch (e) {
                    console.warn('Failed to load system data from localStorage');
                }
            }
        }

        // Initialize system management on page load
        function initializeSystemManagement() {
            loadSystemData();
            updateSystemStats();
            
            // Refresh all system tables
            Object.keys(systemData).forEach(category => {
                refreshSystemTable(category);
            });
            
            console.log('System-first management initialized for multiboard ordering');
        }

        // Add system-level item (called from modal forms) - handles both add and edit
        function addSystemItem(category) {
            const form = document.querySelector('.modal-content form');
            const isEditing = form && form.getAttribute('data-edit-id');
            const editKN = form ? form.getAttribute('data-edit-kn') : null;
            
            let item = {};
            let isValid = true;
            
            switch(category) {
                case 'systems':
                    const systemName = document.getElementById('systemName').value.trim();
                    const systemType = document.getElementById('systemType').value;
                    const systemVersion = document.getElementById('systemVersion').value.trim();
                    const systemDescription = document.getElementById('systemDescription').value.trim();
                    
                    if (!systemName || !systemType || !systemVersion || !systemDescription) {
                        alert('Please fill in all required fields');
                        isValid = false;
                        break;
                    }
                    
                    item = {
                        id: isEditing ? parseInt(form.getAttribute('data-edit-id')) : Date.now(),
                        systemKN: isEditing ? editKN : generateSystemKN('systems', systemType),
                        name: systemName,
                        type: systemType,
                        version: systemVersion,
                        status: 'Active',
                        assemblies: parseInt(document.getElementById('systemAssemblies').value) || 1,
                        description: systemDescription,
                        owner: document.getElementById('systemOwner').value.trim(),
                        files: document.getElementById('systemFiles').value.trim().split(',').map(f => f.trim()).filter(f => f),
                        images: getImageData('system-image-preview'),
                        dateAdded: isEditing ? (systemData[category].find(i => i.id == item.id)?.dateAdded || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                        dateModified: isEditing ? new Date().toISOString().split('T')[0] : undefined,
                        // Enhanced system composition
                        systemAssemblies: [], // Will store {kn, name, quantity} objects
                        systemComponents: [], // Direct components {kpn, name, quantity}  
                        system3DParts: [],    // 3D printed parts {kn, name, quantity}
                        systemCables: []      // Cable assemblies {kn, name, quantity}
                    };
                    
                    // Preserve existing composition data if editing
                    if (isEditing) {
                        const existingItem = systemData[category].find(i => i.id == item.id);
                        if (existingItem) {
                            item.systemAssemblies = existingItem.systemAssemblies || [];
                            item.systemComponents = existingItem.systemComponents || [];
                            item.system3DParts = existingItem.system3DParts || [];
                            item.systemCables = existingItem.systemCables || [];
                            item.images = item.images.length > 0 ? item.images : (existingItem.images || []);
                        }
                    }
                    break;
                    
                case 'assemblies':
                    const assemblyName = document.getElementById('assemblyName').value.trim();
                    const assemblyType = document.getElementById('assemblyType').value;
                    const assemblyVersion = document.getElementById('assemblyVersion').value.trim();
                    const assemblyDescription = document.getElementById('assemblyDescription').value.trim();
                    
                    if (!assemblyName || !assemblyType || !assemblyVersion || !assemblyDescription) {
                        alert('Please fill in all required fields');
                        isValid = false;
                        break;
                    }
                    
                    item = {
                        id: isEditing ? parseInt(form.getAttribute('data-edit-id')) : Date.now(),
                        assemblyKN: isEditing ? editKN : generateSystemKN('assemblies', assemblyType),
                        name: assemblyName,
                        type: assemblyType,
                        version: assemblyVersion,
                        status: 'Active',
                        components: parseInt(document.getElementById('assemblyComponents').value) || 0,
                        description: assemblyDescription,
                        files: document.getElementById('assemblyFiles').value.trim().split(',').map(f => f.trim()).filter(f => f),
                        images: getImageData('assembly-image-preview'),
                        dateAdded: isEditing ? (systemData[category].find(i => i.id == item.id)?.dateAdded || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                        dateModified: isEditing ? new Date().toISOString().split('T')[0] : undefined,
                        // Enhanced assembly composition
                        assemblyComponents: [], // Direct components {kpn, name, quantity, refdes}
                        assembly3DParts: [],    // 3D parts used {kn, name, quantity}
                        assemblyCables: []      // Cables used {kn, name, quantity}
                    };
                    
                    // Preserve existing composition data if editing
                    if (isEditing) {
                        const existingItem = systemData[category].find(i => i.id == item.id);
                        if (existingItem) {
                            item.assemblyComponents = existingItem.assemblyComponents || [];
                            item.assembly3DParts = existingItem.assembly3DParts || [];
                            item.assemblyCables = existingItem.assemblyCables || [];
                            item.images = item.images.length > 0 ? item.images : (existingItem.images || []);
                        }
                    }
                    break;
                    
                case '3d-parts':
                    const partName = document.getElementById('partName').value.trim();
                    const partType = document.getElementById('partType').value;
                    const partMaterial = document.getElementById('partMaterial').value;
                    const partDescription = document.getElementById('partDescription').value.trim();
                    
                    if (!partName || !partType || !partMaterial || !partDescription) {
                        alert('Please fill in all required fields');
                        isValid = false;
                        break;
                    }
                    
                    item = {
                        id: isEditing ? parseInt(form.getAttribute('data-edit-id')) : Date.now(),
                        partKN: isEditing ? editKN : generateSystemKN('3d-parts', partType),
                        name: partName,
                        type: partType,
                        material: partMaterial,
                        status: 'Active',
                        version: document.getElementById('partVersion').value.trim() || 'v1.0',
                        description: partDescription,
                        files: document.getElementById('partFiles').value.trim().split(',').map(f => f.trim()).filter(f => f),
                        images: getImageData('part-image-preview'),
                        dateAdded: isEditing ? (systemData[category].find(i => i.id == item.id)?.dateAdded || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                        dateModified: isEditing ? new Date().toISOString().split('T')[0] : undefined
                    };
                    break;
                    
                case 'pcbs':
                    const pcbName = document.getElementById('pcbName').value.trim();
                    const pcbType = document.getElementById('pcbType').value;
                    const pcbVersion = document.getElementById('pcbVersion').value.trim();
                    const pcbDescription = document.getElementById('pcbDescription').value.trim();
                    
                    if (!pcbName || !pcbType || !pcbVersion || !pcbDescription) {
                        alert('Please fill in all required fields');
                        isValid = false;
                        break;
                    }
                    
                    item = {
                        id: isEditing ? parseInt(form.getAttribute('data-edit-id')) : Date.now(),
                        pcbKN: isEditing ? editKN : generateSystemKN('pcbs', pcbType),
                        name: pcbName,
                        type: pcbType,
                        layers: document.getElementById('pcbLayers').value.trim(),
                        size: document.getElementById('pcbSize').value.trim(),
                        thickness: document.getElementById('pcbThickness').value.trim(),
                        status: 'Active',
                        version: pcbVersion,
                        description: pcbDescription,
                        files: document.getElementById('pcbFiles').value.trim().split(',').map(f => f.trim()).filter(f => f),
                        images: getImageData('pcb-image-preview'),
                        dateAdded: isEditing ? (systemData[category].find(i => i.id == item.id)?.dateAdded || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                        dateModified: isEditing ? new Date().toISOString().split('T')[0] : undefined,
                        // PCB can become a PCBA (system)
                        pcbComponents: [],      // Components mounted on this PCB {kpn, name, quantity, refdes}
                        pcbIsPopulated: false,  // Whether this PCB has components (becomes PCBA)
                        pcbSystemKN: null       // If populated, this becomes a system with this KN
                    };
                    
                    // Preserve existing composition data if editing
                    if (isEditing) {
                        const existingItem = systemData[category].find(i => i.id == item.id);
                        if (existingItem) {
                            item.pcbComponents = existingItem.pcbComponents || [];
                            item.pcbIsPopulated = existingItem.pcbIsPopulated || false;
                            item.pcbSystemKN = existingItem.pcbSystemKN || null;
                            item.images = item.images.length > 0 ? item.images : (existingItem.images || []);
                        }
                    }
                    break;
                    
                case 'cable-assemblies':
                    const cableName = document.getElementById('cableName').value.trim();
                    const cableType = document.getElementById('cableType').value;
                    const cableDescription = document.getElementById('cableDescription').value.trim();
                    
                    if (!cableName || !cableType || !cableDescription) {
                        alert('Please fill in all required fields');
                        isValid = false;
                        break;
                    }
                    
                    item = {
                        id: isEditing ? parseInt(form.getAttribute('data-edit-id')) : Date.now(),
                        cableKN: isEditing ? editKN : generateSystemKN('cable-assemblies', cableType),
                        name: cableName,
                        type: cableType,
                        length: document.getElementById('cableLength').value.trim(),
                        connectors: document.getElementById('cableConnectors').value.trim(),
                        status: 'Active',
                        description: cableDescription,
                        files: document.getElementById('cableFiles').value.trim().split(',').map(f => f.trim()).filter(f => f),
                        images: getImageData('cable-image-preview'),
                        dateAdded: isEditing ? (systemData[category].find(i => i.id == item.id)?.dateAdded || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                        dateModified: isEditing ? new Date().toISOString().split('T')[0] : undefined,
                        // Enhanced cable composition  
                        cableComponents: []     // Components in cable {kpn, name, quantity} (connectors, wires, etc.)
                    };
                    
                    // Preserve existing composition data if editing
                    if (isEditing) {
                        const existingItem = systemData[category].find(i => i.id == item.id);
                        if (existingItem) {
                            item.cableComponents = existingItem.cableComponents || [];
                            item.images = item.images.length > 0 ? item.images : (existingItem.images || []);
                        }
                    }
                    break;
            }
            
            if (!isValid) return;
            
            // Handle add vs edit operation
            if (isEditing) {
                // Find and replace existing item
                const itemIndex = systemData[category].findIndex(i => i.id == item.id);
                if (itemIndex !== -1) {
                    systemData[category][itemIndex] = item;
                }
            } else {
                // Add new item
                systemData[category].push(item);
            }
            
            // Save to localStorage
            localStorage.setItem('kinbenSystemData', JSON.stringify(systemData));
            
            // Refresh displays
            updateSystemStats();
            refreshSystemTable(category);
            
            // Close modal
            closeAddComponentModal();
            
            // Show success message
            const kn = item.systemKN || item.assemblyKN || item.partKN || item.cableKN;
            alert(`✅ Successfully ${isEditing ? 'updated' : 'added'} ${kn}!`);
        }

        // Edit system item with pre-populated form
        function editSystemItem(kn, category) {
            // Find the item to edit
            let item = null;
            for (const [cat, items] of Object.entries(systemData)) {
                item = items.find(i => 
                    i.systemKN === kn || i.assemblyKN === kn || i.partKN === kn || i.cableKN === kn || i.pcbKN === kn
                );
                if (item) {
                    category = cat;
                    break;
                }
            }
            
            if (!item) {
                alert('Item not found for editing.');
                return;
            }
            
            // Close the details modal first
            closeAddComponentModal();
            
            // Open the add modal but pre-populate with existing data
            setTimeout(() => {
                openAddSystemModal(category);
                
                // Pre-populate the form with existing data
                setTimeout(() => {
                    switch(category) {
                        case 'systems':
                            document.getElementById('systemName').value = item.name || '';
                            document.getElementById('systemType').value = item.type || '';
                            document.getElementById('systemVersion').value = item.version || '';
                            document.getElementById('systemAssemblies').value = item.assemblies || 1;
                            document.getElementById('systemOwner').value = item.owner || '';
                            document.getElementById('systemDescription').value = item.description || '';
                            document.getElementById('systemFiles').value = (item.files || []).join(', ');
                            displayImagesInPreview(item.images || [], 'system-image-preview');
                            break;
                            
                        case 'assemblies':
                            document.getElementById('assemblyName').value = item.name || '';
                            document.getElementById('assemblyType').value = item.type || '';
                            document.getElementById('assemblyVersion').value = item.version || '';
                            document.getElementById('assemblyComponents').value = item.components || 0;
                            document.getElementById('assemblyDescription').value = item.description || '';
                            document.getElementById('assemblyFiles').value = (item.files || []).join(', ');
                            displayImagesInPreview(item.images || [], 'assembly-image-preview');
                            break;
                            
                        case '3d-parts':
                            document.getElementById('partName').value = item.name || '';
                            document.getElementById('partType').value = item.type || '';
                            document.getElementById('partMaterial').value = item.material || '';
                            document.getElementById('partVersion').value = item.version || '';
                            document.getElementById('partDescription').value = item.description || '';
                            document.getElementById('partFiles').value = (item.files || []).join(', ');
                            displayImagesInPreview(item.images || [], 'part-image-preview');
                            break;
                            
                        case 'pcbs':
                            document.getElementById('pcbName').value = item.name || '';
                            document.getElementById('pcbType').value = item.type || '';
                            document.getElementById('pcbLayers').value = item.layers || '';
                            document.getElementById('pcbSize').value = item.size || '';
                            document.getElementById('pcbThickness').value = item.thickness || '';
                            document.getElementById('pcbVersion').value = item.version || '';
                            document.getElementById('pcbDescription').value = item.description || '';
                            document.getElementById('pcbFiles').value = (item.files || []).join(', ');
                            displayImagesInPreview(item.images || [], 'pcb-image-preview');
                            break;
                            
                        case 'cable-assemblies':
                            document.getElementById('cableName').value = item.name || '';
                            document.getElementById('cableType').value = item.type || '';
                            document.getElementById('cableLength').value = item.length || '';
                            document.getElementById('cableConnectors').value = item.connectors || '';
                            document.getElementById('cableDescription').value = item.description || '';
                            document.getElementById('cableFiles').value = (item.files || []).join(', ');
                            displayImagesInPreview(item.images || [], 'cable-image-preview');
                            break;
                    }
                    
                    // Change the modal title and button text to indicate editing
                    const modalTitle = document.querySelector('.modal-content h3');
                    if (modalTitle) {
                        modalTitle.textContent = modalTitle.textContent.replace('Add New', 'Edit');
                    }
                    
                    const submitButton = document.querySelector('.modal-content form button[type="submit"]');
                    if (submitButton) {
                        submitButton.textContent = submitButton.textContent.replace('Add', 'Update');
                    }
                    
                    // Store the item ID for updating instead of creating new
                    const form = document.querySelector('.modal-content form');
                    if (form) {
                        form.setAttribute('data-edit-id', item.id);
                        form.setAttribute('data-edit-kn', kn);
                    }
                }, 100);
            }, 100);
        }

        // Delete system item
        function deleteSystemItem(kn, category) {
            if (!confirm(`Are you sure you want to delete ${kn}? This action cannot be undone.`)) {
                return;
            }
            
            // Find and remove the item
            const itemIndex = systemData[category].findIndex(item => 
                item.systemKN === kn || item.assemblyKN === kn || item.partKN === kn || item.cableKN === kn || item.pcbKN === kn
            );
            
            if (itemIndex !== -1) {
                systemData[category].splice(itemIndex, 1);
                localStorage.setItem('kinbenSystemData', JSON.stringify(systemData));
                
                // Refresh displays
                updateSystemStats();
                refreshSystemTable(category);
                
                // Close modal
                closeAddComponentModal();
                
                alert(`✅ Successfully deleted ${kn}!`);
            } else {
                alert('Item not found for deletion.');
            }
        }

        // Sort system-level tables
        function sortSystemTable(category, column) {
            const table = document.querySelector(`#${category === '3d-parts' ? '[id="3d-parts"]' : '#' + category} .component-table`);
            const headers = table.querySelectorAll('th.sortable-header');
            const currentHeader = Array.from(headers).find(h => h.onclick && h.onclick.toString().includes(`'${column}'`));
            
            if (!currentHeader) return;
            
            // Clear all sort indicators
            headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            
            // Determine sort direction
            let ascending = true;
            if (currentHeader.classList.contains('sort-asc')) {
                ascending = false;
                currentHeader.classList.add('sort-desc');
            } else {
                currentHeader.classList.add('sort-asc');
            }
            
            // Sort data
            systemData[category].sort((a, b) => {
                let valA = a[column] || '';
                let valB = b[column] || '';
                
                // Handle numeric values
                if (!isNaN(valA) && !isNaN(valB)) {
                    return ascending ? valA - valB : valB - valA;
                }
                
                // Handle string values
                valA = valA.toString().toLowerCase();
                valB = valB.toString().toLowerCase();
                
                if (ascending) {
                    return valA < valB ? -1 : valA > valB ? 1 : 0;
                } else {
                    return valA > valB ? -1 : valA < valB ? 1 : 0;
                }
            });
            
            refreshSystemTable(category);
        }

        // Export system-level data
        function exportSystemData(format, category) {
            const items = systemData[category] || [];
            if (items.length === 0) {
                alert(`No ${category.replace('-', ' ')} to export.`);
                return;
            }
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            let filename = `${category}_${timestamp}`;
            let content, mimeType;
            
            if (format === 'csv') {
                // Generate CSV headers based on category
                let headers = [];
                switch(category) {
                    case 'systems':
                        headers = ['System KN', 'Name', 'Version', 'Type', 'Status', 'Assemblies', 'Description', 'Owner', 'Files', 'Date Added'];
                        break;
                    case 'assemblies':
                        headers = ['Assembly KN', 'Name', 'Type', 'Version', 'Status', 'Components', 'Description', 'Files', 'Date Added'];
                        break;
                    case '3d-parts':
                        headers = ['Part KN', 'Name', 'Type', 'Material', 'Status', 'Version', 'Description', 'Files', 'Date Added'];
                        break;
                    case 'cable-assemblies':
                        headers = ['Cable KN', 'Name', 'Type', 'Length', 'Connectors', 'Status', 'Description', 'Files', 'Date Added'];
                        break;
                }
                
                content = headers.join(',') + '\n';
                items.forEach(item => {
                    const row = headers.map(header => {
                        let value = '';
                        switch(header) {
                            case 'System KN': value = item.systemKN || ''; break;
                            case 'Assembly KN': value = item.assemblyKN || ''; break;
                            case 'Part KN': value = item.partKN || ''; break;
                            case 'Cable KN': value = item.cableKN || ''; break;
                            case 'Name': value = item.name || ''; break;
                            case 'Version': value = item.version || ''; break;
                            case 'Type': value = item.type || ''; break;
                            case 'Status': value = item.status || ''; break;
                            case 'Material': value = item.material || ''; break;
                            case 'Length': value = item.length || ''; break;
                            case 'Connectors': value = item.connectors || ''; break;
                            case 'Assemblies': value = item.assemblies || ''; break;
                            case 'Components': value = item.components || ''; break;
                            case 'Description': value = item.description || ''; break;
                            case 'Owner': value = item.owner || ''; break;
                            case 'Files': value = (item.files || []).join(';'); break;
                            case 'Date Added': value = item.dateAdded || ''; break;
                            default: value = '';
                        }
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    });
                    content += row.join(',') + '\n';
                });
                
                filename += '.csv';
                mimeType = 'text/csv';
            } else {
                content = JSON.stringify(items, null, 2);
                filename += '.json';
                mimeType = 'application/json';
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`✅ Successfully exported ${items.length} ${category.replace('-', ' ')} to ${filename}!`);
        }

        // ==================== MULTIBOARD WIZARD FUNCTIONS ====================
        
        // Navigate wizard steps
        function nextWizardStep() {
            const currentStep = window.wizardData.step;
            
            // Validate current step before proceeding
            if (!validateWizardStep(currentStep)) return;
            
            // Save current step data
            saveWizardStepData(currentStep);
            
            if (currentStep < 4) {
                window.wizardData.step++;
                updateWizardDisplay();
            }
        }
        
        function previousWizardStep() {
            if (window.wizardData.step > 1) {
                window.wizardData.step--;
                updateWizardDisplay();
            }
        }
        
        function updateWizardDisplay() {
            const step = window.wizardData.step;
            
            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach((el, index) => {
                el.classList.toggle('active', index + 1 === step);
                el.classList.toggle('completed', index + 1 < step);
            });
            
            // Show/hide panels
            document.querySelectorAll('.wizard-panel').forEach((panel, index) => {
                panel.classList.toggle('active', index + 1 === step);
            });
            
            // Update navigation buttons
            const prevBtn = document.getElementById('wizardPrevBtn');
            const nextBtn = document.getElementById('wizardNextBtn');
            const createBtn = document.getElementById('wizardCreateBtn');
            
            prevBtn.style.display = step === 1 ? 'none' : 'inline-block';
            nextBtn.style.display = step === 4 ? 'none' : 'inline-block';
            createBtn.style.display = step === 4 ? 'inline-block' : 'none';
            
            // Special handling for step 4 (review)
            if (step === 4) {
                generateWizardReview();
            }
        }
        
        function validateWizardStep(step) {
            switch(step) {
                case 1:
                    const name = document.getElementById('wizardProjectName').value.trim();
                    const type = document.getElementById('wizardProjectType').value;
                    const desc = document.getElementById('wizardDescription').value.trim();
                    
                    if (!name || !type || !desc) {
                        alert('Please fill in all required fields (Name, Type, Description)');
                        return false;
                    }
                    return true;
                    
                case 2:
                    if (window.wizardData.assemblies.length === 0) {
                        alert('Please add at least one assembly to your system');
                        return false;
                    }
                    return true;
                    
                case 3:
                    // Step 3 is optional - components/parts can be empty
                    return true;
                    
                default:
                    return true;
            }
        }
        
        function saveWizardStepData(step) {
            switch(step) {
                case 1:
                    window.wizardData.project = {
                        name: document.getElementById('wizardProjectName').value.trim(),
                        type: document.getElementById('wizardProjectType').value,
                        version: document.getElementById('wizardVersion').value.trim(),
                        owner: document.getElementById('wizardOwner').value.trim(),
                        assemblyCount: parseInt(document.getElementById('wizardAssemblyCount').value) || 1,
                        description: document.getElementById('wizardDescription').value.trim()
                    };
                    break;
                case 2:
                    // Assembly data is saved dynamically when assemblies are added
                    break;
                case 3:
                    // Component data is saved dynamically when components are added
                    break;
            }
        }
        
        // Add assembly to wizard
        function addWizardAssembly() {
            const assemblyId = Date.now();
            const assemblyList = document.getElementById('wizardAssemblyList');
            
            const assemblyDiv = document.createElement('div');
            assemblyDiv.className = 'wizard-assembly-item';
            assemblyDiv.innerHTML = `
                <div class="assembly-header">
                    <h6>Assembly ${window.wizardData.assemblies.length + 1}</h6>
                    <button type="button" class="btn-remove" onclick="removeWizardAssembly(${assemblyId})">❌</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Assembly Name *</label>
                        <input type="text" id="wizardAsmName${assemblyId}" required placeholder="e.g., Main Controller PCBA">
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="wizardAsmType${assemblyId}" required>
                            <option value="">Select type...</option>
                            <option value="PCBA">PCB Assembly</option>
                            <option value="MECH">Mechanical Assembly</option>
                            <option value="OPT">Optical Assembly</option>
                            <option value="SENS">Sensor Assembly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="wizardAsmQty${assemblyId}" min="1" value="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="wizardAsmDesc${assemblyId}" placeholder="Assembly purpose and functionality"></textarea>
                </div>
            `;
            
            assemblyList.appendChild(assemblyDiv);
            
            // Add to wizard data
            window.wizardData.assemblies.push({
                id: assemblyId,
                name: '',
                type: '',
                quantity: 1,
                description: ''
            });
        }
        
        function removeWizardAssembly(id) {
            document.querySelector(`[data-assembly-id="${id}"]`)?.remove();
            window.wizardData.assemblies = window.wizardData.assemblies.filter(a => a.id !== id);
        }
        
        // Add 3D part to wizard
        function addWizard3DPart() {
            const partId = Date.now();
            const partsList = document.getElementById('wizard3DPartsList');
            
            const partDiv = document.createElement('div');
            partDiv.className = 'wizard-component-item';
            partDiv.innerHTML = `
                <div class="component-header">
                    <h6>3D Part ${window.wizardData.parts3D.length + 1}</h6>
                    <button type="button" class="btn-remove" onclick="removeWizard3DPart(${partId})">❌</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Part Name</label>
                        <input type="text" id="wizard3DName${partId}" placeholder="e.g., Custom Enclosure">
                    </div>
                    <div class="form-group">
                        <label>Material</label>
                        <select id="wizard3DMat${partId}">
                            <option value="PLA">PLA</option>
                            <option value="ABS">ABS</option>
                            <option value="PETG">PETG</option>
                            <option value="TPU">TPU</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="wizard3DQty${partId}" min="1" value="1">
                    </div>
                </div>
            `;
            
            partsList.appendChild(partDiv);
            
            window.wizardData.parts3D.push({
                id: partId,
                name: '',
                material: 'PLA',
                quantity: 1
            });
        }
        
        function removeWizard3DPart(id) {
            event.target.closest('.wizard-component-item').remove();
            window.wizardData.parts3D = window.wizardData.parts3D.filter(p => p.id !== id);
        }
        
        // Add cable assembly to wizard
        function addWizardCable() {
            const cableId = Date.now();
            const cablesList = document.getElementById('wizardCablesList');
            
            const cableDiv = document.createElement('div');
            cableDiv.className = 'wizard-component-item';
            cableDiv.innerHTML = `
                <div class="component-header">
                    <h6>Cable ${window.wizardData.cables.length + 1}</h6>
                    <button type="button" class="btn-remove" onclick="removeWizardCable(${cableId})">❌</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cable Name</label>
                        <input type="text" id="wizardCableName${cableId}" placeholder="e.g., Power Harness">
                    </div>
                    <div class="form-group">
                        <label>Length</label>
                        <input type="text" id="wizardCableLen${cableId}" placeholder="e.g., 150mm">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="wizardCableQty${cableId}" min="1" value="1">
                    </div>
                </div>
            `;
            
            cablesList.appendChild(cableDiv);
            
            window.wizardData.cables.push({
                id: cableId,
                name: '',
                length: '',
                quantity: 1
            });
        }
        
        function removeWizardCable(id) {
            event.target.closest('.wizard-component-item').remove();
            window.wizardData.cables = window.wizardData.cables.filter(c => c.id !== id);
        }
        
        // Add direct component to wizard  
        function addWizardComponent() {
            const compId = Date.now();
            const compsList = document.getElementById('wizardComponentsList');
            
            const compDiv = document.createElement('div');
            compDiv.className = 'wizard-component-item';
            compDiv.innerHTML = `
                <div class="component-header">
                    <h6>Component ${window.wizardData.components.length + 1}</h6>
                    <button type="button" class="btn-remove" onclick="removeWizardComponent(${compId})">❌</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Component Name</label>
                        <input type="text" id="wizardCompName${compId}" placeholder="e.g., Power Supply Module">
                    </div>
                    <div class="form-group">
                        <label>KPN (if available)</label>
                        <input type="text" id="wizardCompKPN${compId}" placeholder="KPN-XXX-XXX-XXX">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="wizardCompQty${compId}" min="1" value="1">
                    </div>
                </div>
            `;
            
            compsList.appendChild(compDiv);
            
            window.wizardData.components.push({
                id: compId,
                name: '',
                kpn: '',
                quantity: 1
            });
        }
        
        function removeWizardComponent(id) {
            event.target.closest('.wizard-component-item').remove();
            window.wizardData.components = window.wizardData.components.filter(c => c.id !== id);
        }
        
        // Generate review content
        function generateWizardReview() {
            const reviewDiv = document.getElementById('wizardReview');
            const data = window.wizardData;
            
            reviewDiv.innerHTML = `
                <div class="review-section">
                    <h5>Project Information</h5>
                    <table class="review-table">
                        <tr><td><strong>Project Name:</strong></td><td>${data.project.name}</td></tr>
                        <tr><td><strong>Type:</strong></td><td>${data.project.type}</td></tr>
                        <tr><td><strong>Version:</strong></td><td>${data.project.version}</td></tr>
                        <tr><td><strong>Owner:</strong></td><td>${data.project.owner || 'Not specified'}</td></tr>
                        <tr><td><strong>Description:</strong></td><td>${data.project.description}</td></tr>
                    </table>
                </div>
                
                <div class="review-section">
                    <h5>Assemblies (${data.assemblies.length})</h5>
                    ${data.assemblies.length === 0 ? '<p><em>No assemblies added</em></p>' : 
                        data.assemblies.map(asm => `
                            <div class="review-item">
                                <strong>${asm.name}</strong> (${asm.type}) - Qty: ${asm.quantity}
                                ${asm.description ? `<br><small>${asm.description}</small>` : ''}
                            </div>
                        `).join('')
                    }
                </div>
                
                <div class="review-section">
                    <h5>3D Printed Parts (${data.parts3D.length})</h5>
                    ${data.parts3D.length === 0 ? '<p><em>No 3D parts added</em></p>' : 
                        data.parts3D.map(part => `
                            <div class="review-item">
                                <strong>${part.name}</strong> (${part.material}) - Qty: ${part.quantity}
                            </div>
                        `).join('')
                    }
                </div>
                
                <div class="review-section">
                    <h5>Cable Assemblies (${data.cables.length})</h5>
                    ${data.cables.length === 0 ? '<p><em>No cables added</em></p>' : 
                        data.cables.map(cable => `
                            <div class="review-item">
                                <strong>${cable.name}</strong> (${cable.length}) - Qty: ${cable.quantity}
                            </div>
                        `).join('')
                    }
                </div>
                
                <div class="review-section">
                    <h5>Direct Components (${data.components.length})</h5>
                    ${data.components.length === 0 ? '<p><em>No direct components added</em></p>' : 
                        data.components.map(comp => `
                            <div class="review-item">
                                <strong>${comp.name}</strong> ${comp.kpn ? `(${comp.kpn})` : ''} - Qty: ${comp.quantity}
                            </div>
                        `).join('')
                    }
                </div>
                
                <div class="review-summary">
                    <h5>Summary</h5>
                    <p>This wizard will create:</p>
                    <ul>
                        <li><strong>1 System</strong> (${data.project.name})</li>
                        ${data.assemblies.length > 0 ? `<li><strong>${data.assemblies.length} Assembly${data.assemblies.length > 1 ? 'ies' : ''}</strong></li>` : ''}
                        ${data.parts3D.length > 0 ? `<li><strong>${data.parts3D.length} 3D Part${data.parts3D.length > 1 ? 's' : ''}</strong></li>` : ''}
                        ${data.cables.length > 0 ? `<li><strong>${data.cables.length} Cable Assembly${data.cables.length > 1 ? 'ies' : ''}</strong></li>` : ''}
                    </ul>
                    <p><strong>Total items to be created:</strong> ${1 + data.assemblies.length + data.parts3D.length + data.cables.length}</p>
                </div>
            `;
        }
        
        // Create the complete multiboard system
        function createMultiboardSystem() {
            const data = window.wizardData;
            
            try {
                // Collect current form data for assemblies
                data.assemblies.forEach(asm => {
                    asm.name = document.getElementById(`wizardAsmName${asm.id}`)?.value || '';
                    asm.type = document.getElementById(`wizardAsmType${asm.id}`)?.value || '';
                    asm.quantity = parseInt(document.getElementById(`wizardAsmQty${asm.id}`)?.value) || 1;
                    asm.description = document.getElementById(`wizardAsmDesc${asm.id}`)?.value || '';
                });
                
                // Create all assemblies first
                const createdAssemblies = [];
                data.assemblies.forEach(asmData => {
                    if (asmData.name && asmData.type) {
                        const assembly = {
                            id: Date.now() + Math.random(),
                            assemblyKN: generateSystemKN('assemblies', asmData.type),
                            name: asmData.name,
                            type: asmData.type,
                            version: 'v1.0',
                            status: 'Active',
                            components: 0,
                            description: asmData.description,
                            files: [],
                            dateAdded: new Date().toISOString().split('T')[0],
                            assemblyComponents: [],
                            assembly3DParts: [],
                            assemblyCables: []
                        };
                        
                        systemData.assemblies.push(assembly);
                        createdAssemblies.push({
                            kn: assembly.assemblyKN,
                            name: assembly.name,
                            quantity: asmData.quantity
                        });
                    }
                });
                
                // Create 3D parts
                const created3DParts = [];
                data.parts3D.forEach(partData => {
                    const name = document.getElementById(`wizard3DName${partData.id}`)?.value;
                    const material = document.getElementById(`wizard3DMat${partData.id}`)?.value;
                    const quantity = parseInt(document.getElementById(`wizard3DQty${partData.id}`)?.value) || 1;
                    
                    if (name) {
                        const part = {
                            id: Date.now() + Math.random(),
                            partKN: generateSystemKN('3d-parts', 'MISC'),
                            name: name,
                            type: 'MISC',
                            material: material,
                            status: 'Active',
                            version: 'v1.0',
                            description: `3D printed part for ${data.project.name}`,
                            files: [],
                            dateAdded: new Date().toISOString().split('T')[0]
                        };
                        
                        systemData['3d-parts'].push(part);
                        created3DParts.push({
                            kn: part.partKN,
                            name: part.name,
                            quantity: quantity
                        });
                    }
                });
                
                // Create cable assemblies
                const createdCables = [];
                data.cables.forEach(cableData => {
                    const name = document.getElementById(`wizardCableName${cableData.id}`)?.value;
                    const length = document.getElementById(`wizardCableLen${cableData.id}`)?.value;
                    const quantity = parseInt(document.getElementById(`wizardCableQty${cableData.id}`)?.value) || 1;
                    
                    if (name) {
                        const cable = {
                            id: Date.now() + Math.random(),
                            cableKN: generateSystemKN('cable-assemblies', 'DATA'),
                            name: name,
                            type: 'DATA',
                            length: length,
                            connectors: 'TBD',
                            status: 'Active',
                            description: `Cable assembly for ${data.project.name}`,
                            files: [],
                            dateAdded: new Date().toISOString().split('T')[0],
                            cableComponents: []
                        };
                        
                        systemData['cable-assemblies'].push(cable);
                        createdCables.push({
                            kn: cable.cableKN,
                            name: cable.name,
                            quantity: quantity
                        });
                    }
                });
                
                // Create direct components list
                const systemComponents = [];
                data.components.forEach(compData => {
                    const name = document.getElementById(`wizardCompName${compData.id}`)?.value;
                    const kpn = document.getElementById(`wizardCompKPN${compData.id}`)?.value;
                    const quantity = parseInt(document.getElementById(`wizardCompQty${compData.id}`)?.value) || 1;
                    
                    if (name) {
                        systemComponents.push({
                            kpn: kpn || 'TBD',
                            name: name,
                            quantity: quantity
                        });
                    }
                });
                
                // Create the main system
                const system = {
                    id: Date.now(),
                    systemKN: generateSystemKN('systems', data.project.type),
                    name: data.project.name,
                    type: data.project.type,
                    version: data.project.version,
                    status: 'Active',
                    assemblies: createdAssemblies.length,
                    description: data.project.description,
                    owner: data.project.owner,
                    files: [],
                    dateAdded: new Date().toISOString().split('T')[0],
                    // Enhanced system composition with relationships
                    systemAssemblies: createdAssemblies,
                    systemComponents: systemComponents,
                    system3DParts: created3DParts,
                    systemCables: createdCables
                };
                
                systemData.systems.push(system);
                
                // Save everything to localStorage
                localStorage.setItem('kinbenSystemData', JSON.stringify(systemData));
                
                // Refresh all displays
                updateSystemStats();
                Object.keys(systemData).forEach(category => {
                    refreshSystemTable(category);
                });
                
                // Close modal
                closeAddComponentModal();
                
                // Success message with summary
                const totalCreated = 1 + createdAssemblies.length + created3DParts.length + createdCables.length;
                alert(`✅ Multiboard System Created Successfully!
                
System: ${system.systemKN} - ${system.name}
Created: ${totalCreated} total items
- 1 System
- ${createdAssemblies.length} Assemblies  
- ${created3DParts.length} 3D Parts
- ${createdCables.length} Cable Assemblies
- ${systemComponents.length} Direct Components

Navigate to the Systems tab to view and manage your new multiboard system!`);
                
                // Automatically switch to systems view
                showSheet('systems');
                
            } catch (error) {
                console.error('Error creating multiboard system:', error);
                alert('❌ Error creating system. Please try again or contact support.');
            }
        }

        function showSheet(sheetName) {
            // Hide all sheets
            const sheets = document.querySelectorAll('.sheet');
            sheets.forEach(sheet => sheet.classList.remove('active'));
            
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected sheet and tab
            document.getElementById(sheetName).classList.add('active');
            event.target.classList.add('active');
            
            // Update component counts and refresh tables
            updateStats();
            
            // Handle system-level sheets first
            if (['systems', 'assemblies', '3d-parts', 'cable-assemblies'].includes(sheetName)) {
                updateSystemStats();
                refreshSystemTable(sheetName);
                console.log(`Switched to ${sheetName} for system management`);
            } else if (sheetName !== 'landing') {
                refreshComponentTable(sheetName);
            }
        }
        
        function updateStats() {
            let totalComponents = 0;
            let activeCategories = 0;
            
            Object.keys(componentData).forEach(category => {
                const count = componentData[category].length;
                totalComponents += count;
                if (count > 0) activeCategories++;
                
                // Update category table counts
                const categoryRow = document.querySelector(`[data-category="${category}"]`);
                if (categoryRow) {
                    categoryRow.querySelector('.count-cell').textContent = count;
                }
            });
            
            // Update stats cards
            document.getElementById('total-components').textContent = totalComponents;
            document.getElementById('active-categories').textContent = activeCategories;
            document.getElementById('total-categories').textContent = Object.keys(componentData).length;
            
            // Add system-level statistics
            let totalSystems = systemData.systems.length;
            let totalAssemblies = systemData.assemblies.length;
            let totalMultiboard = systemData.systems.filter(s => s.assemblies > 1).length;
            
            const systemsElement = document.getElementById('total-systems');
            const assembliesElement = document.getElementById('total-assemblies');
            const multiboardElement = document.getElementById('total-multiboard');
            
            if (systemsElement) systemsElement.textContent = totalSystems;
            if (assembliesElement) assembliesElement.textContent = totalAssemblies;
            if (multiboardElement) multiboardElement.textContent = totalMultiboard;
        }
        
        function generateKPN(category, subcategory) {
            const categoryData = componentData[category] || [];
            const categoryCode = categoryConfigs[category].code;
            const sequence = (categoryData.length + 1).toString().padStart(4, '0');
            return `KPN-${categoryCode}-${subcategory}-${sequence}`;
        }
        
        function openAddComponentModal(category) {
            const modal = document.getElementById('addComponentModal');
            const form = document.getElementById('addComponentForm');
            const categorySelect = document.getElementById('categorySelect');
            const subcategorySelect = document.getElementById('subcategorySelect');
            
            // Set category
            categorySelect.value = category;
            updateSubcategories();
            
            // Show modal
            modal.style.display = 'block';
        }
        
        function closeAddComponentModal() {
            document.getElementById('addComponentModal').style.display = 'none';
        }
        
        // Image upload handling
        function handleImageUpload(input, previewId) {
            const files = input.files;
            const previewContainer = document.getElementById(previewId);
            
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/') && file.size <= 5 * 1024 * 1024) { // 5MB limit
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageItem = document.createElement('div');
                        imageItem.className = 'image-item';
                        imageItem.innerHTML = `
                            <img src="${e.target.result}" class="image-preview" alt="Preview">
                            <button class="image-remove" onclick="removeImagePreview(this)">×</button>
                            <div class="image-caption">${file.name}</div>
                        `;
                        previewContainer.appendChild(imageItem);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removeImagePreview(button) {
            button.parentElement.remove();
        }
        
        function getImageData(previewId) {
            const previewContainer = document.getElementById(previewId);
            const images = [];
            previewContainer.querySelectorAll('.image-item').forEach(item => {
                const img = item.querySelector('img');
                const caption = item.querySelector('.image-caption');
                if (img && caption) {
                    images.push({
                        data: img.src,
                        name: caption.textContent
                    });
                }
            });
            return images;
        }
        
        function displayImagesInPreview(images, previewId) {
            const previewContainer = document.getElementById(previewId);
            if (previewContainer && images && images.length > 0) {
                previewContainer.innerHTML = '';
                images.forEach(img => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    imageItem.innerHTML = `
                        <img src="${img.data}" class="image-preview" alt="${img.name}">
                        <button class="image-remove" onclick="removeImagePreview(this)">×</button>
                        <div class="image-caption">${img.name}</div>
                    `;
                    previewContainer.appendChild(imageItem);
                });
            }
        }
        
        function updateSubcategories() {
            const categorySelect = document.getElementById('categorySelect');
            const subcategorySelect = document.getElementById('subcategorySelect');
            const category = categorySelect.value;
            
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (category && categoryConfigs[category]) {
                categoryConfigs[category].subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
        }
        
        function generateKPNPreview() {
            const category = document.getElementById('categorySelect').value;
            const subcategory = document.getElementById('subcategorySelect').value;
            const preview = document.getElementById('kpnPreview');
            
            if (category && subcategory) {
                const kpn = generateKPN(category, subcategory);
                preview.textContent = kpn;
                document.getElementById('kinbenPN').value = kpn;
            } else {
                preview.textContent = 'Select category and subcategory';
                document.getElementById('kinbenPN').value = '';
            }
        }
        
        function addComponent() {
            const form = document.getElementById('addComponentForm');
            const formData = new FormData(form);
            const category = formData.get('category');
            
            if (!category) {
                alert('Please select a category');
                return;
            }
            
            // Create component object
            const component = {
                kinbenPN: formData.get('kinbenPN'),
                value: formData.get('value'),
                voltage: formData.get('voltage'),
                current: formData.get('current'),
                power: formData.get('power'),
                tolerance: formData.get('tolerance'),
                package: formData.get('package'),
                mounting: formData.get('mounting'),
                temperature: formData.get('temperature'),
                manufacturer: formData.get('manufacturer'),
                manufacturerPN: formData.get('manufacturerPN'),
                description: formData.get('description'),
                supplier: formData.get('supplier'),
                mouserPN: formData.get('mouserPN'),
                digikeyPN: formData.get('digikeyPN'),
                cost: formData.get('cost'),
                moq: formData.get('moq'),
                status: formData.get('status') || 'Active',
                symbolFile: formData.get('symbolFile'),
                footprintFile: formData.get('footprintFile'),
                modelFile: formData.get('modelFile'),
                notes: formData.get('notes'),
                createdDate: new Date().toISOString().split('T')[0],
                createdBy: 'User'
            };
            
            // Add to component data
            if (!componentData[category]) {
                componentData[category] = [];
            }
            componentData[category].push(component);
            
            // Save component data to localStorage
            saveComponentData();
            
            // Close modal and refresh
            closeAddComponentModal();
            form.reset();
            updateStats();
            
            // If we're on the category sheet, refresh it
            const activeSheet = document.querySelector('.sheet.active');
            if (activeSheet && activeSheet.id === category) {
                refreshComponentTable(category);
            }
            
            alert('Component added successfully!');
        }
        
        function refreshComponentTable(category) {
            const table = document.querySelector(`#${category} .component-table tbody`);
            if (!table) return;
            
            const components = componentData[category] || [];
            
            if (components.length === 0) {
                table.innerHTML = '<tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Component" to get started!</td></tr>';
                return;
            }
            
            table.innerHTML = '';
            components.forEach(component => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${component.kinbenPN}</td>
                    <td>${component.value || '-'}</td>
                    <td>${component.voltage || '-'}</td>
                    <td>${component.tolerance || '-'}</td>
                    <td>${component.package || '-'}</td>
                    <td>${component.mounting || '-'}</td>
                    <td>${component.temperature || '-'}</td>
                    <td>${component.manufacturer || '-'}</td>
                    <td>${component.manufacturerPN || '-'}</td>
                    <td>${component.description || '-'}</td>
                    <td>${component.supplier || '-'}</td>
                    <td>${component.mouserPN || '-'}</td>
                    <td>${component.digikeyPN || '-'}</td>
                    <td>${component.cost || '-'}</td>
                    <td>${component.moq || '-'}</td>
                    <td><span class="status-${component.status.toLowerCase()}">${component.status}</span></td>
                    <td>${component.symbolFile || '-'}</td>
                    <td>${component.footprintFile || '-'}</td>
                    <td>${component.modelFile || '-'}</td>
                    <td>${component.notes || '-'}</td>
                `;
                table.appendChild(row);
            });
        }
        
        function exportData(format, category = null) {
            let data = category ? componentData[category] : componentData;
            let filename = category ? `${category}_components` : 'all_components';
            
            if (format === 'csv') {
                exportToCSV(data, filename);
            } else if (format === 'json') {
                exportToJSON(data, filename);
            }
        }
        
        function exportToCSV(data, filename) {
            if (!data || (Array.isArray(data) && data.length === 0)) {
                alert('No data to export');
                return;
            }
            
            let csvContent = '';
            let components = Array.isArray(data) ? data : Object.values(data).flat();
            
            if (components.length === 0) {
                alert('No components to export');
                return;
            }
            
            // Headers
            const headers = Object.keys(components[0]);
            csvContent += headers.join(',') + '\\n';
            
            // Data rows
            components.forEach(component => {
                const row = headers.map(header => {
                    const value = component[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvContent += row.join(',') + '\\n';
            });
            
            downloadFile(csvContent, `${filename}.csv`, 'text/csv');
        }
        
        function exportToJSON(data, filename) {
            const jsonContent = JSON.stringify(data, null, 2);
            downloadFile(jsonContent, `${filename}.json`, 'application/json');
        }
        
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        function searchComponents() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase().trim();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }
            
            // Search across all components or specific category
            let searchResults = [];
            const categoriesToSearch = categoryFilter ? [categoryFilter] : Object.keys(componentData);
            
            categoriesToSearch.forEach(category => {
                const components = componentData[category] || [];
                components.forEach(component => {
                    // Search in all text fields of the component
                    const searchableText = [
                        component.kinbenPN, component.value, component.voltage, component.current, 
                        component.power, component.tolerance, component.package, component.mounting,
                        component.temperature, component.manufacturer, component.manufacturerPN,
                        component.description, component.supplier, component.mouserPN, 
                        component.digikeyPN, component.status, component.notes
                    ].join(' ').toLowerCase();
                    
                    if (searchableText.includes(searchTerm)) {
                        searchResults.push({
                            ...component,
                            category: category,
                            categoryName: getCategoryDisplayName(category)
                        });
                    }
                });
            });
            
            displaySearchResults(searchResults, searchTerm);
        }
        
        function getCategoryDisplayName(category) {
            const categoryNames = {
                capacitors: 'Capacitors', resistors: 'Resistors', inductors: 'Inductors',
                diodes: 'Diodes', transistors: 'Transistors', ics: 'Integrated Circuits',
                connectors: 'Connectors', crystals: 'Crystals & Oscillators', fuses: 'Fuses',
                switches: 'Switches', relays: 'Relays', optocouplers: 'Optocouplers',
                sensors: 'Sensors', mechanical: 'Mechanical', hardware: 'Hardware',
                cables: 'Cables & Wires'
            };
            return categoryNames[category] || category;
        }
        
        function displaySearchResults(results, searchTerm) {
            // Show search results sheet
            showSearchResults();
            
            // Update search results table
            const tbody = document.querySelector('#search-results .search-results-table tbody');
            const resultsCount = document.getElementById('search-results-count');
            const searchTermDisplay = document.getElementById('search-term-display');
            
            resultsCount.textContent = results.length;
            searchTermDisplay.textContent = searchTerm;
            
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 20px;">No components found matching your search.</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            results.forEach(component => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${component.kinbenPN}</strong></td>
                    <td><span class="category-badge">${component.categoryName}</span></td>
                    <td>${highlightSearchTerm(component.value || '-', searchTerm)}</td>
                    <td>${highlightSearchTerm(component.manufacturer || '-', searchTerm)}</td>
                    <td>${highlightSearchTerm(component.manufacturerPN || '-', searchTerm)}</td>
                    <td>${highlightSearchTerm(component.description || '-', searchTerm)}</td>
                    <td><span class="status-${component.status.toLowerCase()}">${component.status}</span></td>
                    <td><button class="btn btn-primary btn-sm" onclick="viewComponent('${component.category}', '${component.kinbenPN}')">View</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function highlightSearchTerm(text, searchTerm) {
            if (!text || !searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        
        function showSearchResults() {
            // Hide all sheets
            const sheets = document.querySelectorAll('.sheet');
            sheets.forEach(sheet => sheet.classList.remove('active'));
            
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show search results sheet
            document.getElementById('search-results').classList.add('active');
            
            // Highlight search tab if it exists, otherwise create visual indicator
            const searchTab = document.querySelector('[onclick="showSheet(\'search-results\')"]');
            if (searchTab) {
                searchTab.classList.add('active');
            }
        }
        
        function viewComponent(category, kinbenPN) {
            // Switch to the category sheet and highlight the component
            showSheet(category);
            
            // Find and highlight the component in the table
            setTimeout(() => {
                const table = document.querySelector(`#${category} .component-table`);
                if (table) {
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const firstCell = row.querySelector('td');
                        if (firstCell && firstCell.textContent === kinbenPN) {
                            row.style.backgroundColor = '#fff3cd';
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Remove highlight after 3 seconds
                            setTimeout(() => {
                                row.style.backgroundColor = '';
                            }, 3000);
                        }
                    });
                }
            }, 100);
        }
        
        function clearSearch() {
            document.getElementById('globalSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            showSheet('landing');
        }
        
        // Category page filtering system
        function filterCategoryComponents(category) {
            const filters = getCategoryFilters(category);
            const components = componentData[category] || [];
            const table = document.querySelector(`#${category} .component-table tbody`);
            const stats = document.querySelector(`#${category} .filter-stats`);
            
            let visibleCount = 0;
            let totalCount = components.length;
            
            if (totalCount === 0) {
                if (stats) stats.textContent = 'No components to filter';
                return;
            }
            
            // Filter components
            const filteredComponents = components.filter(component => {
                let matches = true;
                
                // Text search filter
                if (filters.search && filters.search.trim() !== '') {
                    const searchTerm = filters.search.toLowerCase();
                    const searchableText = [
                        component.kinbenPN, component.value, component.manufacturer, 
                        component.manufacturerPN, component.description, component.notes
                    ].join(' ').toLowerCase();
                    matches = matches && searchableText.includes(searchTerm);
                }
                
                // Manufacturer filter
                if (filters.manufacturer && filters.manufacturer !== '') {
                    matches = matches && (component.manufacturer || '').toLowerCase().includes(filters.manufacturer.toLowerCase());
                }
                
                // Status filter
                if (filters.status && filters.status !== '') {
                    matches = matches && (component.status || '').toLowerCase() === filters.status.toLowerCase();
                }
                
                // Package filter
                if (filters.package && filters.package !== '') {
                    matches = matches && (component.package || '').toLowerCase().includes(filters.package.toLowerCase());
                }
                
                // Mounting filter
                if (filters.mounting && filters.mounting !== '') {
                    matches = matches && (component.mounting || '').toLowerCase() === filters.mounting.toLowerCase();
                }
                
                return matches;
            });
            
            // Hide/show table rows
            const rows = table.querySelectorAll('tr');
            rows.forEach((row, index) => {
                if (index === 0 && row.textContent.includes('No components')) {
                    return; // Skip empty state row
                }
                
                const component = components[index];
                if (component && filteredComponents.includes(component)) {
                    row.classList.remove('hidden-row');
                    visibleCount++;
                } else if (component) {
                    row.classList.add('hidden-row');
                }
            });
            
            // Update stats
            if (stats) {
                stats.textContent = `Showing ${visibleCount} of ${totalCount} components`;
                if (visibleCount !== totalCount) {
                    stats.textContent += ` (${totalCount - visibleCount} filtered out)`;
                }
            }
            
            // Update active filters display
            updateActiveFilters(category, filters);
        }
        
        function getCategoryFilters(category) {
            const filterPrefix = `${category}-filter`;
            return {
                search: (document.getElementById(`${filterPrefix}-search`) || {}).value || '',
                manufacturer: (document.getElementById(`${filterPrefix}-manufacturer`) || {}).value || '',
                status: (document.getElementById(`${filterPrefix}-status`) || {}).value || '',
                package: (document.getElementById(`${filterPrefix}-package`) || {}).value || '',
                mounting: (document.getElementById(`${filterPrefix}-mounting`) || {}).value || ''
            };
        }
        
        function clearCategoryFilters(category) {
            const filterPrefix = `${category}-filter`;
            const filterIds = ['search', 'manufacturer', 'status', 'package', 'mounting'];
            
            filterIds.forEach(filterId => {
                const element = document.getElementById(`${filterPrefix}-${filterId}`);
                if (element) element.value = '';
            });
            
            // Clear active filters and refresh
            updateActiveFilters(category, {});
            refreshComponentTable(category);
        }
        
        function updateActiveFilters(category, filters) {
            const activeFiltersContainer = document.querySelector(`#${category} .active-filters`);
            if (!activeFiltersContainer) return;
            
            activeFiltersContainer.innerHTML = '';
            
            // Add filter badges for active filters
            Object.keys(filters).forEach(filterKey => {
                const filterValue = filters[filterKey];
                if (filterValue && filterValue.trim() !== '') {
                    const badge = document.createElement('div');
                    badge.className = 'filter-badge';
                    badge.innerHTML = `
                        <span>${filterKey}: ${filterValue}</span>
                        <span class="remove-filter" onclick="removeFilter('${category}', '${filterKey}')">&times;</span>
                    `;
                    activeFiltersContainer.appendChild(badge);
                }
            });
        }
        
        function removeFilter(category, filterKey) {
            const filterPrefix = `${category}-filter`;
            const element = document.getElementById(`${filterPrefix}-${filterKey}`);
            if (element) {
                element.value = '';
                filterCategoryComponents(category);
            }
        }
        
        function sortTable(category, columnIndex, dataType = 'string') {
            const table = document.querySelector(`#${category} .component-table`);
            const tbody = table.querySelector('tbody');
            const thead = table.querySelector('thead');
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => 
                !row.textContent.includes('No components') && !row.classList.contains('hidden-row')
            );
            
            if (rows.length === 0) return;
            
            // Get current sort direction for this column
            const header = thead.querySelectorAll('th')[columnIndex];
            const currentDirection = header.dataset.sortDirection || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            
            // Clear all sort indicators
            thead.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                th.dataset.sortDirection = '';
            });
            
            // Set new sort direction and indicator
            header.dataset.sortDirection = newDirection;
            header.classList.add(`sort-${newDirection}`);
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex]?.textContent.trim() || '';
                const bValue = b.cells[columnIndex]?.textContent.trim() || '';
                
                let comparison = 0;
                
                if (dataType === 'number') {
                    // Handle currency and numeric values
                    const aNum = parseFloat(aValue.replace(/[$,]/g, '')) || 0;
                    const bNum = parseFloat(bValue.replace(/[$,]/g, '')) || 0;
                    comparison = aNum - bNum;
                } else if (dataType === 'date') {
                    const aDate = new Date(aValue);
                    const bDate = new Date(bValue);
                    comparison = aDate - bDate;
                } else {
                    // String comparison (default)
                    comparison = aValue.localeCompare(bValue, undefined, { numeric: true, sensitivity: 'base' });
                }
                
                return newDirection === 'asc' ? comparison : -comparison;
            });
            
            // Reorder rows in DOM
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // Make table headers sortable
        function makeSortableHeaders(category) {
            const table = document.querySelector(`#${category} .component-table`);
            if (!table) return;
            
            const headers = table.querySelectorAll('thead th');
            const columnConfig = {
                0: { type: 'string' },    // Kinben PN
                1: { type: 'string' },    // Value/Type
                2: { type: 'string' },    // Voltage/Frequency etc.
                3: { type: 'string' },    // Tolerance/Current etc.
                4: { type: 'string' },    // Package
                5: { type: 'string' },    // Mounting
                6: { type: 'string' },    // Temperature Range
                7: { type: 'string' },    // Manufacturer
                8: { type: 'string' },    // Manufacturer PN
                9: { type: 'string' },    // Description
                10: { type: 'string' },   // Preferred Supplier
                11: { type: 'string' },   // Mouser PN
                12: { type: 'string' },   // DigiKey PN
                13: { type: 'number' },   // Unit Cost
                14: { type: 'number' },   // MOQ
                15: { type: 'string' },   // Status
                16: { type: 'string' },   // Symbol File
                17: { type: 'string' },   // Footprint File
                18: { type: 'string' },   // 3D Model File
                19: { type: 'string' }    // Notes
            };
            
            headers.forEach((header, index) => {
                header.classList.add('sortable-header');
                header.style.cursor = 'pointer';
                header.title = 'Click to sort';
                
                const dataType = columnConfig[index]?.type || 'string';
                header.onclick = () => sortTable(category, index, dataType);
            });
        }
        
        // Generate filter HTML for a category
        function generateCategoryFilters(category, categoryDisplayName) {
            return `
                <!-- Category Filters -->
                <div class="category-filters">
                    <h4>🔍 Filter ${categoryDisplayName}</h4>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label>Search</label>
                            <input type="text" id="${category}-filter-search" class="filter-input" placeholder="Search ${categoryDisplayName.toLowerCase()}..." onkeyup="filterCategoryComponents('${category}')">
                        </div>
                        <div class="filter-group">
                            <label>Manufacturer</label>
                            <input type="text" id="${category}-filter-manufacturer" class="filter-input" placeholder="e.g. Murata, TI, Vishay..." onkeyup="filterCategoryComponents('${category}')">
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="${category}-filter-status" class="filter-select" onchange="filterCategoryComponents('${category}')">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="obsolete">Obsolete</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Package</label>
                            <input type="text" id="${category}-filter-package" class="filter-input" placeholder="e.g. 0603, SOT-23, TO-220..." onkeyup="filterCategoryComponents('${category}')">
                        </div>
                        <div class="filter-group">
                            <label>Mounting</label>
                            <select id="${category}-filter-mounting" class="filter-select" onchange="filterCategoryComponents('${category}')">
                                <option value="">All Mounting</option>
                                <option value="smd">SMD</option>
                                <option value="tht">Through Hole</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-warning btn-sm" onclick="clearCategoryFilters('${category}')">🔄 Clear</button>
                        </div>
                    </div>
                    <div class="active-filters"></div>
                    <div class="filter-stats">Ready to filter components</div>
                </div>
            `;
        }
        
        // Initialize category filters on page load
        function initializeCategoryFilters() {
            const categories = [
                { id: 'capacitors', name: 'Capacitors' }, // Include capacitors since it has manual filters
                { id: 'resistors', name: 'Resistors' },
                { id: 'inductors', name: 'Inductors' },
                { id: 'diodes', name: 'Diodes' },
                { id: 'transistors', name: 'Transistors' },
                { id: 'ics', name: 'ICs' },
                { id: 'connectors', name: 'Connectors' },
                { id: 'crystals', name: 'Crystals' },
                { id: 'fuses', name: 'Fuses' },
                { id: 'switches', name: 'Switches' },
                { id: 'relays', name: 'Relays' },
                { id: 'optocouplers', name: 'Optocouplers' },
                { id: 'sensors', name: 'Sensors' },
                { id: 'mechanical', name: 'Mechanical' },
                { id: 'hardware', name: 'Hardware' },
                { id: 'cables', name: 'Cables' }
            ];
            
            categories.forEach(category => {
                const categorySheet = document.getElementById(category.id);
                if (categorySheet) {
                    const actionButtons = categorySheet.querySelector('.action-buttons');
                    const table = categorySheet.querySelector('.component-table');
                    
                    if (actionButtons && table) {
                        // Add filters if not already present
                        if (!categorySheet.querySelector('.category-filters')) {
                            const filtersHTML = generateCategoryFilters(category.id, category.name);
                            actionButtons.insertAdjacentHTML('afterend', filtersHTML);
                        }
                        
                        // Make table headers sortable
                        makeSortableHeaders(category.id);
                    }
                }
            });
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            updateStats();
            initializeCategoryFilters(); // Add category filters to all pages
            initializeSystemManagement(); // Initialize system-first approach
            
            // Add event listeners
            document.getElementById('categorySelect').addEventListener('change', updateSubcategories);
            document.getElementById('subcategorySelect').addEventListener('change', generateKPNPreview);
            
            // Add Enter key support for search
            document.getElementById('globalSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchComponents();
                }
            });
            
            // Close modal when clicking outside
            document.getElementById('addComponentModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAddComponentModal();
                }
            });
            
            // Setup bulk import drag and drop
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        readCSVFile(files[0]);
                    }
                });
                
                uploadArea.addEventListener('click', function() {
                    document.getElementById('csvFileInput').click();
                });
            }
        });
        
        // Bulk Import Functionality
        let csvData = null;
        let parsedComponents = [];
        
        // File upload handlers
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                readCSVFile(file);
            }
        }
        
        function readCSVFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                csvData = e.target.result;
                parseCSV(csvData);
            };
            reader.readAsText(file);
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                alert('CSV file must contain at least a header row and one data row.');
                return;
            }
            
            // Parse header
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const dataRows = lines.slice(1).filter(line => line.trim() !== '');
            
            parsedComponents = [];
            let validCount = 0;
            let errorCount = 0;
            
            dataRows.forEach((line, index) => {
                if (line.trim() === '') return;
                
                const values = parseCSVLine(line);
                const component = {};
                
                // Map CSV columns to component properties (case-insensitive)
                headers.forEach((header, i) => {
                    const normalizedHeader = header.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const value = values[i] ? values[i].trim() : '';
                    
                    // Map common variations
                    switch (normalizedHeader) {
                        case 'value':
                        case 'componentvalue':
                        case 'partvalue':
                            component.value = value;
                            break;
                        case 'manufacturer':
                        case 'mfg':
                        case 'mfr':
                            component.manufacturer = value;
                            break;
                        case 'manufacturerpn':
                        case 'mfgpn':
                        case 'mfrpn':
                        case 'partnumber':
                        case 'mpn':
                            component.manufacturerPN = value;
                            break;
                        case 'package':
                        case 'footprint':
                        case 'case':
                            component.package = value;
                            break;
                        case 'description':
                        case 'desc':
                            component.description = value;
                            break;
                        case 'category':
                        case 'type':
                        case 'componenttype':
                            component.category = value.toLowerCase();
                            break;
                        case 'subcategory':
                        case 'subtype':
                            component.subcategory = value.toLowerCase();
                            break;
                        case 'voltage':
                        case 'voltagerating':
                        case 'vr':
                            component.voltage = value;
                            break;
                        case 'current':
                        case 'currentrating':
                        case 'ir':
                            component.current = value;
                            break;
                        case 'power':
                        case 'powerrating':
                        case 'pr':
                            component.power = value;
                            break;
                        case 'tolerance':
                        case 'tol':
                            component.tolerance = value;
                            break;
                        case 'mounting':
                        case 'mountingtype':
                            component.mounting = value;
                            break;
                        case 'temperature':
                        case 'temprange':
                        case 'temperaturerange':
                            component.temperature = value;
                            break;
                        case 'status':
                            component.status = value || 'Active';
                            break;
                        case 'notes':
                        case 'comments':
                            component.notes = value;
                            break;
                        case 'mouserpn':
                        case 'mouser':
                            component.mouserPN = value;
                            break;
                        case 'digikeypn':
                        case 'digikey':
                            component.digikeyPN = value;
                            break;
                        case 'cost':
                        case 'price':
                        case 'unitcost':
                            component.cost = value;
                            break;
                        case 'moq':
                        case 'minimumorderquantity':
                            component.moq = value;
                            break;
                    }
                });
                
                // Validate essential fields
                if (!component.value && !component.manufacturerPN) {
                    component.error = `Row ${index + 2}: Missing essential data (value or manufacturer PN)`;
                    errorCount++;
                } else {
                    validCount++;
                }
                
                component.rowNumber = index + 2;
                parsedComponents.push(component);
            });
            
            // Display parsing results
            displayParseResults(validCount, errorCount);
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(item => item.replace(/"/g, ''));
        }
        
        function displayParseResults(validCount, errorCount) {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">✅</div>
                <div class="upload-text">CSV Parsed Successfully!</div>
                <div class="upload-subtext">
                    Found ${validCount} valid components, ${errorCount} with errors
                </div>
                <button type="button" class="btn btn-info" onclick="resetImport()">📁 Choose Different File</button>
            `;
            
            document.getElementById('startImportBtn').disabled = validCount === 0;
            
            if (errorCount > 0) {
                const errorDetails = parsedComponents
                    .filter(comp => comp.error)
                    .map(comp => `<div class="result-error">⚠️ ${comp.error}</div>`)
                    .join('');
                
                document.getElementById('importResults').style.display = 'block';
                document.getElementById('resultSummary').innerHTML = `
                    <h4>Parsing Issues Found</h4>
                    <p>${errorCount} rows have issues that need attention:</p>
                    ${errorDetails}
                `;
            }
        }
        
        // Save component data to localStorage
        function saveComponentData() {
            try {
                localStorage.setItem('kinbenComponentData', JSON.stringify(componentData));
                console.log('Component data saved to localStorage');
            } catch (e) {
                console.error('Failed to save component data:', e);
            }
        }
        
        // Load component data from localStorage
        function loadComponentData() {
            try {
                const saved = localStorage.getItem('kinbenComponentData');
                if (saved) {
                    componentData = JSON.parse(saved);
                    console.log('Component data loaded from localStorage');
                }
            } catch (e) {
                console.warn('Failed to load component data from localStorage:', e);
            }
        }
        
        // Refresh all component category tables
        function refreshAllTables() {
            // Refresh all component category tables
            Object.keys(componentData).forEach(category => {
                refreshComponentTable(category);
            });
        }
        
        function startImport() {
            const validComponents = parsedComponents.filter(comp => !comp.error);
            if (validComponents.length === 0) {
                alert('No valid components to import.');
                return;
            }
            
            const skipDuplicates = document.getElementById('skipDuplicates').checked;
            const validateData = document.getElementById('validateData').checked;
            const defaultCategory = document.getElementById('defaultCategory').value;
            
            // Show progress bar
            document.getElementById('importProgress').style.display = 'block';
            document.getElementById('startImportBtn').disabled = true;
            
            let successCount = 0;
            let skipCount = 0;
            let errorCount = 0;
            const results = [];
            
            // Process components
            validComponents.forEach((component, index) => {
                try {
                    // Determine category
                    let category = component.category || defaultCategory;
                    if (!category && component.value) {
                        category = guessCategory(component.value, component.description);
                    }
                    
                    if (!category) {
                        throw new Error('Cannot determine component category');
                    }
                    
                    // Check for duplicates
                    if (skipDuplicates && component.manufacturerPN) {
                        const existing = findExistingComponent(component.manufacturerPN);
                        if (existing) {
                            skipCount++;
                            results.push({
                                type: 'skip',
                                message: `Row ${component.rowNumber}: Duplicate found - ${component.manufacturerPN}`,
                                component
                            });
                            return;
                        }
                    }
                    
                    // Generate KPN
                    const subcategory = component.subcategory || guessSubcategory(category, component);
                    const kpn = generateKPN(category, subcategory);
                    
                    // Create component object
                    const newComponent = {
                        kinbenPN: kpn,
                        value: component.value || '',
                        voltage: component.voltage || '',
                        current: component.current || '',
                        power: component.power || '',
                        tolerance: component.tolerance || '',
                        package: component.package || '',
                        mounting: component.mounting || '',
                        temperature: component.temperature || '',
                        manufacturer: component.manufacturer || '',
                        manufacturerPN: component.manufacturerPN || '',
                        description: component.description || '',
                        status: component.status || 'Active',
                        notes: component.notes || '',
                        mouserPN: component.mouserPN || '',
                        digikeyPN: component.digikeyPN || '',
                        cost: component.cost || '',
                        moq: component.moq || '',
                        createdDate: new Date().toISOString().split('T')[0],
                        createdBy: 'Bulk Import'
                    };
                    
                    // Add to category
                    if (!componentData[category]) {
                        componentData[category] = [];
                    }
                    componentData[category].push(newComponent);
                    
                    successCount++;
                    results.push({
                        type: 'success',
                        message: `Row ${component.rowNumber}: ${kpn} - ${component.manufacturerPN || component.value}`,
                        component: newComponent
                    });
                    
                } catch (error) {
                    errorCount++;
                    results.push({
                        type: 'error',
                        message: `Row ${component.rowNumber}: ${error.message}`,
                        component
                    });
                }
                
                // Update progress
                const progress = Math.round(((index + 1) / validComponents.length) * 100);
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = `${progress}% Complete`;
            });
            
            // Save data and refresh views
            saveComponentData();
            updateStats();
            refreshAllTables();
            
            // Display results
            displayImportResults(successCount, skipCount, errorCount, results);
        }
        
        function guessCategory(value, description) {
            const text = (value + ' ' + (description || '')).toLowerCase();
            
            if (text.includes('f') || text.includes('capacitor') || text.includes('cap')) {
                return 'capacitors';
            } else if (text.includes('ω') || text.includes('ohm') || text.includes('resistor') || text.includes('res')) {
                return 'resistors';
            } else if (text.includes('h') || text.includes('inductor') || text.includes('choke')) {
                return 'inductors';
            } else if (text.includes('diode') || text.includes('led')) {
                return 'diodes';
            } else if (text.includes('transistor') || text.includes('mosfet') || text.includes('bjt')) {
                return 'transistors';
            } else if (text.includes('ic') || text.includes('mcu') || text.includes('processor')) {
                return 'ics';
            } else if (text.includes('connector') || text.includes('header') || text.includes('socket')) {
                return 'connectors';
            } else if (text.includes('crystal') || text.includes('oscillator') || text.includes('xtal')) {
                return 'crystals';
            }
            
            return null;
        }
        
        function guessSubcategory(category, component) {
            const text = (component.value + ' ' + (component.description || '')).toLowerCase();
            
            switch (category) {
                case 'capacitors':
                    if (text.includes('ceramic') || text.includes('mlcc')) return 'cer';
                    if (text.includes('electrolytic') || text.includes('elco')) return 'elc';
                    if (text.includes('tantalum')) return 'tan';
                    return 'cer'; // default to ceramic
                case 'resistors':
                    if (text.includes('current sense') || text.includes('shunt')) return 'csr';
                    if (text.includes('precision')) return 'prc';
                    return 'chr'; // default to chip resistor
                case 'diodes':
                    if (text.includes('led')) return 'led';
                    if (text.includes('zener')) return 'zen';
                    if (text.includes('schottky')) return 'sch';
                    return 'swt'; // default to switching
                default:
                    return 'std'; // default subcategory
            }
        }
        
        function findExistingComponent(manufacturerPN) {
            for (const category in componentData) {
                const components = componentData[category];
                for (const component of components) {
                    if (component.manufacturerPN === manufacturerPN) {
                        return component;
                    }
                }
            }
            return null;
        }
        
        function displayImportResults(successCount, skipCount, errorCount, results) {
            document.getElementById('importResults').style.display = 'block';
            
            const summary = document.getElementById('resultSummary');
            summary.innerHTML = `
                <h4>Import Complete!</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number result-success">${successCount}</div>
                        <div class="stat-label">Successfully Imported</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number result-warning">${skipCount}</div>
                        <div class="stat-label">Skipped (Duplicates)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number result-error">${errorCount}</div>
                        <div class="stat-label">Failed with Errors</div>
                    </div>
                </div>
            `;
            
            const details = document.getElementById('resultDetails');
            const resultHtml = results.map(result => {
                const className = result.type === 'success' ? 'result-success' : 
                                result.type === 'skip' ? 'result-warning' : 'result-error';
                const icon = result.type === 'success' ? '✅' : 
                           result.type === 'skip' ? '⚠️' : '❌';
                return `<div class="result-item ${className}">${icon} ${result.message}</div>`;
            }).join('');
            
            details.innerHTML = `<h5>Detailed Results:</h5>${resultHtml}`;
            
            document.getElementById('startImportBtn').disabled = false;
        }
        
        function resetImport() {
            csvData = null;
            parsedComponents = [];
            
            // Clear the file input value to reset the file selection
            const fileInput = document.getElementById('csvFileInput');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Reset upload area visual state without recreating the file input
            const uploadArea = document.getElementById('uploadArea');
            const uploadIcon = uploadArea.querySelector('.upload-icon');
            const uploadText = uploadArea.querySelector('.upload-text');
            const uploadSubtext = uploadArea.querySelector('.upload-subtext');
            
            if (uploadIcon) uploadIcon.textContent = '📁';
            if (uploadText) uploadText.textContent = 'Drag and drop your CSV file here';
            if (uploadSubtext) uploadSubtext.textContent = 'or click to browse files';
            
            // Reset UI elements
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importResults').style.display = 'none';
            document.getElementById('startImportBtn').disabled = true;
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0% Complete';
        }
        
        function downloadSampleCSV() {
            const sampleData = [
                ['Value', 'Manufacturer', 'Manufacturer_PN', 'Package', 'Description', 'Category', 'Voltage', 'Tolerance', 'Notes'],
                ['100nF', 'Murata', 'GRM188R71H104KA93D', '0603', '100nF 50V X7R Ceramic Capacitor', 'capacitors', '50V', '10%', 'General purpose'],
                ['1kΩ', 'Vishay', 'CRCW06031K00FKEA', '0603', '1kΩ 100mW Thick Film Resistor', 'resistors', '', '1%', 'Precision'],
                ['10µH', 'Bourns', 'SRR1260-100M', '1260', '10µH 3.3A Power Inductor', 'inductors', '', '20%', 'Power application']
            ];
            
            const csvContent = sampleData.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_components.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</head>
<body>
    <div class="workbook-container">
        <div class="sheet-tabs">
            <div class="tab active" onclick="showSheet('landing')">📊 Dashboard</div>
            <div class="tab" onclick="showSheet('systems')" style="border-left: 3px solid #28a745;">🏗️ SYSTEMS</div>
            <div class="tab" onclick="showSheet('assemblies')" style="border-left: 3px solid #28a745;">🔧 ASSEMBLIES</div>
            <div class="tab" onclick="showSheet('pcbs')" style="border-left: 3px solid #28a745;">🟩 PCBs</div>
            <div class="tab" onclick="showSheet('3d-parts')" style="border-left: 3px solid #28a745;">🖨️ 3D PARTS</div>
            <div class="tab" onclick="showSheet('cable-assemblies')" style="border-left: 3px solid #28a745;">🔗 CABLE ASSY</div>
            <div class="tab" onclick="showSheet('add-component')">➕ Add Component</div>
            <div class="tab" onclick="showSheet('bulk-import')">📥 Bulk Import</div>
            <div class="tab" onclick="showSheet('capacitors')">🔋 CAPACITORS</div>
            <div class="tab" onclick="showSheet('resistors')">⚡ RESISTORS</div>
            <div class="tab" onclick="showSheet('inductors')">🌀 INDUCTORS</div>
            <div class="tab" onclick="showSheet('diodes')">💡 DIODES</div>
            <div class="tab" onclick="showSheet('transistors')">🔧 TRANSISTORS</div>
            <div class="tab" onclick="showSheet('ics')">🖥️ ICs</div>
            <div class="tab" onclick="showSheet('connectors')">🔌 CONNECTORS</div>
            <div class="tab" onclick="showSheet('crystals')">🔮 CRYSTALS</div>
            <div class="tab" onclick="showSheet('fuses')">🛡️ FUSES</div>
            <div class="tab" onclick="showSheet('switches')">🔘 SWITCHES</div>
            <div class="tab" onclick="showSheet('relays')">🔄 RELAYS</div>
            <div class="tab" onclick="showSheet('optocouplers')">💡 OPTOCOUPLERS</div>
            <div class="tab" onclick="showSheet('sensors')">📡 SENSORS</div>
            <div class="tab" onclick="showSheet('mechanical')">⚙️ MECHANICAL</div>
            <div class="tab" onclick="showSheet('hardware')">🔩 HARDWARE</div>
            <div class="tab" onclick="showSheet('cables')">🔌 CABLES</div>
        </div>

        <!-- Enhanced Dashboard -->
        <div id="landing" class="sheet active">
            <div class="landing-page">
                <div class="landing-title">🏗️ Kinben System Manager</div>
                <div class="landing-subtitle">Multi-Level System & Multiboard Management Platform</div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-components">0</div>
                        <div class="stat-label">Total Components</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-categories">0</div>
                        <div class="stat-label">Active Categories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-categories">16</div>
                        <div class="stat-label">Total Categories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-systems">0</div>
                        <div class="stat-label">🏗️ Systems</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-assemblies">0</div>
                        <div class="stat-label">🔧 Assemblies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-multiboard">0</div>
                        <div class="stat-label">📋 Multiboard Projects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">📈</div>
                        <div class="stat-label">Growing Daily</div>
                    </div>
                </div>
                
                <div class="section-header" style="background: #28a745; color: white; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 18px; font-weight: bold; text-align: center;">🏗️ System Management - Multiboard Ordering</div>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="showSheet('systems')">🏗️ Manage Systems</button>
                    <button class="btn btn-primary" onclick="showSheet('assemblies')">🔧 Manage Assemblies</button>
                    <button class="btn btn-info" onclick="openAddSystemModal('systems')">➕ Create New System</button>
                    <button class="btn btn-warning" onclick="openMultiboardWizard()">📋 Multiboard Project Wizard</button>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showSheet('add-component')">➕ Add Component</button>
                    <button class="btn btn-success" onclick="exportData('csv')">📄 Export All CSV</button>
                    <button class="btn btn-info" onclick="exportData('json')">📊 Export JSON</button>
                    <button class="btn btn-warning" onclick="document.getElementById('globalSearch').focus()">🔍 Advanced Search</button>
                </div>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h3>📋 System Purpose</h3>
                        <p>Centralized management of Kinben Part Numbers (KPNs) with standardized naming conventions, component specifications, and library references.</p>
                    </div>
                    <div class="info-card">
                        <h3>🎯 New Features</h3>
                        <ul>
                            <li>✅ Interactive component addition</li>
                            <li>✅ Real-time statistics</li>
                            <li>✅ Export functionality</li>
                            <li>✅ Auto KPN generation</li>
                            <li>✅ Mobile responsive design</li>
                        </ul>
                    </div>
                </div>
                
                <div class="naming-convention">
                    <h3>🏷️ KPN Naming Convention</h3>
                    <p><strong>Format:</strong> KPN-[CATEGORY]-[SUBCATEGORY]-[SEQUENCE]</p>
                    <p><strong>Example:</strong> KPN-CAP-CER-00001 (Ceramic Capacitor #1)</p>
                </div>
            </div>
            
            <!-- Global Search -->
            <div class="search-controls">
                <input type="text" id="globalSearch" class="search-input" placeholder="Search all components...">
                <select id="categoryFilter" class="filter-select">
                    <option value="">All Categories</option>
                    <option value="capacitors">Capacitors</option>
                    <option value="resistors">Resistors</option>
                    <option value="inductors">Inductors</option>
                    <option value="diodes">Diodes</option>
                    <option value="transistors">Transistors</option>
                    <option value="ics">Integrated Circuits</option>
                    <option value="connectors">Connectors</option>
                    <option value="crystals">Crystals & Oscillators</option>
                    <option value="fuses">Fuses</option>
                    <option value="switches">Switches</option>
                    <option value="relays">Relays</option>
                    <option value="optocouplers">Optocouplers</option>
                    <option value="sensors">Sensors</option>
                    <option value="mechanical">Mechanical</option>
                    <option value="hardware">Hardware</option>
                    <option value="cables">Cables & Wires</option>
                </select>
                <button class="btn btn-primary" onclick="searchComponents()">🔍 Search</button>
            </div>
            
            <div class="section-header">📊 Component Categories</div>
            <table class="category-table">
                <tr>
                    <th>Category Code</th>
                    <th>Category Name</th>
                    <th>Subcategories</th>
                    <th>Total Parts</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                <tr data-category="capacitors">
                    <td>CAP</td><td>Capacitors</td><td>CER, ELE, TAN, FIL</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('capacitors')">Add</button></td>
                </tr>
                <tr data-category="resistors">
                    <td>RES</td><td>Resistors</td><td>STD, PRE, VAR, NET</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('resistors')">Add</button></td>
                </tr>
                <tr data-category="inductors">
                    <td>IND</td><td>Inductors</td><td>PWR, CHK, FER</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('inductors')">Add</button></td>
                </tr>
                <tr data-category="diodes">
                    <td>DIO</td><td>Diodes</td><td>STD, LED, ZEN, SCH</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('diodes')">Add</button></td>
                </tr>
                <tr data-category="transistors">
                    <td>TRA</td><td>Transistors</td><td>BJT, FET, MOS</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('transistors')">Add</button></td>
                </tr>
                <tr data-category="ics">
                    <td>IC</td><td>Integrated Circuits</td><td>MCU, ANA, DIG, PWR</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('ics')">Add</button></td>
                </tr>
                <tr data-category="connectors">
                    <td>CON</td><td>Connectors</td><td>HDR, JST, USB, RJ45</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('connectors')">Add</button></td>
                </tr>
                <tr data-category="crystals">
                    <td>CRY</td><td>Crystals & Oscillators</td><td>XTL, OSC, RES</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('crystals')">Add</button></td>
                </tr>
                <tr data-category="fuses">
                    <td>FUS</td><td>Fuses</td><td>STD, RST, PTC</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('fuses')">Add</button></td>
                </tr>
                <tr data-category="switches">
                    <td>SWI</td><td>Switches</td><td>TAC, DIP, ROT, SLI</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('switches')">Add</button></td>
                </tr>
                <tr data-category="relays">
                    <td>REL</td><td>Relays</td><td>EMR, SSR</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('relays')">Add</button></td>
                </tr>
                <tr data-category="optocouplers">
                    <td>OPT</td><td>Optocouplers</td><td>STD, HIS, DAR</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('optocouplers')">Add</button></td>
                </tr>
                <tr data-category="sensors">
                    <td>SEN</td><td>Sensors</td><td>TMP, PRE, ACC, GYR</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('sensors')">Add</button></td>
                </tr>
                <tr data-category="mechanical">
                    <td>MEC</td><td>Mechanical</td><td>ENC, FAN, HEA, SPK</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('mechanical')">Add</button></td>
                </tr>
                <tr data-category="hardware">
                    <td>HWR</td><td>Hardware</td><td>SCR, NUT, WSH, SPC</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('hardware')">Add</button></td>
                </tr>
                <tr data-category="cables">
                    <td>CBL</td><td>Cables & Wires</td><td>PWR, SIG, COA, FFC</td>
                    <td class="count-cell">0</td><td class="status-active">ACTIVE</td>
                    <td><button class="btn btn-primary" onclick="openAddComponentModal('cables')">Add</button></td>
                </tr>
            </table>
        </div>

        <!-- Add Component Sheet -->
        <div id="add-component" class="sheet">
            <div class="section-header">➕ Add New Component</div>
            <div class="add-component-form">
                <h3>Component Information</h3>
                <form id="addComponentForm" onsubmit="event.preventDefault(); addComponent();">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="categorySelect">Category *</label>
                            <select id="categorySelect" name="category" required>
                                <option value="">Select Category</option>
                                <option value="capacitors">Capacitors</option>
                                <option value="resistors">Resistors</option>
                                <option value="inductors">Inductors</option>
                                <option value="diodes">Diodes</option>
                                <option value="transistors">Transistors</option>
                                <option value="ics">Integrated Circuits</option>
                                <option value="connectors">Connectors</option>
                                <option value="crystals">Crystals & Oscillators</option>
                                <option value="fuses">Fuses</option>
                                <option value="switches">Switches</option>
                                <option value="relays">Relays</option>
                                <option value="optocouplers">Optocouplers</option>
                                <option value="sensors">Sensors</option>
                                <option value="mechanical">Mechanical</option>
                                <option value="hardware">Hardware</option>
                                <option value="cables">Cables & Wires</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="subcategorySelect">Subcategory *</label>
                            <select id="subcategorySelect" name="subcategory" required>
                                <option value="">Select Subcategory</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="kinbenPN">Kinben PN (Auto-generated)</label>
                            <input type="text" id="kinbenPN" name="kinbenPN" readonly style="background: #f0f0f0;">
                            <small id="kpnPreview" style="color: #666;">Select category and subcategory</small>
                        </div>
                        <div class="form-group">
                            <label for="value">Value</label>
                            <input type="text" id="value" name="value" placeholder="e.g., 100nF, 1kΩ, 10µH">
                        </div>
                        <div class="form-group">
                            <label for="voltage">Voltage Rating</label>
                            <input type="text" id="voltage" name="voltage" placeholder="e.g., 50V, 3.3V">
                        </div>
                        <div class="form-group">
                            <label for="current">Current Rating</label>
                            <input type="text" id="current" name="current" placeholder="e.g., 1A, 500mA">
                        </div>
                        <div class="form-group">
                            <label for="power">Power Rating</label>
                            <input type="text" id="power" name="power" placeholder="e.g., 0.25W, 1W">
                        </div>
                        <div class="form-group">
                            <label for="tolerance">Tolerance</label>
                            <input type="text" id="tolerance" name="tolerance" placeholder="e.g., ±5%, ±1%">
                        </div>
                        <div class="form-group">
                            <label for="package">Package</label>
                            <input type="text" id="package" name="package" placeholder="e.g., 0603, SOIC-8, TO-220">
                        </div>
                        <div class="form-group">
                            <label for="mounting">Mounting</label>
                            <select id="mounting" name="mounting">
                                <option value="">Select</option>
                                <option value="SMD">SMD</option>
                                <option value="THT">Through Hole</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="temperature">Temperature Range</label>
                            <input type="text" id="temperature" name="temperature" placeholder="e.g., -40°C to +85°C">
                        </div>
                        <div class="form-group">
                            <label for="manufacturer">Manufacturer</label>
                            <input type="text" id="manufacturer" name="manufacturer" placeholder="e.g., Murata, TI, Vishay">
                        </div>
                        <div class="form-group">
                            <label for="manufacturerPN">Manufacturer PN</label>
                            <input type="text" id="manufacturerPN" name="manufacturerPN" placeholder="Manufacturer part number">
                        </div>
                        <div class="form-group">
                            <label for="supplier">Preferred Supplier</label>
                            <select id="supplier" name="supplier">
                                <option value="">Select</option>
                                <option value="Mouser">Mouser</option>
                                <option value="DigiKey">DigiKey</option>
                                <option value="FIDES">FIDES</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mouserPN">Mouser PN</label>
                            <input type="text" id="mouserPN" name="mouserPN" placeholder="Mouser part number">
                        </div>
                        <div class="form-group">
                            <label for="digikeyPN">DigiKey PN</label>
                            <input type="text" id="digikeyPN" name="digikeyPN" placeholder="DigiKey part number">
                        </div>
                        <div class="form-group">
                            <label for="cost">Unit Cost (USD)</label>
                            <input type="number" id="cost" name="cost" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="moq">MOQ</label>
                            <input type="number" id="moq" name="moq" placeholder="Minimum order quantity">
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" name="status">
                                <option value="Active">Active</option>
                                <option value="Pending">Pending</option>
                                <option value="Obsolete">Obsolete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="symbolFile">Symbol File</label>
                            <input type="text" id="symbolFile" name="symbolFile" placeholder="KiCad symbol filename">
                        </div>
                        <div class="form-group">
                            <label for="footprintFile">Footprint File</label>
                            <input type="text" id="footprintFile" name="footprintFile" placeholder="KiCad footprint filename">
                        </div>
                        <div class="form-group">
                            <label for="modelFile">3D Model File</label>
                            <input type="text" id="modelFile" name="modelFile" placeholder="3D model filename">
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" placeholder="Detailed component description"></textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" placeholder="Additional notes, special requirements, etc."></textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-success">✅ Add Component</button>
                        <button type="reset" class="btn btn-warning">🔄 Reset Form</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bulk Import Sheet -->
        <div id="bulk-import" class="sheet">
            <div class="section-header">📥 Bulk Import Components</div>
            <div class="bulk-import-container">
                <h3>Import Components from CSV File</h3>
                <p>Upload a CSV file containing component data. The system will automatically map fields and generate KPN numbers.</p>
                
                <!-- File Upload Area -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">Drag and drop your CSV file here</div>
                    <div class="upload-subtext">or click to browse files</div>
                    <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileSelect(event)">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">📁 Choose File</button>
                </div>

                <!-- Import Options -->
                <div class="import-options">
                    <div class="import-option">
                        <h4>🎯 Import Settings</h4>
                        <div class="form-group">
                            <label>Default Category (if not specified in CSV)</label>
                            <select id="defaultCategory">
                                <option value="">Detect from data</option>
                                <option value="capacitors">Capacitors</option>
                                <option value="resistors">Resistors</option>
                                <option value="inductors">Inductors</option>
                                <option value="diodes">Diodes</option>
                                <option value="transistors">Transistors</option>
                                <option value="ics">Integrated Circuits</option>
                                <option value="connectors">Connectors</option>
                                <option value="crystals">Crystals & Oscillators</option>
                                <option value="fuses">Fuses</option>
                                <option value="switches">Switches</option>
                                <option value="relays">Relays</option>
                                <option value="optocouplers">Optocouplers</option>
                                <option value="sensors">Sensors</option>
                                <option value="mechanical">Mechanical</option>
                                <option value="hardware">Hardware</option>
                                <option value="cables">Cables & Wires</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="skipDuplicates" checked>
                                Skip duplicate components (match by Manufacturer PN)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="validateData" checked>
                                Validate all data before import
                            </label>
                        </div>
                    </div>

                    <div class="import-option">
                        <h4>📋 Expected CSV Format</h4>
                        <p>The CSV file should contain the following columns (case-insensitive):</p>
                        <ul style="font-size: 13px; line-height: 1.6;">
                            <li><strong>Value:</strong> Component value (e.g., 100nF, 1kΩ)</li>
                            <li><strong>Manufacturer:</strong> Component manufacturer</li>
                            <li><strong>Manufacturer_PN:</strong> Manufacturer part number</li>
                            <li><strong>Package:</strong> Component package (e.g., 0603, SOT-23)</li>
                            <li><strong>Description:</strong> Component description</li>
                            <li><strong>Category:</strong> Component category (optional)</li>
                            <li><strong>Subcategory:</strong> Component subcategory (optional)</li>
                        </ul>
                        <p><strong>Note:</strong> KPN numbers will be auto-generated during import.</p>
                    </div>
                </div>

                <!-- Import Progress -->
                <div class="import-progress" id="importProgress">
                    <h4>Import Progress</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0% Complete</div>
                </div>

                <!-- Import Results -->
                <div class="import-results" id="importResults">
                    <div class="result-summary" id="resultSummary">
                        <!-- Summary will be populated here -->
                    </div>
                    <div id="resultDetails">
                        <!-- Detailed results will be populated here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-success" id="startImportBtn" onclick="startImport()" disabled>🚀 Start Import</button>
                    <button type="button" class="btn btn-warning" onclick="resetImport()">🔄 Reset</button>
                    <button type="button" class="btn btn-info" onclick="downloadSampleCSV()">📥 Download Sample CSV</button>
                </div>
            </div>
        </div>

        <!-- Component Category Sheets (Enhanced) -->
        <div id="capacitors" class="sheet">
            <div class="section-header">🔋 CAPACITORS - Category Code: CAP</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('capacitors')">➕ Add Capacitor</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'capacitors')">📄 Export CSV</button>
                <button class="btn btn-info export-button" onclick="exportData('json', 'capacitors')">📊 Export JSON</button>
            </div>
            
            <!-- Category Filters -->
            <div class="category-filters">
                <h4>🔍 Filter Capacitors</h4>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="capacitors-filter-search" class="filter-input" placeholder="Search capacitors..." onkeyup="filterCategoryComponents('capacitors')">
                    </div>
                    <div class="filter-group">
                        <label>Manufacturer</label>
                        <input type="text" id="capacitors-filter-manufacturer" class="filter-input" placeholder="e.g. Murata, Samsung..." onkeyup="filterCategoryComponents('capacitors')">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="capacitors-filter-status" class="filter-select" onchange="filterCategoryComponents('capacitors')">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="obsolete">Obsolete</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Package</label>
                        <input type="text" id="capacitors-filter-package" class="filter-input" placeholder="e.g. 0603, 0805..." onkeyup="filterCategoryComponents('capacitors')">
                    </div>
                    <div class="filter-group">
                        <label>Mounting</label>
                        <select id="capacitors-filter-mounting" class="filter-select" onchange="filterCategoryComponents('capacitors')">
                            <option value="">All Mounting</option>
                            <option value="smd">SMD</option>
                            <option value="tht">Through Hole</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-warning btn-sm" onclick="clearCategoryFilters('capacitors')">🔄 Clear</button>
                    </div>
                </div>
                <div class="active-filters"></div>
                <div class="filter-stats">Ready to filter components</div>
            </div>
            <table class="component-table">
                <thead>
                    <tr>
                        <th>Kinben PN</th><th>Value</th><th>Voltage Rating</th><th>Tolerance</th><th>Package</th>
                        <th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th>
                        <th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th>
                        <th>Unit Cost</th><th>MOQ</th><th>Status</th><th>Symbol File</th><th>Footprint File</th>
                        <th>3D Model File</th><th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Capacitor" to get started!</td></tr>
                </tbody>
            </table>
        </div>

        <div id="resistors" class="sheet">
            <div class="section-header">⚡ RESISTORS - Category Code: RES</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('resistors')">➕ Add Resistor</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'resistors')">📄 Export CSV</button>
                <button class="btn btn-info export-button" onclick="exportData('json', 'resistors')">📊 Export JSON</button>
            </div>
            <table class="component-table">
                <thead>
                    <tr>
                        <th>Kinben PN</th><th>Value</th><th>Power Rating</th><th>Tolerance</th><th>Package</th>
                        <th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th>
                        <th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th>
                        <th>Unit Cost</th><th>MOQ</th><th>Status</th><th>Symbol File</th><th>Footprint File</th>
                        <th>3D Model File</th><th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Resistor" to get started!</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Add similar structure for other categories -->
        <div id="inductors" class="sheet">
            <div class="section-header">🌀 INDUCTORS - Category Code: IND</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('inductors')">➕ Add Inductor</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'inductors')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Value</th><th>Current Rating</th><th>DCR</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>MOQ</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Inductor" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="diodes" class="sheet">
            <div class="section-header">💡 DIODES - Category Code: DIO</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('diodes')">➕ Add Diode</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'diodes')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>Voltage Rating</th><th>Current Rating</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>MOQ</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Diode" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="transistors" class="sheet">
            <div class="section-header">🔧 TRANSISTORS - Category Code: TRA</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('transistors')">➕ Add Transistor</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'transistors')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>Voltage Rating</th><th>Current Rating</th><th>Power Rating</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Transistor" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="ics" class="sheet">
            <div class="section-header">🖥️ INTEGRATED CIRCUITS - Category Code: IC</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('ics')">➕ Add IC</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'ics')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>Voltage Rating</th><th>Current Rating</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Pin Count</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add IC" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="connectors" class="sheet">
            <div class="section-header">🔌 CONNECTORS - Category Code: CON</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('connectors')">➕ Add Connector</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'connectors')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>Positions</th><th>Current Rating</th><th>Voltage Rating</th><th>Pitch</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Connector" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="crystals" class="sheet">
            <div class="section-header">🔮 CRYSTALS & OSCILLATORS - Category Code: CRY</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('crystals')">➕ Add Crystal/Oscillator</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'crystals')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Frequency</th><th>Tolerance</th><th>Load Capacitance</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>MOQ</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Crystal/Oscillator" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="fuses" class="sheet">
            <div class="section-header">🛡️ FUSES - Category Code: FUS</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('fuses')">➕ Add Fuse</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'fuses')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Current Rating</th><th>Voltage Rating</th><th>Type</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>MOQ</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Fuse" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="switches" class="sheet">
            <div class="section-header">🔘 SWITCHES - Category Code: SWI</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('switches')">➕ Add Switch</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'switches')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>Current Rating</th><th>Voltage Rating</th><th>Actuator Type</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Switch" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="relays" class="sheet">
            <div class="section-header">🔄 RELAYS - Category Code: REL</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('relays')">➕ Add Relay</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'relays')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>Coil Voltage</th><th>Contact Rating</th><th>Contact Config</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Relay" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="optocouplers" class="sheet">
            <div class="section-header">💡 OPTOCOUPLERS - Category Code: OPT</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('optocouplers')">➕ Add Optocoupler</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'optocouplers')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>CTR</th><th>Isolation Voltage</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>MOQ</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Optocoupler" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="sensors" class="sheet">
            <div class="section-header">📡 SENSORS - Category Code: SEN</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('sensors')">➕ Add Sensor</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'sensors')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>Range</th><th>Accuracy</th><th>Supply Voltage</th><th>Package</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Sensor" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="mechanical" class="sheet">
            <div class="section-header">⚙️ MECHANICAL - Category Code: MEC</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('mechanical')">➕ Add Mechanical Component</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'mechanical')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>Specifications</th><th>Material</th><th>Dimensions</th><th>Mounting</th><th>Temperature Range</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>MOQ</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Mechanical Component" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="hardware" class="sheet">
            <div class="section-header">🔩 HARDWARE - Category Code: HWR</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('hardware')">➕ Add Hardware</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'hardware')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>Size</th><th>Material</th><th>Finish</th><th>Thread Type</th><th>Length</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>MOQ</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Hardware" to get started!</td></tr></tbody>
            </table>
        </div>

        <div id="cables" class="sheet">
            <div class="section-header">🔌 CABLES & WIRES - Category Code: CBL</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddComponentModal('cables')">➕ Add Cable/Wire</button>
                <button class="btn btn-success export-button" onclick="exportData('csv', 'cables')">📄 Export CSV</button>
            </div>
            <table class="component-table">
                <thead><tr><th>Kinben PN</th><th>Type</th><th>AWG/Size</th><th>Length</th><th>Connector A</th><th>Connector B</th><th>Shielding</th><th>Color</th><th>Manufacturer</th><th>Manufacturer PN</th><th>Description</th><th>Preferred Supplier</th><th>Mouser PN</th><th>DigiKey PN</th><th>Unit Cost</th><th>Status</th><th>Symbol File</th><th>Footprint File</th><th>3D Model File</th><th>Notes</th></tr></thead>
                <tbody><tr><td colspan="20" style="text-align: center; color: #666; padding: 20px;">No components added yet. Click "Add Cable/Wire" to get started!</td></tr></tbody>
            </table>
        </div>

        <!-- Search Results Sheet -->
        <div id="search-results" class="sheet">
            <div class="section-header">🔍 Search Results</div>
            <div class="search-results-header">
                <div class="search-results-info">
                    <h3>Found <span id="search-results-count">0</span> results for "<span id="search-term-display">-</span>"</h3>
                </div>
                <div class="search-results-actions">
                    <button class="btn btn-success" onclick="exportData('csv', null)" title="Export search results">📄 Export CSV</button>
                    <button class="btn btn-warning" onclick="clearSearch()">🔄 New Search</button>
                    <button class="btn btn-primary" onclick="showSheet('landing')">📊 Back to Dashboard</button>
                </div>
            </div>
            
            <table class="search-results-table">
                <thead>
                    <tr>
                        <th>Kinben PN</th>
                        <th>Category</th>
                        <th>Value</th>
                        <th>Manufacturer</th>
                        <th>Manufacturer PN</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="8" style="text-align: center; color: #666; padding: 20px;">Use the search function above to find components across all categories.</td></tr>
                </tbody>
            </table>
        </div>

        <!-- SYSTEMS Management Sheet -->
        <div id="systems" class="sheet">
            <div class="section-header">🏗️ SYSTEMS - Complete Products & Projects (SKN)</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddSystemModal('systems')">➕ Add System</button>
                <button class="btn btn-success export-button" onclick="exportSystemData('csv', 'systems')">📄 Export CSV</button>
                <button class="btn btn-info export-button" onclick="exportSystemData('json', 'systems')">📄 Export JSON</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="systems-count">0</div>
                    <div class="stat-label">Total Systems</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="systems-active">0</div>
                    <div class="stat-label">Active Systems</div>
                </div>
            </div>
            <table class="component-table">
                <thead>
                    <tr>
                        <th class="sortable-header" onclick="sortSystemTable('systems', 'systemKN')">System KN</th>
                        <th class="sortable-header" onclick="sortSystemTable('systems', 'name')">System Name</th>
                        <th class="sortable-header" onclick="sortSystemTable('systems', 'version')">Version</th>
                        <th class="sortable-header" onclick="sortSystemTable('systems', 'type')">Type</th>
                        <th class="sortable-header" onclick="sortSystemTable('systems', 'status')">Status</th>
                        <th class="sortable-header" onclick="sortSystemTable('systems', 'assemblies')">Assemblies</th>
                        <th class="sortable-header" onclick="sortSystemTable('systems', 'description')">Description</th>
                        <th class="sortable-header" onclick="sortSystemTable('systems', 'owner')">Owner</th>
                        <th>Documentation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="10" style="text-align: center; color: #666; padding: 20px;">No systems added yet. Click "Add System" to get started!</td></tr>
                </tbody>
            </table>
        </div>

        <!-- ASSEMBLIES Management Sheet -->
        <div id="assemblies" class="sheet">
            <div class="section-header">🔧 ASSEMBLIES - PCBAs & Mechanical Assemblies (AKN)</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddSystemModal('assemblies')">➕ Add Assembly</button>
                <button class="btn btn-success export-button" onclick="exportSystemData('csv', 'assemblies')">📄 Export CSV</button>
                <button class="btn btn-info export-button" onclick="exportSystemData('json', 'assemblies')">📄 Export JSON</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="assemblies-count">0</div>
                    <div class="stat-label">Total Assemblies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="assemblies-active">0</div>
                    <div class="stat-label">Active Assemblies</div>
                </div>
            </div>
            <table class="component-table">
                <thead>
                    <tr>
                        <th class="sortable-header" onclick="sortSystemTable('assemblies', 'assemblyKN')">Assembly KN</th>
                        <th class="sortable-header" onclick="sortSystemTable('assemblies', 'name')">Assembly Name</th>
                        <th class="sortable-header" onclick="sortSystemTable('assemblies', 'type')">Type</th>
                        <th class="sortable-header" onclick="sortSystemTable('assemblies', 'version')">Version</th>
                        <th class="sortable-header" onclick="sortSystemTable('assemblies', 'status')">Status</th>
                        <th class="sortable-header" onclick="sortSystemTable('assemblies', 'components')">Components</th>
                        <th class="sortable-header" onclick="sortSystemTable('assemblies', 'description')">Description</th>
                        <th>Files</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9" style="text-align: center; color: #666; padding: 20px;">No assemblies added yet. Click "Add Assembly" to get started!</td></tr>
                </tbody>
            </table>
        </div>

        <!-- PCBs Management Sheet -->
        <div id="pcbs" class="sheet">
            <div class="section-header">🟩 PRINTED CIRCUIT BOARDS - Blank PCBs & PCBAs (PKN)</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddSystemModal('pcbs')">➕ Add PCB</button>
                <button class="btn btn-success export-button" onclick="exportSystemData('csv', 'pcbs')">📄 Export CSV</button>
                <button class="btn btn-info export-button" onclick="exportSystemData('json', 'pcbs')">📄 Export JSON</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="pcbs-count">0</div>
                    <div class="stat-label">Total PCBs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pcbs-active">0</div>
                    <div class="stat-label">Active PCBs</div>
                </div>
            </div>
            <table class="component-table">
                <thead>
                    <tr>
                        <th class="sortable-header" onclick="sortSystemTable('pcbs', 'partKN')">PCB KN</th>
                        <th class="sortable-header" onclick="sortSystemTable('pcbs', 'name')">PCB Name</th>
                        <th class="sortable-header" onclick="sortSystemTable('pcbs', 'type')">Type</th>
                        <th class="sortable-header" onclick="sortSystemTable('pcbs', 'layers')">Layers</th>
                        <th class="sortable-header" onclick="sortSystemTable('pcbs', 'size')">Size (mm)</th>
                        <th class="sortable-header" onclick="sortSystemTable('pcbs', 'thickness')">Thickness</th>
                        <th class="sortable-header" onclick="sortSystemTable('pcbs', 'status')">Status</th>
                        <th class="sortable-header" onclick="sortSystemTable('pcbs', 'version')">Version</th>
                        <th class="sortable-header" onclick="sortSystemTable('pcbs', 'description')">Description</th>
                        <th>Files</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="11" style="text-align: center; color: #666; padding: 20px;">No PCBs added yet. Click "Add PCB" to get started!</td></tr>
                </tbody>
            </table>
        </div>

        <!-- 3D PARTS Management Sheet -->
        <div id="3d-parts" class="sheet">
            <div class="section-header">🖨️ 3D PRINTED PARTS - Custom 3D Components (3PN)</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddSystemModal('3d-parts')">➕ Add 3D Part</button>
                <button class="btn btn-success export-button" onclick="exportSystemData('csv', '3d-parts')">📄 Export CSV</button>
                <button class="btn btn-info export-button" onclick="exportSystemData('json', '3d-parts')">📄 Export JSON</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="3d-parts-count">0</div>
                    <div class="stat-label">Total 3D Parts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="3d-parts-active">0</div>
                    <div class="stat-label">Active 3D Parts</div>
                </div>
            </div>
            <table class="component-table">
                <thead>
                    <tr>
                        <th class="sortable-header" onclick="sortSystemTable('3d-parts', 'partKN')">3D Part KN</th>
                        <th class="sortable-header" onclick="sortSystemTable('3d-parts', 'name')">Part Name</th>
                        <th class="sortable-header" onclick="sortSystemTable('3d-parts', 'type')">Type</th>
                        <th class="sortable-header" onclick="sortSystemTable('3d-parts', 'material')">Material</th>
                        <th class="sortable-header" onclick="sortSystemTable('3d-parts', 'status')">Status</th>
                        <th class="sortable-header" onclick="sortSystemTable('3d-parts', 'version')">Version</th>
                        <th class="sortable-header" onclick="sortSystemTable('3d-parts', 'description')">Description</th>
                        <th>STL/CAD Files</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9" style="text-align: center; color: #666; padding: 20px;">No 3D parts added yet. Click "Add 3D Part" to get started!</td></tr>
                </tbody>
            </table>
        </div>

        <!-- CABLE ASSEMBLIES Management Sheet -->
        <div id="cable-assemblies" class="sheet">
            <div class="section-header">🔗 CABLE ASSEMBLIES - Custom Cable Harnesses (CAN)</div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddSystemModal('cable-assemblies')">➕ Add Cable Assembly</button>
                <button class="btn btn-success export-button" onclick="exportSystemData('csv', 'cable-assemblies')">📄 Export CSV</button>
                <button class="btn btn-info export-button" onclick="exportSystemData('json', 'cable-assemblies')">📄 Export JSON</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="cable-assemblies-count">0</div>
                    <div class="stat-label">Total Cable Assemblies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="cable-assemblies-active">0</div>
                    <div class="stat-label">Active Cable Assemblies</div>
                </div>
            </div>
            <table class="component-table">
                <thead>
                    <tr>
                        <th class="sortable-header" onclick="sortSystemTable('cable-assemblies', 'cableKN')">Cable KN</th>
                        <th class="sortable-header" onclick="sortSystemTable('cable-assemblies', 'name')">Cable Name</th>
                        <th class="sortable-header" onclick="sortSystemTable('cable-assemblies', 'type')">Type</th>
                        <th class="sortable-header" onclick="sortSystemTable('cable-assemblies', 'length')">Length</th>
                        <th class="sortable-header" onclick="sortSystemTable('cable-assemblies', 'connectors')">Connectors</th>
                        <th class="sortable-header" onclick="sortSystemTable('cable-assemblies', 'status')">Status</th>
                        <th class="sortable-header" onclick="sortSystemTable('cable-assemblies', 'description')">Description</th>
                        <th>Diagram</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9" style="text-align: center; color: #666; padding: 20px;">No cable assemblies added yet. Click "Add Cable Assembly" to get started!</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Add Component Modal -->
        <div id="addComponentModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAddComponentModal()">&times;</span>
                <h2>Add New Component</h2>
                <p>This modal provides an alternative way to add components. Use the dedicated "Add Component" sheet for a better experience.</p>
                <button class="btn btn-primary" onclick="closeAddComponentModal(); showSheet('add-component')">Go to Add Component Sheet</button>
            </div>
        </div>

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Kinben KPN System...');
            
            // Load existing data from localStorage
            loadSystemData();
            loadComponentData();
            
            // Initialize system management
            initializeSystemManagement();
            
            // Update statistics
            updateSystemStats();
            
            // Show default landing sheet
            showSheet('landing');
            
            console.log('✅ Kinben KPN System initialized successfully!');
        });

        // Additional utility functions for system functionality
        function showSheet(sheetName) {
            // Hide all sheets
            const sheets = document.querySelectorAll('.sheet');
            sheets.forEach(sheet => sheet.classList.remove('active'));
            
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected sheet
            const selectedSheet = document.getElementById(sheetName);
            if (selectedSheet) {
                selectedSheet.classList.add('active');
            }
            
            // Activate corresponding tab
            const selectedTab = document.querySelector(`[onclick="showSheet('${sheetName}')"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Refresh data for current sheet
            if (sheetName === 'landing') {
                updateSystemStats();
            } else if (['systems', 'assemblies', 'pcbs', '3d-parts', 'cable-assemblies'].includes(sheetName)) {
                refreshSystemTable(sheetName);
            }
        }

        // Close modal function
        function closeAddComponentModal() {
            const modal = document.getElementById('addComponentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

    </script>
    </div>
</body>
</html>