<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kinben KPN System - Simplified</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" 
            integrity="sha384-<HASH_FOR_APP>" 
            crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js" 
            integrity="sha384-<HASH_FOR_AUTH>" 
            crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js" 
            integrity="sha384-<HASH_FOR_FIRESTORE>" 
            crossorigin="anonymous"></script>
    
    <style>
        body { 
            font-family: Calibri, Arial, sans-serif; 
            margin: 0; 
            background: #f5f5f5;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            color: #666;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e3f2fd;
        }
        
        .tab.active {
            background: #0078d4;
            color: white;
        }
        
        .content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #0078d4;
            color: white;
        }
        
        .btn-primary:hover {
            background: #106ebe;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .table th {
            background: #0078d4;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .table tr:hover {
            background: #e3f2fd;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #0078d4;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .kpn-preview {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            color: #0078d4;
            text-align: center;
            margin: 10px 0;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }
        
        .bom-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .login-container h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 24px;
        }
        
        .login-container p {
            margin: 0 0 30px 0;
            color: #666;
            font-size: 14px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-form input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #0078d4;
        }
        
        .login-form button {
            padding: 12px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-form button:hover {
            background: #106ebe;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        /* Archived component styles */
        .status-archived {
            color: #6c757d;
            font-weight: bold;
        }
        
        .archived-row {
            opacity: 0.5;
            background-color: #f8f9fa !important;
        }
        
        .archived-row td {
            color: #6c757d !important;
        }
        
        /* Role-based action buttons */
        .archive-btn {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .archive-btn:hover {
            background: #e0a800;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }

        /* Duplicate Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .modal-header h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 20px;
        }

        .modal-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .modal-body {
            padding: 20px 30px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .duplicate-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .duplicate-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .duplicate-item-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .duplicate-item-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .duplicate-item-existing {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .duplicate-item-existing strong {
            color: #0078d4;
        }

        .duplicate-choices {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .duplicate-choices input[type="radio"] {
            margin-right: 5px;
        }

        .duplicate-choices label {
            cursor: pointer;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .duplicate-choices label:hover {
            background: #e9ecef;
        }

        .duplicate-choices input[type="radio"]:checked + label {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="login-modal" class="login-modal">
        <div class="login-container">
            <h2>üîê Login to KPN System</h2>
            <p id="login-description">Choose your login method</p>
            <div class="login-form">
                <!-- Google Sign-In (shown when Firebase is configured) -->
                <button id="google-signin-btn" onclick="signInWithGoogle()" style="background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 15px;">
                    <span style="margin-right: 10px;">üîç</span>Sign in with Google
                </button>
                
                <!-- Local Authentication Form (backup) -->
                <div id="local-auth-form" style="display: none;">
                    <input type="text" id="username" placeholder="Username" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                    <input type="password" id="password" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                    <button onclick="signInLocal()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 10px;">
                        üîë Sign In Locally
                    </button>
                </div>
                
                <!-- Toggle between authentication methods -->
                <button id="toggle-auth-btn" onclick="toggleAuthMethod()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px; width: 100%; margin-bottom: 15px;">
                    Use Local Login
                </button>
                
                <div id="login-status" style="text-align: center; color: #666; font-size: 14px;"></div>
                
                <!-- Local Login Credentials Info -->
                <div id="local-credentials-info" style="display: none; margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 5px; font-size: 12px; color: #495057;">
                    <strong>Local Login Credentials:</strong><br>
                    <strong>Admin:</strong> admin / admin123<br>
                    <strong>Team:</strong> team / team123<br>
                    <em>These are backup accounts when Google auth is unavailable</em>
                </div>
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
                <strong>Note:</strong><br>
                <span id="auth-note">Firebase authentication is not configured. Using local authentication.</span>
            </div>
        </div>
    </div>
    
    <!-- User Info Display -->
    <div id="user-info" class="user-info" style="display: none;">
        <span id="current-user"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üîß Kinben Parts Reference System</h1>
            <p>Simple. Fast. Essential. - Three Core Data Types Only</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-components">0</div>
                <div class="stat-label">Components</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-pcbs">0</div>
                <div class="stat-label">PCBs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-systems">0</div>
                <div class="stat-label">Systems</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('components')">üìã Components</button>
            <button class="tab" onclick="showTab('pcbs')">üîå PCBs</button>
            <button class="tab" onclick="showTab('systems')">üèóÔ∏è Systems</button>
            <button class="tab" onclick="showTab('export')">üìä Export</button>
            <button class="tab" onclick="showTab('config')">‚öôÔ∏è Config</button>
            <button class="tab" id="user-mgmt-tab" onclick="showTab('user-management')" style="display: none;">üë• Users</button>
        </div>
        
        <div class="content" id="simplified-structure">
            <!-- Components Tab -->
            <div id="components" class="tab-panel active">
                <h2>KPN Components</h2>
                <p>Basic electronic parts catalog with auto-generated KPNs</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="comp-category" onchange="updateComponentSubcategories()">
                            <option value="">Select Category</option>
                            <option value="capacitors">Capacitors</option>
                            <option value="resistors">Resistors</option>
                            <option value="inductors">Inductors</option>
                            <option value="diodes">Diodes</option>
                            <option value="transistors">Transistors</option>
                            <option value="ics">Integrated Circuits</option>
                            <option value="connectors">Connectors</option>
                            <option value="switches">Switches</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subcategory</label>
                        <select id="comp-subcategory" onchange="generateComponentKPN()">
                            <option value="">Select Subcategory</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>KPN (Auto-generated)</label>
                        <div class="kpn-preview" id="comp-kpn-preview">Select category and subcategory</div>
                    </div>
                </div>
                
                <!-- Dynamic component fields based on category -->
                <div id="component-dynamic-fields">
                    <p style="color: #666; text-align: center; margin: 40px 0;">
                        Select a category and subcategory to display component-specific fields
                    </p>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="addComponent()">Add Component</button>
                    <button class="btn" onclick="resetComponentForm()" style="background: #6c757d; color: white; display: none;" id="cancel-edit-btn">Cancel Edit</button>
                    <button class="btn btn-success" onclick="exportComponents()">Export CSV</button>
                    <input type="file" id="csv-import-input" accept=".csv" style="display: none;" onchange="importCSV()">
                    <button class="btn btn-info" onclick="document.getElementById('csv-import-input').click()">Import CSV</button>
                    <button class="btn" onclick="exportTemplate()" style="background: #6c757d; color: white;">Download Template</button>
                    
                    <!-- Bulk Actions -->
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="toggleBulkSelection()" style="background: #6c757d; color: white;" id="bulk-select-btn">Enable Bulk Select</button>
                        <div id="bulk-actions" style="display: none; margin-top: 10px;">
                            <button class="btn" onclick="selectAllComponents()" style="background: #17a2b8; color: white;">Select All</button>
                            <button class="btn" onclick="deselectAllComponents()" style="background: #6c757d; color: white;">Deselect All</button>
                            <button class="btn archive-btn" onclick="bulkArchiveComponents()">Archive Selected</button>
                            <button class="btn delete-btn" onclick="bulkDeleteComponents()" id="bulk-delete-btn" style="display: none;">Delete Selected</button>
                        </div>
                    </div>
                </div>
                
                <input type="text" class="search-box" id="comp-search" placeholder="Search components..." onkeyup="filterComponents()">
                
                <table class="table" id="components-table">
                    <thead>
                        <tr>
                            <th id="bulk-select-header" style="display: none;">
                                <input type="checkbox" id="select-all-checkbox" onchange="toggleAllCheckboxes(this)">
                            </th>
                            <th>KPN</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Value/PN</th>
                            <th>Package</th>
                            <th>Specs</th>
                            <th>Vendor</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="components-tbody">
                    </tbody>
                </table>
            </div>
            
            <!-- PCBs Tab -->
            <div id="pcbs" class="tab-panel">
                <h2>PCB Management</h2>
                <p>Simple PCB definitions with BOMs linking to KPN components</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>PCB Name</label>
                        <input type="text" id="pcb-name" placeholder="e.g., Main Controller Board">
                    </div>
                    <div class="form-group">
                        <label>Version</label>
                        <input type="text" id="pcb-version" placeholder="e.g., v1.0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="pcb-status">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="pcb-description" placeholder="PCB description and purpose">
                </div>
                
                <h3>Bill of Materials (BOM)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Component KPN</label>
                        <select id="bom-kpn">
                            <option value="">Select Component</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="bom-quantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>Reference Designator</label>
                        <input type="text" id="bom-refdes" placeholder="e.g., R1, C2, U3">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addBOMItem()">Add to BOM</button>
                    </div>
                </div>
                
                <div id="bom-items"></div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="addPCB()">Add PCB</button>
                    <button class="btn btn-success" onclick="exportPCBs()">Export CSV</button>
                </div>
                
                <input type="text" class="search-box" id="pcb-search" placeholder="Search PCBs..." onkeyup="filterPCBs()">
                
                <table class="table" id="pcbs-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Version</th>
                            <th>Description</th>
                            <th>BOM Items</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="pcbs-tbody">
                    </tbody>
                </table>
            </div>
            
            <!-- Systems Tab -->
            <div id="systems" class="tab-panel">
                <h2>System Hierarchy</h2>
                <p>Systems containing multiple PCBs with simple hierarchical structure</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>System Name</label>
                        <input type="text" id="system-name" placeholder="e.g., IoT Environmental Monitor">
                    </div>
                    <div class="form-group">
                        <label>Version</label>
                        <input type="text" id="system-version" placeholder="e.g., v1.0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="system-status">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="system-description" placeholder="System description and purpose">
                </div>
                
                <h3>System PCBs</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>PCB</label>
                        <select id="system-pcb">
                            <option value="">Select PCB</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="system-pcb-quantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addSystemPCB()">Add PCB</button>
                    </div>
                </div>
                
                <div id="system-pcbs"></div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="addSystem()">Add System</button>
                    <button class="btn btn-success" onclick="exportSystems()">Export CSV</button>
                </div>
                
                <input type="text" class="search-box" id="system-search" placeholder="Search systems..." onkeyup="filterSystems()">
                
                <table class="table" id="systems-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Version</th>
                            <th>Description</th>
                            <th>PCB Count</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="systems-tbody">
                    </tbody>
                </table>
            </div>
            
            <!-- Export Tab -->
            <div id="export" class="tab-panel">
                <h2>Data Export</h2>
                <p>Export your data in CSV format for external tools</p>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="export-components">0</div>
                        <div class="stat-label">Components to Export</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="export-pcbs">0</div>
                        <div class="stat-label">PCBs to Export</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="export-systems">0</div>
                        <div class="stat-label">Systems to Export</div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="exportAll()">Export All Data</button>
                    <button class="btn btn-success" onclick="exportComponents()">Export Components Only</button>
                    <button class="btn btn-success" onclick="exportPCBs()">Export PCBs Only</button>
                    <button class="btn btn-success" onclick="exportSystems()">Export Systems Only</button>
                </div>
            </div>
            
            <!-- Config Tab -->
            <div id="config" class="tab-panel">
                <h2>Configuration</h2>
                <p>Manage system settings and preferred vendors</p>
                
                <div style="max-width: 800px;">
                    <h3>Preferred Vendors</h3>
                    <p>Add and manage your preferred component vendors for dropdown selection</p>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr auto; align-items: end;">
                        <div class="form-group">
                            <label>Vendor Name</label>
                            <input type="text" id="new-vendor-name" placeholder="e.g., Mouser, Digi-Key, Arrow">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="addVendor()">Add Vendor</button>
                        </div>
                    </div>
                    
                    <div id="vendors-list" style="margin-top: 20px;">
                        <h4>Current Vendors:</h4>
                        <div id="vendors-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab (Admin Only) -->
            <div id="user-management" class="tab-panel">
                <h2>User Management</h2>
                <p>Manage user roles and permissions (Admin access required)</p>
                
                <div style="max-width: 800px;">
                    <div id="users-list">
                        <h3>System Users</h3>
                        <p>All users who have signed in to the system</p>
                        
                        <div style="margin-bottom: 20px;">
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">User</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Email</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Current Role</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Last Sign In</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Users will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                            <h4>Role Descriptions</h4>
                            <ul style="margin: 10px 0;">
                                <li><strong>Team:</strong> Can create and archive components, create PCBs and systems</li>
                                <li><strong>Admin:</strong> All team permissions plus ability to delete components and manage users</li>
                                <li><strong>None:</strong> User has no system access (can sign in but cannot use features)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Duplicate Confirmation Modal -->
    <div id="duplicate-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîç Duplicate Components Found</h3>
                <p>The following components already exist in your database. Choose your action for each:</p>
            </div>
            <div class="modal-body">
                <div id="duplicate-list" class="duplicate-list">
                    <!-- Duplicate items will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="processDuplicateChoices()">Apply Choices</button>
                <button class="btn" onclick="cancelDuplicateImport()" style="background: #6c757d; color: white;">Cancel Import</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        // Firebase project configuration for kinbenpartssystem
        const firebaseConfig = {
  apiKey: "AIzaSyDEb-vJyJthW4xZ042Ay_8EDm-RhGBhLxU",
  authDomain: "kinbenpartssystem.firebaseapp.com",
  projectId: "kinbenpartssystem",
  storageBucket: "kinbenpartssystem.firebasestorage.app",
  messagingSenderId: "896608745742",
  appId: "1:896608745742:web:2c84cda1dafbc2519fff5f"
};

        // Check if Firebase config is valid (should always be true now with real config)
        const isFirebaseConfigured = firebaseConfig.apiKey && 
                                    firebaseConfig.appId &&
                                    firebaseConfig.projectId === "kinbenpartssystem";

        // Initialize Firebase only if properly configured and Firebase SDK is available
        let auth = null;
        let db = null;
        let googleProvider = null;
        
        if (isFirebaseConfigured && typeof firebase !== 'undefined') {
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                // Configure Google Auth Provider
                googleProvider = new firebase.auth.GoogleAuthProvider();
                googleProvider.addScope('email');
                googleProvider.addScope('profile');
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.warn('Firebase initialization failed:', error);
            }
        } else {
            console.log('Firebase not configured or SDK not available, using local authentication');
        }

        // Local authentication mode flag
        let useLocalAuth = !isFirebaseConfigured || typeof firebase === 'undefined';

        // Simplified data storage
        let data = {
            components: [],
            pcbs: [],
            systems: [],
            vendors: ['Mouser', 'Digi-Key', 'Arrow', 'Newark', 'Farnell', 'RS Components', 'Avnet', 'Future Electronics']
        };

        // Current user object (compatible with both auth methods)
        let currentUser = { role: 'none', email: '', uid: '', displayName: '', username: null };

        // Local user accounts (backup authentication)
        const localUsers = {
            'admin': { password: 'admin123', role: 'admin', email: 'admin@kinben.local', displayName: 'Local Admin' },
            'team': { password: 'team123', role: 'team', email: 'team@kinben.local', displayName: 'Team User' }
        };

        // Firebase Authentication State Listener (only if Firebase is configured)
        if (auth) {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in via Firebase
                    await handleFirebaseUser(user);
                } else {
                    // User is signed out
                    currentUser = { role: 'none', email: '', uid: '', displayName: '', username: null };
                    showLogin();
                }
            });
        }

        // Handle Firebase user sign in
        async function handleFirebaseUser(user) {
            try {
                // Get user role from Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                let userRole = 'none'; // Default role
                
                if (userDoc.exists) {
                    userRole = userDoc.data().role || 'none';
                } else {
                    // New user - create document with no role
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        displayName: user.displayName,
                        role: 'none',
                        firstSignIn: firebase.firestore.FieldValue.serverTimestamp(),
                        lastSignIn: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Update last sign in
                await db.collection('users').doc(user.uid).update({
                    lastSignIn: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Set current user
                currentUser = {
                    uid: user.uid,
                    username: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    displayName: user.displayName || user.email,
                    role: userRole
                };

                if (userRole === 'none') {
                    // User has no role assigned
                    showNoRoleMessage();
                } else {
                    // User has a role, allow access
                    hideLogin();
                    showUserInfo();
                    
                    // Attempt data migration from localStorage for new Firebase users
                    const migrationSuccess = await migrateLocalStorageToFirestore();
                    if (migrationSuccess) {
                        console.log('Data migration completed or not needed');
                    }
                    
                    loadData(); // Load app data
                    
                    // Show appropriate tabs based on role
                    if (userRole === 'admin') {
                        showUserManagementTab();
                    } else {
                        hideUserManagementTab();
                    }
                }
            } catch (error) {
                console.error('Error handling Firebase user:', error);
                showLoginError('Authentication error. Please try again.');
            }
        }

        // Handle local authentication
        function signInLocal() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showLoginError('Please enter both username and password.');
                return;
            }
            
            const user = localUsers[username];
            if (user && user.password === password) {
                // Successful local login
                currentUser = {
                    uid: 'local_' + username,
                    username: username,
                    email: user.email,
                    displayName: user.displayName,
                    role: user.role
                };
                
                hideLogin();
                showUserInfo();
                loadData(); // Load app data
                
                // Show appropriate tabs based on role
                if (user.role === 'admin') {
                    showUserManagementTab();
                } else {
                    hideUserManagementTab();
                }
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                console.log('Local authentication successful for:', username);
            } else {
                showLoginError('Invalid username or password.');
            }
        }

        // Toggle between Google and local authentication
        function toggleAuthMethod() {
            const localForm = document.getElementById('local-auth-form');
            const googleBtn = document.getElementById('google-signin-btn');
            const toggleBtn = document.getElementById('toggle-auth-btn');
            const credentialsInfo = document.getElementById('local-credentials-info');
            const authNote = document.getElementById('auth-note');
            
            if (useLocalAuth) {
                // Switch to Google auth (if available)
                if (isFirebaseConfigured && typeof firebase !== 'undefined') {
                    useLocalAuth = false;
                    localForm.style.display = 'none';
                    googleBtn.style.display = 'block';
                    toggleBtn.textContent = 'Use Local Login';
                    credentialsInfo.style.display = 'none';
                    authNote.textContent = 'Using Google authentication via Firebase.';
                    document.getElementById('login-description').textContent = 'Sign in with your Google account to access the system';
                } else {
                    showLoginError('Google authentication is not configured or available.');
                }
            } else {
                // Switch to local auth
                useLocalAuth = true;
                localForm.style.display = 'block';
                googleBtn.style.display = 'none';
                toggleBtn.textContent = 'Use Google Login';
                credentialsInfo.style.display = 'block';
                authNote.textContent = 'Using local authentication. Google auth is not configured.';
                document.getElementById('login-description').textContent = 'Enter your local credentials to access the system';
            }
        }

        // Handle user sign out (works for both Firebase and local auth)
        function handleUserSignOut() {
            currentUser = { username: null, role: null, uid: null, email: null, displayName: null };
            showLogin();
            hideUserInfo();
            document.getElementById('user-mgmt-tab').style.display = 'none';
        }

        // Show no role message
        function showNoRoleMessage() {
            hideLogin();
            hideUserInfo();
            document.getElementById('login-status').innerHTML = `
                <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">‚è≥ Access Pending</h4>
                    <p style="margin: 0; color: #856404;">
                        You have successfully signed in as <strong>${currentUser.email}</strong>, 
                        but you haven't been assigned a role yet.
                        <br><br>
                        Please contact your system administrator to request access.
                    </p>
                    <div style="margin-top: 15px;">
                        <button onclick="signOutUser()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer;">
                            Sign Out
                        </button>
                    </div>
                </div>
            `;
            showLogin(); // Keep login modal visible with status message
        }

        // Sign in with Google (only if Firebase is configured)
        async function signInWithGoogle() {
            if (!isFirebaseConfigured || !auth || !googleProvider || typeof firebase === 'undefined') {
                showLoginError('Google authentication is not configured or available.');
                return;
            }
            
            try {
                document.getElementById('login-status').innerHTML = 'Signing in...';
                await auth.signInWithPopup(googleProvider);
            } catch (error) {
                console.error('Error signing in with Google:', error);
                showLoginError('Sign in failed. Please try again later.');
            }
        }

        // Sign out user (works for both auth methods)
        async function signOutUser() {
            try {
                if (auth && currentUser.uid && !currentUser.uid.startsWith('local_')) {
                    await auth.signOut();
                } else {
                    // Local authentication sign out
                    handleUserSignOut();
                }
            } catch (error) {
                console.error('Error signing out:', error);
                handleUserSignOut(); // Fallback to local sign out
            }
        }

        // Show login error
        function showLoginError(message) {
            document.getElementById('login-status').innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 3px; margin-top: 10px;">
                    ${message}
                </div>
            `;
        }

        // Check authentication status (legacy function - now handled by auth state listener)
        function checkAuth() {
            // This is now handled by Firebase Auth state listener
            return currentUser.role && currentUser.role !== 'none';
        }

        // Legacy login function - replaced with Google Sign-In
        function attemptLogin() {
            // This function is no longer used but kept for compatibility
            signInWithGoogle();
        }

        // Logout function - updated for Firebase
        function logout() {
            signOutUser();
        }

        // Show/hide login modal
        function showLogin() {
            document.getElementById('login-modal').style.display = 'flex';
        }

        function hideLogin() {
            document.getElementById('login-modal').style.display = 'none';
        }

        // Show/hide user info
        function showUserInfo() {
            const userInfo = document.getElementById('user-info');
            const currentUserSpan = document.getElementById('current-user');
            currentUserSpan.textContent = `${currentUser.username.charAt(0).toUpperCase() + currentUser.username.slice(1)} User (${currentUser.role === 'admin' ? 'Admin' : 'Team'})`;
            userInfo.style.display = 'block';
        }

        function hideUserInfo() {
            document.getElementById('user-info').style.display = 'none';
        }

        // User Management Functions
        async function loadUsersForManagement() {
            if (currentUser.role !== 'admin') {
                return;
            }

            try {
                const usersSnapshot = await db.collection('users').orderBy('email').get();
                const usersTableBody = document.getElementById('users-table-body');
                usersTableBody.innerHTML = '';

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const row = document.createElement('tr');
                    
                    const lastSignIn = userData.lastSignIn ? 
                        userData.lastSignIn.toDate().toLocaleDateString() : 'Never';
                    
                    row.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #ddd;">${userData.displayName || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${userData.email}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <span style="padding: 3px 8px; border-radius: 3px; font-size: 12px; background: ${getRoleColor(userData.role)}; color: white;">
                                ${userData.role.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${lastSignIn}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <select onchange="updateUserRole('${doc.id}', this.value)" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                <option value="none" ${userData.role === 'none' ? 'selected' : ''}>None</option>
                                <option value="team" ${userData.role === 'team' ? 'selected' : ''}>Team</option>
                                <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </td>
                    `;
                    
                    usersTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Unable to load users. Please try again or contact support.');
            }
        }

        // Get role color for display
        function getRoleColor(role) {
            switch (role) {
                case 'admin': return '#dc3545';
                case 'team': return '#28a745';
                case 'none': return '#6c757d';
                default: return '#6c757d';
            }
        }

        // Update user role
        async function updateUserRole(userId, newRole) {
            if (currentUser.role !== 'admin') {
                alert('Only admins can update user roles.');
                return;
            }

            try {
                await db.collection('users').doc(userId).update({
                    role: newRole,
                    updatedBy: currentUser.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Refresh the users list
                await loadUsersForManagement();
                
                alert(`User role updated to ${newRole.toUpperCase()}`);
            } catch (error) {
                console.error('Error updating user role:', error);
                alert('An error occurred while updating the user role. Please try again later.');
            }
        }

        // Initialize authentication on page load
        window.addEventListener('load', function() {
            // Set up initial authentication mode based on Firebase configuration
            if (!isFirebaseConfigured || typeof firebase === 'undefined') {
                // Default to local auth when Firebase is not configured or not available
                useLocalAuth = true;
                document.getElementById('local-auth-form').style.display = 'block';
                document.getElementById('google-signin-btn').style.display = 'none';
                document.getElementById('toggle-auth-btn').textContent = 'Use Google Login';
                document.getElementById('local-credentials-info').style.display = 'block';
                document.getElementById('auth-note').textContent = 'Firebase authentication is not configured. Using local authentication.';
                document.getElementById('login-description').textContent = 'Enter your local credentials to access the system';
            } else {
                // Firebase is configured, start with Google auth
                useLocalAuth = false;
                document.getElementById('local-auth-form').style.display = 'none';
                document.getElementById('google-signin-btn').style.display = 'block';
                document.getElementById('toggle-auth-btn').textContent = 'Use Local Login';
                document.getElementById('local-credentials-info').style.display = 'none';
                document.getElementById('auth-note').textContent = 'Using Google authentication via Firebase.';
                document.getElementById('login-description').textContent = 'Sign in with your Google account to access the system';
            }
            
            showLogin();
        });

        // Add keyboard support for login modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('login-modal').style.display !== 'none') {
                if (useLocalAuth && document.getElementById('local-auth-form').style.display !== 'none') {
                    signInLocal();
                } else if (isFirebaseConfigured && typeof firebase !== 'undefined') {
                    signInWithGoogle();
                }
            }
        });

        // Load data from Firestore or localStorage fallback
        async function loadData() {
            if (auth && db && currentUser.uid) {
                // Load from Firestore
                try {
                    await loadFromFirestore();
                } catch (error) {
                    console.error('Error loading from Firestore:', error);
                    // Fallback to localStorage on error
                    loadFromLocalStorage();
                }
            } else {
                // Use localStorage when not authenticated or Firebase unavailable
                loadFromLocalStorage();
            }
        }
        
        // Load data from Firestore
        async function loadFromFirestore() {
            console.log('Loading data from Firestore...');
            
            try {
                // Load components with real-time listener
                const componentsRef = db.collection('components');
                const componentsUnsubscribe = componentsRef.onSnapshot((snapshot) => {
                    data.components = [];
                    snapshot.forEach(doc => {
                        data.components.push({ id: doc.id, ...doc.data() });
                    });
                    updateComponentsTable();
                    updateStats();
                });
                
                // Load PCBs with real-time listener
                const pcbsRef = db.collection('pcbs');
                const pcbsUnsubscribe = pcbsRef.onSnapshot((snapshot) => {
                    data.pcbs = [];
                    snapshot.forEach(doc => {
                        data.pcbs.push({ id: doc.id, ...doc.data() });
                    });
                    updatePCBsTable();
                    updateStats();
                });
                
                // Load systems with real-time listener
                const systemsRef = db.collection('systems');
                const systemsUnsubscribe = systemsRef.onSnapshot((snapshot) => {
                    data.systems = [];
                    snapshot.forEach(doc => {
                        data.systems.push({ id: doc.id, ...doc.data() });
                    });
                    updateSystemsTable();
                    updateStats();
                });
                
                // Load vendors
                const vendorsSnapshot = await db.collection('vendors').get();
                if (!vendorsSnapshot.empty) {
                    data.vendors = [];
                    vendorsSnapshot.forEach(doc => {
                        data.vendors.push(doc.data().name);
                    });
                } else {
                    // Initialize default vendors if none exist
                    data.vendors = ['Mouser', 'Digi-Key', 'Arrow', 'Newark', 'Farnell', 'RS Components', 'Avnet', 'Future Electronics'];
                    await saveVendorsToFirestore();
                }
                
                // Store unsubscribe functions for cleanup
                firestoreListenerManager.addUnsubscribers([componentsUnsubscribe, pcbsUnsubscribe, systemsUnsubscribe]);
                
                updateStats();
                renderAll();
                
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                throw error;
            }
        }
        
        // Load data from localStorage (fallback)
        function loadFromLocalStorage() {
            console.log('Loading data from localStorage...');
            const saved = localStorage.getItem('kinben-simple-data');
            if (saved) {
                data = JSON.parse(saved);
                // Ensure vendors array exists for backward compatibility
                if (!data.vendors) {
                    data.vendors = ['Mouser', 'Digi-Key', 'Arrow', 'Newark', 'Farnell', 'RS Components', 'Avnet', 'Future Electronics'];
                    saveData();
                }
            }
            updateStats();
            renderAll();
        }

        // Save data to Firestore or localStorage fallback
        async function saveData() {
            if (auth && db && currentUser.uid) {
                // Save to Firestore
                try {
                    await saveToFirestore();
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    // Fallback to localStorage on error
                    saveToLocalStorage();
                }
            } else {
                // Use localStorage when not authenticated or Firebase unavailable
                saveToLocalStorage();
            }
        }
        
        // Save data to Firestore
        async function saveToFirestore() {
            console.log('Saving data to Firestore...');
            // Note: Individual saves are handled by specific functions
            // This function exists for compatibility but most saves are done directly
            updateStats();
        }
        
        // Save data to localStorage (fallback)
        function saveToLocalStorage() {
            localStorage.setItem('kinben-simple-data', JSON.stringify(data));
            updateStats();
        }
        
        // Save individual component to Firestore
        async function saveComponentToFirestore(component) {
            if (!auth || !db || !currentUser.uid) return false;
            
            try {
                if (component.id) {
                    // Update existing component
                    await db.collection('components').doc(component.id).update({
                        ...component,
                        lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                        lastModifiedBy: currentUser.uid
                    });
                } else {
                    // Add new component
                    const docRef = await db.collection('components').add({
                        ...component,
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.uid,
                        lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                        lastModifiedBy: currentUser.uid
                    });
                    component.id = docRef.id;
                }
                return true;
            } catch (error) {
                console.error('Error saving component to Firestore:', error);
                return false;
            }
        }
        
        // Save vendors to Firestore
        async function saveVendorsToFirestore() {
            if (!auth || !db || !currentUser.uid) return false;
            
            try {
                const batch = db.batch();
                
                // Clear existing vendors
                const existingVendors = await db.collection('vendors').get();
                existingVendors.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                // Add current vendors
                data.vendors.forEach(vendor => {
                    const vendorRef = db.collection('vendors').doc();
                    batch.set(vendorRef, { 
                        name: vendor,
                        createdBy: currentUser.uid,
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await batch.commit();
                return true;
            } catch (error) {
                console.error('Error saving vendors to Firestore:', error);
                return false;
            }
        }
        
        // Save individual PCB to Firestore
        async function savePCBToFirestore(pcb) {
            if (!auth || !db || !currentUser.uid) return false;
            
            try {
                if (pcb.id) {
                    // Update existing PCB
                    await db.collection('pcbs').doc(pcb.id).update({
                        ...pcb,
                        lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                        lastModifiedBy: currentUser.uid
                    });
                } else {
                    // Add new PCB
                    const docRef = await db.collection('pcbs').add({
                        ...pcb,
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.uid,
                        lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                        lastModifiedBy: currentUser.uid
                    });
                    pcb.id = docRef.id;
                }
                return true;
            } catch (error) {
                console.error('Error saving PCB to Firestore:', error);
                return false;
            }
        }
        
        // Data migration utility for localStorage to Firestore
        async function migrateLocalStorageToFirestore() {
            if (!auth || !db || !currentUser.uid) return false;
            
            try {
                // Check if user already has data in Firestore
                const componentsSnapshot = await db.collection('components')
                    .where('createdBy', '==', currentUser.uid)
                    .limit(1)
                    .get();
                if (!componentsSnapshot.empty) {
                    console.log('User already has Firestore data, skipping migration');
                    return true;
                }
                
                // Get localStorage data
                const localData = localStorage.getItem('kinben-simple-data');
                if (!localData) {
                    console.log('No localStorage data to migrate');
                    return true;
                }
                
                const parsedData = JSON.parse(localData);
                console.log('Starting data migration from localStorage to Firestore...');
                
                const batch = db.batch();
                let batchCount = 0;
                
                // Migrate components
                if (parsedData.components && parsedData.components.length > 0) {
                    for (const component of parsedData.components) {
                        const componentRef = db.collection('components').doc();
                        batch.set(componentRef, {
                            ...component,
                            migratedFrom: 'localStorage',
                            createdBy: currentUser.uid,
                            dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                            lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                            lastModifiedBy: currentUser.uid
                        });
                        batchCount++;
                        
                        // Firestore batch limit is 500
                        if (batchCount >= FIRESTORE_BATCH_LIMIT) {
                            await batch.commit();
                            batchCount = 0;
                        }
                    }
                }
                
                // Migrate PCBs
                if (parsedData.pcbs && parsedData.pcbs.length > 0) {
                    for (const pcb of parsedData.pcbs) {
                        const pcbRef = db.collection('pcbs').doc();
                        batch.set(pcbRef, {
                            ...pcb,
                            migratedFrom: 'localStorage',
                            createdBy: currentUser.uid,
                            dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                            lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                            lastModifiedBy: currentUser.uid
                        });
                        batchCount++;
                        
                        if (batchCount >= 400) {
                            await batch.commit();
                            batchCount = 0;
                        }
                    }
                }
                
                // Migrate systems
                if (parsedData.systems && parsedData.systems.length > 0) {
                    for (const system of parsedData.systems) {
                        const systemRef = db.collection('systems').doc();
                        batch.set(systemRef, {
                            ...system,
                            migratedFrom: 'localStorage',
                            createdBy: currentUser.uid,
                            dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                            lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                            lastModifiedBy: currentUser.uid
                        });
                        batchCount++;
                        
                        if (batchCount >= 400) {
                            await batch.commit();
                            batchCount = 0;
                        }
                    }
                }
                
                // Commit remaining items
                if (batchCount > 0) {
                    await batch.commit();
                }
                
                // Migrate vendors if admin
                if (currentUser.role === 'admin' && parsedData.vendors && parsedData.vendors.length > 0) {
                    await saveVendorsToFirestore();
                }
                
                console.log('Data migration completed successfully');
                
                // Optionally backup localStorage data with timestamp
                const backupKey = `kinben-simple-data-backup-${Date.now()}`;
                localStorage.setItem(backupKey, localData);
                
                return true;
            } catch (error) {
                console.error('Error migrating data to Firestore:', error);
                return false;
            }
        }
        
        // Save individual System to Firestore
        async function saveSystemToFirestore(system) {
            if (!auth || !db || !currentUser.uid) return false;
            
            try {
                if (system.id) {
                    // Update existing system
                    await db.collection('systems').doc(system.id).update({
                        ...system,
                        lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                        lastModifiedBy: currentUser.uid
                    });
                } else {
                    // Add new system
                    const docRef = await db.collection('systems').add({
                        ...system,
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.uid,
                        lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                        lastModifiedBy: currentUser.uid
                    });
                    system.id = docRef.id;
                }
                return true;
            } catch (error) {
                console.error('Error saving system to Firestore:', error);
                return false;
            }
        }

        // Category configurations with component-specific fields
        const categoryConfigs = {
            resistors: { 
                code: 'RES', 
                subcategories: ['STD', 'PRE', 'VAR', 'NET'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Yageo, Vishay' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., RC0805FR-0710KL' },
                    { id: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 10k, 4.7k' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 0805, 1206' },
                    { id: 'tolerance', label: 'Tolerance', type: 'text', required: true, placeholder: 'e.g., 1%, 5%' },
                    { id: 'temp-rating', label: 'Temp Rating', type: 'text', required: false, placeholder: 'e.g., -55¬∞C to +125¬∞C' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            capacitors: { 
                code: 'CAP', 
                subcategories: ['CER', 'ELE', 'TAN', 'FIL'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Murata, TDK' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., GRM21BR71H104KA01L' },
                    { id: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 10uF, 100nF' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 0805, 1206' },
                    { id: 'tolerance', label: 'Tolerance', type: 'text', required: false, placeholder: 'e.g., 10%, 20%' },
                    { id: 'voltage', label: 'Voltage', type: 'text', required: true, placeholder: 'e.g., 25V, 50V' },
                    { id: 'rating', label: 'Rating', type: 'text', required: false, placeholder: 'e.g., X7R, X5R, Y5V' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            ics: { 
                code: 'IC', 
                subcategories: ['MCU', 'ANA', 'DIG', 'PWR'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., STMicroelectronics, TI' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., STM32F103C8T6' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., 32-bit ARM Cortex-M3 MCU' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., LQFP-48, QFN-32' },
                    { id: 'rating', label: 'Rating', type: 'text', required: false, placeholder: 'e.g., Automotive, Industrial' },
                    { id: 'datasheet-link', label: 'Datasheet/Product Link', type: 'url', required: false, placeholder: 'https://...' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            inductors: { 
                code: 'IND', 
                subcategories: ['PWR', 'CHK', 'FER'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Murata, Coilcraft' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: false, placeholder: 'e.g., LQM18FN1R0M00D' },
                    { id: 'value', label: 'Value', type: 'text', required: true, placeholder: 'e.g., 10uH, 220nH' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 0805, 1210' },
                    { id: 'tolerance', label: 'Tolerance', type: 'text', required: false, placeholder: 'e.g., 10%, 20%' },
                    { id: 'current-rating', label: 'Current Rating', type: 'text', required: false, placeholder: 'e.g., 1A, 500mA' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            diodes: { 
                code: 'DIO', 
                subcategories: ['STD', 'LED', 'ZEN', 'SCH'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Vishay, Diodes Inc' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., 1N4148WS' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., SOD-323, SOT-23' },
                    { id: 'voltage-rating', label: 'Voltage Rating', type: 'text', required: false, placeholder: 'e.g., 75V, 100V' },
                    { id: 'current-rating', label: 'Current Rating', type: 'text', required: false, placeholder: 'e.g., 150mA, 1A' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            transistors: { 
                code: 'TRA', 
                subcategories: ['BJT', 'FET', 'MOS'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., Infineon, ON Semi' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., 2N7002K' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., SOT-23, TO-220' },
                    { id: 'voltage-rating', label: 'Voltage Rating', type: 'text', required: false, placeholder: 'e.g., 60V, 100V' },
                    { id: 'current-rating', label: 'Current Rating', type: 'text', required: false, placeholder: 'e.g., 300mA, 1A' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            connectors: { 
                code: 'CON', 
                subcategories: ['HDR', 'JST', 'USB', 'RJ45'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., JST, Molex' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., B2B-XH-A(LF)(SN)' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., 2-pin JST XH connector' },
                    { id: 'pitch', label: 'Pitch', type: 'text', required: false, placeholder: 'e.g., 2.54mm, 1.25mm' },
                    { id: 'pins', label: 'Pins', type: 'number', required: false, placeholder: 'e.g., 2, 4, 8' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            },
            switches: { 
                code: 'SWI', 
                subcategories: ['TAC', 'DIP', 'ROT', 'SLI'],
                fields: [
                    { id: 'manufacturer', label: 'Manufacturer', type: 'text', required: false, placeholder: 'e.g., ALPS, Omron' },
                    { id: 'manufacturer-pn', label: 'Manufacturer PN', type: 'text', required: true, placeholder: 'e.g., SKHHPNA010' },
                    { id: 'description', label: 'Description', type: 'text', required: true, placeholder: 'e.g., Tactile switch 4.3x4.3mm' },
                    { id: 'package', label: 'Package', type: 'text', required: true, placeholder: 'e.g., 4.3x4.3mm, SMD' },
                    { id: 'actuation-force', label: 'Actuation Force', type: 'text', required: false, placeholder: 'e.g., 160gf, 260gf' },
                    { id: 'preferred-vendor', label: 'Preferred Vendor', type: 'vendor-select', required: false }
                ]
            }
        };

        // Tab management
        function showTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected panel and tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Update component dropdowns when switching tabs
            if (tabName === 'pcbs' || tabName === 'systems') {
                updateDropdowns();
            }
        }

        // Show/hide user management tab functions
        function showUserManagementTab() {
            const userMgmtTab = document.getElementById('user-mgmt-tab');
            if (userMgmtTab) {
                userMgmtTab.style.display = 'block';
                // Load users if Firebase is available
                if (db) {
                    loadUsersForManagement();
                }
            }
        }

        function hideUserManagementTab() {
            const userMgmtTab = document.getElementById('user-mgmt-tab');
            if (userMgmtTab) {
                userMgmtTab.style.display = 'none';
            }
        }

        // Update subcategories based on category selection
        function updateComponentSubcategories() {
            const category = document.getElementById('comp-category').value;
            const subcategorySelect = document.getElementById('comp-subcategory');
            
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (category && categoryConfigs[category]) {
                categoryConfigs[category].subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
            
            // Update dynamic fields
            updateComponentFields();
            generateComponentKPN();
        }

        // Update component fields based on selected category
        function updateComponentFields() {
            const category = document.getElementById('comp-category').value;
            const dynamicFieldsContainer = document.getElementById('component-dynamic-fields');
            
            if (!category || !categoryConfigs[category]) {
                dynamicFieldsContainer.innerHTML = `
                    <p style="color: #666; text-align: center; margin: 40px 0;">
                        Select a category and subcategory to display component-specific fields
                    </p>
                `;
                return;
            }
            
            const config = categoryConfigs[category];
            let fieldsHTML = '<div class="form-grid">';
            
            // Add KPN field (always present)
            fieldsHTML += `
                <div class="form-group">
                    <label>KPN <span style="color: red;">*</span></label>
                    <input type="text" id="comp-kpn" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Category <span style="color: red;">*</span></label>
                    <input type="text" id="comp-category-display" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Subcategory <span style="color: red;">*</span></label>
                    <input type="text" id="comp-subcategory-display" readonly style="background: #f5f5f5;">
                </div>
            `;
            
            // Add category-specific fields
            config.fields.forEach(field => {
                const requiredMark = field.required ? '<span style="color: red;">*</span>' : '';
                
                if (field.type === 'vendor-select') {
                    // Create vendor dropdown
                    let vendorOptions = '<option value="">Select Vendor</option>';
                    data.vendors.forEach(vendor => {
                        vendorOptions += `<option value="${vendor}">${vendor}</option>`;
                    });
                    
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <select id="comp-${field.id}" ${field.required ? 'required' : ''}>
                                ${vendorOptions}
                            </select>
                        </div>
                    `;
                } else {
                    // Regular input field
                    fieldsHTML += `
                        <div class="form-group">
                            <label>${field.label} ${requiredMark}</label>
                            <input type="${field.type}" 
                                   id="comp-${field.id}" 
                                   placeholder="${field.placeholder || ''}"
                                   ${field.required ? 'required' : ''}>
                        </div>
                    `;
                }
            });
            
            fieldsHTML += '</div>';
            dynamicFieldsContainer.innerHTML = fieldsHTML;
            
            // Update readonly fields if category/subcategory are already selected
            const categorySelect = document.getElementById('comp-category');
            const subcategorySelect = document.getElementById('comp-subcategory');
            if (categorySelect.value) {
                document.getElementById('comp-category-display').value = categorySelect.options[categorySelect.selectedIndex].text;
            }
            if (subcategorySelect.value) {
                document.getElementById('comp-subcategory-display').value = subcategorySelect.value;
            }
        }

        // Generate KPN for component
        // Check if a component with the same identifying fields already exists
        function findDuplicateComponent(componentData) {
            const { category, subcategory } = componentData;
            
            // Core identifying fields that must match for all components
            const coreFields = ['category', 'subcategory'];
            
            // Additional identifying fields per category - comprehensive list based on schema
            const categoryIdentifyingFields = {
                resistors: ['value', 'package', 'tolerance', 'temp_rating', 'manufacturer', 'manufacturer_pn'],
                capacitors: ['value', 'package', 'tolerance', 'voltage_rating', 'rating', 'manufacturer', 'manufacturer_pn'],
                inductors: ['value', 'package', 'tolerance', 'current_rating', 'manufacturer', 'manufacturer_pn'],
                ics: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                diodes: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                transistors: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                connectors: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer'],
                switches: ['manufacturer_pn', 'description', 'package', 'rating', 'manufacturer']
            };
            
            // Get all fields to check for this category
            const allFieldsToCheck = [
                ...coreFields,
                ...(categoryIdentifyingFields[category] || (() => {
                    console.warn(`Unknown category "${category}" encountered. Using fallback fields.`);
                    return ['manufacturer_pn', 'description', 'package'];
                })())
            ];
            
            // Find existing components with same category and subcategory first
            const similarComponents = data.components.filter(comp => 
                comp.category === category && 
                comp.subcategory === subcategory &&
                comp.status === 'Active' // Only check active components
            );
            
            // Check if any existing component has ALL matching identifying fields
            for (const existingComp of similarComponents) {
                let isMatch = true;
                
                for (const field of allFieldsToCheck) {
                    const newValue = (componentData[field] || '').toString().toLowerCase().trim();
                    const existingValue = (existingComp[field] || '').toString().toLowerCase().trim();
                    
                    // Track if at least one field is non-empty for both components
                    const isFieldIdentifying = newValue !== '' || existingValue !== '';
                    
                    if (!isFieldIdentifying) {
                        continue; // Skip non-identifying fields
                    }
                    
                    if (newValue !== existingValue) {
                        isMatch = false;
                        break;
                    }
                }
                
                if (isMatch) {
                    return existingComp;
                }
            }
            
            return null;
        }

        function generateComponentKPN() {
            const category = document.getElementById('comp-category').value;
            const subcategory = document.getElementById('comp-subcategory').value;
            const preview = document.getElementById('comp-kpn-preview');
            
            if (category && subcategory) {
                const config = categoryConfigs[category];
                const existingKPNs = data.components
                    .filter(c => c.kpn.startsWith(`${config.code}-${subcategory}`))
                    .map(c => parseInt(c.kpn.split('-')[2]))
                    .filter(n => !isNaN(n))
                    .sort((a, b) => a - b); // Sort to find gaps
                
                let nextNumber = 1;
                
                // Find the first available number (allows reuse of deleted KPNs)
                for (let i = 0; i < existingKPNs.length; i++) {
                    if (existingKPNs[i] === nextNumber) {
                        nextNumber++;
                    } else {
                        // Found a gap, use this number
                        break;
                    }
                }
                
                const kpn = `${config.code}-${subcategory}-${nextNumber.toString().padStart(3, '0')}`;
                
                preview.textContent = kpn;
                
                // Update KPN in dynamic form if it exists
                const compKpnField = document.getElementById('comp-kpn');
                if (compKpnField) {
                    compKpnField.value = kpn;
                }
                
                // Update category and subcategory display fields
                const compCategoryDisplay = document.getElementById('comp-category-display');
                const compSubcategoryDisplay = document.getElementById('comp-subcategory-display');
                if (compCategoryDisplay) {
                    const categorySelect = document.getElementById('comp-category');
                    compCategoryDisplay.value = categorySelect.options[categorySelect.selectedIndex].text;
                }
                if (compSubcategoryDisplay) {
                    compSubcategoryDisplay.value = subcategory;
                }
            } else {
                preview.textContent = 'Select category and subcategory';
                // Clear dynamic form KPN field
                const compKpnField = document.getElementById('comp-kpn');
                if (compKpnField) {
                    compKpnField.value = '';
                }
            }
        }

        // Add component
        async function addComponent() {
            const category = document.getElementById('comp-category').value;
            const subcategory = document.getElementById('comp-subcategory').value;
            
            if (!category || !subcategory) {
                alert('Please select category and subcategory first');
                return;
            }
            
            const kpn = document.getElementById('comp-kpn').value || document.getElementById('comp-kpn-preview').textContent;
            
            // Collect data from dynamic fields
            const component = {
                kpn,
                category,
                subcategory,
                status: 'Active', // Default status for new components
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            // Validate required fields and collect data
            const config = categoryConfigs[category];
            let missingRequired = [];
            
            config.fields.forEach(field => {
                const fieldElement = document.getElementById(`comp-${field.id}`);
                if (fieldElement) {
                    const value = fieldElement.value.trim();
                    if (field.required && !value) {
                        missingRequired.push(field.label);
                    }
                    component[field.id.replace('-', '_')] = value;
                }
            });
            
            if (missingRequired.length > 0) {
                alert(`Please fill in all required fields: ${missingRequired.join(', ')}`);
                return;
            }
            
            // Check for duplicate components
            const duplicateComponent = findDuplicateComponent(component);
            if (duplicateComponent) {
                alert(`A component with matching specifications already exists with KPN: ${duplicateComponent.kpn}. Cannot create duplicate.`);
                return;
            }
            
            // Save to Firestore if available, otherwise localStorage
            if (auth && db && currentUser.uid) {
                const success = await saveComponentToFirestore(component);
                if (!success) {
                    // Fallback to localStorage
                    data.components.push(component);
                    saveToLocalStorage();
                }
            } else {
                data.components.push(component);
                saveToLocalStorage();
            }
            
            renderComponents();
            
            // Clear form
            document.getElementById('comp-category').value = '';
            document.getElementById('comp-subcategory').value = '';
            document.getElementById('comp-kpn-preview').textContent = 'Select category and subcategory';
            
            // Clear dynamic fields
            const dynamicFieldsContainer = document.getElementById('component-dynamic-fields');
            dynamicFieldsContainer.innerHTML = `
                <p style="color: #666; text-align: center; margin: 40px 0;">
                    Select a category and subcategory to display component-specific fields
                </p>
            `;
            
            // Show success message
            alert('Component added successfully!');
        }

        // Global variables for import process
        let pendingImportData = null;
        let duplicateResults = [];

        // Import components from CSV with duplicate detection
        function importCSV() {
            const fileInput = document.getElementById('csv-import-input');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file must have at least a header row and one data row');
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    let errors = [];
                    let validComponents = [];
                    let duplicates = [];
                    
                    // Check for required headers
                    const requiredHeaders = ['category', 'subcategory'];
                    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                    if (missingHeaders.length > 0) {
                        alert(`Missing required columns: ${missingHeaders.join(', ')}`);
                        return;
                    }
                    
                    // Phase 1: Parse and validate all rows, detect duplicates
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        if (values.length !== headers.length) continue;
                        
                        const rowData = {};
                        headers.forEach((header, index) => {
                            rowData[header] = values[index];
                        });
                        
                        // Validate category and subcategory
                        const category = rowData.category?.toLowerCase();
                        const subcategory = rowData.subcategory?.toUpperCase();
                        
                        if (!category || !categoryConfigs[category]) {
                            errors.push(`Row ${i + 1}: Invalid category "${rowData.category}"`);
                            continue;
                        }
                        
                        if (!subcategory || !categoryConfigs[category].subcategories.includes(subcategory)) {
                            errors.push(`Row ${i + 1}: Invalid subcategory "${rowData.subcategory}" for category "${category}"`);
                            continue;
                        }
                        
                        // Create component object (without KPN for now)
                        const component = {
                            category,
                            subcategory,
                            dateAdded: new Date().toISOString().split('T')[0],
                            status: 'Active',
                            rowNumber: i + 1
                        };
                        
                        // Map CSV fields to component fields - improved mapping logic
                        const config = categoryConfigs[category];
                        config.fields.forEach(field => {
                            // Get the field label and find the matching CSV field
                            const fieldLabel = field.label.toLowerCase();
                            const value = findMatchingCSVField(fieldLabel, field, rowData);
                            
                            // Store with underscored field name
                            component[field.id.replace(/-/g, '_')] = value || '';
                        });
                        
                        // Function to find matching CSV field
                        function findMatchingCSVField(fieldLabel, field, rowData) {
                            // Try exact match with the field label
                            for (const [csvKey, csvValue] of Object.entries(rowData)) {
                                if (csvKey.toLowerCase() === fieldLabel) {
                                    return csvValue;
                                }
                            }
                            
                            // Try common variations
                            const variations = [
                                fieldLabel.replace(/\s+/g, '-'),   // "manufacturer pn" -> "manufacturer-pn"
                                fieldLabel.replace(/\s+/g, '_'),   // "manufacturer pn" -> "manufacturer_pn" 
                                fieldLabel.replace(/\s+/g, ''),    // "manufacturer pn" -> "manufacturerpn"
                                field.id.replace(/-/g, '_'),       // "manufacturer-pn" -> "manufacturer_pn"
                                field.id                            // "manufacturer-pn"
                            ];
                            
                            for (const variation of variations) {
                                if (rowData[variation] !== undefined) {
                                    return rowData[variation];
                                }
                            }
                            
                            // Return empty string if no match is found
                            return '';
                        }
                        
                        // Check for duplicate components
                        const duplicateComponent = findDuplicateComponent(component);
                        if (duplicateComponent) {
                            duplicates.push({
                                component,
                                existingComponent: duplicateComponent,
                                choice: 'keep' // default choice
                            });
                        } else {
                            validComponents.push(component);
                        }
                    }
                    
                    // Show errors if any
                    if (errors.length > 0) {
                        console.log('Import validation errors:', errors);
                        alert(`Found ${errors.length} validation errors. Check console for details.`);
                    }
                    
                    // Store data for processing after user choices
                    pendingImportData = {
                        validComponents,
                        duplicates,
                        errors
                    };
                    
                    // Phase 2: If duplicates found, show modal for user choice
                    if (duplicates.length > 0) {
                        showDuplicateModal(duplicates);
                    } else {
                        // No duplicates, proceed with direct import
                        processFinalImport();
                    }
                    
                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
                
                // Clear the input
                fileInput.value = '';
            };
            
            reader.readAsText(file);
        }

        // Show duplicate confirmation modal
        function showDuplicateModal(duplicates) {
            const modal = document.getElementById('duplicate-modal');
            const duplicateList = document.getElementById('duplicate-list');
            
            // Clear previous content
            duplicateList.innerHTML = '';
            
            // Populate duplicate items
            duplicates.forEach((duplicate, index) => {
                const component = duplicate.component;
                const existing = duplicate.existingComponent;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'duplicate-item';
                
                // Create a user-friendly component description
                const componentDesc = createComponentDescription(component);
                const existingDesc = createComponentDescription(existing);
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'duplicate-item-header';
                const headerSpan = document.createElement('span');
                headerSpan.textContent = `‚ö†Ô∏è Row ${component.rowNumber}: ${componentDesc}`;
                headerDiv.appendChild(headerSpan);
                
                const existingDiv = document.createElement('div');
                existingDiv.className = 'duplicate-item-existing';
                const existingKpnStrong = document.createElement('strong');
                existingKpnStrong.textContent = 'Existing KPN:';
                existingDiv.appendChild(existingKpnStrong);
                existingDiv.appendChild(document.createTextNode(` ${existing.kpn}`));
                existingDiv.appendChild(document.createElement('br'));
                const detailsStrong = document.createElement('strong');
                detailsStrong.textContent = 'Details:';
                existingDiv.appendChild(detailsStrong);
                existingDiv.appendChild(document.createTextNode(` ${existingDesc}`));
                
                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'duplicate-choices';
                const keepInput = document.createElement('input');
                keepInput.type = 'radio';
                keepInput.id = `keep-${index}`;
                keepInput.name = `choice-${index}`;
                keepInput.value = 'keep';
                keepInput.checked = true;
                const keepLabel = document.createElement('label');
                keepLabel.htmlFor = `keep-${index}`;
                keepLabel.textContent = `‚úÖ Keep Existing KPN (${existing.kpn})`;
                choicesDiv.appendChild(keepInput);
                choicesDiv.appendChild(keepLabel);
                
                const newInput = document.createElement('input');
                newInput.type = 'radio';
                newInput.id = `new-${index}`;
                newInput.name = `choice-${index}`;
                newInput.value = 'new';
                const newLabel = document.createElement('label');
                newLabel.htmlFor = `new-${index}`;
                newLabel.textContent = '‚ûï Assign New KPN';
                choicesDiv.appendChild(newInput);
                choicesDiv.appendChild(newLabel);
                
                itemDiv.appendChild(headerDiv);
                itemDiv.appendChild(existingDiv);
                itemDiv.appendChild(choicesDiv);
                
                duplicateList.appendChild(itemDiv);
            });
            
            // Show modal
            modal.style.display = 'flex';
        }

        // Create user-friendly component description
        function createComponentDescription(component) {
            const category = component.category?.charAt(0).toUpperCase() + component.category?.slice(1);
            const subcategory = component.subcategory;
            
            // Create description based on component type
            switch(component.category) {
                case 'resistors':
                case 'inductors':
                    return `${category} ${component.value || 'N/A'} ${component.package || 'N/A'} ${component.tolerance || ''}`.trim();
                case 'capacitors':
                    return `${category} ${component.value || 'N/A'} ${component.package || 'N/A'} ${component.voltage_rating || ''}`.trim();
                case 'ics':
                case 'diodes':
                case 'transistors':
                case 'connectors':
                case 'switches':
                    return `${category} ${component.manufacturer_pn || component.description || 'N/A'}`.trim();
                default:
                    return `${category} ${subcategory}`;
            }
        }

        // Process user choices and handle final import
        function processDuplicateChoices() {
            const duplicates = pendingImportData.duplicates;
            
            // Collect user choices
            duplicates.forEach((duplicate, index) => {
                const keepRadio = document.getElementById(`keep-${index}`);
                const newRadio = document.getElementById(`new-${index}`);
                
                if (keepRadio.checked) {
                    duplicate.choice = 'keep';
                } else if (newRadio.checked) {
                    duplicate.choice = 'new';
                }
            });
            
            // Hide modal and process import
            document.getElementById('duplicate-modal').style.display = 'none';
            processFinalImport();
        }

        // Cancel import process
        function cancelDuplicateImport() {
            document.getElementById('duplicate-modal').style.display = 'none';
            pendingImportData = null;
            duplicateResults = [];
            alert('Import cancelled.');
        }

        // Process final import with user choices
        function processFinalImport() {
            if (!pendingImportData) return;
            
            const { validComponents, duplicates, errors } = pendingImportData;
            let importedCount = 0;
            let reusedCount = 0;
            let reassignedCount = 0;
            let componentsToAdd = [];
            let kpnCounter = 0; // Initialize counter for KPN generation
            
            // Add all non-duplicate components
            validComponents.forEach(component => {
                // Generate KPN for new component
                const kpn = generateKPNForComponent(component, kpnCounter);
                kpnCounter++;
                component.kpn = kpn;
                componentsToAdd.push(component);
                importedCount++;
            });
            
            // Process duplicate choices
            duplicates.forEach(duplicate => {
                if (duplicate.choice === 'new') {
                    // User chose to assign new KPN
                    const kpn = generateKPNForComponent(duplicate.component, importedCount + reassignedCount);
                    duplicate.component.kpn = kpn;
                    componentsToAdd.push(duplicate.component);
                    reassignedCount++;
                } else {
                    // User chose to keep existing - do nothing (reuse existing)
                    reusedCount++;
                }
            });
            
            // Add components to data
            data.components.push(...componentsToAdd);
            
            // Save and refresh UI
            if (componentsToAdd.length > 0) {
                saveData();
                renderComponents();
            }
            
            // Show comprehensive import summary
            showImportSummary(importedCount, reusedCount, reassignedCount, errors.length);
            
            // Reset pending data
            pendingImportData = null;
            duplicateResults = [];
        }

        // Generate KPN for a component during import
        function generateKPNForComponent(component, offset = 0) {
            const { category, subcategory } = component;
            const config = categoryConfigs[category];
            
            const existingKPNs = data.components
                .filter(c => c.kpn.startsWith(`${config.code}-${subcategory}`))
                .map(c => parseInt(c.kpn.split('-')[2]))
                .filter(n => !isNaN(n));
            
            const nextNumber = existingKPNs.length > 0 ? existingKPNs.reduce((max, n) => Math.max(max, n), -Infinity) + 1 + offset : 1 + offset;
            return `${config.code}-${subcategory}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Show detailed import summary
        function showImportSummary(newCount, reusedCount, reassignedCount, errorCount) {
            const totalProcessed = newCount + reusedCount + reassignedCount;
            
            let message = 'üìä Import Summary:\n\n';
            message += `‚úÖ New components created: ${newCount}\n`;
            message += `üîÑ Existing components reused: ${reusedCount}\n`;
            message += `‚ûï Components force-assigned new KPN: ${reassignedCount}\n`;
            message += `üìã Total components processed: ${totalProcessed}\n`;
            
            if (errorCount > 0) {
                message += `‚ùå Validation errors: ${errorCount} (check console)\n`;
            }
            
            message += '\nüéâ Import completed successfully!';
            
            alert(message);
        }

        // Export CSV template for component import
        function exportTemplate() {
            // Create template with all possible fields from all categories
            const allFields = new Set(['Category', 'Subcategory']);
            Object.values(categoryConfigs).forEach(config => {
                config.fields.forEach(field => {
                    allFields.add(field.label);
                });
            });
            
            const headers = Array.from(allFields);
            let csv = headers.join(',') + '\n';
            
            // Add comprehensive example rows for ALL component categories
            const examples = [
                // RESISTORS - Standard, Precision, Variable, Networks
                {
                    category: 'resistors',
                    subcategory: 'STD',
                    data: {
                        'Value': '10k',
                        'Package': '0805', 
                        'Tolerance': '1%',
                        'Temp Rating': '-55¬∞C to +125¬∞C',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                {
                    category: 'resistors',
                    subcategory: 'PRE',
                    data: {
                        'Value': '4.7k',
                        'Package': '0603', 
                        'Tolerance': '0.1%',
                        'Temp Rating': '-55¬∞C to +155¬∞C',
                        'Preferred Vendor': 'Digi-Key'
                    }
                },
                {
                    category: 'resistors',
                    subcategory: 'VAR',
                    data: {
                        'Value': '10k',
                        'Package': '3296W', 
                        'Tolerance': '10%',
                        'Temp Rating': '-40¬∞C to +85¬∞C',
                        'Preferred Vendor': 'Newark'
                    }
                },
                
                // CAPACITORS - Ceramic, Electrolytic, Tantalum, Film
                {
                    category: 'capacitors', 
                    subcategory: 'CER',
                    data: {
                        'Value': '100nF',
                        'Package': '0805',
                        'Tolerance': '10%', 
                        'Voltage': '50V',
                        'Rating': 'X7R',
                        'Preferred Vendor': 'Digi-Key'
                    }
                },
                {
                    category: 'capacitors', 
                    subcategory: 'ELE',
                    data: {
                        'Value': '470uF',
                        'Package': '8x12mm',
                        'Tolerance': '20%', 
                        'Voltage': '25V',
                        'Rating': 'Low ESR',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                {
                    category: 'capacitors', 
                    subcategory: 'TAN',
                    data: {
                        'Value': '22uF',
                        'Package': '1206',
                        'Tolerance': '10%', 
                        'Voltage': '16V',
                        'Rating': 'Industrial',
                        'Preferred Vendor': 'Arrow'
                    }
                },
                {
                    category: 'capacitors', 
                    subcategory: 'FIL',
                    data: {
                        'Value': '1uF',
                        'Package': '1210',
                        'Tolerance': '5%', 
                        'Voltage': '250V',
                        'Rating': 'X2',
                        'Preferred Vendor': 'Farnell'
                    }
                },
                
                // INTEGRATED CIRCUITS - MCU, Analog, Digital, Power
                {
                    category: 'ics',
                    subcategory: 'MCU', 
                    data: {
                        'Manufacturer PN': 'STM32F103C8T6',
                        'Description': '32-bit ARM Cortex-M3 MCU 72MHz',
                        'Package': 'LQFP-48',
                        'Rating': 'Industrial',
                        'Datasheet/Product Link': 'https://www.st.com/stm32f103c8',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                {
                    category: 'ics',
                    subcategory: 'ANA', 
                    data: {
                        'Manufacturer PN': 'LM358DR',
                        'Description': 'Dual Operational Amplifier',
                        'Package': 'SOIC-8',
                        'Rating': 'Industrial',
                        'Datasheet/Product Link': 'https://www.ti.com/product/LM358',
                        'Preferred Vendor': 'Digi-Key'
                    }
                },
                {
                    category: 'ics',
                    subcategory: 'DIG', 
                    data: {
                        'Manufacturer PN': '74HC595D',
                        'Description': '8-bit Serial-In Parallel-Out Shift Register',
                        'Package': 'SOIC-16',
                        'Rating': 'Commercial',
                        'Datasheet/Product Link': 'https://www.nxp.com/products/logic/shift-registers',
                        'Preferred Vendor': 'Newark'
                    }
                },
                {
                    category: 'ics',
                    subcategory: 'PWR', 
                    data: {
                        'Manufacturer PN': 'LM2596S-5.0',
                        'Description': 'Step-Down Voltage Regulator 5V 3A',
                        'Package': 'TO-263-5',
                        'Rating': 'Industrial',
                        'Datasheet/Product Link': 'https://www.ti.com/product/LM2596',
                        'Preferred Vendor': 'Mouser'
                    }
                },
                
                // INDUCTORS - Power, Choke, Ferrite
                {
                    category: 'inductors',
                    subcategory: 'PWR',
                    data: {
                        'Value': '22uH',
                        'Package': '1210',
                        'Tolerance': '20%',
                        'Current Rating': '2A',
                        'Preferred Vendor': 'Coilcraft'
                    }
                },
                {
                    category: 'inductors',
                    subcategory: 'CHK',
                    data: {
                        'Value': '100uH',
                        'Package': '0805',
                        'Tolerance': '10%',
                        'Current Rating': '500mA',
                        'Preferred Vendor': 'Murata'
                    }
                },
                {
                    category: 'inductors',
                    subcategory: 'FER',
                    data: {
                        'Value': '220nH',
                        'Package': '0603',
                        'Tolerance': '25%',
                        'Current Rating': '200mA',
                        'Preferred Vendor': 'TDK'
                    }
                },
                
                // DIODES - Standard, LED, Zener, Schottky
                {
                    category: 'diodes',
                    subcategory: 'STD',
                    data: {
                        'Manufacturer PN': '1N4148WS',
                        'Package': 'SOD-323',
                        'Voltage Rating': '75V',
                        'Current Rating': '150mA',
                        'Preferred Vendor': 'Vishay'
                    }
                },
                {
                    category: 'diodes',
                    subcategory: 'LED',
                    data: {
                        'Manufacturer PN': 'LTST-C170KRKT',
                        'Package': '0805',
                        'Voltage Rating': '2.1V',
                        'Current Rating': '20mA',
                        'Preferred Vendor': 'Lite-On'
                    }
                },
                {
                    category: 'diodes',
                    subcategory: 'ZEN',
                    data: {
                        'Manufacturer PN': 'BZX84C5V1',
                        'Package': 'SOT-23',
                        'Voltage Rating': '5.1V',
                        'Current Rating': '250mA',
                        'Preferred Vendor': 'NXP'
                    }
                },
                {
                    category: 'diodes',
                    subcategory: 'SCH',
                    data: {
                        'Manufacturer PN': 'BAT54S',
                        'Package': 'SOT-23',
                        'Voltage Rating': '30V',
                        'Current Rating': '200mA',
                        'Preferred Vendor': 'Infineon'
                    }
                },
                
                // TRANSISTORS - BJT, FET, MOSFET
                {
                    category: 'transistors',
                    subcategory: 'BJT',
                    data: {
                        'Manufacturer PN': 'MMBT3904',
                        'Package': 'SOT-23',
                        'Voltage Rating': '40V',
                        'Current Rating': '200mA',
                        'Preferred Vendor': 'ON Semi'
                    }
                },
                {
                    category: 'transistors',
                    subcategory: 'FET',
                    data: {
                        'Manufacturer PN': '2N7002K',
                        'Package': 'SOT-23',
                        'Voltage Rating': '60V',
                        'Current Rating': '300mA',
                        'Preferred Vendor': 'Nexperia'
                    }
                },
                {
                    category: 'transistors',
                    subcategory: 'MOS',
                    data: {
                        'Manufacturer PN': 'BSS138',
                        'Package': 'SOT-23',
                        'Voltage Rating': '50V',
                        'Current Rating': '220mA',
                        'Preferred Vendor': 'Fairchild'
                    }
                },
                
                // CONNECTORS - Header, JST, USB, RJ45
                {
                    category: 'connectors',
                    subcategory: 'HDR',
                    data: {
                        'Manufacturer PN': 'TSW-102-07-G-S',
                        'Description': '2-pin 0.1" header socket',
                        'Pitch': '2.54mm',
                        'Pins': '2',
                        'Preferred Vendor': 'Samtec'
                    }
                },
                {
                    category: 'connectors',
                    subcategory: 'JST',
                    data: {
                        'Manufacturer PN': 'B4B-XH-A(LF)(SN)',
                        'Description': '4-pin JST XH connector',
                        'Pitch': '2.5mm',
                        'Pins': '4',
                        'Preferred Vendor': 'JST'
                    }
                },
                {
                    category: 'connectors',
                    subcategory: 'USB',
                    data: {
                        'Manufacturer PN': 'USB4085-GF-A',
                        'Description': 'USB-C receptacle',
                        'Pitch': '0.5mm',
                        'Pins': '24',
                        'Preferred Vendor': 'GCT'
                    }
                },
                {
                    category: 'connectors',
                    subcategory: 'RJ45',
                    data: {
                        'Manufacturer PN': 'SI-60062-F',
                        'Description': 'RJ45 Ethernet connector with LEDs',
                        'Pitch': '1.27mm',
                        'Pins': '8',
                        'Preferred Vendor': 'Bel Fuse'
                    }
                },
                
                // SWITCHES - Tactile, DIP, Rotary, Slide
                {
                    category: 'switches',
                    subcategory: 'TAC',
                    data: {
                        'Manufacturer PN': 'SKHHPNA010',
                        'Description': 'Tactile switch 4.3x4.3mm',
                        'Package': '4.3x4.3mm',
                        'Actuation Force': '160gf',
                        'Preferred Vendor': 'Alps'
                    }
                },
                {
                    category: 'switches',
                    subcategory: 'DIP',
                    data: {
                        'Manufacturer PN': 'DS01-254-1-04BK-SMT',
                        'Description': '4-position DIP switch',
                        'Package': 'SMT',
                        'Actuation Force': '250gf',
                        'Preferred Vendor': 'CTS'
                    }
                },
                {
                    category: 'switches',
                    subcategory: 'ROT',
                    data: {
                        'Manufacturer PN': 'PEC11R-4015F-S0024',
                        'Description': 'Rotary encoder with switch',
                        'Package': 'Through-hole',
                        'Actuation Force': '200gf',
                        'Preferred Vendor': 'Bourns'
                    }
                },
                {
                    category: 'switches',
                    subcategory: 'SLI',
                    data: {
                        'Manufacturer PN': 'SS12D00G3',
                        'Description': 'SPDT slide switch',
                        'Package': '4.5x1.8mm',
                        'Actuation Force': '120gf',
                        'Preferred Vendor': 'E-Switch'
                    }
                }
            ];
            
            examples.forEach(example => {
                const row = headers.map(header => {
                    if (header === 'Category') return example.category;
                    if (header === 'Subcategory') return example.subcategory;
                    return example.data[header] || '';
                });
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            downloadCSV(csv, 'kinben-components-template.csv');
        }

        // Current BOM items for PCB form
        let currentBOM = [];

        // Add BOM item
        function addBOMItem() {
            const kpn = document.getElementById('bom-kpn').value;
            const quantity = parseInt(document.getElementById('bom-quantity').value);
            const refdes = document.getElementById('bom-refdes').value;
            
            if (!kpn || !quantity || !refdes) {
                alert('Please fill in all BOM fields');
                return;
            }
            
            const component = data.components.find(c => c.kpn === kpn);
            if (!component) {
                alert('Component not found');
                return;
            }
            
            const bomItem = {
                kpn,
                componentName: `${component.manufacturer} ${component.partNumber}`,
                quantity,
                refdes
            };
            
            currentBOM.push(bomItem);
            renderBOMItems();
            
            // Clear form
            document.getElementById('bom-kpn').value = '';
            document.getElementById('bom-quantity').value = '1';
            document.getElementById('bom-refdes').value = '';
        }

        // Remove BOM item
        function removeBOMItem(index) {
            currentBOM.splice(index, 1);
            renderBOMItems();
        }

        // Render BOM items
        function renderBOMItems() {
            const container = document.getElementById('bom-items');
            container.innerHTML = '';
            
            currentBOM.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bom-row';
                div.innerHTML = `
                    <span>${item.componentName}</span>
                    <span>Qty: ${item.quantity}</span>
                    <span>RefDes: ${item.refdes}</span>
                    <button class="remove-btn" onclick="removeBOMItem(${index})">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        // Add PCB
        async function addPCB() {
            const name = document.getElementById('pcb-name').value;
            const version = document.getElementById('pcb-version').value;
            const status = document.getElementById('pcb-status').value;
            const description = document.getElementById('pcb-description').value;
            
            if (!name || !version || currentBOM.length === 0) {
                alert('Please fill in PCB details and add at least one BOM item');
                return;
            }
            
            const pcb = {
                name,
                version,
                status,
                description,
                bom: [...currentBOM],
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            // Save to Firestore if available, otherwise localStorage
            if (auth && db && currentUser.uid) {
                const success = await savePCBToFirestore(pcb);
                if (!success) {
                    // Fallback to localStorage
                    data.pcbs.push(pcb);
                    saveToLocalStorage();
                }
            } else {
                data.pcbs.push(pcb);
                saveToLocalStorage();
            }
            
            renderPCBs();
            
            // Clear form
            document.getElementById('pcb-name').value = '';
            document.getElementById('pcb-version').value = '';
            document.getElementById('pcb-description').value = '';
            currentBOM = [];
            renderBOMItems();
        }

        // Current system PCBs
        let currentSystemPCBs = [];

        // Add system PCB
        function addSystemPCB() {
            const pcbName = document.getElementById('system-pcb').value;
            const quantity = parseInt(document.getElementById('system-pcb-quantity').value);
            
            if (!pcbName || !quantity) {
                alert('Please select PCB and quantity');
                return;
            }
            
            const pcb = data.pcbs.find(p => p.name === pcbName);
            if (!pcb) {
                alert('PCB not found');
                return;
            }
            
            const systemPCB = {
                name: pcbName,
                version: pcb.version,
                quantity
            };
            
            currentSystemPCBs.push(systemPCB);
            renderSystemPCBs();
            
            // Clear form
            document.getElementById('system-pcb').value = '';
            document.getElementById('system-pcb-quantity').value = '1';
        }

        // Remove system PCB
        function removeSystemPCB(index) {
            currentSystemPCBs.splice(index, 1);
            renderSystemPCBs();
        }

        // Render system PCBs
        function renderSystemPCBs() {
            const container = document.getElementById('system-pcbs');
            container.innerHTML = '';
            
            currentSystemPCBs.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bom-row';
                div.innerHTML = `
                    <span>${item.name} (${item.version})</span>
                    <span>Qty: ${item.quantity}</span>
                    <span></span>
                    <button class="remove-btn" onclick="removeSystemPCB(${index})">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        // Add system
        async function addSystem() {
            const name = document.getElementById('system-name').value;
            const version = document.getElementById('system-version').value;
            const status = document.getElementById('system-status').value;
            const description = document.getElementById('system-description').value;
            
            if (!name || !version || currentSystemPCBs.length === 0) {
                alert('Please fill in system details and add at least one PCB');
                return;
            }
            
            const system = {
                name,
                version,
                status,
                description,
                pcbs: [...currentSystemPCBs],
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            // Save to Firestore if available, otherwise localStorage
            if (auth && db && currentUser.uid) {
                const success = await saveSystemToFirestore(system);
                if (!success) {
                    // Fallback to localStorage
                    data.systems.push(system);
                    saveToLocalStorage();
                }
            } else {
                data.systems.push(system);
                saveToLocalStorage();
            }
            
            renderSystems();
            
            // Clear form
            document.getElementById('system-name').value = '';
            document.getElementById('system-version').value = '';
            document.getElementById('system-description').value = '';
            currentSystemPCBs = [];
            renderSystemPCBs();
        }

        // Update dropdowns
        function updateDropdowns() {
            // Update BOM KPN dropdown - exclude archived components
            const bomSelect = document.getElementById('bom-kpn');
            bomSelect.innerHTML = '<option value="">Select Component</option>';
            data.components.forEach(comp => {
                if (comp.status === 'Active') {  // Only show active components, not archived
                    const option = document.createElement('option');
                    option.value = comp.kpn;
                    option.textContent = `${comp.kpn} - ${comp.manufacturer || comp.manufacturer_pn || 'Unknown'} ${comp.partNumber || comp.value || ''}`;
                    bomSelect.appendChild(option);
                }
            });
            
            // Update system PCB dropdown
            const systemPCBSelect = document.getElementById('system-pcb');
            systemPCBSelect.innerHTML = '<option value="">Select PCB</option>';
            data.pcbs.forEach(pcb => {
                if (pcb.status === 'Active') {
                    const option = document.createElement('option');
                    option.value = pcb.name;
                    option.textContent = `${pcb.name} (${pcb.version})`;
                    systemPCBSelect.appendChild(option);
                }
            });
        }

        // Render functions
        function renderComponents() {
            const tbody = document.getElementById('components-tbody');
            tbody.innerHTML = '';
            
            data.components.forEach(comp => {
                const row = document.createElement('tr');
                
                // Add archived styling if component is archived
                if (comp.status === 'Archived') {
                    row.className = 'archived-row';
                }
                
                // Get category config for this component
                const config = categoryConfigs[comp.category];
                
                // Determine value/PN field
                let valuePn = comp.value || comp.manufacturer_pn || comp.manufacturer_PN || '';
                
                // Determine package
                let packageValue = comp.package || '';
                
                // Build specs string
                let specs = [];
                if (comp.tolerance) specs.push(`¬±${comp.tolerance}`);
                if (comp.voltage) specs.push(`${comp.voltage}`);
                if (comp.rating) specs.push(`${comp.rating}`);
                if (comp.temp_rating) specs.push(`${comp.temp_rating}`);
                if (comp.current_rating) specs.push(`${comp.current_rating}`);
                if (comp.voltage_rating) specs.push(`${comp.voltage_rating}`);
                if (comp.actuation_force) specs.push(`${comp.actuation_force}`);
                if (comp.pitch) specs.push(`${comp.pitch}`);
                if (comp.pins) specs.push(`${comp.pins}P`);
                
                // Get vendor
                let vendor = comp.preferred_vendor || '';
                
                // Build action buttons based on user role and component status
                let actionButtons = '';
                if (comp.status !== 'Archived') {
                    actionButtons += `<button class="btn" onclick="editComponent('${comp.kpn}')" style="background: #ff9800; color: white; padding: 4px 8px; font-size: 12px; margin-right: 5px;">Edit</button>`;
                    
                    if (currentUser.role === 'team') {
                        actionButtons += `<button class="archive-btn" onclick="archiveComponent('${comp.kpn}')">Archive</button>`;
                    } else if (currentUser.role === 'admin') {
                        actionButtons += `<button class="archive-btn" onclick="archiveComponent('${comp.kpn}')">Archive</button>`;
                        actionButtons += `<button class="delete-btn" onclick="deleteComponent('${comp.kpn}')">Delete</button>`;
                    }
                } else {
                    // Show status for archived components
                    actionButtons = '<span class="status-archived">Archived</span>';
                    if (currentUser.role === 'admin') {
                        actionButtons += ` <button class="delete-btn" onclick="deleteComponent('${comp.kpn}')">Delete</button>`;
                    }
                }
                
                // Build checkbox column if in bulk selection mode
                let checkboxColumn = '';
                if (bulkSelectionMode) {
                    checkboxColumn = `<td><input type="checkbox" class="component-checkbox" value="${comp.kpn}"></td>`;
                }
                
                row.innerHTML = `
                    ${checkboxColumn}
                    <td><strong>${comp.kpn}</strong></td>
                    <td>${comp.category.charAt(0).toUpperCase() + comp.category.slice(1)}</td>
                    <td>${comp.subcategory}</td>
                    <td>${valuePn}</td>
                    <td>${packageValue}</td>
                    <td>${specs.join(', ')}</td>
                    <td>${vendor}</td>
                    <td>
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderPCBs() {
            const tbody = document.getElementById('pcbs-tbody');
            tbody.innerHTML = '';
            
            data.pcbs.forEach(pcb => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pcb.name}</td>
                    <td>${pcb.version}</td>
                    <td>${pcb.description}</td>
                    <td>${pcb.bom.length} items</td>
                    <td><span class="status-${pcb.status.toLowerCase()}">${pcb.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSystems() {
            const tbody = document.getElementById('systems-tbody');
            tbody.innerHTML = '';
            
            data.systems.forEach(system => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${system.name}</td>
                    <td>${system.version}</td>
                    <td>${system.description}</td>
                    <td>${system.pcbs.length} PCBs</td>
                    <td><span class="status-${system.status.toLowerCase()}">${system.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAll() {
            renderComponents();
            renderPCBs();
            renderSystems();
            renderVendors();
            updateDropdowns();
        }
        
        // Individual update functions for real-time Firestore listeners
        function updateComponentsTable() {
            renderComponents();
        }
        
        function updatePCBsTable() {
            renderPCBs();
        }
        
        function updateSystemsTable() {
            renderSystems();
        }

        // Filter functions
        function filterComponents() {
            const search = document.getElementById('comp-search').value.toLowerCase();
            const rows = document.querySelectorAll('#components-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterPCBs() {
            const search = document.getElementById('pcb-search').value.toLowerCase();
            const rows = document.querySelectorAll('#pcbs-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterSystems() {
            const search = document.getElementById('system-search').value.toLowerCase();
            const rows = document.querySelectorAll('#systems-tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Update statistics
        function updateStats() {
            document.getElementById('total-components').textContent = data.components.length;
            document.getElementById('total-pcbs').textContent = data.pcbs.length;
            document.getElementById('total-systems').textContent = data.systems.length;
            
            document.getElementById('export-components').textContent = data.components.length;
            document.getElementById('export-pcbs').textContent = data.pcbs.length;
            document.getElementById('export-systems').textContent = data.systems.length;
        }

        // Export functions
        function exportComponents() {
            if (data.components.length === 0) {
                alert('No components to export');
                return;
            }
            
            // Get all possible field names
            const allFields = new Set(['KPN', 'Category', 'Subcategory', 'Date Added']);
            Object.values(categoryConfigs).forEach(config => {
                config.fields.forEach(field => {
                    allFields.add(field.label);
                });
            });
            
            const headers = Array.from(allFields);
            let csv = headers.join(',') + '\n';
            
            csv += data.components.map(c => {
                return headers.map(header => {
                    let value = '';
                    switch(header) {
                        case 'KPN': value = c.kpn; break;
                        case 'Category': value = c.category; break;
                        case 'Subcategory': value = c.subcategory; break;
                        case 'Date Added': value = c.dateAdded; break;
                        case 'Value': value = c.value || ''; break;
                        case 'Package': value = c.package || ''; break;
                        case 'Tolerance': value = c.tolerance || ''; break;
                        case 'Temp Rating': value = c.temp_rating || ''; break;
                        case 'Preferred Vendor': value = c.preferred_vendor || ''; break;
                        case 'Voltage': value = c.voltage || ''; break;
                        case 'Rating': value = c.rating || ''; break;
                        case 'Manufacturer PN': value = c.manufacturer_pn || ''; break;
                        case 'Description': value = c.description || ''; break;
                        case 'Datasheet/Product Link': value = c.datasheet_link || ''; break;
                        case 'Current Rating': value = c.current_rating || ''; break;
                        case 'Voltage Rating': value = c.voltage_rating || ''; break;
                        case 'Pitch': value = c.pitch || ''; break;
                        case 'Pins': value = c.pins || ''; break;
                        case 'Actuation Force': value = c.actuation_force || ''; break;
                        default: value = '';
                    }
                    return `"${value}"`;
                }).join(',');
            }).join('\n');
            
            downloadCSV(csv, 'kinben-components.csv');
        }

        function exportPCBs() {
            if (data.pcbs.length === 0) {
                alert('No PCBs to export');
                return;
            }
            
            const csv = 'PCB Name,Version,Status,Description,BOM Items,Date Added\n' +
                data.pcbs.map(p => 
                    `"${p.name}",${p.version},${p.status},"${p.description}",${p.bom.length},${p.dateAdded}`
                ).join('\n');
            
            downloadCSV(csv, 'kinben-pcbs.csv');
        }

        function exportSystems() {
            if (data.systems.length === 0) {
                alert('No systems to export');
                return;
            }
            
            const csv = 'System Name,Version,Status,Description,PCB Count,Date Added\n' +
                data.systems.map(s => 
                    `"${s.name}",${s.version},${s.status},"${s.description}",${s.pcbs.length},${s.dateAdded}`
                ).join('\n');
            
            downloadCSV(csv, 'kinben-systems.csv');
        }

        function exportAll() {
            exportComponents();
            exportPCBs();
            exportSystems();
        }

        // Vendor management functions
        async function addVendor() {
            const vendorName = document.getElementById('new-vendor-name').value.trim();
            if (!vendorName) {
                alert('Please enter a vendor name');
                return;
            }
            
            if (data.vendors.includes(vendorName)) {
                alert('Vendor already exists');
                return;
            }
            
            data.vendors.push(vendorName);
            data.vendors.sort(); // Keep vendors sorted
            
            // Save to Firestore if available
            if (auth && db && currentUser.uid) {
                const success = await saveVendorsToFirestore();
                if (!success) {
                    saveToLocalStorage();
                }
            } else {
                saveToLocalStorage();
            }
            
            renderVendors();
            
            // Clear input
            document.getElementById('new-vendor-name').value = '';
            
            alert(`Added vendor: ${vendorName}`);
        }
        
        async function removeVendor(vendorName) {
            if (confirm(`Remove vendor "${vendorName}"?`)) {
                data.vendors = data.vendors.filter(v => v !== vendorName);
                
                // Save to Firestore if available
                if (auth && db && currentUser.uid) {
                    const success = await saveVendorsToFirestore();
                    if (!success) {
                        saveToLocalStorage();
                    }
                } else {
                    saveToLocalStorage();
                }
                
                renderVendors();
            }
        }
        
        function renderVendors() {
            const container = document.getElementById('vendors-container');
            if (!container) return;
            
            container.innerHTML = '';
            data.vendors.forEach(vendor => {
                const vendorTag = document.createElement('div');
                vendorTag.style.cssText = 'background: #e3f2fd; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px;';
                vendorTag.innerHTML = `
                    <span>${vendor}</span>
                    <button onclick="removeVendor('${vendor}')" style="background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
                `;
                container.appendChild(vendorTag);
            });
        }
        
        // Component editing functionality
        function editComponent(kpn) {
            const component = data.components.find(c => c.kpn === kpn);
            if (!component) {
                alert('Component not found');
                return;
            }
            
            // Switch to components tab
            showTab('components');
            
            // Set category and subcategory
            document.getElementById('comp-category').value = component.category;
            updateComponentSubcategories();
            document.getElementById('comp-subcategory').value = component.subcategory;
            updateComponentFields();
            generateComponentKPN();
            
            // Fill in the dynamic fields
            const config = categoryConfigs[component.category];
            if (config) {
                config.fields.forEach(field => {
                    const fieldElement = document.getElementById(`comp-${field.id}`);
                    if (fieldElement) {
                        const value = component[field.id.replace('-', '_')] || '';
                        if (field.type === 'vendor-select') {
                            fieldElement.value = value;
                        } else {
                            fieldElement.value = value;
                        }
                    }
                });
            }
            
            // Change the add button to update mode
            const addButton = document.querySelector('button[onclick="addComponent()"]');
            addButton.textContent = 'Update Component';
            addButton.setAttribute('onclick', `updateComponent('${kpn}')`);
            
            // Show cancel edit button
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            
            // Scroll to form
            document.getElementById('components').scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateComponent(originalKPN) {
            const category = document.getElementById('comp-category').value;
            const subcategory = document.getElementById('comp-subcategory').value;
            
            if (!category || !subcategory) {
                alert('Please select category and subcategory first');
                return;
            }
            
            // Find component index
            const componentIndex = data.components.findIndex(c => c.kpn === originalKPN);
            if (componentIndex === -1) {
                alert('Component not found');
                return;
            }
            
            const kpn = document.getElementById('comp-kpn').value || document.getElementById('comp-kpn-preview').textContent;
            
            // Collect data from dynamic fields
            const component = {
                kpn,
                category,
                subcategory,
                status: data.components[componentIndex].status || 'Active', // Keep original status
                dateAdded: data.components[componentIndex].dateAdded, // Keep original date
                archivedDate: data.components[componentIndex].archivedDate, // Keep archived date if exists
                archivedBy: data.components[componentIndex].archivedBy // Keep archived by if exists
            };
            
            // Validate required fields and collect data
            const config = categoryConfigs[category];
            let missingRequired = [];
            
            config.fields.forEach(field => {
                const fieldElement = document.getElementById(`comp-${field.id}`);
                if (fieldElement) {
                    const value = fieldElement.value.trim();
                    if (field.required && !value) {
                        missingRequired.push(field.label);
                    }
                    component[field.id.replace('-', '_')] = value;
                }
            });
            
            if (missingRequired.length > 0) {
                alert(`Please fill in all required fields: ${missingRequired.join(', ')}`);
                return;
            }
            
            // Update component
            data.components[componentIndex] = component;
            saveData();
            renderComponents();
            
            // Reset form
            resetComponentForm();
            
            alert('Component updated successfully!');
        }
        
        function resetComponentForm() {
            document.getElementById('comp-category').value = '';
            document.getElementById('comp-subcategory').value = '';
            document.getElementById('comp-kpn-preview').textContent = 'Select category and subcategory';
            
            // Clear dynamic fields
            const dynamicFieldsContainer = document.getElementById('component-dynamic-fields');
            dynamicFieldsContainer.innerHTML = `
                <p style="color: #666; text-align: center; margin: 40px 0;">
                    Select a category and subcategory to display component-specific fields
                </p>
            `;
            
            // Reset button
            const addButton = document.querySelector('button[onclick^="updateComponent"], button[onclick="addComponent()"]');
            addButton.textContent = 'Add Component';
            addButton.setAttribute('onclick', 'addComponent()');
            
            // Hide cancel edit button
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        // Archive component (Team and Admin can do this)
        // Global variable to track bulk selection mode
        let bulkSelectionMode = false;

        // Toggle bulk selection mode
        function toggleBulkSelection() {
            bulkSelectionMode = !bulkSelectionMode;
            const bulkBtn = document.getElementById('bulk-select-btn');
            const bulkActions = document.getElementById('bulk-actions');
            const bulkHeader = document.getElementById('bulk-select-header');
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            
            if (bulkSelectionMode) {
                bulkBtn.textContent = 'Exit Bulk Select';
                bulkBtn.style.background = '#dc3545';
                bulkActions.style.display = 'block';
                bulkHeader.style.display = '';
                
                // Show delete button only for admin users
                if (currentUser.role === 'admin') {
                    bulkDeleteBtn.style.display = '';
                }
                
                renderComponents(); // Re-render to show checkboxes
            } else {
                bulkBtn.textContent = 'Enable Bulk Select';
                bulkBtn.style.background = '#6c757d';
                bulkActions.style.display = 'none';
                bulkHeader.style.display = 'none';
                bulkDeleteBtn.style.display = 'none';
                
                // Clear all selections
                document.getElementById('select-all-checkbox').checked = false;
                renderComponents(); // Re-render to hide checkboxes
            }
        }

        // Toggle all checkboxes
        function toggleAllCheckboxes(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.component-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = masterCheckbox.checked;
            });
        }

        // Select all components
        function selectAllComponents() {
            const masterCheckbox = document.getElementById('select-all-checkbox');
            masterCheckbox.checked = true;
            toggleAllCheckboxes(masterCheckbox);
        }

        // Deselect all components
        function deselectAllComponents() {
            const masterCheckbox = document.getElementById('select-all-checkbox');
            masterCheckbox.checked = false;
            toggleAllCheckboxes(masterCheckbox);
        }

        // Get selected component KPNs
        function getSelectedComponentKPNs() {
            const selectedKPNs = [];
            const checkboxes = document.querySelectorAll('.component-checkbox:checked');
            checkboxes.forEach(checkbox => {
                selectedKPNs.push(checkbox.value);
            });
            return selectedKPNs;
        }

        // Bulk archive components
        function bulkArchiveComponents() {
            const selectedKPNs = getSelectedComponentKPNs();
            
            if (selectedKPNs.length === 0) {
                alert('Please select components to archive.');
                return;
            }
            
            if (confirm(`Are you sure you want to archive ${selectedKPNs.length} selected components? Archived components cannot be used in new BOMs.`)) {
                let archivedCount = 0;
                
                selectedKPNs.forEach(kpn => {
                    const componentIndex = data.components.findIndex(c => c.kpn === kpn);
                    if (componentIndex !== -1 && data.components[componentIndex].status !== 'Archived') {
                        data.components[componentIndex].status = 'Archived';
                        data.components[componentIndex].archivedDate = new Date().toISOString().split('T')[0];
                        data.components[componentIndex].archivedBy = currentUser.username;
                        archivedCount++;
                    }
                });
                
                if (archivedCount > 0) {
                    saveData();
                    renderComponents();
                    updateDropdowns();
                    alert(`Successfully archived ${archivedCount} components.`);
                    
                    // Clear selections
                    deselectAllComponents();
                } else {
                    alert('No components were archived (they may already be archived).');
                }
            }
        }

        // Bulk delete components (Admin only)
        function bulkDeleteComponents() {
            if (currentUser.role !== 'admin') {
                alert('Only Admin users can delete components.');
                return;
            }
            
            const selectedKPNs = getSelectedComponentKPNs();
            
            if (selectedKPNs.length === 0) {
                alert('Please select components to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to PERMANENTLY DELETE ${selectedKPNs.length} selected components? This will allow their KPNs to be reused for new components.`)) {
                let deletedCount = 0;
                
                // Delete in reverse order to avoid index issues
                for (let i = data.components.length - 1; i >= 0; i--) {
                    if (selectedKPNs.includes(data.components[i].kpn)) {
                        data.components.splice(i, 1);
                        deletedCount++;
                    }
                }
                
                if (deletedCount > 0) {
                    saveData();
                    renderComponents();
                    updateDropdowns();
                    alert(`Successfully deleted ${deletedCount} components. Their KPNs can now be reused.`);
                    
                    // Clear selections
                    deselectAllComponents();
                } else {
                    alert('No components were deleted.');
                }
            }
        }

        function archiveComponent(kpn) {
            if (confirm(`Are you sure you want to archive component ${kpn}? Archived components cannot be used in new BOMs.`)) {
                const componentIndex = data.components.findIndex(c => c.kpn === kpn);
                if (componentIndex !== -1) {
                    data.components[componentIndex].status = 'Archived';
                    data.components[componentIndex].archivedDate = new Date().toISOString().split('T')[0];
                    data.components[componentIndex].archivedBy = currentUser.username;
                    saveData();
                    renderComponents();
                    updateDropdowns(); // Refresh dropdowns to exclude archived components
                    alert(`Component ${kpn} has been archived.`);
                }
            }
        }

        // Delete component (Admin only - allows KPN reuse)
        function deleteComponent(kpn) {
            if (currentUser.role !== 'admin') {
                alert('Only Admin users can delete components.');
                return;
            }
            
            if (confirm(`Are you sure you want to PERMANENTLY DELETE component ${kpn}? This will allow the KPN to be reused for new components.`)) {
                const componentIndex = data.components.findIndex(c => c.kpn === kpn);
                if (componentIndex !== -1) {
                    // Remove from components array completely
                    data.components.splice(componentIndex, 1);
                    saveData();
                    renderComponents();
                    updateDropdowns();
                    alert(`Component ${kpn} has been permanently deleted. The KPN can now be reused.`);
                }
            }
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Don't automatically load data - Firebase auth state listener will handle this
            // loadData(); // Commented out - now handled by auth state change
        });
    </script>
</body>
</html>
